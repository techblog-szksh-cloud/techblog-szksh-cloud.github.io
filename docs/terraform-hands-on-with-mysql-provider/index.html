<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.89.4" />



<link rel="canonical" href="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/">


    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <title>Terraform ハンズオン with MySQL Provider - melody</title>
    
<meta name="description" content="Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、 では手頃な題材はあるかと言われると少し難しいです。公式の Getting Started では AWS が使われていますが、 AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。 もう少し手軽なものが欲しいところです。そこで公式の Provider で丁度いいものはないか探したところ、 MySQL Provider が良さそうでした。 MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。ちなみに公式の Provider のリストはこちらです。 https://github.com/terraform-providers https://www.terraform.io/docs/providers/index.html  また、 Terraform に関しては Terraform 入門 も参照してください。今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。以降、コマンドの実行結果は一部省略することがあります。$ mkdir workspace $ cd workspace Terraform のバージョンと tfenv Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で terraform plan などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。 そういう意味では、 tfenv によってバージョン管理するのが良いです。">

<meta property="og:title" content="Terraform ハンズオン with MySQL Provider - melody">
<meta property="og:type" content="article">
<meta property="og:url" content="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/">
<meta property="og:image" content="https://techblog.szksh.cloud/images/default.png">
<meta property="og:site_name" content="melody">
<meta property="og:description" content="Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、 では手頃な題材はあるかと言われると少し難しいです。公式の Getting Started では AWS が使われていますが、 AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。 もう少し手軽なものが欲しいところです。そこで公式の Provider で丁度いいものはないか探したところ、 MySQL Provider が良さそうでした。 MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。ちなみに公式の Provider のリストはこちらです。 https://github.com/terraform-providers https://www.terraform.io/docs/providers/index.html  また、 Terraform に関しては Terraform 入門 も参照してください。今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。以降、コマンドの実行結果は一部省略することがあります。$ mkdir workspace $ cd workspace Terraform のバージョンと tfenv Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で terraform plan などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。 そういう意味では、 tfenv によってバージョン管理するのが良いです。">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="melody">
<meta name="twitter:url" content="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/">
<meta name="twitter:title" content="Terraform ハンズオン with MySQL Provider - melody">
<meta name="twitter:description" content="Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、 では手頃な題材はあるかと言われると少し難しいです。公式の Getting Started では AWS が使われていますが、 AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。 もう少し手軽なものが欲しいところです。そこで公式の Provider で丁度いいものはないか探したところ、 MySQL Provider が良さそうでした。 MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。ちなみに公式の Provider のリストはこちらです。 https://github.com/terraform-providers https://www.terraform.io/docs/providers/index.html  また、 Terraform に関しては Terraform 入門 も参照してください。今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。以降、コマンドの実行結果は一部省略することがあります。$ mkdir workspace $ cd workspace Terraform のバージョンと tfenv Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で terraform plan などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。 そういう意味では、 tfenv によってバージョン管理するのが良いです。">
<meta name="twitter:image" content="https://techblog.szksh.cloud/images/default.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"https:\/\/techblog.szksh.cloud\/"
    },
    "headline": "Terraform ハンズオン with MySQL Provider - melody",
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/techblog.szksh.cloud\/images\/default.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2020-01-17T09:14:08JST",
    "dateModified": "2020-01-17T09:14:08JST",
    "author": {
      "@type": "Person",
      "name": "melody"
    },
    "publisher": {
      "@type": "Organization",
      "name": "melody",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/techblog.szksh.cloud\/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、 では手頃な題材はあるかと言われると少し難しいです。\n公式の Getting Started では AWS が使われていますが、 AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。 もう少し手軽なものが欲しいところです。\nそこで公式の Provider で丁度いいものはないか探したところ、 MySQL Provider が良さそうでした。 MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。\nちなみに公式の Provider のリストはこちらです。\n https:\/\/github.com\/terraform-providers https:\/\/www.terraform.io\/docs\/providers\/index.html  また、 Terraform に関しては Terraform 入門 も参照してください。\n今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。\n以降、コマンドの実行結果は一部省略することがあります。\n$ mkdir workspace $ cd workspace Terraform のバージョンと tfenv Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で terraform plan などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。 そういう意味では、 tfenv によってバージョン管理するのが良いです。"
  }
</script>


    <link href="https://techblog.szksh.cloud/css/styles.css" rel="stylesheet">
    

  </head>

  <body>
    
    
    

    <header class="l-header">
      <nav class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://techblog.szksh.cloud/">melody</a>
          </div>

          

        </div>
      </nav>
    </header>

    <main>
      <div class="container">
        
<div class="row">
  <div class="col-md-8">

    <nav class="p-crumb">
      <ol class="breadcrumb">
        <li><a href="https://techblog.szksh.cloud/"><i class="fa fa-home" aria-hidden="true"></i></a></li>
        
        <li class="active">Terraform ハンズオン with MySQL Provider</li>
      </ol>
    </nav>

    <article class="single">
  <header>
    <ul class="p-facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2020-01-17T09:14:08JST">Jan 17, 2020</time></li>
      
      
    </ul>

    <h1 class="title">Terraform ハンズオン with MySQL Provider</h1>
    
    
    <section>
      <div>
        <ul class="p-terms">
          
          <li><a href="https://techblog.szksh.cloud/tags/terraform/">terraform</a></li>
          
        </ul>
      </div>
    </section>
    
  </header>

  

  <div class="article-body"><p>Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、
では手頃な題材はあるかと言われると少し難しいです。</p>
<p><a href="https://learn.hashicorp.com/terraform/getting-started/build">公式の Getting Started では AWS が使われています</a>が、
AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。
もう少し手軽なものが欲しいところです。</p>
<p>そこで公式の Provider で丁度いいものはないか探したところ、 <a href="https://www.terraform.io/docs/providers/mysql/">MySQL Provider</a> が良さそうでした。
MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。</p>
<p>ちなみに公式の Provider のリストはこちらです。</p>
<ul>
<li><a href="https://github.com/terraform-providers">https://github.com/terraform-providers</a></li>
<li><a href="https://www.terraform.io/docs/providers/index.html">https://www.terraform.io/docs/providers/index.html</a></li>
</ul>
<p>また、 Terraform に関しては <a href="https://techblog.szksh.cloud/terraform-getting-started/">Terraform 入門</a> も参照してください。</p>
<p>今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。</p>
<p>以降、コマンドの実行結果は一部省略することがあります。</p>
<pre tabindex="0"><code>$ mkdir workspace
$ cd workspace
</code></pre><h2 id="terraform-のバージョンと-tfenv">Terraform のバージョンと tfenv</h2>
<p>Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で <code>terraform plan</code> などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。
そういう意味では、 <a href="https://github.com/tfutils/tfenv">tfenv</a> によってバージョン管理するのが良いです。</p>
<p><code>.terraform-version</code> を作成します。</p>
<pre tabindex="0"><code>$ echo 0.12.19 &gt; .terraform-version
$ tfenv install
$ terraform version
Terraform v0.12.19
</code></pre><h2 id="mysql-を-docker-で動かす">MySQL を Docker で動かす</h2>
<p>では MySQL を Docker で動かします。</p>
<p><a href="https://hub.docker.com/_/mysql?tab=description">https://hub.docker.com/_/mysql?tab=description</a></p>
<h3 id="docker-compose-使う場合">Docker Compose 使う場合</h3>
<p>docker-compose.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">mysql</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mysql:5.7.28</span>
    <span style="color:#f92672">ports</span>:
    - <span style="color:#e6db74">&#34;23306:3306&#34;</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">MYSQL_ROOT_PASSWORD</span>: <span style="color:#ae81ff">password</span>
</code></pre></div><pre tabindex="0"><code>$ docker-compose up -d
$ docker-compose ps  # コンテナが起動しているか確認
</code></pre><p>不要になったら削除しましょう。</p>
<pre tabindex="0"><code>$ docker-compose rm -sf mysql
</code></pre><p>これから Terraform で MySQL の Database を作成します。
作成されているか確認するために MySQL に接続しておきます。</p>
<pre tabindex="0"><code>$ docker-compose exec mysql mysql -u root -p -P 23306
mysql&gt; show databases;  # database の一覧を確認
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)
</code></pre><h3 id="docker-compose-を使わない場合">Docker Compose を使わない場合</h3>
<p>基本的に Docker Compose 使う場合と変わりません。</p>
<pre tabindex="0"><code>$ docker run --name terraform-mysql -p &quot;23306:3306&quot; -e MYSQL_ROOT_PASSWORD=password -d mysql:5.7.28
$ docker exec -ti terraform-mysql mysql -u root -p -P 23306
$ docker rm -vf terraform-mysql
</code></pre><h2 id="リソースの作成">リソースの作成</h2>
<p>次のような設定ファイルを用意します。</p>
<p>main.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;mysql&#34;</span> {
  endpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost:23306&#34;</span>
  username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;root&#34;</span>
  password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;password&#34;</span>
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
}
</code></pre></div><p>設定できる属性やその意味などはドキュメントを確認してください。</p>
<p><a href="https://www.terraform.io/docs/providers/mysql/r/database.html">https://www.terraform.io/docs/providers/mysql/r/database.html</a></p>
<p>MySQL Provider の設定として MySQL に接続するための情報と、Terraform によって作成するデータベース <code>foo</code> の設定が定義されています。
password が平文で書かれているのが気になるかもしれませんが、一旦スルーしてください。</p>
<p>この状態で <code>terraform plan</code> を実行してみます。 <code>terraform plan</code> は <code>terraform apply</code> によるリソースの作成を DRY RUN するコマンドです。</p>
<pre tabindex="0"><code>$ terraform plan

Error: Could not satisfy plugin requirements


Plugin reinitialization required. Please run &quot;terraform init&quot;.

Plugins are external binaries that Terraform uses to access and manipulate
resources. The configuration provided requires plugins which can't be located,
don't satisfy the version constraints, or are otherwise incompatible.

Terraform automatically discovers provider requirements from your
configuration, including providers used in child modules. To see the
requirements and constraints from each module, run &quot;terraform providers&quot;.



Error: provider.mysql: no suitable version installed
  version requirements: &quot;(any version)&quot;
  versions installed: none
</code></pre><p>失敗しました。</p>
<blockquote>
<p>Plugin reinitialization required. Please run &ldquo;terraform init&rdquo;.</p>
</blockquote>
<p>とある通り、 <code>terraform plan</code> や <code>apply</code> などのコマンドを実行する前に <code>terraform init</code> を実行する必要があります。</p>
<pre tabindex="0"><code>$ terraform init

Initializing the backend...

Initializing provider plugins...
- Checking for available provider plugins...
- Downloading plugin for provider &quot;mysql&quot; (terraform-providers/mysql) 1.9.0...
^C
The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, it is recommended to add version = &quot;...&quot; constraints to the
corresponding provider blocks in configuration, with the constraint strings
suggested below.

* provider.mysql: version = &quot;~&gt; 1.9&quot;

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
</code></pre><p>Provider のダウンロードが行われています。
<code>terraform init</code> を実行すると <code>.terraform</code> というディレクトリが作成されます。</p>
<pre tabindex="0"><code>$ ls -A
.terraform  .terraform-version  main.tf
</code></pre><p><code>terraform init</code> は何度でも安全に実行できます。
<code>.terraform</code> を削除した場合でももう一度 <code>terraform init</code> を実行すれば問題ありません。</p>
<p>次に <code>terraform plan</code> を実行します。</p>
<pre tabindex="0"><code>$ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.


------------------------------------------------------------------------

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # mysql_database.foo will be created
  + resource &quot;mysql_database&quot; &quot;foo&quot; {
      + default_character_set = &quot;utf8&quot;
      + default_collation     = &quot;utf8_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;foo&quot;
    }

Plan: 1 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an &quot;-out&quot; parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
&quot;terraform apply&quot; is subsequently run.
</code></pre><blockquote>
<p>Plan: 1 to add, 0 to change, 0 to destroy.</p>
</blockquote>
<p>とある通り、リソースが 1 つ作成されるようです。 DRY RUN なのでまだ作成されてません。</p>
<p>では実際に作成してみましょう。</p>
<pre tabindex="0"><code>$ terraform apply
An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # mysql_database.foo will be created
  + resource &quot;mysql_database&quot; &quot;foo&quot; {
      + default_character_set = &quot;utf8&quot;
      + default_collation     = &quot;utf8_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;foo&quot;
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

mysql_database.foo: Creating...
mysql_database.foo: Creation complete after 0s [id=foo]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
</code></pre><p>途中確認があるので <code>yes</code> と入力すると実際に変更が適用されます。</p>
<p>本当に Database が作られているか確認します。
MySQL クエリを叩きます。</p>
<pre tabindex="0"><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| foo                |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.01 sec)

mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME='foo';
+--------------+-------------+----------------------------+------------------------+----------+
| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |
+--------------+-------------+----------------------------+------------------------+----------+
| def          | foo         | utf8                       | utf8_general_ci        | NULL     |
+--------------+-------------+----------------------------+------------------------+----------+
1 row in set (0.00 sec)
</code></pre><p>ありました。</p>
<p>すると <code>terraform.tfstate</code> というファイルが作られているはずです。</p>
<pre tabindex="0"><code>$ ls
docker-compose.yml main.tf  terraform.tfstate
</code></pre><p>こんな JSON ファイルになります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">4</span>,
  <span style="color:#f92672">&#34;terraform_version&#34;</span>: <span style="color:#e6db74">&#34;0.12.19&#34;</span>,
  <span style="color:#f92672">&#34;serial&#34;</span>: <span style="color:#ae81ff">1</span>,
  <span style="color:#f92672">&#34;lineage&#34;</span>: <span style="color:#e6db74">&#34;7011a551-bfa1-96a5-4153-2c9d6f32251c&#34;</span>,
  <span style="color:#f92672">&#34;outputs&#34;</span>: {},
  <span style="color:#f92672">&#34;resources&#34;</span>: [
    {
      <span style="color:#f92672">&#34;mode&#34;</span>: <span style="color:#e6db74">&#34;managed&#34;</span>,
      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;mysql_database&#34;</span>,
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
      <span style="color:#f92672">&#34;provider&#34;</span>: <span style="color:#e6db74">&#34;provider.mysql&#34;</span>,
      <span style="color:#f92672">&#34;instances&#34;</span>: [
        {
          <span style="color:#f92672">&#34;schema_version&#34;</span>: <span style="color:#ae81ff">0</span>,
          <span style="color:#f92672">&#34;attributes&#34;</span>: {
            <span style="color:#f92672">&#34;default_character_set&#34;</span>: <span style="color:#e6db74">&#34;utf8&#34;</span>,
            <span style="color:#f92672">&#34;default_collation&#34;</span>: <span style="color:#e6db74">&#34;utf8_general_ci&#34;</span>,
            <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>
          },
          <span style="color:#f92672">&#34;private&#34;</span>: <span style="color:#e6db74">&#34;bnVsbA==&#34;</span>
        }
      ]
    }
  ]
}
</code></pre></div><p>管理されているリソースの情報と、 Terraform のバージョンなどのメタ情報が保存されています。
このファイルは基本的に terraform によって更新されるものであり、人間が手で修正するものではありません。</p>
<h2 id="古い-terraform-を使ってみる">古い Terraform を使ってみる</h2>
<p>ここであえて古いバージョンの Terraform を使って <code>terraform plan</code> を実行してみます。</p>
<pre tabindex="0"><code>$ echo 0.12.12 &gt; .terraform-version
$ tfenv install
$ terraform version
$ terraform plan
Error: Error locking state: Error acquiring the state lock: state snapshot was created by Terraform v0.12.19, which is newer than current v0.12.12; upgrade to Terraform v0.12.19 or greater to work with this state

Terraform acquires a state lock to protect the state from being written
by multiple users at the same time. Please resolve the issue above and try
again. For most commands, you can disable locking with the &quot;-lock=false&quot;
flag, but this is not recommended.
</code></pre><p>失敗しました。 State の lock に失敗したようです。 State の lock については <a href="https://techblog.szksh.cloud/terraform-state-locking/">https://techblog.szksh.cloud/terraform-state-locking/</a> も参照してください。</p>
<p>このように古いバージョンの terraform は使えません。
一方新しいバージョンを使うには問題なく使えますが、 State の <code>terraform_version</code> が更新され、それまでのバージョンを使ってた人が突然 <code>terraform plan</code> などができなくなりますので、注意が必要です。</p>
<p>これが前述した意味になります。</p>
<blockquote>
<p>Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で <code>terraform plan</code> などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。</p>
</blockquote>
<p>では元のバージョンに戻しましょう。</p>
<pre tabindex="0"><code>$ echo 0.12.19 &gt; .terraform-version
$ terraform version
$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><h2 id="リソースの更新">リソースの更新</h2>
<p>同じ調子でもう一つ Database を作ってみましょう。
Database foo の設定をコピーして <code>terraform plan</code> を実行します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan

Error: Duplicate resource &quot;mysql_database&quot; configuration

  on main.tf line 11:
  11: resource &quot;mysql_database&quot; &quot;foo&quot; {

A mysql_database resource named &quot;foo&quot; was already declared at main.tf:7,1-32.
Resource names must be unique per type in each module.
</code></pre><p>失敗しました。エラーメッセージの通り、リソースパスはユニークでないといけません。
修正しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;bar&#34; { # &#34;foo&#34; を &#34;bar&#34;</span> <span style="color:#66d9ef">に変更</span>
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.bar will be created
  + resource &quot;mysql_database&quot; &quot;bar&quot; {
      + default_character_set = &quot;utf8&quot;
      + default_collation     = &quot;utf8_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;foo&quot;
    }

Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre><p>作成されるようです。 apply してみましょう。</p>
<pre tabindex="0"><code>$ terraform apply
mysql_database.bar: Creating...

Error: Error 1007: Can't create database 'foo'; database exists

  on main.tf line 11, in resource &quot;mysql_database&quot; &quot;bar&quot;:
  11: resource &quot;mysql_database&quot; &quot;bar&quot; {
</code></pre><p>失敗しました。同じ名前のデータベースは作成できないので当然です。
このように plan に成功しても apply に失敗することはあります。</p>
<p>では name を修正しましょう。ついでに database foo の default character set を修正します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span><span style="color:#75715e"> # default character set を修正。デフォルトは utf8
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;bar&#34;</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bar&#34;</span><span style="color:#75715e"> # 名前を foo から bar に変更
</span><span style="color:#75715e"></span>}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.bar will be created
  + resource &quot;mysql_database&quot; &quot;bar&quot; {
      + default_character_set = &quot;utf8&quot;
      + default_collation     = &quot;utf8_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;bar&quot;
    }

  # mysql_database.foo will be updated in-place
  ~ resource &quot;mysql_database&quot; &quot;foo&quot; {
      ~ default_character_set = &quot;utf8&quot; -&gt; &quot;utf8mb4&quot;
        default_collation     = &quot;utf8_general_ci&quot;
        id                    = &quot;foo&quot;
        name                  = &quot;foo&quot;
    }

Plan: 1 to add, 1 to change, 0 to destroy.
</code></pre><pre tabindex="0"><code>$ terraform apply
mysql_database.bar: Creating...
mysql_database.foo: Modifying... [id=foo]
mysql_database.bar: Creation complete after 0s [id=bar]

Error: Error 1253: COLLATION 'utf8_general_ci' is not valid for CHARACTER SET 'utf8mb4'

  on main.tf line 7, in resource &quot;mysql_database&quot; &quot;foo&quot;:
   7: resource &quot;mysql_database&quot; &quot;foo&quot; {
</code></pre><p>mysql_database.foo の変更に失敗しました。一方 mysql_database.bar の作成には成功しています。</p>
<pre tabindex="0"><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| bar                |
| foo                |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
6 rows in set (0.00 sec)

mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME='foo';
+--------------+-------------+----------------------------+------------------------+----------+
| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |
+--------------+-------------+----------------------------+------------------------+----------+
| def          | foo         | utf8                       | utf8_general_ci        | NULL     |
+--------------+-------------+----------------------------+------------------------+----------+
1 row in set (0.00 sec)
</code></pre><p>このように、一部の変更の適用に失敗にしても、その他の変更は適用されるという、ある意味中途半端に apply される場合があります。こういった場合に rollback するようなコマンドはないので気をつけましょう。適用された変更はちゃんと State に反映されています。</p>
<p>では mysql_database.foo の変更に失敗したので、適切に設定を変更しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span><span style="color:#75715e"> # utf8_general_ci から変更
</span><span style="color:#75715e"></span>}
</code></pre></div><p>apply に <code>--auto-approve</code> というオプションをつけると確認なしに適用されます。CIで実行する場合には基本これをつけることになると思います。</p>
<pre tabindex="0"><code>$ terraform apply --auto-approve
mysql_database.foo: Refreshing state... [id=foo]
mysql_database.bar: Refreshing state... [id=bar]
mysql_database.foo: Modifying... [id=foo]
mysql_database.foo: Modifications complete after 0s [id=foo]

Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
</code></pre><p>変更できました。</p>
<pre tabindex="0"><code>mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME='foo';
+--------------+-------------+----------------------------+------------------------+----------+
| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |
+--------------+-------------+----------------------------+------------------------+----------+
| def          | foo         | utf8mb4                    | utf8mb4_general_ci     | NULL     |
+--------------+-------------+----------------------------+------------------------+----------+
1 row in set (0.00 sec)
</code></pre><h2 id="terraformtfstatebackup">terraform.tfstate.backup</h2>
<p>ところで <code>terraform.tfstate.backup</code> というファイルが作られています。</p>
<pre tabindex="0"><code>$ ls
docker-compose.yml main.tf  terraform.tfstate  terraform.state.backup
</code></pre><p>これは名前の通り <code>terraform.tfstate</code> のバックアップです。
<code>terraform.tfstate</code> が terraform のコマンドによって更新される前に自動的にバックアップが作成されます。</p>
<h2 id="リソースの-recreate">リソースの recreate</h2>
<p>今度は database の名前を変更してみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo2&#34;</span><span style="color:#75715e"> # foo から変更
</span><span style="color:#75715e"></span>  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.foo must be replaced
-/+ resource &quot;mysql_database&quot; &quot;foo&quot; {
        default_character_set = &quot;utf8mb4&quot;
        default_collation     = &quot;utf8mb4_general_ci&quot;
      ~ id                    = &quot;foo&quot; -&gt; (known after apply)
      ~ name                  = &quot;foo&quot; -&gt; &quot;foo2&quot; # forces replacement
    }

Plan: 1 to add, 0 to change, 1 to destroy.
</code></pre><p>先程 default_collation と default_character_set を変更した際は既存のデータベースが更新されましたが、今度は新しく作り直されるようです。
これはリソースの定義に依存します。ソースコードを確認しましょう。</p>
<p><a href="https://github.com/terraform-providers/terraform-provider-mysql/blob/v1.9.0/mysql/resource_database.go#L31">https://github.com/terraform-providers/terraform-provider-mysql/blob/v1.9.0/mysql/resource_database.go#L31</a></p>
<p>属性の定義で <code>ForceNew: true</code> となっている場合、その属性が変更されるとリソースが作り直されます。デフォルトだと既存のリソースの更新になります。
新しく作り直されるということは、テーブルなどは消えるはずです。試しにテーブルを作っておいて、 apply してみましょう。</p>
<pre tabindex="0"><code>mysql&gt; show tables from foo;
Empty set (0.00 sec)

mysql&gt; create table foo.zoo (id int);
Query OK, 0 rows affected (0.03 sec)

mysql&gt; show tables from foo;
+---------------+
| Tables_in_foo |
+---------------+
| zoo           |
+---------------+
1 row in set (0.00 sec)
</code></pre><pre tabindex="0"><code>$ terraform apply --auto-approve
mysql_database.foo: Refreshing state... [id=foo]
mysql_database.bar: Refreshing state... [id=bar]
mysql_database.foo: Destroying... [id=foo]
mysql_database.foo: Destruction complete after 0s
mysql_database.foo: Creating...
mysql_database.foo: Creation complete after 0s [id=foo2]

Apply complete! Resources: 1 added, 0 changed, 1 destroyed.
</code></pre><blockquote>
<p>mysql_database.foo: Destroying&hellip; [id=foo]</p>
</blockquote>
<p>とあるように一度削除されています。</p>
<pre tabindex="0"><code>mysql&gt; show tables from foo;
ERROR 1049 (42000): Unknown database 'foo'
mysql&gt; show tables from foo2;
Empty set (0.00 sec)
</code></pre><p>新しいデータベースには先程作成したテーブルがありません。このように recreate は危険な操作なのでやるときには注意を払いましょう。</p>
<h2 id="変数の利用">変数の利用</h2>
<p>変数を使ってみましょう。設定を修正します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo2&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">default_character_set</span><span style="color:#75715e">  # 変数 default_character_set を参照
</span><span style="color:#75715e"></span>  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan

Error: Reference to undeclared input variable

  on main.tf line 9, in resource &quot;mysql_database&quot; &quot;foo&quot;:
   9:   default_character_set = var.default_character_set

An input variable with the name &quot;default_character_set&quot; has not been declared.
This variable can be declared with a variable &quot;default_character_set&quot; {}
block.
</code></pre><p>エラーになりました。変数を利用するには宣言が必要です。
<code>variables.tf</code> というファイルを作成しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;default_character_set&#34;</span> {
  type <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
var.default_character_set
  Enter a value:
</code></pre><p>値の入力を求められました。これは変数の値が設定されていないからです。
ここでは <code>foo</code> と入力してみます。</p>
<pre tabindex="0"><code>$ terraform plan
var.default_character_set
  Enter a value: foo

Terraform will perform the following actions:

  # mysql_database.foo will be updated in-place
  ~ resource &quot;mysql_database&quot; &quot;foo&quot; {
      ~ default_character_set = &quot;utf8mb4&quot; -&gt; &quot;foo&quot;
        default_collation     = &quot;utf8mb4_general_ci&quot;
        id                    = &quot;foo2&quot;
        name                  = &quot;foo2&quot;
    }

Plan: 0 to add, 1 to change, 0 to destroy.
</code></pre><p><code>-input=false</code> にすると入力を求められずにエラーを返します。</p>
<pre tabindex="0"><code>$ terraform plan -input=false

Error: No value for required variable

  on variables.tf line 1:
   1: variable &quot;default_character_set&quot; {

The root module input variable &quot;default_character_set&quot; is not set, and has no
default value. Use a -var or -var-file command line argument to provide a
value for this variable.
</code></pre><p><code>terraform.tfvars</code> というファイルを作成し、値を設定しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl">default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span>
</code></pre></div><pre tabindex="0"><code>$ terraform plan

No changes. Infrastructure is up-to-date.
</code></pre><p><code>terraform.tfvars</code> は特別なファイル名で、カレントディレクトリにこのファイルがあると自動で読み込まれます。</p>
<p>ファイル名を変えて terraform plan をしてみましょう。</p>
<pre tabindex="0"><code>$ mv terraform.tfvars main.tfvars
$ terraform plan
var.default_character_set
  Enter a value:
</code></pre><p>聞かれました。 main.tfvars が読み込まれていません。 <code>-var-file</code> オプションでファイルを指定すれば main.tfvars を読み込めます。</p>
<pre tabindex="0"><code>$ terraform plan -var-file=main.tfvars
</code></pre><p>もとに戻しておきます。</p>
<pre tabindex="0"><code>$ mv main.tfvars terraform.tfvars
</code></pre><h2 id="他のリソースの属性の参照">他のリソースの属性の参照</h2>
<p>設定を修正します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo2&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">default_character_set</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;bar&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#66d9ef">mysql_database</span>.<span style="color:#66d9ef">foo</span>.<span style="color:#66d9ef">default_character_set</span><span style="color:#75715e">  # 他のリソースの属性を参照
</span><span style="color:#75715e"></span>  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span><span style="color:#75715e">  # default_character_set に合わせて変更
</span><span style="color:#75715e"></span>}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.bar will be updated in-place
  ~ resource &quot;mysql_database&quot; &quot;bar&quot; {
      ~ default_character_set = &quot;utf8&quot; -&gt; &quot;utf8mb4&quot;
      ~ default_collation     = &quot;utf8_general_ci&quot; -&gt; &quot;utf8mb4_general_ci&quot;
        id                    = &quot;bar&quot;
        name                  = &quot;bar&quot;
    }

Plan: 0 to add, 1 to change, 0 to destroy.
</code></pre><pre tabindex="0"><code>$ terraform apply --auto-approve
mysql_database.foo: Refreshing state... [id=foo2]
mysql_database.bar: Refreshing state... [id=bar]
mysql_database.bar: Modifying... [id=bar]
mysql_database.bar: Modifications complete after 0s [id=bar]

Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
</code></pre><h2 id="terraform-state-rm">terraform state rm</h2>
<p><a href="https://www.terraform.io/docs/commands/state/rm.html">https://www.terraform.io/docs/commands/state/rm.html</a></p>
<p>Terraform は State によって設定ファイル中のリソースと実際のリソースをマッピングしています。
State からリソースを削除して <code>terraform plan</code> を実行してみると、 Terraform はそのリソースを新規で作成しようとします。</p>
<pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.

$ terraform state rm mysql_database.bar
Removed mysql_database.bar
Successfully removed 1 resource instance(s).

$ terraform plan
Terraform will perform the following actions:

  # mysql_database.bar will be created
  + resource &quot;mysql_database&quot; &quot;bar&quot; {
      + default_character_set = &quot;utf8mb4&quot;
      + default_collation     = &quot;utf8mb4_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;bar&quot;
    }

Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre><p>実際には同じ名前のデータベースは作成できないので <code>apply</code> で失敗するはずです。
<code>terraform state rm</code> は元々 Terraform で管理していたものを Terraform で管理するのを止めたり、あるいは手動で削除してしまったリソースを State からも削除するのに使えます。</p>
<h2 id="terraform-import">terraform import</h2>
<p><a href="https://www.terraform.io/docs/import/index.html">https://www.terraform.io/docs/import/index.html</a>
<a href="https://www.terraform.io/docs/commands/import.html">https://www.terraform.io/docs/commands/import.html</a></p>
<p><code>terraform import</code> は Terraform で管理されていないリソースを Terraform で管理するために State にリソースのデータを取り込むコマンドです。
ちょうど <code>mysql_database.bar</code> を State から消してしまったので、 import することにしましょう。</p>
<p><a href="https://www.terraform.io/docs/providers/mysql/r/database.html#import">https://www.terraform.io/docs/providers/mysql/r/database.html#import</a> にある通り、データベースはデータベース名を指定すれば import 出来ます。</p>
<pre tabindex="0"><code>$ terraform import mysql_database.bar bar
mysql_database.bar: Importing from ID &quot;bar&quot;...
mysql_database.bar: Import prepared!
  Prepared mysql_database for import
mysql_database.bar: Refreshing state... [id=bar]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
</code></pre><p>import 出来ました。 <code>terraform plan</code> を実行して差分がなくなっていることを確認します。</p>
<pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><p>次に手動で Database を作成してそれを import してみましょう。</p>
<pre tabindex="0"><code>mysql&gt; create database zoo;
Query OK, 1 row affected (0.00 sec)
</code></pre><pre tabindex="0"><code>$ terraform import mysql_database.zoo zoo
Error: resource address &quot;mysql_database.zoo&quot; does not exist in the configuration.

Before importing this resource, please create its configuration in the root module. For example:

resource &quot;mysql_database&quot; &quot;zoo&quot; {
  # (resource arguments)
}
</code></pre><p>失敗しました。 <code>mysql_database.zoo</code> が存在しないからです。
空で良いのでリソースの設定を追加しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;zoo&#34;</span> {
}
</code></pre></div><pre tabindex="0"><code>$ terraform import mysql_database.zoo zoo
mysql_database.zoo: Importing from ID &quot;zoo&quot;...
mysql_database.zoo: Import prepared!
  Prepared mysql_database for import
mysql_database.zoo: Refreshing state... [id=zoo]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
</code></pre><p>import 出来たので zoo を Terraform で管理できるようになりました。
<code>terraform plan</code> を実行してみます。</p>
<pre tabindex="0"><code>$ terraform plan

Error: Missing required argument

  on main.tf line 19, in resource &quot;mysql_database&quot; &quot;zoo&quot;:
  19: resource &quot;mysql_database&quot; &quot;zoo&quot; {

The argument &quot;name&quot; is required, but no definition was found.
</code></pre><p>zoo の設定が空で name が設定されていないので失敗しました。
修正します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;zoo&#34;</span> {
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zoo&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.zoo will be updated in-place
  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {
      ~ default_character_set = &quot;latin1&quot; -&gt; &quot;utf8&quot;
      ~ default_collation     = &quot;latin1_swedish_ci&quot; -&gt; &quot;utf8_general_ci&quot;
        id                    = &quot;zoo&quot;
        name                  = &quot;zoo&quot;
    }

Plan: 0 to add, 1 to change, 0 to destroy.
</code></pre><p>まだ差分が出てしまいました。</p>
<p>import は State にはリソースのデータを反映してくれますが、設定ファイルには反映してくれないので自分で反映させる必要があります。
一部の Provider では、設定ファイルに自動で反映させるためのサードパーティのツールもあります。</p>
<p>修正します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;zoo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zoo&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;latin1&#34;</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;latin1_swedish_ci&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><p>無事差分がなくなりました。</p>
<h2 id="リソースの削除">リソースの削除</h2>
<p>次にリソースを削除してみます。</p>
<p><code>terraform destroy</code> もありますが、今回は設定をコメントアウトします。
ちなみに Terraform の設定ファイルの記述言語である HCL ではコメントアウトは <code>#</code> でも <code>//</code> でもどちらでも良いです。</p>
<p><a href="https://github.com/hashicorp/hcl#syntax">https://github.com/hashicorp/hcl#syntax</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#75715e"># resource &#34;mysql_database&#34; &#34;bar&#34; {
</span><span style="color:#75715e">#   name                  = &#34;bar&#34;
</span><span style="color:#75715e">#   default_character_set = mysql_database.foo.default_character_set
</span><span style="color:#75715e">#   default_collation     = &#34;utf8mb4_general_ci&#34;
</span><span style="color:#75715e"># }
</span></code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.bar will be destroyed
  - resource &quot;mysql_database&quot; &quot;bar&quot; {
      - default_character_set = &quot;utf8mb4&quot; -&gt; null
      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null
      - id                    = &quot;bar&quot; -&gt; null
      - name                  = &quot;bar&quot; -&gt; null
    }

Plan: 0 to add, 0 to change, 1 to destroy.
</code></pre><pre tabindex="0"><code>$ terraform apply --auto-approve
mysql_database.foo: Refreshing state... [id=foo2]
mysql_database.bar: Refreshing state... [id=bar]
mysql_database.bar: Destroying... [id=bar]
mysql_database.bar: Destruction complete after 0s

Apply complete! Resources: 0 added, 0 changed, 1 destroyed.
</code></pre><pre tabindex="0"><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| foo2               |
| mysql              |
| performance_schema |
| sys                |
| zoo                |
+--------------------+
6 rows in set (0.00 sec)
</code></pre><p>確かに削除されています。</p>
<h2 id="terraform-state-mv">terraform state mv</h2>
<p><a href="https://www.terraform.io/docs/commands/state/mv.html">https://www.terraform.io/docs/commands/state/mv.html</a></p>
<p>ここで リソースの名前を変えて <code>terraform plan</code> してみましょう。名前を変えたくなることはまぁあると思います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;foo2&#34;</span> {<span style="color:#75715e"> # foo から foo2 に変更
</span><span style="color:#75715e"></span>  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo2&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">default_character_set</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.foo will be destroyed
  - resource &quot;mysql_database&quot; &quot;foo&quot; {
      - default_character_set = &quot;utf8mb4&quot; -&gt; null
      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null
      - id                    = &quot;foo2&quot; -&gt; null
      - name                  = &quot;foo2&quot; -&gt; null
    }

  # mysql_database.foo2 will be created
  + resource &quot;mysql_database&quot; &quot;foo2&quot; {
      + default_character_set = &quot;utf8mb4&quot;
      + default_collation     = &quot;utf8mb4_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;foo2&quot;
    }

Plan: 1 to add, 0 to change, 1 to destroy.
</code></pre><p>既存のデータベースが削除されて新しいデータベースが作成されてしまいそうです。
State に記録されているリソースのパスを修正する必要があります。</p>
<pre tabindex="0"><code>$ terraform state mv mysql_database.foo mysql_database.foo2
Move &quot;mysql_database.foo&quot; to &quot;mysql_database.foo2&quot;
Successfully moved 1 object(s).
</code></pre><pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><p>差分がなくなりました。</p>
<p>このようにコマンドによって State を更新する必要があるので、特に複数人で作業する場合は安易にリソースパスを変更するべきではありません。</p>
<h2 id="terraform-refresh">terraform refresh</h2>
<p><a href="https://www.terraform.io/docs/commands/refresh.html">https://www.terraform.io/docs/commands/refresh.html</a></p>
<p><code>terraform refresh</code> は実際のインフラの情報を取得して State に反映させるコマンドです。
Terraform を使わずに加えた変更を State に反映させるのに使えます。
Terraform を使ってインフラを管理している以上、 Terraform を使わずにインフラを変更するのは望ましくないですが、実際のところはよくある話かと思います。</p>
<p>Terraform を使わずに default_character_set を変更してみましょう。</p>
<pre tabindex="0"><code>mysql&gt; ALTER DATABASE zoo DEFAULT CHARACTER SET utf8mb4;
Query OK, 1 row affected (0.01 sec)

mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME='zoo';
+--------------+-------------+----------------------------+------------------------+----------+
| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |
+--------------+-------------+----------------------------+------------------------+----------+
| def          | zoo         | utf8mb4                    | utf8mb4_general_ci     | NULL     |
+--------------+-------------+----------------------------+------------------------+----------+
1 row in set (0.00 sec)
</code></pre><p>default_character_set を変えると自動で DEFAULT_COLLATION_NAME も変わりました。
設定ファイルにも変更を反映させましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;zoo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zoo&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><p><code>-refresh=false</code> をつけて terraform plan を実行してみます。</p>
<pre tabindex="0"><code>$ terraform plan -refresh=false
Terraform will perform the following actions:

  # mysql_database.zoo will be updated in-place
  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {
      ~ default_character_set = &quot;latin1&quot; -&gt; &quot;utf8mb4&quot;
      ~ default_collation     = &quot;latin1_swedish_ci&quot; -&gt; &quot;utf8mb4_general_ci&quot;
        id                    = &quot;zoo&quot;
        name                  = &quot;zoo&quot;
    }

Plan: 0 to add, 1 to change, 0 to destroy.

Warning: Resource targeting is in effect

You are creating a plan with the -target option, which means that the result
of this plan may not represent all of the changes requested by the current
configuration.

The -target option is not for routine use, and is provided only for
exceptional situations such as recovering from errors or mistakes, or when
Terraform specifically suggests to use it as part of an error message.
</code></pre><p>差分が出てしまいました。これは State が更新されていないからです。
terraform.tfstate を確認してみましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">    {
      <span style="color:#f92672">&#34;mode&#34;</span>: <span style="color:#e6db74">&#34;managed&#34;</span>,
      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;mysql_database&#34;</span>,
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;zoo&#34;</span>,
      <span style="color:#f92672">&#34;provider&#34;</span>: <span style="color:#e6db74">&#34;provider.mysql&#34;</span>,
      <span style="color:#f92672">&#34;instances&#34;</span>: [
        {
          <span style="color:#f92672">&#34;schema_version&#34;</span>: <span style="color:#ae81ff">0</span>,
          <span style="color:#f92672">&#34;attributes&#34;</span>: {
            <span style="color:#f92672">&#34;default_character_set&#34;</span>: <span style="color:#e6db74">&#34;latin1&#34;</span>,
            <span style="color:#f92672">&#34;default_collation&#34;</span>: <span style="color:#e6db74">&#34;latin1_swedish_ci&#34;</span>,
            <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;zoo&#34;</span>,
            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;zoo&#34;</span>
          },
          <span style="color:#f92672">&#34;private&#34;</span>: <span style="color:#e6db74">&#34;eyJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&#34;</span>
        }
      ]
    }
</code></pre></div><p><code>-refresh=false</code> を取ると今度は差分がなくなるはずです。</p>
<pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><p>これは、実は terraform plan はデフォルトでは State の内容と設定ファイルを比較する前に実際のインフラの情報を取得し State の内容をインメモリで更新した上で設定ファイルと比較しているからです。
ただし、インメモリでの更新であり、実際の State が更新されているわけではないです。</p>
<p>今までスルーしてきましたが、そのことは terraform plan の結果でも説明されています。</p>
<pre tabindex="0"><code>$ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.
</code></pre><p>ではなんで <code>-refresh=false</code> が必要になるかというと、理由の一つとして <code>terraform plan</code> が速くなることが挙げられます。
むしろ <code>-refresh=false</code> をつけないと、管理するリソースの数が増えれば増えるほど情報を取得してくるのに時間がかかるようになりますし、
場合によっては API の rate limit に引っかかるなんてこともあるかもしれません。</p>
<p>なので普段 <code>-refresh=false</code> をつけて <code>terraform plan</code> を実行するようにしていると Terraform を使わずに加えたインフラの修正を State に取り込むために <code>terraform refresh</code> を実行する必要が出てきたりします。</p>
<p>State は更新されていないので <code>-refresh=false</code> とすれば相変わらず差分は出ます。</p>
<pre tabindex="0"><code>$ terraform plan -refresh=false
Terraform will perform the following actions:

  # mysql_database.zoo will be updated in-place
  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {
      ~ default_character_set = &quot;utf8mb4&quot; -&gt; &quot;latin1&quot;
      ~ default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; &quot;latin1_swedish_ci&quot;
        id                    = &quot;zoo&quot;
        name                  = &quot;zoo&quot;
    }

Plan: 0 to add, 1 to change, 0 to destroy.
</code></pre><p>差分が出ました。 <code>terraform refresh</code> を実行すると State が更新され、差分がなくなるはずです。</p>
<pre tabindex="0"><code>$ terraform refresh
module.app.mysql_database.db: Refreshing state... [id=app]
mysql_database.foo2: Refreshing state... [id=foo2]
mysql_database.zoo: Refreshing state... [id=zoo]
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">    {
      <span style="color:#f92672">&#34;mode&#34;</span>: <span style="color:#e6db74">&#34;managed&#34;</span>,
      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;mysql_database&#34;</span>,
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;zoo&#34;</span>,
      <span style="color:#f92672">&#34;provider&#34;</span>: <span style="color:#e6db74">&#34;provider.mysql&#34;</span>,
      <span style="color:#f92672">&#34;instances&#34;</span>: [
        {
          <span style="color:#f92672">&#34;schema_version&#34;</span>: <span style="color:#ae81ff">0</span>,
          <span style="color:#f92672">&#34;attributes&#34;</span>: {
            <span style="color:#f92672">&#34;default_character_set&#34;</span>: <span style="color:#e6db74">&#34;utf8mb4&#34;</span>,
            <span style="color:#f92672">&#34;default_collation&#34;</span>: <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>,
            <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;zoo&#34;</span>,
            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;zoo&#34;</span>
          },
          <span style="color:#f92672">&#34;private&#34;</span>: <span style="color:#e6db74">&#34;eyJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&#34;</span>
        }
      ]
    }
</code></pre></div><pre tabindex="0"><code>$ terraform plan -refresh=false
No changes. Infrastructure is up-to-date.
</code></pre><h2 id="module">Module</h2>
<p><a href="https://www.terraform.io/docs/configuration/modules.html">https://www.terraform.io/docs/configuration/modules.html</a></p>
<p>簡単なモジュールを作ってみましょう。</p>
<pre tabindex="0"><code>$ mkdir database
vi database/database.tf
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;db&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;app&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><p>では Module を使って database を作ってみます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">module</span> <span style="color:#e6db74">&#34;app&#34;</span> {
  source <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./database&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Error: Module not installed

  on main.tf line 25:
  25: module &quot;app&quot; {

This module is not yet installed. Run &quot;terraform init&quot; to install all modules
required by this configuration.
</code></pre><p>失敗しました。 <code>terraform init</code> する必要があります。</p>
<pre tabindex="0"><code>$ terraform init
</code></pre><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # module.app.mysql_database.db will be created
  + resource &quot;mysql_database&quot; &quot;db&quot; {
      + default_character_set = &quot;utf8mb4&quot;
      + default_collation     = &quot;utf8mb4_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;app&quot;
    }

Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre><pre tabindex="0"><code>$ terraform apply --auto-approve
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
</code></pre><h3 id="module-パラメータ">Module パラメータ</h3>
<p>これで Module を使って Database を作れましたが、 name が &ldquo;app&rdquo; 固定なので使いづらいですね。名前を変えられるようにしましょう。</p>
<p>database/database.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;db&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">name</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4&#34;</span>
  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><p>database/variables.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;name&#34;</span> {
  type <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan

Error: Missing required argument

  on main.tf line 25, in module &quot;app&quot;:
  25: module &quot;app&quot; {

The argument &quot;name&quot; is required, but no definition was found.
</code></pre><p>必須パラメータを指定していないので失敗しました。デフォルト値を設定しましょう。</p>
<p><a href="https://www.terraform.io/docs/configuration/variables.html">https://www.terraform.io/docs/configuration/variables.html</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;name&#34;</span> {
  type    <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
  default <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;app&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><p>パラメータを渡して name を変更しましょう。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">module</span> <span style="color:#e6db74">&#34;app&#34;</span> {
  source <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./database&#34;</span>
  name   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;app2&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # module.app.mysql_database.db must be replaced
-/+ resource &quot;mysql_database&quot; &quot;db&quot; {
        default_character_set = &quot;utf8mb4&quot;
        default_collation     = &quot;utf8mb4_general_ci&quot;
      ~ id                    = &quot;app&quot; -&gt; (known after apply)
      ~ name                  = &quot;app&quot; -&gt; &quot;app2&quot; # forces replacement
    }
</code></pre><p>パラメータを渡せました。もとに戻しておきます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">module</span> <span style="color:#e6db74">&#34;app&#34;</span> {
  source <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./database&#34;</span>
  name   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;app&#34;</span>
}
</code></pre></div><h3 id="module-output">Module Output</h3>
<p><a href="https://www.terraform.io/docs/configuration/outputs.html">https://www.terraform.io/docs/configuration/outputs.html</a></p>
<p>mysql_database.bar から mysql_database.foo の属性を参照したように、 <code>module.app</code> で作成したデータベースの属性を参照するにはどうしたらよいでしょうか？
モジュール内であれば普通に参照できますが、モジュールの外から参照するには、 Module 側で明示的に公開する必要があります。不便な側面もあるかもしれませんが、カプセル化とも言えますね。</p>
<p>default_character_set を公開しましょう。</p>
<p>database/output.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">output</span> <span style="color:#e6db74">&#34;default_character_set&#34;</span> {
  value <span style="color:#f92672">=</span> <span style="color:#66d9ef">mysql_database</span>.<span style="color:#66d9ef">db</span>.<span style="color:#66d9ef">default_character_set</span>
}
</code></pre></div><p>そして参照します。</p>
<p>main.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;zoo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zoo&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#66d9ef">module</span>.<span style="color:#66d9ef">app</span>.<span style="color:#66d9ef">default_character_set</span><span style="color:#75715e">  # 参照
</span><span style="color:#75715e"></span>  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><pre tabindex="0"><code>$ terraform plan
No changes. Infrastructure is up-to-date.
</code></pre><h2 id="terraform-destroy">terraform destroy</h2>
<p><a href="https://www.terraform.io/docs/commands/destroy.html">https://www.terraform.io/docs/commands/destroy.html</a></p>
<p>ここまでお疲れさまでした。
ハンズオンの最後にこれまで作ったデータベースを削除してしまいましょう。
<code>-target</code> オプションでリソースパスを指定して特定のリソースだけ削除できます。
<code>-target</code> オプションは複数回指定することで複数のリソースを指定できます。</p>
<pre tabindex="0"><code>$ terraform destroy -target=module.app

Terraform will perform the following actions:

  # mysql_database.zoo will be destroyed
  - resource &quot;mysql_database&quot; &quot;zoo&quot; {
      - default_character_set = &quot;utf8mb4&quot; -&gt; null
      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null
      - id                    = &quot;zoo&quot; -&gt; null
      - name                  = &quot;zoo&quot; -&gt; null
    }

  # module.app.mysql_database.db will be destroyed
  - resource &quot;mysql_database&quot; &quot;db&quot; {
      - default_character_set = &quot;utf8mb4&quot; -&gt; null
      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null
      - id                    = &quot;app&quot; -&gt; null
      - name                  = &quot;app&quot; -&gt; null
    }

Plan: 0 to add, 0 to change, 2 to destroy.

Do you really want to destroy all resources?
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value: yes
</code></pre><p>module.app を消そうとしたら、 mysql_database.zoo も削除されそうになっています。
これは mysql_database.zoo が module.app の属性に依存しているからです。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;mysql_database&#34; &#34;zoo&#34;</span> {
  name                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zoo&#34;</span>
  default_character_set <span style="color:#f92672">=</span> <span style="color:#66d9ef">module</span>.<span style="color:#66d9ef">app</span>.<span style="color:#66d9ef">default_character_set</span><span style="color:#75715e">  # module.app に依存
</span><span style="color:#75715e"></span>  default_collation     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf8mb4_general_ci&#34;</span>
}
</code></pre></div><p><code>-target</code> オプションで <code>mysql_database.zoo</code> を指定すればそれだけ削除されます。</p>
<pre tabindex="0"><code>$ terraform destroy -target=mysql_database.zoo
Terraform will perform the following actions:

  # mysql_database.zoo will be destroyed
  - resource &quot;mysql_database&quot; &quot;zoo&quot; {
      - default_character_set = &quot;utf8mb4&quot; -&gt; null
      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null
      - id                    = &quot;zoo&quot; -&gt; null
      - name                  = &quot;zoo&quot; -&gt; null
    }

Plan: 0 to add, 0 to change, 1 to destroy.

Do you really want to destroy all resources?
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value:
</code></pre><p>確認されるので、 yes と入力して削除します。</p>
<pre tabindex="0"><code>  Enter a value: yes

mysql_database.zoo: Destroying... [id=zoo]
mysql_database.zoo: Destruction complete after 0s

Warning: Applied changes may be incomplete

The plan was created with the -target option in effect, so some changes
requested in the configuration may have been ignored and the output values may
not be fully updated. Run the following command to verify that no other
changes are pending:
    terraform plan

Note that the -target option is not suitable for routine use, and is provided
only for exceptional situations such as recovering from errors or mistakes, or
when Terraform specifically suggests to use it as part of an error message.


Destroy complete! Resources: 1 destroyed.
</code></pre><pre tabindex="0"><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| app                |
| foo2               |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
6 rows in set (0.00 sec)
</code></pre><p>確かに消えています。
設定ファイルからは消えていないので <code>terraform plan</code> を実行すると Create しようとします。</p>
<pre tabindex="0"><code>$ terraform plan
Terraform will perform the following actions:

  # mysql_database.zoo will be created
  + resource &quot;mysql_database&quot; &quot;zoo&quot; {
      + default_character_set = &quot;utf8mb4&quot;
      + default_collation     = &quot;utf8mb4_general_ci&quot;
      + id                    = (known after apply)
      + name                  = &quot;zoo&quot;
    }

Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre><p>リソースパスを指定しないと全てのリソースを削除します。</p>
<pre tabindex="0"><code>$ terraform destroy --auto-approve
module.app.mysql_database.db: Refreshing state... [id=app]
mysql_database.foo2: Refreshing state... [id=foo2]
mysql_database.foo2: Destroying... [id=foo2]
module.app.mysql_database.db: Destroying... [id=app]
module.app.mysql_database.db: Destruction complete after 0s
mysql_database.foo2: Destruction complete after 0s

Destroy complete! Resources: 2 destroyed.
</code></pre><pre tabindex="0"><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)
</code></pre><p>全部消えました。</p>
</div>

  <footer class="article-footer">
    
    
    <section class="bordered">
      <header>
        <div class="panel-title">TAGS</div>
      </header>
      <div>
        <ul class="p-terms">
          
          <li><a href="https://techblog.szksh.cloud/tags/terraform/">terraform</a></li>
          
        </ul>
      </div>
    </section>
    
  </footer>

</article>


    
  </div>

  <div class="col-md-4">
    
<aside class="l-sidebar">

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">LATESTS</div>
    </div>
    <div class="list-group">
      
      <a href="https://techblog.szksh.cloud/what-i-did-2021-11/" class="list-group-item">2021-11 やったこと</a>
      
      <a href="https://techblog.szksh.cloud/update-aqua-v0.7.16/" class="list-group-item">aqua の最近の update (v0.7.4 ~ v0.7.16)</a>
      
      <a href="https://techblog.szksh.cloud/what-i-did-2021-10/" class="list-group-item">2021-10 やったこと</a>
      
      <a href="https://techblog.szksh.cloud/what-i-did-2021-09/" class="list-group-item">2021-09 やったこと</a>
      
      <a href="https://techblog.szksh.cloud/aqua-global-configs/" class="list-group-item">aqua で組織・チームのツール群を管理</a>
      
      <a href="https://techblog.szksh.cloud/aqua-generate/" class="list-group-item">aqua の設定ファイルをインタラクティブに生成する generate コマンド</a>
      
      <a href="https://techblog.szksh.cloud/aqua-v0.5/" class="list-group-item">aqua v0.1.0 から v0.5.0 での変更点</a>
      
      <a href="https://techblog.szksh.cloud/what-i-did-2021-08/" class="list-group-item">2021-08 やったこと</a>
      
      <a href="https://techblog.szksh.cloud/aqua/" class="list-group-item">aqua - CLI ツールのバージョン管理</a>
      
      <a href="https://techblog.szksh.cloud/github-app-for-codebuild/" class="list-group-item">AWS CodeBuild を実行する Github App を作る</a>
      
    </div>
  </section>

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">TAG</div>
    </div>
    <div class="list-group">
      
      <a href="https://techblog.szksh.cloud/tags/oss" class="list-group-item">oss (43)</a>
      
      <a href="https://techblog.szksh.cloud/tags/job" class="list-group-item">job (19)</a>
      
      <a href="https://techblog.szksh.cloud/tags/drone" class="list-group-item">drone (14)</a>
      
      <a href="https://techblog.szksh.cloud/tags/terraform" class="list-group-item">terraform (13)</a>
      
      <a href="https://techblog.szksh.cloud/tags/buildflow" class="list-group-item">buildflow (12)</a>
      
      <a href="https://techblog.szksh.cloud/tags/golang" class="list-group-item">golang (6)</a>
      
      <a href="https://techblog.szksh.cloud/tags/aqua" class="list-group-item">aqua (5)</a>
      
      <a href="https://techblog.szksh.cloud/tags/circleci" class="list-group-item">circleci (5)</a>
      
      <a href="https://techblog.szksh.cloud/tags/graylog" class="list-group-item">graylog (5)</a>
      
      <a href="https://techblog.szksh.cloud/tags/ansible" class="list-group-item">ansible (3)</a>
      
    </div>
  </section>

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">ARCHIVE</div>
    </div>
    <div class="list-group">
      
      <a href="https://techblog.szksh.cloud/archives/2021/11" class="list-group-item">2021/11 (1)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/10" class="list-group-item">2021/10 (3)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/09" class="list-group-item">2021/09 (3)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/08" class="list-group-item">2021/08 (3)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/07" class="list-group-item">2021/07 (3)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/06" class="list-group-item">2021/06 (1)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/05" class="list-group-item">2021/05 (1)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/04" class="list-group-item">2021/04 (4)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/03" class="list-group-item">2021/03 (1)</a>
      
      <a href="https://techblog.szksh.cloud/archives/2021/02" class="list-group-item">2021/02 (3)</a>
      
    </div>
  </section>

</aside>


  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="container">
        <p><span class="h-logo">&copy; melody</span></p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_beg">Beg</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

