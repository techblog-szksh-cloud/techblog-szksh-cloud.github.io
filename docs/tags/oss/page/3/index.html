<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">56 posts tagged with &quot;oss&quot; | Melody</title><meta data-rh="true" property="og:title" content="56 posts tagged with &quot;oss&quot; | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/tags/oss/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/tags/oss/page/3"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/oss/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/oss/page/3" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.24bd547c.css">
<link rel="preload" href="/assets/js/runtime~main.d45b45d3.js" as="script">
<link rel="preload" href="/assets/js/main.5c242a30.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022">2022 年振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-12">Looking back at Dec 2022</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-11">My Activity in 2022-11</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-10">My Activity in 2022-10</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-09">My Activity in 2022-09</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>56 posts tagged with &quot;oss&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/what-i-did-2021-08">2021-08 やったこと</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-09-02T05:33:16.000Z" itemprop="datePublished">September 2, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="仕事">仕事<a class="hash-link" href="#仕事" title="Direct link to heading">​</a></h2><ul><li>AWS IAM User を削除する際に force_destroy が true になっているか Conftest でテスト</li><li>Terraform の State 分割</li><li>Terraform Modules を別リポジトリで管理して versioning</li><li>git-secrets を secretlint に移行<ul><li>git-secrets がメンテされてなくて、既知バグが放置されているから</li></ul></li><li>CI で terraform fmt によるフォーマットの自動化</li><li>WIP: AWS WAF の COUNT, BLOCK ログを Firehose で抽出</li><li>WIP: AWS CodeBuild で Provisioning Error が発生したら自動で Retry</li><li>WIP: AWS CodeBuild のための GitHub App の開発</li><li>WIP: AWS SSO について調査</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="oss-contribution">OSS Contribution<a class="hash-link" href="#oss-contribution" title="Direct link to heading">​</a></h2><p>Renovate の GitHub Actions のドキュメントの修正をしました。
ドキュメント中に書かれたバージョンを Renovate で自動 update するようにしました。</p><ul><li><a href="https://github.com/renovatebot/github-action/pull/556" target="_blank" rel="noopener noreferrer">docs: fix broken links and update GitHub Actions</a></li><li><a href="https://github.com/renovatebot/github-action/pull/557" target="_blank" rel="noopener noreferrer">chore: update GitHub Actions in README by Renovate</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="新たに作った-oss">新たに作った OSS<a class="hash-link" href="#新たに作った-oss" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/suzuki-shunsuke/logrus-error" target="_blank" rel="noopener noreferrer">logrus-error</a>: <a href="https://github.com/sirupsen/logrus" target="_blank" rel="noopener noreferrer">logrus</a>.Fields を error に埋め込む Go の薄いライブラリ</li><li><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a>: Command Line Tools Version Manager<ul><li><a href="https://github.com/suzuki-shunsuke/aqua-proxy" target="_blank" rel="noopener noreferrer">aqua-proxy</a>: aqua の内部ツール </li><li><a href="https://github.com/suzuki-shunsuke/aqua-installer" target="_blank" rel="noopener noreferrer">aqua-installer</a>: aqua をインストールするスクリプトと GitHub Actions</li></ul></li><li><a href="https://github.com/suzuki-shunsuke/go-checkout-github-merged-commit" target="_blank" rel="noopener noreferrer">go-checkout-github-merged-commit</a>: PR の merged commit を checkout する Go のライブラリ</li><li><a href="https://github.com/suzuki-shunsuke/aws-codebuild-retry" target="_blank" rel="noopener noreferrer">aws-codebuild-retry</a>: AWS CodeBuild を Retry する Lambda Function</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog">Blog<a class="hash-link" href="#blog" title="Direct link to heading">​</a></h2><ul><li><a href="https://techblog.szksh.cloud/archives/2021/08/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/archives/2021/08/</a><ul><li><a href="https://techblog.szksh.cloud/aqua/" target="_blank" rel="noopener noreferrer">aqua - CLI ツールのバージョン管理</a></li><li><a href="https://techblog.szksh.cloud/github-app-for-codebuild/" target="_blank" rel="noopener noreferrer">AWS CodeBuild を実行する Github App を作る</a></li></ul></li><li>Quipper<ul><li><a href="https://blog.studysapuri.jp/entry/2021/08/11/080000" target="_blank" rel="noopener noreferrer">Terraform の CI に tfmigrate を導入した話</a></li><li><a href="https://blog.studysapuri.jp/entry/2021/08/02/080000" target="_blank" rel="noopener noreferrer">AWS IAM の管理を miam から Terraform に移行した話</a></li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 2021-08 やったこと" href="/what-i-did-2021-08"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/aqua">aqua - CLI ツールのバージョン管理</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-08-28T00:07:38.000Z" itemprop="datePublished">August 28, 2021</time> · <!-- -->16 min read</div></header><div class="markdown" itemprop="articleBody"><p>2021-09-04 追記: <a href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></p><p><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a> という OSS を開発しているので紹介します。</p><p>記事の内容は aqua v0.1.0 に基づきます。将来的に仕様が変わる可能性があります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-とは">aqua とは<a class="hash-link" href="#aqua-とは" title="Direct link to heading">​</a></h2><p>aqua は CLI ツールのバージョン管理のための CLI です。
aqua で管理する主な対象は GitHub Release で公開されているツールです。
YAML の設定ファイルを書いてコマンドを実行すると指定したツールをインストールすることができます。</p><p>例えば以下のような設定ファイルを書き、 <code>aqua install</code> というコマンドを実行すると
<a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a>, <a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a> などが GitHub Release からダウンロードされ、インストールされます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx-amd64{{else}}{{if eq .OS &quot;linux&quot;}}linux64{{else}}win64.exe{{end}}{{end}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> open</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ちなみに上記の設定ファイルの</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>の部分では Go の <a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener noreferrer">text/template</a> と <a href="http://masterminds.github.io/sprig/" target="_blank" rel="noopener noreferrer">sprig</a> が使われています。</p><p>ツールごとに URL を調べて download して tarball などを展開してインストールしてなどの面倒な作業を aqua で自動化できます。
update も基本的に設定ファイルの version を更新するだけで OK です。</p><p>aqua を使うと同じツールの複数のバージョンを管理してプロジェクトによってバージョンを切り替えるといったことも容易にできます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="3-つの主なユースケース">3 つの主なユースケース<a class="hash-link" href="#3-つの主なユースケース" title="Direct link to heading">​</a></h2><p>aqua では以下の 3 つの主なユースケースを想定しています。</p><ul><li>CI/CD で必要なツールの管理</li><li>ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理</li><li>特定のプロジェクト(リポジトリ)によらないツールの管理</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース1-cicd-で必要なツールの管理">ユースケース1: CI/CD で必要なツールの管理<a class="hash-link" href="#ユースケース1-cicd-で必要なツールの管理" title="Direct link to heading">​</a></h3><p>例えば Terraform の Monorepo の CI で以下のような様々なツールを使っていたとしましょう。</p><ul><li><a href="https://cli.github.com/" target="_blank" rel="noopener noreferrer">gh</a></li><li><a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a></li><li><a href="https://tfsec.dev/" target="_blank" rel="noopener noreferrer">tfsec</a></li><li><a href="https://github.com/terraform-linters/tflint" target="_blank" rel="noopener noreferrer">tflint</a></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a></li><li><a href="https://github.com/open-policy-agent/opa" target="_blank" rel="noopener noreferrer">opa</a></li><li><a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a></li><li><a href="https://github.com/mvdan/sh" target="_blank" rel="noopener noreferrer">shfmt</a></li><li><a href="https://github.com/koalaman/shellcheck" target="_blank" rel="noopener noreferrer">shellcheck</a></li><li><a href="https://github.com/suzuki-shunsuke/github-comment" target="_blank" rel="noopener noreferrer">github-comment</a></li></ul><p>これらを1個1個 curl などを使ってインストールするコードを書くのは面倒ですが、
aqua であれば設定ファイルを宣言的に書いて <code>aqua i</code> を実行すれば終わりです。
新たにツールを追加する場合でも設定ファイルに追記すればよく、スクリプトを更新する必要はありません。
バージョンを明示的に指定できるのでコードを変更してないのに急にツールが更新されることもありませんし、 <a href="https://docs.renovatebot.com/modules/manager/regex/" target="_blank" rel="noopener noreferrer">Renovate の Regex Manager</a> などを使えば更新を自動化することもできます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理">ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理<a class="hash-link" href="#ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理" title="Direct link to heading">​</a></h3><p>あるリポジトリのローカルでの開発に必要なツールを aqua で管理することができます。
リポジトリ直下に <code>aqua.yaml</code> を置いておけば OK です。
バージョンも指定されているので、人によってバージョンが違ったりする問題も解消できます。
<code>aqua.yaml</code> と同じディレクトリに <code>.aqua</code> が作成されるのでそれを .gitignore に追加し、 <code>.aqua/bin</code> を PATH に追加しましょう。
direnv を使い、リポジトリ直下に .envrc を置いて <code>.aqua/bin</code> を PATH に追加すると便利です。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">aqua.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.envrc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>.envrc</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PATH_add .aqua/bin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>.aqua/bin</code> を PATH に追加しなくても <code>aqua exec -- &lt;コマンド&gt; ...</code> で実行することもできます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース3-特定のプロジェクトリポジトリによらないツールの管理">ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理<a class="hash-link" href="#ユースケース3-特定のプロジェクトリポジトリによらないツールの管理" title="Direct link to heading">​</a></h3><p>特定のプロジェクトによらずにツールを laptop にインストールしたい場合にも使えます。
<code>~/.aqua/global/aqua.yaml</code> に設定ファイルを記述し、 <code>~/.aqua/global/.aqua/bin</code> を PATH に追加してください。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$HOME/.aqua/global/.aqua/bin:$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>そして <code>~/.aqua/global</code> 配下で <code>aqua i</code> を実行すればインストールができます。
<code>~/.aqua/global</code> を Git で管理して GitHub などでホスティングするのも良いでしょう。</p><p><a href="https://github.com/suzuki-shunsuke/my-aqua-config" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/my-aqua-config</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="akoi-との違い">akoi との違い<a class="hash-link" href="#akoi-との違い" title="Direct link to heading">​</a></h2><p>ところで、自分は aqua に似たツールとして <a href="http://github.com/suzuki-shunsuke/akoi" target="_blank" rel="noopener noreferrer">akoi</a> というツールを公開していて、自分もこれまでこのツールを使ってきました。
aqua と akoi は「CLI ツールのバージョン管理」という目的・ゴールは同じです。
akoi も結構便利なツールですが、 akoi が抱える様々な課題を解決するために aqua を開発しています。
aqua は akoi のいわば後継ツールです。
ただしコードは全く別物ですし、互換性もありません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="akoi-と比べた-aqua-の良い点">akoi と比べた aqua の良い点<a class="hash-link" href="#akoi-と比べた-aqua-の良い点" title="Direct link to heading">​</a></h3><ul><li>GitHub Access Token を使ったインストールをサポート<ul><li>private repository をサポート</li><li>akoi は anonymous なアクセスなので rate limit に引っかかりやすい</li></ul></li><li>管理対象のコマンド実行時にツールのインストールが可能</li><li>設定ファイルを更新したあとに install コマンドを実行する必要がない<ul><li>akoi は symbolic link を作り直すために install コマンドを実行する必要がある</li></ul></li><li>管理対象のツールの実体を共有できる<ul><li>project ごとにツールを install する必要がない(計算資源の効率化)</li><li>akoi と違って ツールによって実体のインストール先は一意に決まるので、干渉することがなく安全に共有できる</li></ul></li><li>事前に archive の中のパスを知っている必要がない<ul><li>akoi は install 時に archive を展開してファイルをコピーし、シンボリックリンクを作成する<ul><li>パスが間違っていると失敗し、 download からやり直しになる</li><li>そのため、新しいツールを akoi で管理する場合はまず archive の構造を調べる必要がある</li></ul></li><li>aqua は install したあとに ~/.aqua 配下を見て file.src を修正すれば良いし、間違っててコマンドの実行に失敗しても download のやり直しとかはない</li></ul></li><li><code>bin_path</code>, <code>link_path</code> ような設定について考えなくて良い<ul><li>akoi は設定ファイルでインストール先などを設定できるようになっている</li><li>どう設定すべきか悩ましいし、リポジトリによって設定が違ったりして設定を統一するのが難しい</li><li>aqua はインストール先などが設定できないのでユーザーが迷う必要がない</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="管理対象のツールの実体を共有できる">管理対象のツールの実体を共有できる<a class="hash-link" href="#管理対象のツールの実体を共有できる" title="Direct link to heading">​</a></h4><p>aqua はツールの実体を AQUA_ROOT_DIR <code>~/.aqua</code> にインストールし、共有することができます。
複数のリポジトリで同じバージョンの同じツールを使う場合に共有できるので、
インストールにかかる時間を短縮できますし、無駄にディスク容量を消費することもありません。
設定ファイルによって動的にバージョンを取得するので、共有していてもリポジトリごとに異なるバージョンを使うこともできます。</p><p>安全に共有できるようにツールの実体のインストール先はダウンロード元によってユニークかつ一意に決まるようになっています。
ユーザーがカスタマイズすることはできません(ルートディレクトリは変えられますが、ルート以下は変えられません)。</p><p>例えば OSX で jq-1.6 のインストール先は以下になります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/pkgs/github_release/github.com/stedolan/jq/jq-1.6/jq-osx-amd64/jq-osx-amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように GitHub Release からインストールする場合</p><ul><li>リポジトリのオーナー</li><li>リポジトリ名</li><li>tag</li><li>GitHub Release のアセット名</li></ul><p>などから一意に決まるため、あるリポジトリでは jq をフォークしたものを使うといった場合でも安全に共存することができます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="便利な---only-link-option">便利な <code>--only-link</code> option<a class="hash-link" href="#便利な---only-link-option" title="Direct link to heading">​</a></h2><p><code>aqua install</code> を実行するとツールごとに以下のことが実行されます。</p><ol><li><code>.aqua/bin</code> 配下にシンボリックリンクを作成</li><li>ダウンロード</li><li>tarball などの展開</li><li>~/.aqua 配下にインストール</li></ol><p>aqua.yaml の packages に大量のツールが定義されていると、
大量のツールが一度にインストールされることになり、
並列で実行されるとはいえ、都合が悪いこともあるでしょう。</p><p><code>--only-link</code> option をつけて実行すると、シンボリックリンクだけ作成しダウンロードなどは行わないので直ぐに終わります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua install --only-link</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>その状態でツールを実行すると、ツールが自動でインストールされてから実行されるので
本当に必要になってからインストールすることが可能であり、余計なインストールが発生しないので便利です。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="コマンド実行時の自動インストール動的なバージョン切り替えの仕組み">コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み<a class="hash-link" href="#コマンド実行時の自動インストール動的なバージョン切り替えの仕組み" title="Direct link to heading">​</a></h2><p>aqua は設定ファイルを更新すると <code>aqua install</code> 実行をしなくても更新が反映される、
ツールがまだインストールされていなくてもツールを実行時に自動でインストールされるという機能があります。</p><p>tfenv も .terraform-version を更新すればすぐ反映されますし、
terraform コマンドを実行時にまだ指定したバージョンがインストールされてなかったら自動でインストールされますが、それに似ていますね
(ただし tfenv の機能がどう実装されているかは調べてませんし、 aqua を実装する上で参考にしたりはしていません)。</p><p>上記の機能が aqua でどう実現されているか簡単に説明します。</p><p>例えば aqua で jq をインストールし、 <code>jq -h</code> を実行したとしましょう。
jq を実行すると aqua-proxy を経由して <code>aqua exec -- jq -h</code> が実行されます。
この辺の詳細は <a href="#aqua-proxy-%E3%81%A8%E3%81%AF">aqua-proxy とは</a> を参照してください。
<code>aqua exec</code> は aqua の設定ファイルで指定されたバージョンがインストールされているかチェックし、まだインストールされていなかったらインストールし、コマンド <code>jq -h</code> を実行します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-proxy-とは">aqua-proxy とは<a class="hash-link" href="#aqua-proxy-とは" title="Direct link to heading">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/aqua-proxy" target="_blank" rel="noopener noreferrer">aqua-proxy</a> は aqua が内部的に依存しているツールです。
コマンド実行時に aqua 及び aqua で管理するツールのバージョンを動的に変更するために作られました。
aqua のために開発されており、 aqua 以外で使われることは想定していません。</p><p>aqua-proxy は <code>aqua install</code> や <code>aqua exec</code> を実行した際に自動で <code>~/.aqua/bin/aqua-proxy</code> にインストールされます。
aqua はツールをインストールする際に <code>.aqua/bin/&lt;ツール&gt;</code> から <code>~/.aqua/bin/aqua-proxy</code> へのシンボリックリンクを作成するので、 <code>&lt;ツール&gt;</code> を実行すると <code>~/.aqua/bin/aqua-proxy</code> が呼ばれます。</p><p>aqua-proxy は <a href="https://pkg.go.dev/os#Args" target="_blank" rel="noopener noreferrer">os#Args</a> からツール名を取得し、
<code>aqua exec -- &lt;ツール名&gt; ...</code> を実行します。
これによりコマンド実行時に aqua 及び <code>&lt;ツール&gt;</code> のバージョンを動的に変更することを実現しています。</p><p><code>.aqua/bin/&lt;ツール&gt;</code> から aqua-proxy へのシンボリックリンクは静的であり、 aqua-proxy のバージョンを切り替えることは難しいです。
aqua-proxy の機能・責務が大きくなると aqua-proxy のバージョン管理や aqua との互換性を考えなくてはならなくなります。
aqua-proxy のバージョンをほぼ気にしなくて良いよう、 aqua-proxy は最小限の機能・責務しか持たず、安定的であまり変更されないように設計されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="プロセスツリーを確認してみる">プロセスツリーを確認してみる<a class="hash-link" href="#プロセスツリーを確認してみる" title="Direct link to heading">​</a></h2><p>既に説明したとおり <code>&lt;ツール&gt;</code> を実行した際には実はプロセスツリー的には
<code>aqua-proxy =&gt; aqua =&gt; &lt;ツール&gt;</code> という風になっています。</p><p><code>&lt;ツール&gt;</code> を直接実行した場合と挙動に違いが出ないように以下のようなことに気を配っています。</p><ul><li>SIGINT, SIGTERM などのシグナルが適切に <code>&lt;ツール&gt;</code> のプロセスまで伝達されるようにする</li><li><code>&lt;ツール&gt;</code> の exit code が伝達されるようにする</li></ul><p>試しに fzf を実行してみて別のターミナルでプロセスツリーを確認してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls | fzf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>fzf が起動しますが、そのままにしておいて別のターミナルでプロセスツリーを確認してみます。
Mac の <code>pstree</code> を使っています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-+- 83548 foo fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> \-+- 83549 foo aqua exec -- fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   \--- 83550 foo /Users/foo/.aqua/pkgs/github_release/github.com/junegunn/fzf/0.27.2/fzf-0.27.2-darwin_amd64.zip/fzf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>紛らわしいのですが、最初のプロセスの実体は fzf ではなくて aqua-proxy です。 fzf が aqua-proxy へのシンボリックになっているのでこうなっています。
ここで aqua-proxy に SIGTERM を送ると手元の Mac ではちゃんと子プロセスまで終了しました。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kill 83548</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>この辺のシグナルハンドリングは Windows だと正常に動かないかもしれません。</p><p><a href="https://pkg.go.dev/os#Signal" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/os#Signal</a></p><blockquote><p>The only signal values guaranteed to be present in the os package on all systems are os.Interrupt (send the process an interrupt) and os.Kill (force the process to exit).
On Windows, sending os.Interrupt to a process with os.Process.Signal is not implemented;
it will return an error instead of sending a signal.</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about aqua - CLI ツールのバージョン管理" href="/aqua"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/what-i-did-2021-07">2021-07 やったこと</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-07-27T21:58:45.000Z" itemprop="datePublished">July 27, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>今まで仕事に限定して書いてきましたが、 OSS 活動なんかにも触れてもいいんじゃないかと思ったので分かる範囲で書きます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="仕事">仕事<a class="hash-link" href="#仕事" title="Direct link to heading">​</a></h2><ul><li>Docker Image を Docker Hub から ECR へ移行</li><li>Terraform<ul><li>.terraform.lock.hcl を CI の中で自動で更新(commit, push)できるようにした<ul><li>Terraform に詳しくない人も使うので、自動化したほうが良いと判断</li></ul></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a> を CI に導入</li><li>(in progress) Terraform Modules を Terraform の Monorepo とは別リポジトリで管理して versioning するようにした</li><li>Route53 の管理を <a href="https://github.com/codenize-tools/roadworker" target="_blank" rel="noopener noreferrer">Roadworker</a> から Terraform へ移行</li><li>tfmigrate を使ったリファクタリング</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="event">Event<a class="hash-link" href="#event" title="Direct link to heading">​</a></h2><ul><li><a href="https://mercari.connpass.com/event/211073/" target="_blank" rel="noopener noreferrer">Open Policy Agent Rego Knowledge Sharing Meetup</a> で登壇<ul><li><a href="https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e" target="_blank" rel="noopener noreferrer">https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="oss-contribution">OSS Contribution<a class="hash-link" href="#oss-contribution" title="Direct link to heading">​</a></h2><p>AWS AppConfig を Terraform で管理できるようにする PR が無事マージされました。</p><ul><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/20172" target="_blank" rel="noopener noreferrer">feat: add aws_appconfig_deployment</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/20176" target="_blank" rel="noopener noreferrer">fix: add the attribute &quot;environment_id&quot; to aws_appconfig_environment</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19359" target="_blank" rel="noopener noreferrer">feat: support AppConfig Deployment Strategy</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19324" target="_blank" rel="noopener noreferrer">feat: support AppConfig Hosted Configuration Version</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19320" target="_blank" rel="noopener noreferrer">feat: add appconfig_configuration_profile</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19307" target="_blank" rel="noopener noreferrer">feat: add aws_appconfig_application and aws_appconfig_environment</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="新たに作った-oss">新たに作った OSS<a class="hash-link" href="#新たに作った-oss" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/tfmigrator/cli" target="_blank" rel="noopener noreferrer">tfmigrator/cli</a>: CLI to Migrate Terraform Configuration and State with terraform state command and hcledit</li><li><a href="https://github.com/suzuki-shunsuke/renovate-github-tags-datasource-repositories" target="_blank" rel="noopener noreferrer">Renovate github-tags Datasource Repositories</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="tfmigrator">tfmigrator<a class="hash-link" href="#tfmigrator" title="Direct link to heading">​</a></h3><p>Terraform Configuration と State をマイグレーションする tfmigrator の CLI をリリースしました。
tfmigrator には紆余曲折有り(?)、時系列的に</p><ul><li><a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfmigrator</a> を開発。 CLI</li><li>YAML の設定ファイルの表現力に限界を感じ、 suzuki-shunsuke/tfmigrator をフォークして Go のライブラリ <a href="https://github.com/tfmigrator/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator/tfmigrator</a> を開発<ul><li>簡単に CLI を実装できるように API も提供</li><li>ついでに色々改良<ul><li><a href="https://github.com/minamijoyo/hcledit" target="_blank" rel="noopener noreferrer">hcledit</a> のインストールが不要</li><li>ファイルの in place の更新をサポート</li><li>dry run のサポート</li><li>複数のリソースをまとめて扱えるような API も提供 <a href="https://pkg.go.dev/github.com/tfmigrator/tfmigrator@v0.5.1/tfmigrator#QuickRunBatch" target="_blank" rel="noopener noreferrer">QuickRunBatch</a></li><li>etc</li></ul></li></ul></li><li>実際に tfmigrator/tfmigrator を使ってみると Go を書くのがちょっと面倒くさい<ul><li>そもそも複雑な rule を一度に適用しようとするのが間違っていると感じた</li></ul></li><li>tfmigrator/tfmigrator を使い、 CLI も実装 tfmigrator/cli<ul><li>やはり基本的なユースケースでは YAML 書くほうが楽</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="renovate-github-tags-datasource-repositories">Renovate github-tags Datasource Repositories<a class="hash-link" href="#renovate-github-tags-datasource-repositories" title="Direct link to heading">​</a></h3><p>Renovate の Datasource や Manager でサポートされていない package を Renovate で update するために、
package ように GitHub Repository を作って package のバージョンに合わせて GitHub tag を更新し、
<code>github-tags</code> Datasource として使おうというプロジェクトです。
現状 AWS RDS や AWS Elasticache の engine version 用のリポジトリを作っています。
tag は GitHub Actions を毎日定期実行することで更新します。
詳細はリポジトリの README でも読んでください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="新しいバージョンをリリースした-oss">新しいバージョンをリリースした OSS<a class="hash-link" href="#新しいバージョンをリリースした-oss" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a><ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases/tag/v2.0.0-0" target="_blank" rel="noopener noreferrer">v2.0.0-0</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases/tag/v1.1.0" target="_blank" rel="noopener noreferrer">v1.1.0</a><ul><li><a href="https://twitter.com/szkdash/status/1416263752475836416" target="_blank" rel="noopener noreferrer">https://twitter.com/szkdash/status/1416263752475836416</a></li></ul></li></ul></li></ul><p>terraform v0.15.4 から Terraform 以外での変更も plan に出力されるようになって
わかりにくいと感じたので、 tfcmt でテンプレート変数追加して見やすくできるようにしました。
Refreshing state のログを除外したり、warning 目立たせたりもできて便利です。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog">Blog<a class="hash-link" href="#blog" title="Direct link to heading">​</a></h2><ul><li><a href="https://techblog.szksh.cloud/archives/2021/07/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/archives/2021/07/</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 2021-07 やったこと" href="/what-i-did-2021-07"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/tfmigrator">terraformer で雑に生成した tf ファイル と state を分割したくてツールを書いた</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-01-31T05:53:23.000Z" itemprop="datePublished">January 31, 2021</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/GoogleCloudPlatform/terraformer" target="_blank" rel="noopener noreferrer">terraformer</a> で雑に生成した Terraform の設定ファイル (以下 tf ファイル) と state を分割したくてツールを書きました。</p><p><a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="経緯">経緯<a class="hash-link" href="#経緯" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="miam-から-terraform-へ移行したい">miam から Terraform へ移行したい<a class="hash-link" href="#miam-から-terraform-へ移行したい" title="Direct link to heading">​</a></h3><p><a href="https://github.com/codenize-tools/miam" target="_blank" rel="noopener noreferrer">miam</a> というツールで管理されている大量のリソースを Terraform で管理したくなりました。
多くの AWS Resource は Terraform で管理されていますが、 IAM に関しては miam で管理されています。
なぜ Terraform ではなく miam で管理されているかというと、当時のことは自分には分かりませんが、歴史的な経緯もあると思います。
昔は今よりも Terraform の表現力が豊かではなく、 Ruby で自由にかける miam のほうが扱いやすかったとか、
miam だと miam でリソースを管理することを強制できるため、権限管理を厳格にやるという観点では都合が良いという点もあるかと思います。</p><p>ではなぜ Terraform で管理したくなったかというと、
一番大きな理由は miam で頻繁に rate limit に引っかかるようになったからです。
Terraform にしろ miam にしろ CI/CD で test, apply が実行されるようになっています。
miam では毎回全部のリソースを対象に処理が実行されるため、リソースの数が増えるにつれて rate limit に引っかかりやすくなります。
CI を rerun すれば成功するのですが、悪いときは 3 回連続で rate limit に引っかかり、 4 回目でようやく成功するということもありました。</p><p>Terraform ではサービスや環境単位で State が分割されており、 CI も PR でファイルが変更された state に対してのみ実行されるため、
rate limit に引っかかることは基本ないようになっています。</p><p>他にも色々理由はあるのですが、本題からそれるのでやめておきます。
rate limit だけなら miam でも exclude する機能があるので頑張ればなんとかなる気はします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="やりたかったこと">やりたかったこと<a class="hash-link" href="#やりたかったこと" title="Direct link to heading">​</a></h3><ul><li>Terraform で既存のリソースを管理したい<ul><li>tf ファイル と state を生成したい</li></ul></li><li>Terraform の設定ファイル と state はサービス・環境ごとに分割したい</li><li>Terraform のリソースパスはヒューマンリーダブルにしたい<ul><li>これは難しければ諦めるのもありだが、できればやりたい</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraformer-で自動生成するも色々問題があった">terraformer で自動生成するも色々問題があった<a class="hash-link" href="#terraformer-で自動生成するも色々問題があった" title="Direct link to heading">​</a></h3><p>まずは terraformer で雑に tf ファイル と state を生成しました。
今回 terraformer を使うのは初めてで、 terraformer で万事解決なら話は簡単だったのですが、話はそんな簡単ではありませんでした。
これに関しては、自分の問題(使い方を間違っている、ドキュメントをちゃんと読んでいない)なのか、 あるいは terraformer 側の問題なのかよく分かってない部分もあります。</p><p>まずドキュメントを読んでもいまいちリソースのフィルタリングの仕方が分かりませんでした。
試しに IAM role の名前を指定してそれだけ import しようとしましたが、なぜか全 IAM リソースが import されてしまいました。</p><p>良くわからないので、これは全 IAM リソースを雑に import してからサービス・環境ごとに分割するしか無いかなぁと思いました。</p><p>加えて、リソースパスが全然ヒューマンリーダブルではありませんでした。 terraformer としてはこれは仕方ないと思いますが、なんとかリネームしたいと思いました。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="最初手作業で始めるも自動化が必要と悟る">最初手作業で始めるも、自動化が必要と悟る<a class="hash-link" href="#最初手作業で始めるも自動化が必要と悟る" title="Direct link to heading">​</a></h3><p>最初特定のサービスに関して手作業で tf ファイル, state を移行する作業を行ってみました。
簡単なシェルスクリプトを書いて半自動化してみました。
tf ファイルの操作には <a href="https://github.com/minamijoyo/hcledit" target="_blank" rel="noopener noreferrer">hcledit</a> が便利です。</p><p>以下のようなコマンドを使いました。</p><ul><li>terraform state mv</li><li>hcledit block get</li><li>hcledit block mv</li><li>hcledit block list</li></ul><p>で、やってみたものの、なにせ対象が多いので、これを一つ一つ手作業でやるのは大変だし、ヒューマンエラーは避けられないと感じました。
そこでちょっとしたツールを作ることにしました。
手作業で一回やった分手順はイメージできているので、割と簡単にできるだろうと思いました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="tfmigrator">tfmigrator<a class="hash-link" href="#tfmigrator" title="Direct link to heading">​</a></h2><p>そこで作ったのが <a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator</a> です。
今回は AWS の IAM リソースを扱いますが、 tfmigrator は特定の provider などには依存しないツールです。
Terraform CLI と hcledit が必要です。</p><p>まず terraformer で IAM リソースを全部 import してきます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraformer import aws -r iam --compact --path-pattern .</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると resources.tf と terraform.tfstate が作られます。</p><p>tfmigrator の設定ファイル tfmigrator.yaml を書きます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 既に Terraform で管理されているものは無視</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&quot;tags&quot; in Values &amp;&amp; Values.tags.ManagedBy == &quot;Terraform&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exclude</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&quot;name&quot; not in Values&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exclude</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `name` に &quot;foo&quot; が含まれているものはサービス foo のリソースとみなして分割</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Values.name contains &quot;foo&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">state_out</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo/terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resource_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{.Values.name}}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tf_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo/resource.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 以下略</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>tfmigrator の処理の流れをなんとなくそれっぽい擬似言語で表現します。
実際の処理の流れとは若干異なりますが、雰囲気が伝わればと思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">for resource in state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for item config.items</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if item.rule.match(resource)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if item.exclude</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # このリソースは処理せず次のリソースの処理に移る</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # tf の migration (note: 元の tf はそのまま)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hcledit block get resource.path &lt; tf | hcledit block mv resource.path &quot;${resource.type}.${item.resource_name(resource)}&quot; &gt;&gt; item.tf_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      terraform state mv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 次のリソースの処理に移る</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      break</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>各 item の設定の意味はこんな感じです。</p><ul><li>rule: <a href="https://github.com/antonmedv/expr/blob/master/docs/Language-Definition.md" target="_blank" rel="noopener noreferrer">expr</a> の expression 。この条件にマッチしたリソースをこの item で処理する</li><li>exclude: true の場合、この item にマッチしたリソースは無視する</li><li>state_out: <code>terraform state mv</code> の <code>-state-out</code></li><li>resource_name: 新しいリソース名。デフォルトでは名前はそのまま。 Go の <a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener noreferrer">text/template</a> で処理されます</li><li>tf_path: Terraform の設定ファイルの出力先</li></ul><p>設定ファイルを書いたら tfmigrator を実行します。
いきなりマイグレーションをするというよりは、まずは dry run てきなことをして動作を確認したいですね。
<code>-skip-state</code> をつけると <code>terraform state mv</code> を skip し、分割される tf ファイル を新しいファイルに出力だけします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat *.tf | tfmigrator run -skip-state</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>生成された tf ファイル を眺めて、良さそうなら <code>-skip-state</code> をとって実行します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="tf-ファイル生成時の注意点">tf ファイル生成時の注意点<a class="hash-link" href="#tf-ファイル生成時の注意点" title="Direct link to heading">​</a></h2><p>tf ファイルの生成は現状追記モードで実行されます。なので <code>-skip-state</code> をつけて複数回実行すると同じ設定が重複して書き込まれることになります。
それが困る場合は実行前に対象ファイルを消してから実行してください。</p><p>また、tf ファイルの移行は既存の tf ファイルに対して <code>hcledit block get</code>, <code>hcledit block mv</code> を実行して行われるため、
元の tf ファイルはそのまま残ること、また expression は評価されないことに注意が必要です。
例えば <code>name = var.name</code> のように変数を参照している場合、それもそのまま評価されずに残ります。
とりあえず自分がやりたかったのは terraformer で生成した tf ファイルの移行だったので、そんなに問題にはならないだろうと思っています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="エラーハンドリング">エラーハンドリング<a class="hash-link" href="#エラーハンドリング" title="Direct link to heading">​</a></h2><p>あるリソースの処理でエラーが起こったら即座に異常終了するようにしています。
(当然ですが)ロールバックとかはしません(し、できません)。
エラー出力しつつ次のリソースの処理に移る、というのも考えられますが、間違って <code>terraform state mv</code> されると面倒なので、現状即座に終了するようにしています。
問題のあるリソースを無視したい場合は、 tfmigrator の設定でそのリソースにマッチする item を追加し <code>exclude: true</code> とすればよいでしょう。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="このツールの便利なところ">このツールの便利なところ<a class="hash-link" href="#このツールの便利なところ" title="Direct link to heading">​</a></h2><ul><li>expr を用いてリソースを分類できる</li><li>設定ファイルに記述し、ワン・コマンドで実行できる<ul><li>レビューできる</li><li>後で見返せる</li></ul></li></ul><p>ローカルで試行錯誤しながら複数のコマンドを実行していると、後でなにやったかわからなくなりがちですし、途中で作業を中断したりすると、あとで今どういう状態なのか分からなくなったりします。
ワン・コマンドで実行できるとそういう問題がなくて便利ですね。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="肝心の移行はできたのか">肝心の移行はできたのか<a class="hash-link" href="#肝心の移行はできたのか" title="Direct link to heading">​</a></h2><p>まだできていません。移行するために tfmigrator を作ったので、これから移行していこうという段階です。
なので tfmigrator はまだ全然使い込んでないですし、使ってく中で機能修正したりすることもあると思います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="最後に">最後に<a class="hash-link" href="#最後に" title="Direct link to heading">​</a></h2><p>terraformer で雑に import してきた tf ファイルと state をいい感じに分割するために tfmigrator というツールを作りました。
tfmigrator が役に立つケースは割と限られているというか、日常的に使うようなツールでもないですが、
terraformer で雑に import してきたのは良いが、扱いに困っているなんて人には役に立つかもしれません。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about terraformer で雑に生成した tf ファイル と state を分割したくてツールを書いた" href="/tfmigrator"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/fork-tfnotify">tfnotify を fork した</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-01-02T10:42:10.000Z" itemprop="datePublished">January 2, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/mercari/tfnotify" target="_blank" rel="noopener noreferrer">mercari/tfnotify</a> を Fork して 2 つほど OSS を作りました。</p><ul><li><a href="https://github.com/suzuki-shunsuke/tfnotify" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfnotify</a> - tfnotify と互換性あり</li><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt</a> - tfnotify と互換性がない</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="開発の経緯">開発の経緯<a class="hash-link" href="#開発の経緯" title="Direct link to heading">​</a></h2><p>これまで tfnotify を便利に使わせてもらってたのですが、幾つか改善したいと思うところがあり、本家に PR を投げました。
しかし残念ながらこれまでのところ反応がなく、そこまで本家が活発ではないこと、また他にも色々改修したいところがあったことから、自分でフォークしてメンテすることにしました。
最初は互換性を維持しながら <a href="https://github.com/suzuki-shunsuke/tfnotify" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfnotify</a> を開発していました(今もしています)。
しかし、開発を進めるに連れ、自分にとって必要のないプラットフォームなどに関するコードが邪魔であると感じ、それらを消したバージョンを別に開発することにしました。
互換性がなくなることから、名前も変えて tfcmt としました。</p><p><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt</a></p><p>こういった経緯から、 tfcmt のほうを優先的に開発していますが、 tfcmt で実装した機能を後から suzuki-shunsuke/tfnotify にも実装してたりもします。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="fork-元のバージョン">Fork 元のバージョン<a class="hash-link" href="#fork-元のバージョン" title="Direct link to heading">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/tfnotify" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfnotify</a> は <a href="https://github.com/mercari/tfnotify/releases/tag/v0.7.0" target="_blank" rel="noopener noreferrer">mercari/tfnotify v0.7.0</a> <a href="https://github.com/mercari/tfnotify/commit/fb178d8a5a51f88a51b7fda93ed5443ff56dfc8f" target="_blank" rel="noopener noreferrer">fb178d8</a> をフォークしました。
一方 tfcmt は <a href="https://github.com/suzuki-shunsuke/tfnotify/releases/tag/v1.3.3" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfnotify v1.3.3</a> をフォークしました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="mercaritfnotify-との違い">mercari/tfnotify との違い<a class="hash-link" href="#mercaritfnotify-との違い" title="Direct link to heading">​</a></h2><p>本家との違いは Release Note とドキュメントを参照してください。</p><ul><li>suzuki-shunsuke/tfnotify<ul><li><a href="https://github.com/suzuki-shunsuke/tfnotify/releases" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfnotify/releases</a></li><li><a href="https://github.com/suzuki-shunsuke/tfnotify/blob/master/COMPARED_WITH_TFNOTIFY.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfnotify/blob/master/COMPARED_WITH_TFNOTIFY.md</a></li></ul></li><li>suzuki-shunsuke/tfcmt<ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt/releases</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt/blob/master/COMPARED_WITH_TFNOTIFY.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt/blob/master/COMPARED_WITH_TFNOTIFY.md</a></li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about tfnotify を fork した" href="/fork-tfnotify"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/collaborator-of-terraform-docker-provider">Terraform の Docker Provider の Collaborator になりました</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-12-03T00:07:32.000Z" itemprop="datePublished">December 3, 2020</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>先日 <a href="https://github.com/kreuzwerker/terraform-provider-docker" target="_blank" rel="noopener noreferrer">kreuzwerker/terraform-provider-docker</a> の Collaborator になりました。
<a href="https://github.com/kreuzwerker/terraform-provider-docker" target="_blank" rel="noopener noreferrer">kreuzwerker/terraform-provider-docker</a> は Terraform の Docker Provider であり、 Docker コンテナや image, network などを管理できます。
元々は Hashicorp の Official Provider であった <a href="https://github.com/terraform-providers/terraform-provider-docker" target="_blank" rel="noopener noreferrer">terraform-providers/terraform-provider-docker</a> が <a href="https://github.com/kreuzwerker/terraform-provider-docker" target="_blank" rel="noopener noreferrer">kreuzwerker/terraform-provider-docker</a> に移管され、 Community Provider になりました。
元のリポジトリは hashicorp org に移され archive されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="collaborator-になった経緯">Collaborator になった経緯<a class="hash-link" href="#collaborator-になった経緯" title="Direct link to heading">​</a></h2><p>リポジトリが移管される際に、メンテナを募集していて過去に contribution していた自分にも声をかけていただきました。</p><p><a href="https://github.com/hashicorp/terraform-provider-docker/issues/306" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-docker/issues/306</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="contributor-になった経緯">Contributor になった経緯<a class="hash-link" href="#contributor-になった経緯" title="Direct link to heading">​</a></h2><p>自分がこの provider に contribution した経緯は、 Terraform の Hands on を書くのに丁度よい provider を探していたことでした。</p><p>Hands on の題材として Docker コンテナを作ったりできたらいいんじゃないかなと思って Docker provider を試してみました。
しかし当時の docker_container リソースは read をちゃんとサポートしていませんでした。
なので import や update がまともに動きませんでした。
それを見かねて修正して PR を投げたのが最初です。</p><ul><li><a href="https://github.com/hashicorp/terraform-provider-docker/pull/234" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-docker/pull/234</a></li><li><a href="https://github.com/hashicorp/terraform-provider-docker/pull/236" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-docker/pull/236</a></li></ul><p>その後も幾つか contribution をしました。</p><p>なお、 PR を投げたものの、 Hands on は MySQL Provider を使って書きました。</p><p><a href="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform の Docker Provider の Collaborator になりました" href="/collaborator-of-terraform-docker-provider"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/splitting-circleci-config">Splitting .circleci/config.yml</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-11-07T05:43:10.000Z" itemprop="datePublished">November 7, 2020</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this post I introduce how to split a huge <code>.circleci/config.yml</code>.</p><p>CircleCI doesn&#x27;t support to split .circleci/config.yml, so we manage all workflows and jobs configuration into one file .circleci/config.yml.
If the repository is <a href="https://en.wikipedia.org/wiki/Monorepo" target="_blank" rel="noopener noreferrer">Monorepo</a>, the more the number of services increases, the more the size of .circleci/config.yml becomes large and it&#x27;s hard to maintain .circleci/config.yml.
By splitting .circleci/config.yml per service, it makes easy to maintain .circleci/config.yml and we can configure split file&#x27;s <a href="https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/about-code-owners" target="_blank" rel="noopener noreferrer">CODEOWNERS</a>.</p><p>To split .circleci/config.yml, you have to generate .circleci/config.yml by merging split files and commit both split files and .circleci/config.yml.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="circleci-config-pack">circleci config pack<a class="hash-link" href="#circleci-config-pack" title="Direct link to heading">​</a></h2><p>We can merge split files with the command <code>circleci config pack</code>, but I introduce the other tool <a href="https://github.com/suzuki-shunsuke/circleci-config-merge" target="_blank" rel="noopener noreferrer">circleci-config-merge</a>.</p><p>CircleCI CLI is an official tool so it&#x27;s reliable, but I feel the restriction of the file name and the directory structure is a little strict.
We have to manage all files on the same directory, and the file path is reflected to generated YAML content.</p><p>For the detail of <code>circleci config pack</code>, please see the official document.</p><p><a href="https://circleci.com/docs/2.0/local-cli/#packing-a-config" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/local-cli/#packing-a-config</a></p><p>If you can accept the restriction of <code>circleci config pack</code>, I recommend to use it because it is an official tool.
But if it is difficult to accept the restriction, maybe <a href="https://github.com/suzuki-shunsuke/circleci-config-merge" target="_blank" rel="noopener noreferrer">circleci-config-merge</a> would help you.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="circleci-config-merge">circleci-config-merge<a class="hash-link" href="#circleci-config-merge" title="Direct link to heading">​</a></h2><p>circleci-config-merge is a CLI tool to generate .circleci/config.yml by merging split files.</p><p>The usage of circleci-config-merge is like the following.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ circleci-config-merge merge &lt;file1&gt; [&lt;file2&gt; ...]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There is no restriction of file paths, and the format of split file is same as .circleci/config.yml.</p><p>For example, you can manage files on the same directory.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">.circleci/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.yml # generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service1.yml # split config per service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service2.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Or you can also manage files on each service directory.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">service1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  circleci/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workflow.yml # you can split file freely</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobs.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service2/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  circleci/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>circleci-config-merge merges the list of workflow jobs.</p><p>For example,</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> foo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> bar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The workflow <code>build</code>&#x27;s jobs are merged as the following.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># sort by job name for comparison</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> foo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="test-circleciconfigyml-in-ci">Test .circleci/config.yml in CI<a class="hash-link" href="#test-circleciconfigyml-in-ci" title="Direct link to heading">​</a></h2><p>If you split .circleci/config.yml, you should test in CI whether .circleci/config.yml is generated by merging split files.
circleci-config-merge doesn&#x27;t provide such a feature, but you can implement the test with the other tool like <a href="https://github.com/homeport/dyff" target="_blank" rel="noopener noreferrer">dyff</a>.</p><p>I have created an example repository <a href="https://github.com/suzuki-shunsuke/example-circleci-config-merge" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/example-circleci-config-merge</a>.
You can use this example as a reference to split .circleci/config.yml and setup CI.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="use-case">Use case<a class="hash-link" href="#use-case" title="Direct link to heading">​</a></h2><p>Lastly, I introduce a use case of circleci-config-merge.
Recently, I split a huge .circleci/config.yml which is over 6,000 lines to about 60 files.
It was hard to maintain the original .circleci/config.yml, but by splitting it became easy to maintain .circleci/config.yml.
If you are suffer from a huge .circleci/config.yml, let&#x27;s split it!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>In this post I introduced how to split a huge .circleci/config.yml.
We can generate .circleci/config.yml by merging split files with <a href="https://github.com/suzuki-shunsuke/circleci-config-merge" target="_blank" rel="noopener noreferrer">circleci-config-merge</a>.
Please see the example <a href="https://github.com/suzuki-shunsuke/example-circleci-config-merge" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/example-circleci-config-merge</a> as a reference to split .circleci/config.yml and setup CI.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/circleci">circleci</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Splitting .circleci/config.yml" href="/splitting-circleci-config"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/github-ci-monitor">github-ci-monitor: CI のステータスを DataDog で監視</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-11-01T08:51:44.000Z" itemprop="datePublished">November 1, 2020</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自作の OSS <a href="https://github.com/suzuki-shunsuke/github-ci-monitor" target="_blank" rel="noopener noreferrer">github-ci-monitor</a> の紹介です。</p><p>GitHub リポジトリの CI のステータスを定期的に取得し、 DataDog に送ることで、 CI のステータスを監視するツールです。
現状は AWS Lambda で動かすことを想定していますが、他の方法でも動かせるようにするつもりです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="motivation">Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">​</a></h2><p>モチベーションは、 PR をマージしたあとに CI がこけた場合に通知が欲しいというものです。
マージしたあとに CI が一瞬で終わるなら無事終わるのを見届けてもいいんですが、
数分かかると待ってるのも時間がもったいないです。
しばらくしたあとに結果を確認すればいいんですが、それも面倒くさいですし、普通に忘れます。
そうするとデプロイしたつもりが実は CI がこけてたなんてことが普通にあります。</p><p>そういうことにすぐ気づけるよう、 Slack に通知がほしいと思っていました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="仕組み">仕組み<a class="hash-link" href="#仕組み" title="Direct link to heading">​</a></h2><p>仕組みは単純です。</p><p>GitHub API で各リポジトリのステータスを取得し、 DataDog API でステータスを送信しています。
DataDog API は <a href="https://docs.datadoghq.com/ja/api/v1/service-checks/" target="_blank" rel="noopener noreferrer">Service Check API</a> を使っています。
status は以下のようになります。</p><ul><li>0: 正常</li><li>1: 異常</li><li>3: ステータスの取得に失敗</li></ul><p>また以下の tag が付きます。</p><ul><li>owner: リポジトリのオーナー</li><li>repo: リポジトリ名</li><li>ref: ブランチ名</li></ul><p>各リポジトリのステータスは現状 3 つをサポートしています。</p><ul><li>Commit Status: <a href="https://docs.github.com/en/free-pro-team@latest/rest/reference/repos#get-the-combined-status-for-a-specific-reference" target="_blank" rel="noopener noreferrer">Get the combined status for a specific reference</a></li><li>Check API:<ul><li>Check Run: <a href="https://docs.github.com/en/free-pro-team@latest/rest/reference/checks#list-check-runs-for-a-git-reference" target="_blank" rel="noopener noreferrer">List check runs for a Git reference</a></li><li>Check Suite: <a href="https://docs.github.com/en/free-pro-team@latest/rest/reference/checks#list-check-suites-for-a-git-reference" target="_blank" rel="noopener noreferrer">List check suites for a Git reference</a></li></ul></li></ul><p>それぞれ on/off を設定でき、複数指定した場合は、どれか 1 つでも失敗していたら status が 1 になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="lambda-で動かす場合のアーキテクチャ">Lambda で動かす場合のアーキテクチャ<a class="hash-link" href="#lambda-で動かす場合のアーキテクチャ" title="Direct link to heading">​</a></h2><p>CloudWatch Events で定期的(5分毎とか)に Lambda Function を実行します。
リポジトリのリストなどの設定は環境変数で渡し、 GitHub Access Token などのクレデンシャルは AWS Secrets Manager 経由で渡します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="実装方針">実装方針<a class="hash-link" href="#実装方針" title="Direct link to heading">​</a></h2><p>CI がこけたら通知してほしいという要件を満たす方法は色々あると思います。</p><p>まず CI の中でこけた場合に通知を飛ばすようにすることが考えられます。
以下のようなメリットがあります(書いてみたら結構ありますね)。</p><ul><li>ツールをどっかで動かしたりツール自体を監視したりする必要がない</li><li>より詳細なメッセージを送れる<ul><li>コマンドの標準エラー出力を含めたり</li><li>CI のリンク貼ったり、 PR の author をメンションしたりもしやすい</li></ul></li><li>CI がこけたらリアルタイムで通知できる</li><li>ポーリングと違い、無駄に API を叩く必要がない</li></ul><p>一方で、これを漏れなく実装するのはけっこう大変だと思います。
例えば CircleCI だと全ての Job でちゃんとハンドリングしないといけなかったりすると思います。
リポジトリが 1 個だけならそれでもいいですが、何十個もあるとなるとだいぶ大変だと思います。</p><p>今回のツールのような方式だと対象のリポジトリの CI に一切手を加えずに実装できるのが大きいです。</p><p>また、 CI の結果を取得する API として CI サービスが提供する API を使って取得することも考えられます。
しかし、 GitHub API を使えば CI サービス毎に実装したりする必要がなくて楽です。</p><p>Slack API を使ってメッセージを投稿するようなことも一瞬考えましたが、 DataDog を使うことで以下のメリットがあります。</p><ul><li>送信先やメッセージのテンプレートとかをツールで管理しなくて良い</li><li>何度もメッセージを送らないように状態を DB で持たなくて良い</li><li>アラートを一時的に止めたりするのも簡単</li></ul><p>また、時間軸でどれだけ CI が壊れた状態だったか、復旧するのにどのくらい時間がかかったか分かるのもなにかに使えるかもしれません。</p><p>今回のツールに限らず、 Slack に直接通知するより DataDog や Sentry を経由したほうが上手くいくことも結構あると思っています。</p><p>また、定期実行する方法としては Lambda 以外にも</p><ul><li>Jenkins</li><li>適当なサーバで cron</li><li>CI サービス</li><li>k8s の CronJob</li><li>k8s の Deployment</li></ul><p>など色々あると思います。そういう風にも実行できるようにバイナリを今後提供したいと思っています。
Lambda を使うとインフラを管理しなくて良いのがメリットだと思います。</p><p>また、 DataDog API で結果を送る push 型のアーキテクチャとは別に、
DataDog Agent + Prometheus Exporter の pull 型もあるんじゃないかなと思います。
そうするとツール側で DataDog API Key が不要になるというメリットがあります。
こちらのパターンも今後実装してみたいと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about github-ci-monitor: CI のステータスを DataDog で監視" href="/github-ci-monitor"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/matchfile">matchfile - 変更されたファイルの一覧から必要なタスクを導出するための CLI ツール</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-10-27T10:39:44.000Z" itemprop="datePublished">October 27, 2020</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自作の CLI ツール matchfile について紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/matchfile" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/matchfile</a></p><p>この記事の執筆時点で最新バージョンは v0.1.1 です。</p><p>変更されたファイルの一覧から実行する必要のあるタスクを導出するための CLI ツールです。
Go で書かれていて、バイナリをダウンロードしてくれば使えます。</p><p>Pull Request (以下 PR) の CI では PR で変更されたファイルに応じて
必要なタスク(build, test, lint, etc) だけを実行したかったりします。</p><p>そこで、 <code>PR で変更されたファイルパスのリスト</code> と <code>タスクが依存するファイルパスの条件</code> を元に、そのタスクを実行する必要があるか判定するためのコマンドとして matchfile を開発しました。</p><p>ただし、 matchfile の機能としては PR や CI とは独立しているので、もっと別の目的でも使えるとは思います。</p><p>matchfile は <code>PR で変更されたファイルパスのリスト</code> や <code>タスクが依存するファイルパスの条件</code> を取得したりする機能はありません。</p><p><code>PR で変更されたファイルパスのリスト</code> は <a href="https://github.com/suzuki-shunsuke/ci-info" target="_blank" rel="noopener noreferrer">ci-info</a> という自分が作った別のツールを使うと取得できます。</p><p><code>タスクが依存するファイルパスの条件</code> はタスクに大きく依存するので matchfile はカバーしていません。</p><p>matchfile の使い方としては</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ matchfile run &lt;PR で変更されたファイルパスのリストが書かれたファイルへのパス&gt; &lt;タスクが依存するファイルパスの条件が書かれたファイルへのパス&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>で、 <code>PR で変更されたファイルパスのリスト</code> のうち一つでも <code>タスクが依存するファイルパスの条件</code> にマッチすれば <code>true</code> を、マッチしなければ <code>false</code> を標準出力します。
コマンドの exit code で結果を表現することも考えられましたが、そうすると <code>set -e</code> しているときに若干面倒くさいので、標準出力で表現しました。</p><p>ごく簡単な例を示します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo template/foo.tpl &gt; changed_files.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ echo template &gt; template_dependencies.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ matchfile run changed_files.txt template_dependencies.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>タスクが依存するファイルパスの条件</code> は独自のフォーマットで指定します。
<a href="https://git-scm.com/docs/gitignore" target="_blank" rel="noopener noreferrer">gitignore のフォーマット</a>にインスパイアされていますが、正規表現が使えるなど、独自のフォーマットになっています。
CI の中でシェルスクリプトで動的に生成することを想定し、行指向のフォーマットになっています。
Go 実装のパーサーが提供されたよく知られた行指向の(コマンドで生成しやすい)フォーマットがあれば良かったんですが、見つからなかったので簡単にフォーマットを定義してみました。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[#][!][&lt;kind&gt;,...] &lt;path&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>1行に1つ条件を書きます。
上から全部評価されます(どれかマッチしても終わりません)。
<code>#</code> はコメントです。行の途中にコメントを書くことはできません。</p><p><code>!</code> は gitignore と似ていますが、その行を評価する時点で評価結果が <code>true</code> であり、<code>!</code> を除いたその行の評価が <code>true</code> の場合、評価結果が <code>false</code> になります。
日本語が下手くそですね。</p><p>簡単な例を示すと、 <code>foo/foo.txt 以外の foo ディレクトリ直下のファイル</code> としたい場合、次のようになります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">glob foo/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!glob foo/foo.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>kind</code> は <code>path</code> をどう扱うかを示していて、幾つか種類があります。</p><ul><li>equal: ファイルパスが文字列として完全に一致すればマッチ</li><li>dir: ファイルパスが <code>&lt;path&gt;/</code> で始まればマッチ</li><li>regexp: 正規表現</li><li>glob: グロブ。 <code>**</code> はサポートされてません</li></ul><p>kind はカンマつなぎで複数指定でき、複数指定した場合は、先に指定したものからマッチするかテストされ、一つでもマッチしたらその条件がマッチするものとして扱われます。</p><p>kind の指定は任意で、指定しない場合、 kind は <code>equal,dir,glob</code> として扱われます。</p><p>つまり</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foo.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>は</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">equal,dir,glob foo.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>と同じです。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about matchfile - 変更されたファイルの一覧から必要なタスクを導出するための CLI ツール" href="/matchfile"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/buildflow-goal">なぜ buildflow を作ったのか</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-10-18T00:53:08.000Z" itemprop="datePublished">October 18, 2020</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>buildflow というツールを開発しているので <code>buildflow</code> というタグをつけて何回かに分けてブログを書きます。</p><p>この記事では なぜ buildflow を作ったのかについて説明します。
開発者である自分の好みや置かれた環境などが所々に反映された内容になっています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="解決したい課題">解決したい課題<a class="hash-link" href="#解決したい課題" title="Direct link to heading">​</a></h2><p>自分は CI/CD の DX の改善に業務として取り組んでいます。
リポジトリはたくさんあり、横断的にメンテナンスしています。
幾つかのリポジトリはモノレポになっており、 CI の複雑さが増していたり、 CI の実行時間が長かったりします。</p><p>現在の CI/CD には以下のような問題があると感じています(他にもあるんですが、 buildflow と関係ないので割愛)。</p><ul><li>実行時間が長い<ul><li>PR とは関係ない処理(test, build, etc) が実行されている</li></ul></li><li>金銭的に高い<ul><li>実行時間が長いので無駄にお金がかかっている</li><li>CI サービスによっては並列度を上げることで実行時間が縮む場合があるが、それでもその分お金がかかる</li></ul></li><li>PR とは直接関係ないところで失敗する<ul><li>PR とは関係ない処理(test, build, etc) が実行されていて、それらが flaky で失敗する</li></ul></li><li>メンテナンス性が悪い<ul><li>属人化気味</li><li>何をやっているのか分かりにくい</li></ul></li><li>同じような機能を複数のリポジトリで実装・メンテしたくない</li></ul><p>これらの問題を解決するために buildflow を開発しました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="buildflow-で必要な処理だけを実行する">buildflow で必要な処理だけを実行する<a class="hash-link" href="#buildflow-で必要な処理だけを実行する" title="Direct link to heading">​</a></h2><p>buildflow では PR の情報を自動で取得し、それらに応じて実行する処理を変更できます。
変更されたファイルに応じてだけでなく、 label や PR の author などでも変更できます。
Tengo script を用いて柔軟なロジックを実装できます。
JSON や YAML の読み込みもサポートしているので、依存関係などの設定を別ファイルで管理することも出来ます。</p><p>一部の CI サービスはこれを解決するための機能を提供しています。
CodeBuild は Webhook の Filter で特定のファイルが変更された場合のみ build を実行できますし、
GitHub Actions でも似たようなことが出来ます。 </p><ul><li><a href="https://docs.github.com/ja/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#onpushpull_requestpaths" target="_blank" rel="noopener noreferrer">https://docs.github.com/ja/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#onpushpull_requestpaths</a></li></ul><p>それらで事足りるならそれでも良いでしょう。
それらだけだと難しい場合、 buildflow を使うとより柔軟に対応できるかもしれません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="並列処理による高速化">並列処理による高速化<a class="hash-link" href="#並列処理による高速化" title="Direct link to heading">​</a></h2><p>シェルスクリプトで for loop などで処理していて時間がかかっている場合、
buildflow で並列処理すると高速化するかもしれません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="メンテナンス性">メンテナンス性<a class="hash-link" href="#メンテナンス性" title="Direct link to heading">​</a></h2><p>buildflow を使わなくても「必要な処理だけを実行」したり「並列処理で高速化」したりはできるでしょう。
それでも buildflow を開発したのは、楽をするため、メンテナンス性を高めるためです。</p><p>PR の情報はよく必要になるので自動で取得するようにしています。</p><p>シェルスクリプトで複雑な CI を実装していると、メンテナンス性が悪くなります。
チームメンバーのシェルスクリプトへの習熟度に依存しますが、
シェルスクリプトはエンジニアなら誰でも書ける分全員が習熟しているとは限りませんし、
容易にバグが生まれます。
チームによりますが、Python や Ruby, Go といった他の言語と比べ、 lint や test がされてないことが多いせいもあるとは思います。
アプリケーションのコードは当然 CI で test, lint するのに、
CI とかのシェルスクリプトはしないというのも珍しくないと思います。</p><p>あとはサポートされているデータ構造が貧弱だったり、関数の I/F がわかりにくかったり、ググりにくい機能が多かったり、
コマンドのオプションを逐一調べないとわからなかったりします。</p><p>余談ですが、 shellcheck や shfmt を使うことをオススメします。
shellcheck を始めて使うと、シェルスクリプトにはこんなに色々罠があるのかと気付かされると思います。</p><p><a href="https://google.github.io/styleguide/shellguide.html" target="_blank" rel="noopener noreferrer">Google の Shell Style Guide</a> では次のように書かれています。</p><blockquote><p>If you are writing a script that is more than 100 lines long, or that uses non-straightforward control flow logic, you should rewrite it in a more structured language now</p></blockquote><p>では Ruby や Python といったスクリプト言語で書いたらどうでしょうか？
シェルスクリプトで挙げた問題は解決すると思いますし、非常に自然で合理的な選択だと思います。</p><p>それでも buildflow を実装したのには、幾つか課題感があったからです。
まずは処理系、サードパーティのライブラリ、 OS パッケージに依存することです。
サードパーティのライブラリは使わなければいい話ですが、 Ruby や Python を使っていれば使いたいという声も出てくることはあるでしょう。
アプリケーションで同じ言語を使っていればそれとの共存も気にしないといけないかもしれません。
buildflow に限らず、自分は Go の「ワンバイナリで動く」という世界観が非常に好きです。</p><p>自分はこれまでシェルスクリプトを Go で書き直すということをやってきました。
その場合以下の2つがありますが、どちらにせよ課題感があります。</p><ul><li>ビルド済みのバイナリを使う<ul><li>配布方法を考えないといけない</li></ul></li><li>スクリプト言語のように <code>go run</code> で実行する<ul><li>他のスクリプト言語と同様の問題がある</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ロジックとコマンドの分離">ロジックとコマンドの分離<a class="hash-link" href="#ロジックとコマンドの分離" title="Direct link to heading">​</a></h2><p>シェルスクリプトを何かしらの言語で書き直す場合、
全てをそれらで書きたいわけではありません。
だからこそ、規模が小さいうちはシェルスクリプトで書くのでしょう。
シェルスクリプトで書いたほうが楽な部分もあるのです。</p><p>buildflow ではコードを以下の3つに分離します。</p><ul><li>設定ファイル(YAML)</li><li>Tengo script</li><li>シェルスクリプト(細かいこと言うと、シェルスクリプト以外も実は使えるけど)</li></ul><p>こうしてシェルスクリプトで書きにくい部分を分離し、適切な粒度で管理することでメンテナンス性を高めるというのが一つの狙いです。
Tengo script は基本的にデータの整形などに役割を限定し、外部ファイルに切り出せるようにすることで
テストしやすいようになっています。</p><p>buildflow にはフレームワークとしての側面があり、
buildflow に乗っかることで共通の機能の実装を省いたり、コードを適切に分割してメンテナンス性を維持することができると期待しています。</p><p>尤もここはトレードオフがあるでしょう。
上記の 3 つを行き来しないといけなくて辛いというフィードバックをもらったこともあります。
コード分割は必須ではないので YAML にインラインで書くことも出来ますが、あまりおすすめしないのと、
そもそも上記のフィードバックはファイルの行き来だけでなく</p><ul><li>buildflow の設定</li><li>Tengo Script</li><li>シェルスクリプト</li></ul><p>という 3 つの異なる言語を行き来するという意味もあるのでしょう。</p><p>それはそういう側面もあるでしょう。
これは buildflow の根本的な部分なので変更されることはないと思います。
もし変更するようなら多分別のツールとして作っているでしょう。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="Direct link to heading">​</a></h2><p>buildflow は自分が直面している CI/CD の課題</p><ul><li>必要な処理だけ実行したい</li><li>共通の処理を逐一実装したくない</li><li>メンテナンス性を高めたい</li></ul><p>を解決するために作りました。</p><p>buildflow はワンバイナリで動きます。
コードを適切に分離し、シェルスクリプトから複雑なロジックを除去することで、メンテナンス性を高めることを目指しています。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/buildflow">buildflow</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about なぜ buildflow を作ったのか" href="/buildflow-goal"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tags/oss/page/2"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tags/oss/page/4"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d45b45d3.js"></script>
<script src="/assets/js/main.5c242a30.js"></script>
</body>
</html>