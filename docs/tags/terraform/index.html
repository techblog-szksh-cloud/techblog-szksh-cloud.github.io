<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">13 posts tagged with &quot;terraform&quot; | Melody</title><meta data-rh="true" property="og:title" content="13 posts tagged with &quot;terraform&quot; | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/tags/terraform"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/tags/terraform"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/terraform" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/terraform" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.078ea440.js" as="script">
<link rel="preload" href="/assets/js/main.1e5265b5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-03">2022-03 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-02">2022-02 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2021-11">2021-11 やったこと</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/update-aqua-v0.7.16">aqua の最近の update (v0.7.4 ~ v0.7.16)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2021-10">2021-10 やったこと</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>13 posts tagged with &quot;terraform&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/create-empty-lambda-by-terraform">Terraform で空の AWS Lambda Function を作る方法</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-06-24T12:25:24.000Z" itemprop="datePublished">June 24, 2021</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform で空の AWS Lambda Function を作ろうとした際にちょっとハマったのでやり方を書いておきます。</p><p>「空の Lambda Function」という表現は適切ではないかもしれませんが、
Lambda で実行するコードのデプロイは Terraform 以外のツールでやるけど、
Lambda Function の作成は Terraform で行うので、 dummy のコードを指定して Terraform で Lambda を作るという話です。</p><p>自分は今は <a href="https://github.com/fujiwara/lambroll" target="_blank" rel="noopener noreferrer">lambroll</a> というツールで Lambda をデプロイしています。
lambroll は Lambda Function も作ってくれるので Terraform で作る必要は必ずしもありません。</p><p>しかし Lambda Function に関連するリソースを Terraform で管理する場合、
Lambda Function も Terraform で作ると Lambda Function の ARN や Invoke ARN を参照できます。</p><p>また lambroll でデプロイする場合も先に Terraform で IAM Role を作成する必要がありますが、
Terraform で aws_lambda_permission のようなリソースを作成するには Lambda Function が先に作られている必要があるので、
互いに依存関係が発生し、面倒なことになります。</p><p>また Lambda Function の削除も Terraform でできるようになります。</p><p>なので、 Terraform で Lambda Function を作っておいたほうが色々都合が良いです。</p><p>Terraform で作成と削除は行うものの、更新をしたいわけではないので、 <code>ignore_changes = all</code> を指定します。</p><p><a href="https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes</a></p><p>Lambda Function を Web UI などから作る場合 Function code はなくても大丈夫ですが、
Terraform で Lambda Function を作る場合、 <code>filename</code> や <code>image_uri</code>, <code>s3_bucket</code> のいずれかが必須になります。
これは issue もありますが、仕様のようにみえます。</p><p><a href="https://github.com/hashicorp/terraform-provider-aws/issues/5945" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-aws/issues/5945</a></p><p>ECR や S3 に dummy のコードを用意するというのも一つの手ですが、環境に依存するのがあまり良い気がしないので、
archive_file data source を使って dummy の zip ファイルを生成するという方法を取ることにしました。</p><p><a href="https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file</a></p><p>次のようなコードで CI で terraform apply を実行しましたが、 zip file がないと言われて失敗しました。</p><div class="codeBlockContainer_I0IT language-tf theme-code-block"><div class="codeBlockContent_wNvx tf"><pre tabindex="0" class="prism-code language-tf codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_lambda_function&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Terraform can create and destroy the remote object but will never propose updates to it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_changes = all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function_name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role          = aws_iam_role.main.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handler  = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runtime  = &quot;provided.al2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename = data.archive_file.dummy.output_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;archive_file&quot; &quot;dummy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = &quot;zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_path = &quot;${path.module}/dummy.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content  = &quot;dummy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Error: unable to load &quot;lambda-base/dummy.zip&quot;: open lambda-base/dummy.zip: no such file or directory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>しかしローカルで terraform plan, apply を実行してみても再現しませんでした。</p><p>CI では Pull Request で plan file を生成して S3 に plan file を upload し、 PR をマージした default branch では terraform plan を実行せずに S3 から plan file をダウンロードして terraform apply を実行しています。</p><p><a href="https://blog.studysapuri.jp/entry/2021/03/10/080000" target="_blank" rel="noopener noreferrer">Pull Request の terraform plan の実行結果を S3 に保存して安全に apply | Quipper Product Team Blog</a></p><p>plan file を指定して terraform apply を実行した際には zip file が作成されず、上記のエラーが発生することがわかりました。</p><p>関連する issue もありました。 <a href="https://github.com/hashicorp/terraform-provider-archive/issues/39" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-archive/issues/39</a></p><p>この issue では幾つかの解決方法が紹介されています。ちなみに 2021-06-24 現在 Hashicorp 側からは特に反応がないように見えます。
random_uuid や random_string を使った方法もありますが、 Lambda を作成するだけなら null_resource に依存させるだけで十分のように思えました。</p><div class="codeBlockContainer_I0IT language-tf theme-code-block"><div class="codeBlockContent_wNvx tf"><pre tabindex="0" class="prism-code language-tf codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;archive_file&quot; &quot;dummy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = &quot;zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_path = &quot;${path.module}/dummy.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content  = &quot;dummy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    null_resource.main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;null_resource&quot; &quot;main&quot; {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように null_resource に依存させると terraform plan では zip file が作られず、 terraform apply ではじめて zip file が作られるため、
terraform apply が失敗することはなくなりました。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/lambda">lambda</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform で空の AWS Lambda Function を作る方法" href="/create-empty-lambda-by-terraform"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-providers-lock">terraform init で lock ファイルが更新される問題の対応</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-04-24T12:57:27.000Z" itemprop="datePublished">April 24, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform v0.14 で local で <code>terraform init</code> すると lock ファイルが更新されてしまう問題に対応しました。</p><p>結論を最初に言うと、 <a href="https://blog.studysapuri.jp/entry/2021/03/12/080000" target="_blank" rel="noopener noreferrer">100 以上の Terraform 環境をいい感じに v0.14 に upgrade した方法</a>で紹介している方法で Renovate で Terraform Provider を update する際に <code>terraform init -upgrade</code> を実行して lock ファイルを更新してコミット・プッシュしているのですが、
その際に <code>terraform providers lock -platform=darwin_amd64</code> を実行するようにしました。</p><p>Terraform v0.14 で lock ファイル <code>.terraform.lock.hcl</code> が導入されました。
Renovate で Terraform Provider を update する際にも lock ファイルを更新する必要があるので、
<code>terraform init -upgrade</code> を実行して lock ファイルを更新してコミット・プッシュしています。
なのですが、ローカルで <code>terraform init</code> を実行するとなんか lock ファイルが更新されることが良くありました。しばらく放置していたのですが、 developer から「なんかファイル更新されたんだけど、これコミットしていいの？」と聞かれ、このまま放っておいて困惑させたりもやっとさせたりするのは良くないなと思い、調べてみました。</p><p>lock ファイルについて <a href="https://speakerdeck.com/minamijoyo/how-to-update-terraform-dot-lock-dot-hcl-efficiently" target="_blank" rel="noopener noreferrer">.terraform.lock.hcl 完全に理解した</a>で詳しく解説されていたので大変助かりました。</p><ul><li>lock ファイルには provider の hash 値が記録されている</li><li>lock ファイルは <code>terraform init</code> で自動的に更新される</li><li>hash 値は platform (Mac, Linux, etc) によって違う</li><li><code>terraform init</code> 実行時に、その platform の hash 値が lock ファイルになければ追加される<ul><li>デフォルトでは実行環境以外の Platform の hash 値は追加されない</li></ul></li><li>CI は Linux 上で実行しているので、 Linux の hash 値だけが記録される</li><li>ローカルで Mac 上で <code>terraform init</code> すると Mac の hash 値が追加され、 lock ファイルに差分が生じる</li></ul><p>なので差分が出てしまった場合はコミットするで良いとは思いますが、そもそも CI で lock ファイルを更新する際に Mac の hash 値も追加してしまえばローカルで Mac 上で <code>terraform init</code> しても差分が出なくなります。ちなみに Windows 上で <code>terraform init</code> する人は自分の周りにはいなさそうなので、 Windows は対応しないことにしました。</p><p><a href="https://blog.studysapuri.jp/entry/2021/03/12/080000" target="_blank" rel="noopener noreferrer">100 以上の Terraform 環境をいい感じに v0.14 に upgrade した方法</a>で紹介しているようにすでに lock ファイルを更新してコミット・プッシュする仕組みはあるので、変更としては 1 (正確にはコードコメント入れて4)行追加するだけでした。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">github-comment exec -- terraform providers lock -platform=darwin_amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about terraform init で lock ファイルが更新される問題の対応" href="/terraform-providers-lock"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-module-template">Terraform Module の Template という使い方</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-04-03T02:04:25.000Z" itemprop="datePublished">April 3, 2021</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform Module の使い方として Terraform Module のテンプレートをコピペして使うというアプローチを紹介します。</p><p>Terraform の設定ファイル(以下 tfファイル) を書く際、毎回一から書くのは大変です。
多くの場合、既存のコードを再利用したほうが楽でしょう。</p><p>Terraform のコードの再利用の仕組みとして、 Module があります。
Module は勿論便利なのですが、使い方には注意が必要で、「安易に Module 化するな。使うな」というふうな考え方もあるでしょう。
自分も基本的に同意見で、 Module を共用するようになると Module への変更がしづらくなったり、パラメータがどんどん増えて複雑になったりします。</p><p>例えば次のように共用の local Module を作成するアプローチがあります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lambda-base/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  foo/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf # リポジトリ直下の modules/lambda-base を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf # リポジトリ直下の modules/lambda-base を参照</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると modules 配下の Module を変更した際にその Module を使っているすべてのサービスに影響が出てしまい、
サービスのオーナーが様々だったり、曖昧だったり不在だったりすると変更が難しいですし、どんどん Module が複雑になったりします。</p><p>Module を別のリポジトリでバージョニングして管理し、バージョンを指定するようにするというやり方もありますが、
結構複雑というか考えることが多いアプローチだとは思います。</p><p>Terraform にそこまで詳しくない developer にも書いてもらうとなると、シンプルなアプローチにするのが望ましいでしょう(当然これは組織によりますが)。</p><p>そこで Module のテンプレートを用意し、 Module を使いたくなったらそれをコピペして使うというアプローチがあります。
例えば <code>lambda-base</code> という Module の Template を foo というサービスの staging 環境と production 環境で使う場合、次のような感じになります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">services/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  foo/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lambda-base/ # templates からコピー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lambda-base/ # templates からコピー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">templates/ # Module のテンプレートを置いておく</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lambda-base/ # 中身は普通の Module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputs.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると 2 つの Module はそれぞれ独立しているため、変更がしやすくなりますし、シンプルに保つことが出来ます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="テンプレートエンジンとかは使わない">テンプレートエンジンとかは使わない<a class="hash-link" href="#テンプレートエンジンとかは使わない" title="Direct link to heading">​</a></h2><p>Module の Template をコピペする際に、コードに変数を埋め込んでコピペする際に置換したりとか、高度なテンプレートエンジンを使って動的に内容を変えたりといったことも考えられますが、
個人的には複雑度が上がるのでやらないほうが良いかなと思っています。
変数であれば Module の input variable として渡せばよいし、テンプレートエンジン使いたいのであれば、テンプレートを分けたり、 HCL で表現したりすればよいのではという気がします。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="考えられるデメリット">考えられるデメリット<a class="hash-link" href="#考えられるデメリット" title="Direct link to heading">​</a></h2><p>通常の Module と比べて、デメリットとしては以下のようなことが考えられます。</p><ul><li>コード量が増える(DRY じゃない)</li><li>Module を一箇所で管理できない<ul><li>一括して変更を加えることが出来ない</li><li>設定を強制することができない</li></ul></li></ul><p>しかし、個人的にはこれは大した問題じゃないと思っています。</p><p>コードが増えることに関しては、それはそうとしか言いようがありません。
一括して変更を加えることが出来ないのは、トレードオフだと思っていて、むしろ対処のサービスを限定しながら Module に変更を加えられるというメリットのほうが大きいと思っています。
設定を強制することができないのは、たしかにそれはあると思っていて、コピペした Module に一括して変更を加えたり Conftest などでテストする仕組みが必要かなと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform Module の Template という使い方" href="/terraform-module-template"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/tfmigrator">terraformer で雑に生成した tf ファイル と state を分割したくてツールを書いた</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-01-31T05:53:23.000Z" itemprop="datePublished">January 31, 2021</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/GoogleCloudPlatform/terraformer" target="_blank" rel="noopener noreferrer">terraformer</a> で雑に生成した Terraform の設定ファイル (以下 tf ファイル) と state を分割したくてツールを書きました。</p><p><a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="経緯">経緯<a class="hash-link" href="#経緯" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="miam-から-terraform-へ移行したい">miam から Terraform へ移行したい<a class="hash-link" href="#miam-から-terraform-へ移行したい" title="Direct link to heading">​</a></h3><p><a href="https://github.com/codenize-tools/miam" target="_blank" rel="noopener noreferrer">miam</a> というツールで管理されている大量のリソースを Terraform で管理したくなりました。
多くの AWS Resource は Terraform で管理されていますが、 IAM に関しては miam で管理されています。
なぜ Terraform ではなく miam で管理されているかというと、当時のことは自分には分かりませんが、歴史的な経緯もあると思います。
昔は今よりも Terraform の表現力が豊かではなく、 Ruby で自由にかける miam のほうが扱いやすかったとか、
miam だと miam でリソースを管理することを強制できるため、権限管理を厳格にやるという観点では都合が良いという点もあるかと思います。</p><p>ではなぜ Terraform で管理したくなったかというと、
一番大きな理由は miam で頻繁に rate limit に引っかかるようになったからです。
Terraform にしろ miam にしろ CI/CD で test, apply が実行されるようになっています。
miam では毎回全部のリソースを対象に処理が実行されるため、リソースの数が増えるにつれて rate limit に引っかかりやすくなります。
CI を rerun すれば成功するのですが、悪いときは 3 回連続で rate limit に引っかかり、 4 回目でようやく成功するということもありました。</p><p>Terraform ではサービスや環境単位で State が分割されており、 CI も PR でファイルが変更された state に対してのみ実行されるため、
rate limit に引っかかることは基本ないようになっています。</p><p>他にも色々理由はあるのですが、本題からそれるのでやめておきます。
rate limit だけなら miam でも exclude する機能があるので頑張ればなんとかなる気はします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="やりたかったこと">やりたかったこと<a class="hash-link" href="#やりたかったこと" title="Direct link to heading">​</a></h3><ul><li>Terraform で既存のリソースを管理したい<ul><li>tf ファイル と state を生成したい</li></ul></li><li>Terraform の設定ファイル と state はサービス・環境ごとに分割したい</li><li>Terraform のリソースパスはヒューマンリーダブルにしたい<ul><li>これは難しければ諦めるのもありだが、できればやりたい</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraformer-で自動生成するも色々問題があった">terraformer で自動生成するも色々問題があった<a class="hash-link" href="#terraformer-で自動生成するも色々問題があった" title="Direct link to heading">​</a></h3><p>まずは terraformer で雑に tf ファイル と state を生成しました。
今回 terraformer を使うのは初めてで、 terraformer で万事解決なら話は簡単だったのですが、話はそんな簡単ではありませんでした。
これに関しては、自分の問題(使い方を間違っている、ドキュメントをちゃんと読んでいない)なのか、 あるいは terraformer 側の問題なのかよく分かってない部分もあります。</p><p>まずドキュメントを読んでもいまいちリソースのフィルタリングの仕方が分かりませんでした。
試しに IAM role の名前を指定してそれだけ import しようとしましたが、なぜか全 IAM リソースが import されてしまいました。</p><p>良くわからないので、これは全 IAM リソースを雑に import してからサービス・環境ごとに分割するしか無いかなぁと思いました。</p><p>加えて、リソースパスが全然ヒューマンリーダブルではありませんでした。 terraformer としてはこれは仕方ないと思いますが、なんとかリネームしたいと思いました。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="最初手作業で始めるも自動化が必要と悟る">最初手作業で始めるも、自動化が必要と悟る<a class="hash-link" href="#最初手作業で始めるも自動化が必要と悟る" title="Direct link to heading">​</a></h3><p>最初特定のサービスに関して手作業で tf ファイル, state を移行する作業を行ってみました。
簡単なシェルスクリプトを書いて半自動化してみました。
tf ファイルの操作には <a href="https://github.com/minamijoyo/hcledit" target="_blank" rel="noopener noreferrer">hcledit</a> が便利です。</p><p>以下のようなコマンドを使いました。</p><ul><li>terraform state mv</li><li>hcledit block get</li><li>hcledit block mv</li><li>hcledit block list</li></ul><p>で、やってみたものの、なにせ対象が多いので、これを一つ一つ手作業でやるのは大変だし、ヒューマンエラーは避けられないと感じました。
そこでちょっとしたツールを作ることにしました。
手作業で一回やった分手順はイメージできているので、割と簡単にできるだろうと思いました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="tfmigrator">tfmigrator<a class="hash-link" href="#tfmigrator" title="Direct link to heading">​</a></h2><p>そこで作ったのが <a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator</a> です。
今回は AWS の IAM リソースを扱いますが、 tfmigrator は特定の provider などには依存しないツールです。
Terraform CLI と hcledit が必要です。</p><p>まず terraformer で IAM リソースを全部 import してきます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraformer import aws -r iam --compact --path-pattern .</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると resources.tf と terraform.tfstate が作られます。</p><p>tfmigrator の設定ファイル tfmigrator.yaml を書きます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 既に Terraform で管理されているものは無視</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&quot;tags&quot; in Values &amp;&amp; Values.tags.ManagedBy == &quot;Terraform&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exclude</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&quot;name&quot; not in Values&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exclude</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `name` に &quot;foo&quot; が含まれているものはサービス foo のリソースとみなして分割</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">rule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Values.name contains &quot;foo&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">state_out</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo/terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resource_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{.Values.name}}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tf_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo/resource.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 以下略</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>tfmigrator の処理の流れをなんとなくそれっぽい擬似言語で表現します。
実際の処理の流れとは若干異なりますが、雰囲気が伝わればと思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">for resource in state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for item config.items</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if item.rule.match(resource)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if item.exclude</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # このリソースは処理せず次のリソースの処理に移る</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        break</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # tf の migration (note: 元の tf はそのまま)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hcledit block get resource.path &lt; tf | hcledit block mv resource.path &quot;${resource.type}.${item.resource_name(resource)}&quot; &gt;&gt; item.tf_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      terraform state mv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 次のリソースの処理に移る</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      break</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>各 item の設定の意味はこんな感じです。</p><ul><li>rule: <a href="https://github.com/antonmedv/expr/blob/master/docs/Language-Definition.md" target="_blank" rel="noopener noreferrer">expr</a> の expression 。この条件にマッチしたリソースをこの item で処理する</li><li>exclude: true の場合、この item にマッチしたリソースは無視する</li><li>state_out: <code>terraform state mv</code> の <code>-state-out</code></li><li>resource_name: 新しいリソース名。デフォルトでは名前はそのまま。 Go の <a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener noreferrer">text/template</a> で処理されます</li><li>tf_path: Terraform の設定ファイルの出力先</li></ul><p>設定ファイルを書いたら tfmigrator を実行します。
いきなりマイグレーションをするというよりは、まずは dry run てきなことをして動作を確認したいですね。
<code>-skip-state</code> をつけると <code>terraform state mv</code> を skip し、分割される tf ファイル を新しいファイルに出力だけします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat *.tf | tfmigrator run -skip-state</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>生成された tf ファイル を眺めて、良さそうなら <code>-skip-state</code> をとって実行します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="tf-ファイル生成時の注意点">tf ファイル生成時の注意点<a class="hash-link" href="#tf-ファイル生成時の注意点" title="Direct link to heading">​</a></h2><p>tf ファイルの生成は現状追記モードで実行されます。なので <code>-skip-state</code> をつけて複数回実行すると同じ設定が重複して書き込まれることになります。
それが困る場合は実行前に対象ファイルを消してから実行してください。</p><p>また、tf ファイルの移行は既存の tf ファイルに対して <code>hcledit block get</code>, <code>hcledit block mv</code> を実行して行われるため、
元の tf ファイルはそのまま残ること、また expression は評価されないことに注意が必要です。
例えば <code>name = var.name</code> のように変数を参照している場合、それもそのまま評価されずに残ります。
とりあえず自分がやりたかったのは terraformer で生成した tf ファイルの移行だったので、そんなに問題にはならないだろうと思っています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="エラーハンドリング">エラーハンドリング<a class="hash-link" href="#エラーハンドリング" title="Direct link to heading">​</a></h2><p>あるリソースの処理でエラーが起こったら即座に異常終了するようにしています。
(当然ですが)ロールバックとかはしません(し、できません)。
エラー出力しつつ次のリソースの処理に移る、というのも考えられますが、間違って <code>terraform state mv</code> されると面倒なので、現状即座に終了するようにしています。
問題のあるリソースを無視したい場合は、 tfmigrator の設定でそのリソースにマッチする item を追加し <code>exclude: true</code> とすればよいでしょう。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="このツールの便利なところ">このツールの便利なところ<a class="hash-link" href="#このツールの便利なところ" title="Direct link to heading">​</a></h2><ul><li>expr を用いてリソースを分類できる</li><li>設定ファイルに記述し、ワン・コマンドで実行できる<ul><li>レビューできる</li><li>後で見返せる</li></ul></li></ul><p>ローカルで試行錯誤しながら複数のコマンドを実行していると、後でなにやったかわからなくなりがちですし、途中で作業を中断したりすると、あとで今どういう状態なのか分からなくなったりします。
ワン・コマンドで実行できるとそういう問題がなくて便利ですね。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="肝心の移行はできたのか">肝心の移行はできたのか<a class="hash-link" href="#肝心の移行はできたのか" title="Direct link to heading">​</a></h2><p>まだできていません。移行するために tfmigrator を作ったので、これから移行していこうという段階です。
なので tfmigrator はまだ全然使い込んでないですし、使ってく中で機能修正したりすることもあると思います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="最後に">最後に<a class="hash-link" href="#最後に" title="Direct link to heading">​</a></h2><p>terraformer で雑に import してきた tf ファイルと state をいい感じに分割するために tfmigrator というツールを作りました。
tfmigrator が役に立つケースは割と限られているというか、日常的に使うようなツールでもないですが、
terraformer で雑に import してきたのは良いが、扱いに困っているなんて人には役に立つかもしれません。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about terraformer で雑に生成した tf ファイル と state を分割したくてツールを書いた" href="/tfmigrator"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/fork-tfnotify">tfnotify を fork した</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-01-02T10:42:10.000Z" itemprop="datePublished">January 2, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/mercari/tfnotify" target="_blank" rel="noopener noreferrer">mercari/tfnotify</a> を Fork して 2 つほど OSS を作りました。</p><ul><li><a href="https://github.com/suzuki-shunsuke/tfnotify" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfnotify</a> - tfnotify と互換性あり</li><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt</a> - tfnotify と互換性がない</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="開発の経緯">開発の経緯<a class="hash-link" href="#開発の経緯" title="Direct link to heading">​</a></h2><p>これまで tfnotify を便利に使わせてもらってたのですが、幾つか改善したいと思うところがあり、本家に PR を投げました。
しかし残念ながらこれまでのところ反応がなく、そこまで本家が活発ではないこと、また他にも色々改修したいところがあったことから、自分でフォークしてメンテすることにしました。
最初は互換性を維持しながら <a href="https://github.com/suzuki-shunsuke/tfnotify" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfnotify</a> を開発していました(今もしています)。
しかし、開発を進めるに連れ、自分にとって必要のないプラットフォームなどに関するコードが邪魔であると感じ、それらを消したバージョンを別に開発することにしました。
互換性がなくなることから、名前も変えて tfcmt としました。</p><p><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt</a></p><p>こういった経緯から、 tfcmt のほうを優先的に開発していますが、 tfcmt で実装した機能を後から suzuki-shunsuke/tfnotify にも実装してたりもします。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="fork-元のバージョン">Fork 元のバージョン<a class="hash-link" href="#fork-元のバージョン" title="Direct link to heading">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/tfnotify" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfnotify</a> は <a href="https://github.com/mercari/tfnotify/releases/tag/v0.7.0" target="_blank" rel="noopener noreferrer">mercari/tfnotify v0.7.0</a> <a href="https://github.com/mercari/tfnotify/commit/fb178d8a5a51f88a51b7fda93ed5443ff56dfc8f" target="_blank" rel="noopener noreferrer">fb178d8</a> をフォークしました。
一方 tfcmt は <a href="https://github.com/suzuki-shunsuke/tfnotify/releases/tag/v1.3.3" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfnotify v1.3.3</a> をフォークしました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="mercaritfnotify-との違い">mercari/tfnotify との違い<a class="hash-link" href="#mercaritfnotify-との違い" title="Direct link to heading">​</a></h2><p>本家との違いは Release Note とドキュメントを参照してください。</p><ul><li>suzuki-shunsuke/tfnotify<ul><li><a href="https://github.com/suzuki-shunsuke/tfnotify/releases" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfnotify/releases</a></li><li><a href="https://github.com/suzuki-shunsuke/tfnotify/blob/master/COMPARED_WITH_TFNOTIFY.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfnotify/blob/master/COMPARED_WITH_TFNOTIFY.md</a></li></ul></li><li>suzuki-shunsuke/tfcmt<ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt/releases</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt/blob/master/COMPARED_WITH_TFNOTIFY.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/tfcmt/blob/master/COMPARED_WITH_TFNOTIFY.md</a></li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about tfnotify を fork した" href="/fork-tfnotify"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/collaborator-of-terraform-docker-provider">Terraform の Docker Provider の Collaborator になりました</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-12-03T00:07:32.000Z" itemprop="datePublished">December 3, 2020</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>先日 <a href="https://github.com/kreuzwerker/terraform-provider-docker" target="_blank" rel="noopener noreferrer">kreuzwerker/terraform-provider-docker</a> の Collaborator になりました。
<a href="https://github.com/kreuzwerker/terraform-provider-docker" target="_blank" rel="noopener noreferrer">kreuzwerker/terraform-provider-docker</a> は Terraform の Docker Provider であり、 Docker コンテナや image, network などを管理できます。
元々は Hashicorp の Official Provider であった <a href="https://github.com/terraform-providers/terraform-provider-docker" target="_blank" rel="noopener noreferrer">terraform-providers/terraform-provider-docker</a> が <a href="https://github.com/kreuzwerker/terraform-provider-docker" target="_blank" rel="noopener noreferrer">kreuzwerker/terraform-provider-docker</a> に移管され、 Community Provider になりました。
元のリポジトリは hashicorp org に移され archive されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="collaborator-になった経緯">Collaborator になった経緯<a class="hash-link" href="#collaborator-になった経緯" title="Direct link to heading">​</a></h2><p>リポジトリが移管される際に、メンテナを募集していて過去に contribution していた自分にも声をかけていただきました。</p><p><a href="https://github.com/hashicorp/terraform-provider-docker/issues/306" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-docker/issues/306</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="contributor-になった経緯">Contributor になった経緯<a class="hash-link" href="#contributor-になった経緯" title="Direct link to heading">​</a></h2><p>自分がこの provider に contribution した経緯は、 Terraform の Hands on を書くのに丁度よい provider を探していたことでした。</p><p>Hands on の題材として Docker コンテナを作ったりできたらいいんじゃないかなと思って Docker provider を試してみました。
しかし当時の docker_container リソースは read をちゃんとサポートしていませんでした。
なので import や update がまともに動きませんでした。
それを見かねて修正して PR を投げたのが最初です。</p><ul><li><a href="https://github.com/hashicorp/terraform-provider-docker/pull/234" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-docker/pull/234</a></li><li><a href="https://github.com/hashicorp/terraform-provider-docker/pull/236" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-docker/pull/236</a></li></ul><p>その後も幾つか contribution をしました。</p><p>なお、 PR を投げたものの、 Hands on は MySQL Provider を使って書きました。</p><p><a href="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform の Docker Provider の Collaborator になりました" href="/collaborator-of-terraform-docker-provider"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/post-tfnotify-parse-error">tfnotify の parse error を通知する</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-09-11T23:05:59.000Z" itemprop="datePublished">September 11, 2020</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/mercari/tfnotify" target="_blank" rel="noopener noreferrer">tfnotify</a> が terraform の標準出力のパースに失敗してコメントを投稿できないことがあります。</p><p>コメントを投稿できなくてもビルドのログには残るのですが、やはりコメントを投稿できると便利なので、tfnotify がパースエラーでコメントの投稿に失敗したら、 <a href="https://github.com/suzuki-shunsuke/github-comment" target="_blank" rel="noopener noreferrer">github-comment</a> でコメントを投稿するようにしました。</p><p>なお、この記事を書いている時点のバージョンは tfnotify v0.7.0, github-comment v1.9.0 です。</p><p>例えば <code>tfnotify plan</code> がパースエラーになった場合、 <code>cannot parse plan result</code> というメッセージが標準エラー出力されます。
そこで標準エラー出力に <code>cannot parse plan result</code> が含まれていたら github-comment でコメントするようにします。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan | github-comment exec -k plan -- tfnotify plan</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>.github-comment.yml</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 細かく template を分けているが、別に分けなくてもよい</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">templates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># header は CodeBuild の場合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{Env &quot;TARGET&quot;}} [Build link]({{Env &quot;CODEBUILD_BUILD_URL&quot;}})&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exit_code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;:{{if eq .ExitCode 0}}white_check_mark{{else}}x{{end}}: Exit Code {{.ExitCode}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">join_command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    $ {{.JoinCommand}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    ```</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hidden_combined_output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    &lt;details&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;pre</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">&lt;code</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">.CombinedOutput</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">&lt;/code</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">&lt;/pre</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/details</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">exec_default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    {{template &quot;header&quot; .}}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">template &quot;exit_code&quot; .</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">template &quot;join_command&quot; .</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">template &quot;hidden_combined_output&quot; .</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">exec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">plan</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Stderr contains &quot;cannot parse plan result&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      {{template &quot;exec_default&quot; .}}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>tfnotify apply</code> の場合は <code>cannot parse apply result</code> というメッセージを出力するので
次のようになります。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply -auto-approve | github-comment exec -k apply -- tfnotify apply</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">exec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apply</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      Stderr contains &quot;cannot parse apply result&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      {{template &quot;exec_default&quot; .}}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="tfnotify-のコードを確認">tfnotify のコードを確認<a class="hash-link" href="#tfnotify-のコードを確認" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/mercari/tfnotify/blob/v0.7.0/terraform/parser.go#L158" target="_blank" rel="noopener noreferrer">https://github.com/mercari/tfnotify/blob/v0.7.0/terraform/parser.go#L158</a></li><li><a href="https://github.com/mercari/tfnotify/blob/v0.7.0/terraform/parser.go#L111" target="_blank" rel="noopener noreferrer">https://github.com/mercari/tfnotify/blob/v0.7.0/terraform/parser.go#L111</a></li><li><a href="https://github.com/mercari/tfnotify/blob/v0.7.0/notifier/github/notify.go#L20-L21" target="_blank" rel="noopener noreferrer">https://github.com/mercari/tfnotify/blob/v0.7.0/notifier/github/notify.go#L20-L21</a></li><li><a href="https://github.com/mercari/tfnotify/blob/v0.7.0/main.go#L193" target="_blank" rel="noopener noreferrer">https://github.com/mercari/tfnotify/blob/v0.7.0/main.go#L193</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tfnotify">tfnotify</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/github-comment">github-comment</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about tfnotify の parse error を通知する" href="/post-tfnotify-parse-error"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-hands-on-with-mysql-provider">Terraform ハンズオン with MySQL Provider</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-17T00:14:08.000Z" itemprop="datePublished">January 17, 2020</time> · <!-- -->40 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、
では手頃な題材はあるかと言われると少し難しいです。</p><p><a href="https://learn.hashicorp.com/terraform/getting-started/build" target="_blank" rel="noopener noreferrer">公式の Getting Started では AWS が使われています</a>が、
AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。
もう少し手軽なものが欲しいところです。</p><p>そこで公式の Provider で丁度いいものはないか探したところ、 <a href="https://www.terraform.io/docs/providers/mysql/" target="_blank" rel="noopener noreferrer">MySQL Provider</a> が良さそうでした。
MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。</p><p>ちなみに公式の Provider のリストはこちらです。</p><ul><li><a href="https://github.com/terraform-providers" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers</a></li><li><a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/index.html</a></li></ul><p>また、 Terraform に関しては <a href="https://techblog.szksh.cloud/terraform-getting-started/" target="_blank" rel="noopener noreferrer">Terraform 入門</a> も参照してください。</p><p>今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。</p><p>以降、コマンドの実行結果は一部省略することがあります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir workspace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd workspace</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-のバージョンと-tfenv">Terraform のバージョンと tfenv<a class="hash-link" href="#terraform-のバージョンと-tfenv" title="Direct link to heading">​</a></h2><p>Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で <code>terraform plan</code> などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。
そういう意味では、 <a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer">tfenv</a> によってバージョン管理するのが良いです。</p><p><code>.terraform-version</code> を作成します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo 0.12.19 &gt; .terraform-version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tfenv install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform v0.12.19</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="mysql-を-docker-で動かす">MySQL を Docker で動かす<a class="hash-link" href="#mysql-を-docker-で動かす" title="Direct link to heading">​</a></h2><p>では MySQL を Docker で動かします。</p><p><a href="https://hub.docker.com/_/mysql?tab=description" target="_blank" rel="noopener noreferrer">https://hub.docker.com/_/mysql?tab=description</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="docker-compose-使う場合">Docker Compose 使う場合<a class="hash-link" href="#docker-compose-使う場合" title="Direct link to heading">​</a></h3><p>docker-compose.yml</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5.7.28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;23306:3306&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">MYSQL_ROOT_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose up -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose ps  # コンテナが起動しているか確認</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>不要になったら削除しましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose rm -sf mysql</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これから Terraform で MySQL の Database を作成します。
作成されているか確認するために MySQL に接続しておきます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose exec mysql mysql -u root -p -P 23306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;  # database の一覧を確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="docker-compose-を使わない場合">Docker Compose を使わない場合<a class="hash-link" href="#docker-compose-を使わない場合" title="Direct link to heading">​</a></h3><p>基本的に Docker Compose 使う場合と変わりません。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run --name terraform-mysql -p &quot;23306:3306&quot; -e MYSQL_ROOT_PASSWORD=password -d mysql:5.7.28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -ti terraform-mysql mysql -u root -p -P 23306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker rm -vf terraform-mysql</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの作成">リソースの作成<a class="hash-link" href="#リソースの作成" title="Direct link to heading">​</a></h2><p>次のような設定ファイルを用意します。</p><p>main.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;mysql&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpoint = &quot;localhost:23306&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username = &quot;root&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password = &quot;password&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>設定できる属性やその意味などはドキュメントを確認してください。</p><p><a href="https://www.terraform.io/docs/providers/mysql/r/database.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/mysql/r/database.html</a></p><p>MySQL Provider の設定として MySQL に接続するための情報と、Terraform によって作成するデータベース <code>foo</code> の設定が定義されています。
password が平文で書かれているのが気になるかもしれませんが、一旦スルーしてください。</p><p>この状態で <code>terraform plan</code> を実行してみます。 <code>terraform plan</code> は <code>terraform apply</code> によるリソースの作成を DRY RUN するコマンドです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Could not satisfy plugin requirements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plugin reinitialization required. Please run &quot;terraform init&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plugins are external binaries that Terraform uses to access and manipulate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resources. The configuration provided requires plugins which can&#x27;t be located,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">don&#x27;t satisfy the version constraints, or are otherwise incompatible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform automatically discovers provider requirements from your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configuration, including providers used in child modules. To see the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">requirements and constraints from each module, run &quot;terraform providers&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: provider.mysql: no suitable version installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version requirements: &quot;(any version)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  versions installed: none</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。</p><blockquote><p>Plugin reinitialization required. Please run &quot;terraform init&quot;.</p></blockquote><p>とある通り、 <code>terraform plan</code> や <code>apply</code> などのコマンドを実行する前に <code>terraform init</code> を実行する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Initializing the backend...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Initializing provider plugins...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Checking for available provider plugins...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Downloading plugin for provider &quot;mysql&quot; (terraform-providers/mysql) 1.9.0...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The following providers do not have any version constraints in configuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">so the latest version was installed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To prevent automatic upgrades to new major versions that may contain breaking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes, it is recommended to add version = &quot;...&quot; constraints to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">corresponding provider blocks in configuration, with the constraint strings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">suggested below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* provider.mysql: version = &quot;~&gt; 1.9&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform has been successfully initialized!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">any changes that are required for your infrastructure. All Terraform commands</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">should now work.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you ever set or change modules or backend configuration for Terraform,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rerun this command to reinitialize your working directory. If you forget, other</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">commands will detect it and remind you to do so if necessary.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Provider のダウンロードが行われています。
<code>terraform init</code> を実行すると <code>.terraform</code> というディレクトリが作成されます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.terraform  .terraform-version  main.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform init</code> は何度でも安全に実行できます。
<code>.terraform</code> を削除した場合でももう一度 <code>terraform init</code> を実行すれば問題ありません。</p><p>次に <code>terraform plan</code> を実行します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Refreshing Terraform state in-memory prior to plan...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The refreshed state will be used to calculate this plan, but will not be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persisted to local or remote state storage.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">An execution plan has been generated and is shown below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resource actions are indicated with the following symbols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note: You didn&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">can&#x27;t guarantee that exactly these actions will be performed if</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;terraform apply&quot; is subsequently run.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>Plan: 1 to add, 0 to change, 0 to destroy.</p></blockquote><p>とある通り、リソースが 1 つ作成されるようです。 DRY RUN なのでまだ作成されてません。</p><p>では実際に作成してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">An execution plan has been generated and is shown below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resource actions are indicated with the following symbols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you want to perform these actions?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will perform the actions described above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Only &#x27;yes&#x27; will be accepted to approve.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creation complete after 0s [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>途中確認があるので <code>yes</code> と入力すると実際に変更が適用されます。</p><p>本当に Database が作られているか確認します。
MySQL クエリを叩きます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 rows in set (0.01 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;foo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | foo         | utf8                       | utf8_general_ci        | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ありました。</p><p>すると <code>terraform.tfstate</code> というファイルが作られているはずです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose.yml main.tf  terraform.tfstate</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こんな JSON ファイルになります。</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;terraform_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.12.19&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;serial&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;lineage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;7011a551-bfa1-96a5-4153-2c9d6f32251c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;outputs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;resources&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;managed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mysql_database&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;provider.mysql&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;instances&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;schema_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;attributes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_character_set&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_collation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8_general_ci&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bnVsbA==&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>管理されているリソースの情報と、 Terraform のバージョンなどのメタ情報が保存されています。
このファイルは基本的に terraform によって更新されるものであり、人間が手で修正するものではありません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="古い-terraform-を使ってみる">古い Terraform を使ってみる<a class="hash-link" href="#古い-terraform-を使ってみる" title="Direct link to heading">​</a></h2><p>ここであえて古いバージョンの Terraform を使って <code>terraform plan</code> を実行してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo 0.12.12 &gt; .terraform-version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tfenv install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error locking state: Error acquiring the state lock: state snapshot was created by Terraform v0.12.19, which is newer than current v0.12.12; upgrade to Terraform v0.12.19 or greater to work with this state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform acquires a state lock to protect the state from being written</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">by multiple users at the same time. Please resolve the issue above and try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">again. For most commands, you can disable locking with the &quot;-lock=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag, but this is not recommended.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。 State の lock に失敗したようです。 State の lock については <a href="https://techblog.szksh.cloud/terraform-state-locking/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/terraform-state-locking/</a> も参照してください。</p><p>このように古いバージョンの terraform は使えません。
一方新しいバージョンを使うには問題なく使えますが、 State の <code>terraform_version</code> が更新され、それまでのバージョンを使ってた人が突然 <code>terraform plan</code> などができなくなりますので、注意が必要です。</p><p>これが前述した意味になります。</p><blockquote><p>Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で <code>terraform plan</code> などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。</p></blockquote><p>では元のバージョンに戻しましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo 0.12.19 &gt; .terraform-version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの更新">リソースの更新<a class="hash-link" href="#リソースの更新" title="Direct link to heading">​</a></h2><p>同じ調子でもう一つ Database を作ってみましょう。
Database foo の設定をコピーして <code>terraform plan</code> を実行します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Duplicate resource &quot;mysql_database&quot; configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 11:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11: resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A mysql_database resource named &quot;foo&quot; was already declared at main.tf:7,1-32.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resource names must be unique per type in each module.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。エラーメッセージの通り、リソースパスはユニークでないといけません。
修正しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;bar&quot; { # &quot;foo&quot; を &quot;bar&quot; に変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>作成されるようです。 apply してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error 1007: Can&#x27;t create database &#x27;foo&#x27;; database exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 11, in resource &quot;mysql_database&quot; &quot;bar&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11: resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。同じ名前のデータベースは作成できないので当然です。
このように plan に成功しても apply に失敗することはあります。</p><p>では name を修正しましょう。ついでに database foo の default character set を修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot; # default character set を修正。デフォルトは utf8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;bar&quot; # 名前を foo から bar に変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8&quot; -&gt; &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Modifying... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Creation complete after 0s [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error 1253: COLLATION &#x27;utf8_general_ci&#x27; is not valid for CHARACTER SET &#x27;utf8mb4&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 7, in resource &quot;mysql_database&quot; &quot;foo&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   7: resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>mysql_database.foo の変更に失敗しました。一方 mysql_database.bar の作成には成功しています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| bar                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6 rows in set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;foo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | foo         | utf8                       | utf8_general_ci        | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように、一部の変更の適用に失敗にしても、その他の変更は適用されるという、ある意味中途半端に apply される場合があります。こういった場合に rollback するようなコマンドはないので気をつけましょう。適用された変更はちゃんと State に反映されています。</p><p>では mysql_database.foo の変更に失敗したので、適切に設定を変更しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot; # utf8_general_ci から変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>apply に <code>--auto-approve</code> というオプションをつけると確認なしに適用されます。CIで実行する場合には基本これをつけることになると思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Modifying... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Modifications complete after 0s [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 0 added, 1 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>変更できました。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;foo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | foo         | utf8mb4                    | utf8mb4_general_ci     | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraformtfstatebackup">terraform.tfstate.backup<a class="hash-link" href="#terraformtfstatebackup" title="Direct link to heading">​</a></h2><p>ところで <code>terraform.tfstate.backup</code> というファイルが作られています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose.yml main.tf  terraform.tfstate  terraform.state.backup</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これは名前の通り <code>terraform.tfstate</code> のバックアップです。
<code>terraform.tfstate</code> が terraform のコマンドによって更新される前に自動的にバックアップが作成されます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの-recreate">リソースの recreate<a class="hash-link" href="#リソースの-recreate" title="Direct link to heading">​</a></h2><p>今度は database の名前を変更してみましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot; # foo から変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo must be replaced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-/+ resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ id                    = &quot;foo&quot; -&gt; (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ name                  = &quot;foo&quot; -&gt; &quot;foo2&quot; # forces replacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 1 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>先程 default_collation と default_character_set を変更した際は既存のデータベースが更新されましたが、今度は新しく作り直されるようです。
これはリソースの定義に依存します。ソースコードを確認しましょう。</p><p><a href="https://github.com/terraform-providers/terraform-provider-mysql/blob/v1.9.0/mysql/resource_database.go#L31" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers/terraform-provider-mysql/blob/v1.9.0/mysql/resource_database.go#L31</a></p><p>属性の定義で <code>ForceNew: true</code> となっている場合、その属性が変更されるとリソースが作り直されます。デフォルトだと既存のリソースの更新になります。
新しく作り直されるということは、テーブルなどは消えるはずです。試しにテーブルを作っておいて、 apply してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Empty set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; create table foo.zoo (id int);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 0 rows affected (0.03 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Tables_in_foo |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| zoo           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Destroying... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creation complete after 0s [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 1 added, 0 changed, 1 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>mysql_database.foo: Destroying... <!-- -->[id=foo]</p></blockquote><p>とあるように一度削除されています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR 1049 (42000): Unknown database &#x27;foo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Empty set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>新しいデータベースには先程作成したテーブルがありません。このように recreate は危険な操作なのでやるときには注意を払いましょう。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変数の利用">変数の利用<a class="hash-link" href="#変数の利用" title="Direct link to heading">​</a></h2><p>変数を使ってみましょう。設定を修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = var.default_character_set  # 変数 default_character_set を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Reference to undeclared input variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 9, in resource &quot;mysql_database&quot; &quot;foo&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   9:   default_character_set = var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">An input variable with the name &quot;default_character_set&quot; has not been declared.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This variable can be declared with a variable &quot;default_character_set&quot; {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">block.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>エラーになりました。変数を利用するには宣言が必要です。
<code>variables.tf</code> というファイルを作成しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;default_character_set&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>値の入力を求められました。これは変数の値が設定されていないからです。
ここでは <code>foo</code> と入力してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8mb4&quot; -&gt; &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-input=false</code> にすると入力を求められずにエラーを返します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -input=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: No value for required variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on variables.tf line 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1: variable &quot;default_character_set&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The root module input variable &quot;default_character_set&quot; is not set, and has no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default value. Use a -var or -var-file command line argument to provide a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value for this variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform.tfvars</code> というファイルを作成し、値を設定しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">default_character_set = &quot;utf8mb4&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform.tfvars</code> は特別なファイル名で、カレントディレクトリにこのファイルがあると自動で読み込まれます。</p><p>ファイル名を変えて terraform plan をしてみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mv terraform.tfvars main.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>聞かれました。 main.tfvars が読み込まれていません。 <code>-var-file</code> オプションでファイルを指定すれば main.tfvars を読み込めます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -var-file=main.tfvars</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>もとに戻しておきます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mv main.tfvars terraform.tfvars</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="他のリソースの属性の参照">他のリソースの属性の参照<a class="hash-link" href="#他のリソースの属性の参照" title="Direct link to heading">​</a></h2><p>設定を修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = mysql_database.foo.default_character_set  # 他のリソースの属性を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;  # default_character_set に合わせて変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8&quot; -&gt; &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;utf8_general_ci&quot; -&gt; &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Modifying... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Modifications complete after 0s [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 0 added, 1 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state-rm">terraform state rm<a class="hash-link" href="#terraform-state-rm" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/state/rm.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/rm.html</a></p><p>Terraform は State によって設定ファイル中のリソースと実際のリソースをマッピングしています。
State からリソースを削除して <code>terraform plan</code> を実行してみると、 Terraform はそのリソースを新規で作成しようとします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform state rm mysql_database.bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Removed mysql_database.bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully removed 1 resource instance(s).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>実際には同じ名前のデータベースは作成できないので <code>apply</code> で失敗するはずです。
<code>terraform state rm</code> は元々 Terraform で管理していたものを Terraform で管理するのを止めたり、あるいは手動で削除してしまったリソースを State からも削除するのに使えます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-import">terraform import<a class="hash-link" href="#terraform-import" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a>
<a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/import.html</a></p><p><code>terraform import</code> は Terraform で管理されていないリソースを Terraform で管理するために State にリソースのデータを取り込むコマンドです。
ちょうど <code>mysql_database.bar</code> を State から消してしまったので、 import することにしましょう。</p><p><a href="https://www.terraform.io/docs/providers/mysql/r/database.html#import" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/mysql/r/database.html#import</a> にある通り、データベースはデータベース名を指定すれば import 出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import mysql_database.bar bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Importing from ID &quot;bar&quot;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Import prepared!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Prepared mysql_database for import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Import successful!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The resources that were imported are shown above. These resources are now in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">your Terraform state and will henceforth be managed by Terraform.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Import 出来ました。 <code>terraform plan</code> を実行して差分がなくなっていることを確認します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>次に手動で Database を作成してそれを import してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; create database zoo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 1 row affected (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import mysql_database.zoo zoo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: resource address &quot;mysql_database.zoo&quot; does not exist in the configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before importing this resource, please create its configuration in the root module. For example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # (resource arguments)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。 <code>mysql_database.zoo</code> が存在しないからです。
空で良いのでリソースの設定を追加しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import mysql_database.zoo zoo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Importing from ID &quot;zoo&quot;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Import prepared!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Prepared mysql_database for import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Refreshing state... [id=zoo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Import successful!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The resources that were imported are shown above. These resources are now in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">your Terraform state and will henceforth be managed by Terraform.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Import 出来たので zoo を Terraform で管理できるようになりました。
<code>terraform plan</code> を実行してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Missing required argument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 19, in resource &quot;mysql_database&quot; &quot;zoo&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  19: resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The argument &quot;name&quot; is required, but no definition was found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>zoo の設定が空で name が設定されていないので失敗しました。
修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;latin1&quot; -&gt; &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;latin1_swedish_ci&quot; -&gt; &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>まだ差分が出てしまいました。</p><p>Import は State にはリソースのデータを反映してくれますが、設定ファイルには反映してくれないので自分で反映させる必要があります。
一部の Provider では、設定ファイルに自動で反映させるためのサードパーティのツールもあります。</p><p>修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;latin1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;latin1_swedish_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>無事差分がなくなりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの削除">リソースの削除<a class="hash-link" href="#リソースの削除" title="Direct link to heading">​</a></h2><p>次にリソースを削除してみます。</p><p><code>terraform destroy</code> もありますが、今回は設定をコメントアウトします。
ちなみに Terraform の設定ファイルの記述言語である HCL ではコメントアウトは <code>#</code> でも <code>//</code> でもどちらでも良いです。</p><p><a href="https://github.com/hashicorp/hcl#syntax" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/hcl#syntax</a></p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   default_character_set = mysql_database.foo.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;bar&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;bar&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 0 to change, 1 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Destroying... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 0 added, 0 changed, 1 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo2               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| zoo                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>確かに削除されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state-mv">terraform state mv<a class="hash-link" href="#terraform-state-mv" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/state/mv.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/mv.html</a></p><p>ここで リソースの名前を変えて <code>terraform plan</code> してみましょう。名前を変えたくなることはまぁあると思います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo2&quot; { # foo から foo2 に変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;foo2&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;foo2&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo2 will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;foo2&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 1 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>既存のデータベースが削除されて新しいデータベースが作成されてしまいそうです。
State に記録されているリソースのパスを修正する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform state mv mysql_database.foo mysql_database.foo2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Move &quot;mysql_database.foo&quot; to &quot;mysql_database.foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully moved 1 object(s).</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>差分がなくなりました。</p><p>このようにコマンドによって State を更新する必要があるので、特に複数人で作業する場合は安易にリソースパスを変更するべきではありません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-refresh">terraform refresh<a class="hash-link" href="#terraform-refresh" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/refresh.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/refresh.html</a></p><p><code>terraform refresh</code> は実際のインフラの情報を取得して State に反映させるコマンドです。
Terraform を使わずに加えた変更を State に反映させるのに使えます。
Terraform を使ってインフラを管理している以上、 Terraform を使わずにインフラを変更するのは望ましくないですが、実際のところはよくある話かと思います。</p><p>Terraform を使わずに default_character_set を変更してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; ALTER DATABASE zoo DEFAULT CHARACTER SET utf8mb4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 1 row affected (0.01 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;zoo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | zoo         | utf8mb4                    | utf8mb4_general_ci     | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>default_character_set を変えると自動で DEFAULT_COLLATION_NAME も変わりました。
設定ファイルにも変更を反映させましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-refresh=false</code> をつけて terraform plan を実行してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -refresh=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;latin1&quot; -&gt; &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;latin1_swedish_ci&quot; -&gt; &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Resource targeting is in effect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You are creating a plan with the -target option, which means that the result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of this plan may not represent all of the changes requested by the current</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The -target option is not for routine use, and is provided only for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exceptional situations such as recovering from errors or mistakes, or when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform specifically suggests to use it as part of an error message.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>差分が出てしまいました。これは State が更新されていないからです。
terraform.tfstate を確認してみましょう。</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;managed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mysql_database&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;provider.mysql&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;instances&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;schema_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;attributes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_character_set&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latin1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_collation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latin1_swedish_ci&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-refresh=false</code> を取ると今度は差分がなくなるはずです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これは、実は terraform plan はデフォルトでは State の内容と設定ファイルを比較する前に実際のインフラの情報を取得し State の内容をインメモリで更新した上で設定ファイルと比較しているからです。
ただし、インメモリでの更新であり、実際の State が更新されているわけではないです。</p><p>今までスルーしてきましたが、そのことは terraform plan の結果でも説明されています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Refreshing Terraform state in-memory prior to plan...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The refreshed state will be used to calculate this plan, but will not be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persisted to local or remote state storage.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ではなんで <code>-refresh=false</code> が必要になるかというと、理由の一つとして <code>terraform plan</code> が速くなることが挙げられます。
むしろ <code>-refresh=false</code> をつけないと、管理するリソースの数が増えれば増えるほど情報を取得してくるのに時間がかかるようになりますし、
場合によっては API の rate limit に引っかかるなんてこともあるかもしれません。</p><p>なので普段 <code>-refresh=false</code> をつけて <code>terraform plan</code> を実行するようにしていると Terraform を使わずに加えたインフラの修正を State に取り込むために <code>terraform refresh</code> を実行する必要が出てきたりします。</p><p>State は更新されていないので <code>-refresh=false</code> とすれば相変わらず差分は出ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -refresh=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8mb4&quot; -&gt; &quot;latin1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; &quot;latin1_swedish_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>差分が出ました。 <code>terraform refresh</code> を実行すると State が更新され、差分がなくなるはずです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform refresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Refreshing state... [id=app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Refreshing state... [id=zoo]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;managed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mysql_database&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;provider.mysql&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;instances&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;schema_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;attributes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_character_set&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8mb4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_collation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8mb4_general_ci&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -refresh=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="module">Module<a class="hash-link" href="#module" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/modules.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/modules.html</a></p><p>簡単なモジュールを作ってみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi database/database.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>では Module を使って database を作ってみます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Module not installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 25:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  25: module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This module is not yet installed. Run &quot;terraform init&quot; to install all modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">required by this configuration.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。 <code>terraform init</code> する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # module.app.mysql_database.db will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-パラメータ">Module パラメータ<a class="hash-link" href="#module-パラメータ" title="Direct link to heading">​</a></h3><p>これで Module を使って Database を作れましたが、 name が &quot;app&quot; 固定なので使いづらいですね。名前を変えられるようにしましょう。</p><p>database/database.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = var.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>database/variables.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Missing required argument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 25, in module &quot;app&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  25: module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The argument &quot;name&quot; is required, but no definition was found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>必須パラメータを指定していないので失敗しました。デフォルト値を設定しましょう。</p><p><a href="https://www.terraform.io/docs/configuration/variables.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/variables.html</a></p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>パラメータを渡して name を変更しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name   = &quot;app2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # module.app.mysql_database.db must be replaced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-/+ resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ id                    = &quot;app&quot; -&gt; (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ name                  = &quot;app&quot; -&gt; &quot;app2&quot; # forces replacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>パラメータを渡せました。もとに戻しておきます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name   = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-output">Module Output<a class="hash-link" href="#module-output" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/configuration/outputs.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/outputs.html</a></p><p>mysql_database.bar から mysql_database.foo の属性を参照したように、 <code>module.app</code> で作成したデータベースの属性を参照するにはどうしたらよいでしょうか？
モジュール内であれば普通に参照できますが、モジュールの外から参照するには、 Module 側で明示的に公開する必要があります。不便な側面もあるかもしれませんが、カプセル化とも言えますね。</p><p>default_character_set を公開しましょう。</p><p>database/output.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;default_character_set&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = mysql_database.db.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>そして参照します。</p><p>main.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = module.app.default_character_set  # 参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-destroy">terraform destroy<a class="hash-link" href="#terraform-destroy" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/destroy.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/destroy.html</a></p><p>ここまでお疲れさまでした。
ハンズオンの最後にこれまで作ったデータベースを削除してしまいましょう。
<code>-target</code> オプションでリソースパスを指定して特定のリソースだけ削除できます。
<code>-target</code> オプションは複数回指定することで複数のリソースを指定できます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy -target=module.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # module.app.mysql_database.db will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;app&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;app&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 0 to change, 2 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you really want to destroy all resources?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will destroy all your managed infrastructure, as shown above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>module.app を消そうとしたら、 mysql_database.zoo も削除されそうになっています。
これは mysql_database.zoo が module.app の属性に依存しているからです。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = module.app.default_character_set  # module.app に依存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-target</code> オプションで <code>mysql_database.zoo</code> を指定すればそれだけ削除されます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy -target=mysql_database.zoo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 0 to change, 1 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you really want to destroy all resources?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will destroy all your managed infrastructure, as shown above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>確認されるので、 yes と入力して削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Destroying... [id=zoo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Applied changes may be incomplete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The plan was created with the -target option in effect, so some changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">requested in the configuration may have been ignored and the output values may</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">not be fully updated. Run the following command to verify that no other</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes are pending:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that the -target option is not suitable for routine use, and is provided</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">only for exceptional situations such as recovering from errors or mistakes, or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">when Terraform specifically suggests to use it as part of an error message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destroy complete! Resources: 1 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| app                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo2               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>確かに消えています。
設定ファイルからは消えていないので <code>terraform plan</code> を実行すると Create しようとします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>リソースパスを指定しないと全てのリソースを削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Refreshing state... [id=app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Destroying... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Destroying... [id=app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destroy complete! Resources: 2 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>全部消えました。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform ハンズオン with MySQL Provider" href="/terraform-hands-on-with-mysql-provider"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-getting-started">Terraform 入門</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-16T00:25:05.000Z" itemprop="datePublished">January 16, 2020</time> · <!-- -->26 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="参考">参考<a class="hash-link" href="#参考" title="Direct link to heading">​</a></h2><ul><li><a href="https://qiita.com/Chanmoro/items/55bf0da3aaf37dc26f73" target="_blank" rel="noopener noreferrer">10分で理解するTerraform | Qiita</a></li><li><a href="https://qiita.com/fukubaka0825/items/68506b1e6644404d6cc0" target="_blank" rel="noopener noreferrer">Terraform入門資料(v0.12.0対応) ~基本知識から設計や運用、知っておくべきtipsまで~ | Qiita</a></li><li><a href="https://dev.classmethod.jp/cloud/terraform-getting-started-with-aws/" target="_blank" rel="noopener noreferrer">AWSでTerraformに入門 | Developers.io</a></li><li><a href="https://qiita.com/minamijoyo/items/1f57c62bed781ab8f4d7" target="_blank" rel="noopener noreferrer">Terraform職人入門: 日々の運用で学んだ知見を淡々とまとめる | Qiita</a></li></ul><p>手を動かしたい方は <a href="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/" target="_blank" rel="noopener noreferrer">Terraform ハンズオン with MySQL Provider</a> も参考にしてください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="前提">前提<a class="hash-link" href="#前提" title="Direct link to heading">​</a></h2><ul><li>執筆時点 (2020/01/05) で Terraform の最新バージョンは v0.12.18 です</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-とは">Terraform とは<a class="hash-link" href="#terraform-とは" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> は Infrastructure as Code を実現する汎用的なCLIツールです。
インフラの状態を設定ファイルに定義し、コマンドを実行することで、
実際のインフラの状態と設定ファイルの差分を検知し、設定ファイルに記述されたとおりになるようにインフラを変更(CRUD)します。</p><p><a href="https://www.hashicorp.com/" target="_blank" rel="noopener noreferrer">Hashicorp</a> という企業がホストしている OSS になります。
Go で書かれています。 <a href="https://github.com/hashicorp/terraform" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-のインストール">Terraform のインストール<a class="hash-link" href="#terraform-のインストール" title="Direct link to heading">​</a></h2><p>Terraform は Go 製なので 1 バイナリをダウンロードしてインストールするだけです。</p><p><a href="https://www.terraform.io/downloads.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/downloads.html</a></p><p>tfenv を使うと管理が楽です。</p><p><a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer">https://github.com/tfutils/tfenv</a></p><p>tfenv は Terraform のバージョン管理ツールです。
pyenv や rbenv の Terraform 版みたいなものです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="用語集">用語集<a class="hash-link" href="#用語集" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="provider">Provider<a class="hash-link" href="#provider" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html#terraform-provider" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#terraform-provider</a></p><p>Terraform を「汎用的な」ツールといいましたが、ここでいう「汎用的」とは、 AWS などの特定のサービス専用ではなく、様々なサービスを同じように扱うことが出来るという意味です。
実際に AWS などのインフラを操作する場合にはインフラが提供する API を利用するわけですが、
サービス固有の API 呼び出しなどの処理を <code>Provider</code> という形で Terraform 本体から切り出すことでこの汎用性は実現されています。
Provider は AWS や GCP などの Hashicorp 公式のものもあれば、サードパーティ製のものもありますし、自分で作ってしまうことも出来ます。</p><ul><li>公式 Provider<ul><li><a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/index.html</a></li><li><a href="https://github.com/terraform-providers" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers</a></li></ul></li><li>サードパーティ Provider<ul><li><a href="https://www.terraform.io/docs/providers/type/community-index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/type/community-index.html</a></li><li>[宣伝][Graylog]<!-- -->(<a href="https://www.graylog.org/products/open-source" target="_blank" rel="noopener noreferrer">https://www.graylog.org/products/open-source</a>) の Provider <a href="https://github.com/suzuki-shunsuke/go-graylog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog</a></li></ul></li></ul><p>少し突っ込んだ話をすると、 Terraform 本体同様 Provider も実態は Golang で書かれた1バイナリであり、本体から Provider を RPC によって呼び出すという形でプラグイン機構を実現しています。
<a href="https://github.com/hashicorp/go-plugin" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/go-plugin</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="余談-provider-の自作">余談: Provider の自作<a class="hash-link" href="#余談-provider-の自作" title="Direct link to heading">​</a></h3><p>Provider の自作に興味のある方は <a href="https://www.terraform.io/docs/extend/writing-custom-providers.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/extend/writing-custom-providers.html</a> を読むと良いでしょう。
ただし、それを読めば全てわかるということはなく、作りながら Terraform 本体や AWSなどの公式の Provider のソースコードや GoDoc を読みつつ試行錯誤することになると思います。</p><ul><li><a href="https://github.com/terraform-providers/terraform-provider-aws/tree/master/aws" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers/terraform-provider-aws/tree/master/aws</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#Schema" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#Schema</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#ResourceData" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#ResourceData</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソース">リソース<a class="hash-link" href="#リソース" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html#resource" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#resource</a></p><p>Terraform ではインフラを構成する最小の構成要素を <code>リソース</code> と呼びます。
例えばサーバが 3 台あればそれぞれが別々のリソースと言えます。
リソースごとに設定を記述します。
<code>terraform apply</code> コマンドを実行すると各リソースについて設定と実際のインフラの状態の差分が検知され、リソースごとに CRUD 処理が実行されます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="設定ファイル">設定ファイル<a class="hash-link" href="#設定ファイル" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/configuration/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/index.html</a></li><li><a href="https://github.com/hashicorp/hcl/blob/hcl2/hclsyntax/spec.md" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/hcl/blob/hcl2/hclsyntax/spec.md</a></li></ul><p>設定ファイルは <a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener noreferrer">HCL</a> という言語で記述します。
HCL は Hashicorp Configuration Language の略で、 Hashicorp が開発している JSON や YAML のような設定を記述する言語です。</p><p>Terraform v0.12 では HCL の v2 を使います。 v1 は古いので注意してください。</p><p>設定ファイルの拡張子は基本 <code>.tf</code> です。
次のような形でリソースを定義します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># resource &quot;リソースの種類&quot; &quot;リソース名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_instance&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 属性名 = 属性値</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ami           = &quot;ami-2757f631&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_type = &quot;t2.micro&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>余談ですが、 <a href="https://github.github.com/gfm/" target="_blank" rel="noopener noreferrer">GFM (GitHub Flavored Markdown)</a> では <code>hcl</code> でシンタックスハイライトができます。</p><p>各リソース定義はパスによって識別されます。
上記のようなシンプルなリソースの定義の場合 <code>リソースの種類.リソース名</code> (<code>aws_instance.example</code>) です。パスは一意でなければいけません。</p><p>設定ファイルは同じ1つのディレクトリに置きます。
<code>terraform plan</code> などのコマンドはカレントディレクトリ直下のファイルしか見ません。</p><p>リソースの属性はリソースの種類によって異なります。
各Provider のドキュメントを参照しましょう。</p><p>例えば AWS の EC2 instance のドキュメントはこちらです。 <a href="https://www.terraform.io/docs/providers/aws/r/instance.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/aws/r/instance.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの属性の参照">リソースの属性の参照<a class="hash-link" href="#リソースの属性の参照" title="Direct link to heading">​</a></h2><p>あるリソースの設定で他のリソースの属性値を参照することが出来ます。</p><p>サンプルを示します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_instance_profile&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # リソース aws_iam_role.example の属性 name の値を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role = aws_iam_role.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="state">State<a class="hash-link" href="#state" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/index.html</a></p><p>設定ファイルと実際のインフラの差分を検知するには、設定ファイルのリソース定義と実際のインフラのマッピングが必要になります。
設定ファイル上ではリソースはパスによって識別されますが、実際のインフラのリソースはインフラ固有の ID などで識別されます。
設定ファイル上のリソースのパスと、実際のインフラのリソースの ID とのマッピングを保存するストレージが <code>State</code> になります。
ただし State の役割はマッピングだけではありません。詳細は <a href="https://www.terraform.io/docs/state/purpose.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/purpose.html</a> を参照してください。
「ストレージ」といいましたがその実態はデフォルトではただの JSON ファイルです。
デフォルトでは <code>terraform apply</code> などを実行すると勝手に <code>terraform.tfstate</code> という名前のファイルがカレントディレクトリに作成、更新されます。
State の保存先は S3 を含め色々サポートされています。</p><p><a href="https://www.terraform.io/docs/backends/types/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/index.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-state-を持たないツールとの違い">発展: State を持たないツールとの違い<a class="hash-link" href="#発展-state-を持たないツールとの違い" title="Direct link to heading">​</a></h3><p>Terraform の他にもインフラを管理するツールはありますが、その中には State のようなマッピングを持たないものもあります。
マッピングを持たないツールだと、ツールを使わずに作ったリソースがツールによって削除される可能性があります。
一方、 Terraform ではツールを使わずに作ったリソースは変更の対象になりません。
変更の対象にしたい場合はそのリソースの情報を State に追加する必要があります。
ただの JSON ファイルなので手で修正することも出来ますが、 <a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">terraform import</a> という専用のコマンドがあるのでそれを使うほうが安全です。</p><p><a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a></p><p>逆に、あまりないケースではありますが、あるリソースについて Terraform で管理するのをやめたい場合、
そのリソースを設定ファイルだけでなく State からも削除する必要があります。
単純に設定ファイルから削除するだけだと、 Terraform によって実際のインフラのリソースが削除されてしまいます。
State から削除するには <a href="https://www.terraform.io/docs/commands/state/rm.html" target="_blank" rel="noopener noreferrer">terraform state rm</a> というコマンドを使います。</p><p>その他 State を管理するためのコマンドが色々あるのでドキュメントを参照してください。</p><p><a href="https://www.terraform.io/docs/commands/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/index.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-remote-state-を使うか否か">発展: Remote State を使うか否か<a class="hash-link" href="#発展-remote-state-を使うか否か" title="Direct link to heading">​</a></h3><p>Terraform を CI/CD によって実行する前提です。
基本的に remote state を使うべきだと思います。</p><p>remote state を使わない場合、 <code>terraform.tfstate</code> を Git で管理することになるでしょう。
その場合、 feature branch の terraform.tfstate と実際のインフラの状態の乖離が起こりえます。
チームの規模が大きく複数の開発が並行して行われれば行われるほど、乖離の弊害が大きくなり、 remote state を使ったほうが良いということになるでしょう。</p><p>また、 CI/CD で更新された <code>terraform.tfstate</code> を commit &amp; push する必要があります。
<code>terraform apply</code> で失敗した場合、一部のリソースの更新には成功し、State が更新されているかもしれません。
<code>terraform apply</code> が失敗しても即座に終了させずに <code>terraform.tfstate</code> を commit &amp; push する必要があります。
これは CI/CD のコードで気をつければ問題ないのでデメリットと言うほどではないですが、昔自分は何度か commit &amp; push し損ねて面倒くさいことになりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変数">変数<a class="hash-link" href="#変数" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/glossary.html#variables" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#variables</a></li><li><a href="https://learn.hashicorp.com/terraform/getting-started/variables.html" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/terraform/getting-started/variables.html</a></li></ul><p>設定ファイルでは変数が使えます。
変数を使うには宣言が必要です。宣言では型なども指定できます。</p><p><a href="https://www.terraform.io/docs/configuration/types.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/types.html</a></p><p>変数の宣言はつぎのようにします。 <code>.tf</code> のどこに書いても大丈夫です。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># variable &quot;変数名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = &quot;string&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>変数の値の設定は次のようにします。 <code>terraform.tfvars</code> というファイル名に書いておくとコマンド実行時に自動で読み込まれます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ami = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;us-east-1&quot; = &quot;ami-abc123&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;us-west-2&quot; = &quot;ami-def456&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>コマンドライン引数で渡すことも出来ます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="provider-の設定">Provider の設定<a class="hash-link" href="#provider-の設定" title="Direct link to heading">​</a></h2><p>Provider を使うには設定が必要です。
設定の属性は Provider によって違います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># provider &quot;Provider名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;google&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = &quot;acme-app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = &quot;us-central1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="module">Module<a class="hash-link" href="#module" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/modules/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/modules/index.html</a>
<a href="https://www.terraform.io/docs/configuration/modules.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/modules.html</a></p><p>複数のリソースの設定をまとめて再利用可能な形でパッケージングする仕組みとして Module があります。
リソースが1つだけでも、チーム固有の設定を Module のデフォルト値として設定したり、チームでは使わないリソースの属性を隠蔽したり用途はあるかと思います。</p><p>Module の作り方は通常の Terraform の設定ファイルの記述と同様、 1つのディレクトリ直下にパッケージングするリソースの設定ファイルを記述するだけです。</p><p>Module は次のように使います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># module &quot;名前&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;servers&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # モジュールへのパス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./app-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # モジュールのパラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  servers = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Module のパスは <code>module.モジュール名</code> (module.servers) になります。</p><p>Module の <code>source</code> としてはローカルのディレクトリへのパス以外にも様々なものをサポートしています。</p><p><a href="https://www.terraform.io/docs/modules/sources.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/modules/sources.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="コミュニティの-module">コミュニティの Module<a class="hash-link" href="#コミュニティの-module" title="Direct link to heading">​</a></h3><p>コミュニティによって様々な Module が提供されています。</p><ul><li><a href="https://registry.terraform.io/" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/</a></li><li><a href="https://registry.terraform.io/modules/terraform-aws-modules" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/modules/terraform-aws-modules</a></li><li><a href="https://github.com/terraform-community-modules" target="_blank" rel="noopener noreferrer">https://github.com/terraform-community-modules</a></li><li><a href="https://github.com/terraform-aws-modules" target="_blank" rel="noopener noreferrer">https://github.com/terraform-aws-modules</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-化するべきか否か">Module 化するべきか否か<a class="hash-link" href="#module-化するべきか否か" title="Direct link to heading">​</a></h3><p>Go や Python などのプログラミング言語でのモジュール(ライブラリやパッケージ等呼び方は様々ですが)化と比べ、
Terraform の Module 化は慎重でなければなりません。
理由はいくつかありますが、</p><ul><li>Module を変更すると State の変更も必要になる場合もある</li><li>Terraform の設定は中々パワフルだとは思いますが、プログラミング言語に比べると柔軟性が足らず、変更に弱く、複雑になるとメンテナンス性が悪くなります</li></ul><p>偏見かもしれませんが、プログラミング言語に比べると、 Terraform に「精通」している人はそれほど多くないと思います。
初心者は直ぐ Module 化に飛びつくのはやめた方が良いと思います(尤も使ってみないと理解が深まらないという意味では使ったほうが良いですが)。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/outputs.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/outputs.html</a></p><p>Module で定義したリソースの属性は基本的に外部から隠蔽されます。
リソースの属性を参照できるようにするには、次のように個別に Output として宣言する必要があります。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;instance_ip_addr&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_instance.server.private_ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これはモジュールで定義したリソース <code>aws_instance.server</code> の属性 <code>private_ip</code> を Module の属性 <code>instance_ip_addr</code> として外部に公開するという意味です。
Module のパスが module.servers だとすると、 <code>module.servers.instance_ip_addr</code> で参照できます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="data-source">Data Source<a class="hash-link" href="#data-source" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/data-sources.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/data-sources.html</a></p><p>Data source は Terraform で管理していない(あるいは他の State で管理している)リソースの属性を参照するための仕組みです。</p><p>次のように記述します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># data &quot;リソースの種類&quot; &quot;リソース名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;aws_ami&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # リソースを一意に識別するためのクエリ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  most_recent = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  owners = [&quot;self&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name   = &quot;app-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tested = &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Data source では属性によって実際のインフラのリソースを検索します。検索にマッチするリソースは必ず1つでなければならず、
複数マッチしたり1つもマッチしなかったりすると失敗します(厳密には Provider の実装次第ですが)。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="他の-state-で管理されているリソースの属性を-data-source-として参照する">他の State で管理されているリソースの属性を Data source として参照する<a class="hash-link" href="#他の-state-で管理されているリソースの属性を-data-source-として参照する" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/providers/terraform/d/remote_state.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/terraform/d/remote_state.html</a></p><p>他の State で管理されているリソースの属性を Data source を使って参照するために <code>terraform_remote_state</code> があります。
参照するには Module 同様 その属性が Output によって外部に公開されている必要があります。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;terraform_remote_state&quot; &quot;vpc&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;remote&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    organization = &quot;hashicorp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspaces = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name = &quot;vpc-prod&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="workspace">workspace<a class="hash-link" href="#workspace" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/state/workspaces.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/workspaces.html</a></li><li><a href="https://blog.mosuke.tech/entry/2018/06/16/terraform-workspaces/" target="_blank" rel="noopener noreferrer">Terraform workspaceを利用して環境毎のリソース名の変更を行う</a></li><li><a href="http://kenzo0107.hatenablog.com/entry/2019/04/17/103558" target="_blank" rel="noopener noreferrer">Terraform 運用ベストプラクティス 2019 ~workspace をやめてみた等諸々~</a></li></ul><p>Terraform には workspace という機能がありますが、こちらの機能は自分は使ったことがないので簡単に触れるだけに留めます。
workspace の代表的なユースケースは production や staging などの異なる環境で同じ設定ファイルを共有しつつ State を switch することだと思います。</p><p>workspace を使わない場合環境ごとにディレクトリ及び設定ファイルを完全に分けることになると思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>workspace を使うと設定ファイルを共有できます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform.tfstate.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform.tfstate</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>環境ごとの設定の微妙な違いは設定ファイル内で分岐することになるのでしょう。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-workspace-を使うべきか">発展: workspace を使うべきか<a class="hash-link" href="#発展-workspace-を使うべきか" title="Direct link to heading">​</a></h3><p>workspace を使うべきか否かは意見が分かれている様に思えます。
恐らくユースケースやチームメンバーの Terraform への成熟度にもよるでしょう。</p><p>現状自分は「使わない」というスタンスです。</p><p>自分がこれまで関わってきたチーム事情だと Terraform に全員が精通しているというよりは、むしろ Terraform にそこまで詳しくない人も触ることが多いです。
偏見かもしれませんが、そういうチームは少なくないのではないでしょうか？
そういうチーム状況では、 workspace を使って DRY になるというメリット以上に、 workspace そのものへの学習コストや環境によって設定ファイル内で分岐する学習コストを省き、
Terraform に精通していなくても理解できるくらいシンプルに保つことのほうが大事なのではないかなと思います。</p><p>特に、これまで Terraform を特定のサービス横断的なチームで管理していた状態から各サービスの担当者に ownership を委譲しようとする場合、上述の学習コスト・複雑さが弊害になるのではないかなと感じています。</p><p>ただし、繰り返しになりますが自分は workspace を使ったことがありません。
上記の自分の認識が間違っているかもしれませんし、今後 workspace を使ってみたら考えが変わるかもしれません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-command-の基本的な使い方">Terraform command の基本的な使い方<a class="hash-link" href="#terraform-command-の基本的な使い方" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/index.html</a></p><p>設定ファイルを書いた上で基本的なコマンドの使い方について説明します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-init">terraform init<a class="hash-link" href="#terraform-init" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/init.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/init.html</a></p><p>まず、 <code>terraform init</code> を実行する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform init</code> によって、依存する Provider がインストールされたりします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-fmt">terraform fmt<a class="hash-link" href="#terraform-fmt" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/fmt.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/fmt.html</a></p><p><code>terraform fmt</code> によってコードを整形することが出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform fmt [-check] [-recursive]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-check</code> をつけると、コードを整形する代わりに、コードが整形されていなかったら exit code が non 0 で終了します。
CI でコードが整形されているかのチェックに使えます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-plan">terraform plan<a class="hash-link" href="#terraform-plan" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/plan.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/plan.html</a></p><p><code>terraform plan</code> によって <code>terraform apply</code> の dry run が出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan [-refresh=false]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>実際のインフラは変更されず、 <code>apply</code> を実行した場合にどのような変更が行われるか出力されます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-apply">terraform apply<a class="hash-link" href="#terraform-apply" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/apply.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/apply.html</a></p><p>実際にインフラを設定ファイルに合わせて変更します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply [-auto-approve]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>デフォルトでは最初に plan の実行結果が出力されて本当に変更を適用してよいか確認があります。
<code>-auto-approve</code> を指定すると確認を skip 出来ます。</p><p><code>plan</code> に成功しても <code>apply</code> には失敗する場合もあります。
簡単な例としては更新する権限がない場合です。
<code>apply</code> に失敗すると一部のリソースだけ更新されるということは起こりえます。
そうなってもロールバックとかは出来ない(terraform に rollback の機能はない)ので注意してください。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-destroy">terraform destroy<a class="hash-link" href="#terraform-destroy" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/destroy.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/destroy.html</a></p><p>Terraform で作成したインフラを削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>恐らく実際の運用でこれを使うことはあまりないと思います。
削除したいなら設定ファイルからそのリソースを消して apply するでしょう。
Terraform の勉強がてら遊びで作ったものを丸っと消すとか主にそういう用途で使われる気がします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-refresh">terraform refresh<a class="hash-link" href="#terraform-refresh" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/refresh.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/refresh.html</a></p><p>State を実際のインフラの状態に合わせて更新します。
インフラは更新されません。
手動でインフラを変更した場合に、その変更を State に反映させるのに使えます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform refresh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-import">terraform import<a class="hash-link" href="#terraform-import" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/import.html</a>
<a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a></p><p>Terraform で管理されていないリソースのデータを State にインポートします。
State はリソースパスとインフラのID のマッピングを管理すると言いましたが、 import コマンドの引数ではこの2つを渡すことでマッピングできるようにします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># リソースパス ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import aws_instance.example i-abcd1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ちなみに、一部のリソースは import をサポートしてません。
サポートしているかどうかは Provider の実装に依存します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state">terraform state<a class="hash-link" href="#terraform-state" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/index.html</a></p><p>State を操作するためのコマンドです。様々なサブコマンドがあります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-の-cicd">Terraform の CI/CD<a class="hash-link" href="#terraform-の-cicd" title="Direct link to heading">​</a></h2><p>terraform apply は原則 CD によって実行されるべきだし、
CI によって <code>terraform fmt -check</code> や <code>terraform plan</code> は実行されるべきだと思っています。</p><p>逆に <code>terraform plan</code> や <code>apply</code> は CI/CD でやってるけど、
<code>terraform state</code> や <code>terraform import</code> はローカルから実行しているというチームも少なくはないのかなという気がしています。</p><p>課題となりうるのは</p><ul><li>Credential の管理</li><li>IP制限</li></ul><p>かなと思います。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="credential-の管理">Credential の管理<a class="hash-link" href="#credential-の管理" title="Direct link to heading">​</a></h3><p>Terraform で使うクレデンシャルは強力な権限を持ちがちなので扱いに注意しないといけません。
権限を絞るのが理想ですが、結構難しかったりします。</p><p>例えば PR の CI では <code>terraform apply</code> を実行しないのであれば、 PR の CI 用に Read Only なクレデンシャルを用意するとかもありかもしれません。</p><p>例えば AWS のインフラ管理を Terraform + CircleCI で行う場合、
AWS のクレデンシャルを CircleCI で参照できるようにする必要があります。
CircleCI では SSH でコンテナにログインできるため、クレデンシャルを盗もうと盗めますし、
CircleCI に限らず悪意のあるコードを CI で実行して外部にクレデンシャルを送ることも出来ます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ip-制限">IP 制限<a class="hash-link" href="#ip-制限" title="Direct link to heading">​</a></h3><p>CI で Terraform を使う場合、 CI の実行環境からインフラの API にアクセスできる必要があります。
IP 制限をかけている場合、 CI の実行環境からはアクセスできるようにするなどの工夫が必要です。
CI の実行環境の IP range が定まってない場合、話は更に難しくなります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="発展-設定ファイル中で使える関数">発展: 設定ファイル中で使える関数<a class="hash-link" href="#発展-設定ファイル中で使える関数" title="Direct link to heading">​</a></h2><p>設定ファイル内ではビルドイン関数が使えます。
公式ドキュメントを参照してください。</p><p><a href="https://www.terraform.io/docs/configuration/functions.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/functions.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="余談-awesome-terraform">余談: awesome-terraform<a class="hash-link" href="#余談-awesome-terraform" title="Direct link to heading">​</a></h2><p><a href="https://github.com/shuaibiyy/awesome-terraform" target="_blank" rel="noopener noreferrer">https://github.com/shuaibiyy/awesome-terraform</a></p><p>Terraform 関連の awesome なツールのリンク集です。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform 入門" href="/terraform-getting-started"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-state-locking">Terraform の State Locking の概要</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-10T07:18:05.000Z" itemprop="datePublished">January 10, 2020</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform の <a href="https://www.terraform.io/docs/state/locking.html" target="_blank" rel="noopener noreferrer">State Locking</a> という機能の概要について説明します。
ただし、自分もちゃんと理解しているわけではないので、推測も混じります。
基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="state-locking-とは">State Locking とは<a class="hash-link" href="#state-locking-とは" title="Direct link to heading">​</a></h2><p><code>terraform plan</code> などのコマンドは State を変更する場合があります。
その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。</p><hr><p>例えば S3 backend の state を state rm で更新する場合を考えます。
これはコマンド内部で</p><ol><li>現在の State を取得する (READ)</li><li>修正した State を S3 に push する (WRITE)</li></ol><p>という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。</p><hr><p>そこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="コマンドラインオプション">コマンドラインオプション<a class="hash-link" href="#コマンドラインオプション" title="Direct link to heading">​</a></h2><p>plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-lock=true          Lock the state file when locking is supported.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-lock-timeout=0s    Duration to retry a state lock.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-lock</code> はデフォルトで true なので State Locking のことを知らなくても実は State Locking 使ってたということもありえますが、 Backend type によっては State Locking のための設定をしていないと State Locking が無効になっている可能性があります。</p><p>例えば S3 backend で State Locking をするには DynamoDB が必要であり、 DynamoDB の設定 <code>dynamodb_table</code> が設定されていないと State Locking は無効になります。</p><p>また、<code>-lock=false</code> で無効化できますが、公式的に非推奨になります。</p><p><code>-lock-timeout</code> は lock の取得に失敗した場合に何秒後にリトライするかの設定になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="force-unlock">force-unlock<a class="hash-link" href="#force-unlock" title="Direct link to heading">​</a></h2><p>lock の解放に失敗した場合のために、 <a href="https://www.terraform.io/docs/commands/force-unlock.html" target="_blank" rel="noopener noreferrer">force-unlock</a> というコマンドがあります。
何らかのトラブルで lock が解放されない場合に使います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform force-unlock LOCK_ID</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>例えば plan を実行中にキャンセルすると lock が解放されないことがあるようです。</p><p>lock が解放されていない状態で plan などを実行すると lock の取得に失敗し、次のようなエラーが起こります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Acquiring state lock. This may take a few moments...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error locking state: Error acquiring the state lock: ConditionalCheckFailedException: The conditional request failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status code: 400, request id: xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock Info:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ID:        xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Path:      terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Operation: OperationTypePlan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Who:       xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version:   0.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Created:   2020-01-09 09:30:37.41120929 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Info:      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform acquires a state lock to protect the state from being written</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">by multiple users at the same time. Please resolve the issue above and try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">again. For most commands, you can disable locking with the &quot;-lock=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag, but this is not recommended.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ここで出力される ID を force-unlock の引数として指定します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform force-unlock xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you really want to force-unlock?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will remove the lock on the remote state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  This will allow local Terraform commands to modify this state, even though it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  may be still be in use. Only &#x27;yes&#x27; will be accepted to confirm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform state has been successfully unlocked!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The state has been unlocked, and Terraform commands should now be able to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obtain a new lock on the remote state.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="s3-backend">S3 backend<a class="hash-link" href="#s3-backend" title="Direct link to heading">​</a></h2><p>State Locking をサポートしているかは Backend type によりますが、 S3 の場合、 DynamoDB を使えばできます。</p><p><a href="https://www.terraform.io/docs/backends/types/s3.html#configuration-variables" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/s3.html#configuration-variables</a></p><p>backend の設定で <code>dynamodb_table</code> を設定する必要があります。</p><p><a href="https://www.terraform.io/docs/backends/types/s3.html#dynamodb_table" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/s3.html#dynamodb_table</a></p><blockquote><p>dynamodb_table - (Optional) The name of a DynamoDB table to use for state locking and consistency. The table must have a primary key named LockID. If not present, locking will be disabled.</p></blockquote><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;terraform_remote_state&quot; &quot;network&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;s3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket = &quot;terraform-state-prod&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key    = &quot;network/terraform.tfstate&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # state locking の設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dynamodb_table = &quot;???&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>IAMの権限としては <a href="https://www.terraform.io/docs/backends/types/s3.html#dynamodb-table-permissions" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/s3.html#dynamodb-table-permissions</a> が必要です。</p><p>DynamoDB のテーブルには <code>LockID</code> という Primary Key が必要です。 型は <code>文字列</code> です。</p><p>そして State Locking を有効にした状態で plan などを実行すると
DynamoDB のテーブルにレコードが State ごとに作られるようです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="state-locking-をすれば安全というわけではない">State Locking をすれば安全、というわけではない<a class="hash-link" href="#state-locking-をすれば安全というわけではない" title="Direct link to heading">​</a></h2><p>State Locking 自体は安全性に寄与する仕組みではありますが、 State Locking さえすれば安全かというとそうではないと思います。</p><p>複数人が同時に plan や apply などを実行する環境では、別のロック機構も必要だと思います。</p><p>詳細はまた別途書こうと思いますが、CI/CD で plan, apply などを実行する場合、 apply 実行中はそれが終わるまで他の plan や apply の実行を wait するような仕組みがないと危険です。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Terraform の State Locking の概要" href="/terraform-state-locking"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tags/terraform/page/2"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.078ea440.js"></script>
<script src="/assets/js/main.1e5265b5.js"></script>
</body>
</html>