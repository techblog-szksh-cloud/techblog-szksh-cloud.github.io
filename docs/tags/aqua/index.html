<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">5 posts tagged with &quot;aqua&quot; | Melody</title><meta data-rh="true" property="og:title" content="5 posts tagged with &quot;aqua&quot; | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/tags/aqua"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/tags/aqua"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/aqua" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/aqua" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.b1f8b1b5.js" as="script">
<link rel="preload" href="/assets/js/main.71a74257.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-09">Activity at 2022-09</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-08">2022-08 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-07">2022-07 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-06">2022-06 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-05">2022-05 振り返り</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>5 posts tagged with &quot;aqua&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/update-aqua-v0.7.16">aqua の最近の update (v0.7.4 ~ v0.7.16)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-11-18T11:21:57.000Z" itemprop="datePublished">November 18, 2021</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>以前 aqua <a href="https://github.com/suzuki-shunsuke/aqua/releases/tag/v0.7.3" target="_blank" rel="noopener noreferrer">v0.7.3</a> がリリースされた際に <a href="/aqua-global-configs/">aqua で組織・チームのツール群を管理</a> という記事を書きました。
あれからもうすぐ 2 ヶ月になり、最新バージョンは <a href="https://github.com/suzuki-shunsuke/aqua/releases/tag/v0.7.16" target="_blank" rel="noopener noreferrer">v0.7.16</a> になりました。
そこで v0.7.4 ~ v0.7.16 の間の更新と、関連 repository の更新を幾つか(全部ではない)紹介します。</p><p>基本的に <a href="https://github.com/suzuki-shunsuke/aqua/releases" target="_blank" rel="noopener noreferrer">Release Note</a> に書いてある内容です。</p><ul><li>GitHub の Access Token が基本的に不要になりました</li><li>Homebrew で install できるようになりました</li><li>aqua.yaml がより簡潔に書けるようになりました</li><li>aqua.yaml の packages を他のローカルのファイルから import できるようになりました</li><li>aqua.yaml をディレクトリの階層的にネストできるようになりました</li><li>aqua which コマンドをサポートしました</li><li>github_archive, github_content type をサポートしました</li><li>(advanced) バージョンによってパッケージの type が変更された場合にも対応できるようになりました</li><li><a href="https://github.com/suzuki-shunsuke/aqua-registry" target="_blank" rel="noopener noreferrer">Standard Registry</a> の package の数が 139 =&gt; 220 になりました。</li><li><a href="https://circleci.com/developer/orbs/orb/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua のための CircleCI Orb</a> をリリースしました</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="github-の-access-token-が基本的に不要になりました">GitHub の Access Token が基本的に不要になりました<a class="hash-link" href="#github-の-access-token-が基本的に不要になりました" title="Direct link to heading">​</a></h2><p>private repository から package をインストール場合は当然必要ですが、そうでなければ不要になりました。
これにより、 aqua を導入するハードルが下がりましたし、 GitHub API の Rate Limit に引っかかることが基本的になくなりました。</p><p>余談ですが、 private repository のツールを簡単に install できるのも aqua の便利な点だなと思っています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="homebrew-で-install-できるようになりました">Homebrew で install できるようになりました<a class="hash-link" href="#homebrew-で-install-できるようになりました" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install suzuki-shunsuke/aqua/aqua</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Homebrew で install できるようにすることで、より手軽に導入してもらえるようになりました。</p><p>ちなみに aqua を aqua で管理出来ないのかというと、現状できません(無限ループになってしまう)。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aquayaml-がより簡潔に書けるようになりました">aqua.yaml がより簡潔に書けるようになりました<a class="hash-link" href="#aquayaml-がより簡潔に書けるようになりました" title="Direct link to heading">​</a></h2><p>AS IS</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> direnv/direnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v2.28.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=direnv/direnv</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TO BE</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> direnv/direnv@v2.28.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><code>registry: standard</code> が省略可能</li><li>version を name に @ のあとに書ける<ul><li>これにより、 <a href="https://docs.renovatebot.com/modules/manager/regex" target="_blank" rel="noopener noreferrer">Renovate の Regex Manager</a> 用にコメント <code># renovate: depName=direnv/direnv</code> を書く必要がなくなりました</li></ul></li></ul><p>これにより 1 行で書けるようになりました。
ただ簡潔にかけて楽というだけでなく、 Renovate 用のコメントでパッケージ名を間違えて指定するリスクがなくなりました。</p><p>e.g. パッケージ名を間違えている例</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> direnv/direnv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v2.28.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=cli/cli</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><a href="https://github.com/suzuki-shunsuke/aqua-renovate-config" target="_blank" rel="noopener noreferrer">aqua-renovate-config</a> を使えばコメントを書かなくても version を上げることが出来ます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aquayaml-の-packages-を他のローカルのファイルから-import-できるようになりました">aqua.yaml の packages を他のローカルのファイルから import できるようになりました<a class="hash-link" href="#aquayaml-の-packages-を他のローカルのファイルから-import-できるようになりました" title="Direct link to heading">​</a></h2><p>e.g.</p><p>ディレクトリ構成</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">aqua.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aqua/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reviewdog.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  golangci-lint.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>aqua.yaml </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">import</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aqua/</span><span class="token important">*.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>aqua/reviewdog.yaml</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> reviewdog/reviewdog@v0.13.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このようにファイルを分割することで、特定のパッケージが update された場合のみ CI で特定の job を実行するといったことがやりやすくなります。
例えば GitHub Actions の <a href="https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#onpushpull_requestpaths" target="_blank" rel="noopener noreferrer"><code>on.&lt;push|pull_request&gt;.paths</code></a> の場合、</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;**.go&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aqua/golangci</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lint.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="aquayaml-をディレクトリの階層的にネストできるようになりました">aqua.yaml をディレクトリの階層的にネストできるようになりました<a class="hash-link" href="#aquayaml-をディレクトリの階層的にネストできるようになりました" title="Direct link to heading">​</a></h2><p>aqua はカレントディレクトリからルートディレクトリに遡って <code>^\.?aqua\.ya?ml$</code> を探索します。
このとき、それまではファイルを一つ見つけた時点で探索をやめていましたが、全ての階層を探索するようになりました。
同じパッケージが定義されていた場合、先に見つかった設定ファイルの version が優先されます。
これにより、 Monorepo でも aqua が使いやすくなりました。
Monorepo 直下に aqua.yaml を置きつつ、サブディレクトリに aqua.yaml を置いても、サブディレクトリ配下で Monorepo 直下の aqua.yaml も参照できるようになりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-which-コマンドをサポートしました">aqua which コマンドをサポートしました<a class="hash-link" href="#aqua-which-コマンドをサポートしました" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ which gh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Users/shunsuke-suzuki/.aqua/bin/gh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua which gh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Users/shunsuke-suzuki/.aqua/pkgs/github_release/github.com/cli/cli/v2.2.0/gh_2.2.0_macOS_amd64.tar.gz/gh_2.2.0_macOS_amd64/bin/gh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>aqua は <code>~/.aqua/bin</code> 配下にシンボリックリンクを作成し、コマンド実行時に動的にバージョンを決定し、インストールされたコマンドを実行します。
よって <code>which</code> や <code>command -v</code> では実際に実行されるコマンドのパスが分かりませんが、 aqua which コマンドを使うとパスが分かります。
ちなみに aqua で管理されてないコマンドでもパスを取得できます。</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua which git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/bin/git</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>少々変わった使い方ですが、 aqua でインストールされた実行ファイルを別のパスにコピーしたい場合に便利です。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cp &quot;$(aqua which gh)&quot; src/gh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="github_archive-github_content-type-をサポートしました">github_archive, github_content type をサポートしました<a class="hash-link" href="#github_archive-github_content-type-をサポートしました" title="Direct link to heading">​</a></h2><p>Standard Registry にある package をインストールしているだけの方は、そもそも package の type というものを気にする必要もないので
あまり関係ない話かもしれませんが、 <code>http</code>, <code>github_release</code> package に加えて、 <code>github_archive</code>, <code>github_content</code> package もサポートされました。
<code>github_archive</code> は GitHub Repository の Archive をパッケージとして扱うもので、 <a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer">tfenv</a> を aqua でインストールする際なんかに使われています。
<code>github_content</code> は GitHub Content API を使って GitHub Repository の単一ファイルをパッケージとして扱うものです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="advanced-バージョンによってパッケージの-type-が変更された場合にも対応できるようになりました">(advanced) バージョンによってパッケージの type が変更された場合にも対応できるようになりました<a class="hash-link" href="#advanced-バージョンによってパッケージの-type-が変更された場合にも対応できるようになりました" title="Direct link to heading">​</a></h2><p>これまた advanced な内容で多くの方にはあまり関係ない裏側の仕組みの話ですが、パッケージによってはバージョンによって type が変わることがあります(かなりまれですが)。
あとは repository の owner が変わったりなんかもありますが、そういった場合にも対応できるようになりました。
ちなみに GitHub Release の asset のファイル名のフォーマットや、 asset のディレクトリ構成が変わることは時々ありますが、それらには元々対応できています。</p><p>e.g.  <a href="https://github.com/suzuki-shunsuke/aqua-registry/blob/v0.10.7/registry.yaml#L486-L492" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry/blob/v0.10.7/registry.yaml#L486-L492</a></p><p><a href="https://github.com/suzuki-shunsuke/aqua/blob/v0.7.16/docs/registry_config.md#version_constraint-version_overrides" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua/blob/v0.7.16/docs/registry_config.md#version_constraint-version_overrides</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="standard-registry-package-の数が-139--220-になりました">Standard Registry package の数が 139 =&gt; 220 になりました。<a class="hash-link" href="#standard-registry-package-の数が-139--220-になりました" title="Direct link to heading">​</a></h2><p>Standard Registry は <a href="https://github.com/suzuki-shunsuke/aqua-registry/releases/tag/v0.8.6" target="_blank" rel="noopener noreferrer">v0.8.6</a> から <a href="https://github.com/suzuki-shunsuke/aqua-registry/releases/tag/v0.10.7" target="_blank" rel="noopener noreferrer">v0.10.7</a> になりましたが、その結果 package の数は 139 から 220 になりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-のための-circleci-orb-をリリースしました">aqua のための CircleCI Orb をリリースしました<a class="hash-link" href="#aqua-のための-circleci-orb-をリリースしました" title="Direct link to heading">​</a></h2><p>CircleCI で Orb を使って aqua を install したり aqua を使ってパッケージをインストールできるようになりました。
aqua とパッケージを cache してくれます。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about aqua の最近の update (v0.7.4 ~ v0.7.16)" href="/update-aqua-v0.7.16"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/aqua-global-configs">aqua で組織・チームのツール群を管理</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-09-25T03:01:56.000Z" itemprop="datePublished">September 25, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a> <a href="https://github.com/suzuki-shunsuke/aqua/releases/tag/v0.7.3" target="_blank" rel="noopener noreferrer">v0.7.3</a> をリリースし、
複数の global configuration をサポートしました。</p><p>個人で使う分にはあまり嬉しい機能でもないかもしれませんが、
会社・組織・チームといった集団(以下<code>組織</code>で統一)で設定を共有するには便利な機能だと思います。</p><p>これまで aqua では 2 つの設定ファイルをサポートしていました。</p><ul><li>-c で指定した場合はそのファイル、そうでなければカレントディレクトリから探索して最初に見つかったファイル<ul><li>リポジトリ直下にそのリポジトリ用の aqua.yaml をおく</li></ul></li><li>global configuration (デフォルトは <code>~/.aqua/global/[.]aqua.y[a]ml</code>)<ul><li>個人の dotfiles とかで aqua.yaml を管理しておく</li></ul></li></ul><p>こうすることで特定のリポジトリ用の設定と個人の設定を管理することができます。</p><p>しかし、第三の設定を参照することはできませんでした。
例えばある組織で使うツールセットを aqua で管理しようと思ってもこれまでは難しかったです。</p><p>そこで <code>AQUA_GLOBAL_CONFIG</code> という環境変数に <code>:</code> 区切りで設定ファイルへのパスを設定することで先頭から順に設定ファイルを参照するようにしました。</p><p>設定ファイルの優先順位は高い方から順に次のようになります。</p><ol><li>-c で指定した場合はそのファイル、そうでなければカレントディレクトリから探索して最初に見つかったファイル</li><li><code>AQUA_GLOBAL_CONFIG</code></li><li>global configuration (デフォルトは <code>~/.aqua/global/[.]aqua.y[a]ml</code>)</li></ol><p>イメージとしては</p><ol><li>プロジェクト(リポジトリ)の設定</li><li>組織の設定</li><li>個人の設定</li></ol><p>という感じです。</p><p>例えば GitHub Organizations に aqua-config というリポジトリを作成し、以下のようなファイルを用意したとしましょう。</p><ul><li>all.yaml: 全 Developer 用の設定</li><li>sre.yaml: SRE Team 用の設定</li></ul><p>そのリポジトリをローカル <code>/home/foo/aqua-config</code> に checkout したとしましょう。
あなたが SRE の場合、 AQUA_GLOBAL_CONFIG を次のように設定しましょう。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export AQUA_GLOBAL_CONFIG=/home/foo/aqua-config/sre.yaml:/home/foo/aqua-config/all.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすることで特定のリポジトリ用の設定と個人の設定(dotfiles)に加えて、
自分が所属する組織用の設定も参照することができます。</p><p>組織としては組織に必要なツール群を aqua で宣言的に管理できるため、
セットアップのコストも下がり、バージョンも組織で統一することができます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-install-に追加された--a-option"><code>aqua install</code> に追加された <code>-a</code> option<a class="hash-link" href="#aqua-install-に追加された--a-option" title="Direct link to heading">​</a></h2><p>v0.7.3 では <code>aqua install</code> に <code>-a</code> option が追加されました。
<code>aqua install</code> はデフォルトでは global configuration は参照しません。
global configuration を参照するのは <code>aqua exec</code> 及び aqua でインストールされたツールを実行したとき(内部的に <code>aqua exec</code> が実行されている)だけです。</p><p><code>-a</code> option をつけると global configuration も含めて全ての設定ファイルを参照し install を実行します。</p><p>aqua.yaml を Git で管理している場合は定期的に リポジトリを pull して <code>aqua i -a -l</code> を実行するのが良いでしょう。
簡単なスクリプトを書いたり、 cron で定期実行するようにするとよいかもしれません。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about aqua で組織・チームのツール群を管理" href="/aqua-global-configs"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/aqua-generate">aqua の設定ファイルをインタラクティブに生成する generate コマンド</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-09-05T01:17:39.000Z" itemprop="datePublished">September 5, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li><a href="/aqua">aqua - CLI ツールのバージョン管理</a></li><li><a href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></li></ul><p>aqua v0.5.1 で追加された generate というサブコマンドを紹介します。</p><p>aqua では Registry を活用することで設定を記述する手間を省くことができますが、
Registry を活用するには、インストールしたいツールが Registry で定義されているか、されているとしたら name はなにか調べる必要があります。
Registry で定義されているのに見逃してしまうこともあるでしょう。</p><p>また、 aqua でツールをインストールするには version を指定する必要がありますが、多くの場合はとりあえず最新バージョンはなにかを調べることになるでしょう。</p><p>これらの手間を減らすために generate というインタラクティブなコマンドを追加しました。
これは aqua.yaml で指定されている Registry で定義されている packages の一覧から package を fuzzy search によって選択し、
更に <code>github_release</code> package の場合は release version の一覧を fuzzy search によって選択することで package の YAML 定義を出力するコマンドです。</p><p>使ってみるのが早いでしょう。 aqua.yaml に Standard Registry を追加した上で <code>aqua g</code> を実行してみます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.1 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>すると fuzzy search が起動し、 package が選択できます。
自分が使いたいツール名で検索してみて、あればそれを選択します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  direnv (standard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consul (standard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conftest (standard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; golangci-lint (standard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  47/47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>golangci-lint を選んでみましょう。
すると golangci-lint のバージョンの一覧が選択できます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  v1.40.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1.40.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1.41.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1.41.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; v1.42.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  30/30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>version を選ぶと YAML が出力されます。</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: golangci-lint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry: standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: v1.42.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>この YAML を <code>aqua.yaml</code> の <code>packages</code> に追記すれば OK です。</p><p>helm のように GitHub Release からではなく公式サイトからインストールするようなツールはバージョンのリストを取得するのが難しいのでバージョンの選択はできません。</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry: standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version: &quot;&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>それでも helm が <code>helm</code> という name で standard registry に登録されていることはわかるので、十分便利です。</p><p>ちなみに fuzzy search には <a href="https://github.com/ktr0731/go-fuzzyfinder" target="_blank" rel="noopener noreferrer">ktr0731/go-fuzzyfinder</a> を使わせていただきました。非常に簡単に fuzzy search が実装できてとても便利でした。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about aqua の設定ファイルをインタラクティブに生成する generate コマンド" href="/aqua-generate"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-09-04T02:58:42.000Z" itemprop="datePublished">September 4, 2021</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="/aqua/">先日 aqua v0.1.0 をリリースした記事を書いた</a>ばかりですが、
そこから更に開発を続けて v0.5.0 をリリースしたので、変更点を紹介します。</p><p>基本的に <a href="https://github.com/suzuki-shunsuke/aqua/releases" target="_blank" rel="noopener noreferrer">Release Note</a> に書いてあるとおりです。</p><ul><li>PATH を project (aqua.yaml) 毎に設定する必要がなくなりました<ul><li><code>~/.aqua/bin</code> を PATH に追加すればよくなりました</li><li>direnv などを使って環境変数を追加する必要がなくなりました</li></ul></li><li><code>install</code> コマンドに <code>--test</code> option を追加し、 <code>file.src</code> の設定が正しいかテストできるようになりました<ul><li>CI で aqua の設定をテストするのに便利</li></ul></li><li>GitHub Release だけでなく、任意の URL から tool のダウンロード・インストールができるようになりました<ul><li>Go や helm, Hashicorp の product のような公式サイトからダウンロードするタイプのツールも install できるようになりました</li></ul></li><li>Breaking Change: <code>inline_registry</code> の設定の形式を変更しました</li><li>aqua の設定の再利用性を高める <code>Registry</code> という仕組みを導入しました<ul><li>standard <code>Registry</code> を公開しました <a href="https://github.com/suzuki-shunsuke/aqua-registry" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry</a></li></ul></li><li>簡単な slide を公開しました: <a href="https://speakerdeck.com/szksh/introduction-of-aqua" target="_blank" rel="noopener noreferrer">https://speakerdeck.com/szksh/introduction-of-aqua</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="path-を-project-aquayaml-毎に設定する必要がなくなりました">PATH を project (aqua.yaml) 毎に設定する必要がなくなりました<a class="hash-link" href="#path-を-project-aquayaml-毎に設定する必要がなくなりました" title="Direct link to heading">​</a></h2><p>aqua v0.1.0 では symbolic link を aqua.yaml のあるディレクトリの <code>.aqua/bin</code> 配下に作成しており、ここを PATH に追加する必要がありました。
direnv とかを使うと便利ですが、間接的に(?) aqua が direnv のようなツールに依存している形になり、微妙でした。</p><p>aqua v0.5.0 では symbolic link を <code>~/.aqua/bin</code> 配下に作成するため、 .bashrc などで <code>~/.aqua/bin</code> を PATH に追加しておけば project ごとに環境変数を追加する必要はなくなりました。
ちなみに作成される symbolic link は aqua-proxy へのリンクであり、ツールのバージョンには依存しないので <code>~/.aqua/bin</code> を共有しても干渉することはありません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="応用-aquabin-配下に-symbolic-link-を作る上での課題とそれの解決法">[応用]<!-- --> <code>~/.aqua/bin</code> 配下に symbolic link を作る上での課題とそれの解決法<a class="hash-link" href="#応用-aquabin-配下に-symbolic-link-を作る上での課題とそれの解決法" title="Direct link to heading">​</a></h3><p><code>~/.aqua/bin</code> 配下に symbolic link を作って PATH に追加する場合、一つ大きな課題があります
(だからこそ v0.1.0 ではプロジェクトごとに symbolic link を作っていました)。
<code>~/.aqua/bin</code> 配下に symbolic link を作って PATH に追加すると、基本的にそのファイルが呼ばれることになります。
そのツールを aqua で管理しているプロジェクト配下ならそれで良いですが、そうでない場合、本来 aqua 以外でインストールしたものを実行したくても実行できません。
例えば homebrew で jq を install していて、あるプロジェクトでは aqua を使ってバージョンを固定したものを使いたいが、それ以外では homebrew で install したものを使いたいといった場合に問題になります。</p><p>この問題を解決するため、 aqua ではツールを呼び出す際に <code>PATH</code> をチェックして aqua-proxy へのリンクとなっているものは除外するというハック(?)のようなことをしています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-コマンドに---test-option-を追加し-filesrc-の設定が正しいかテストできるようになりました"><code>install</code> コマンドに <code>--test</code> option を追加し、 <code>file.src</code> の設定が正しいかテストできるようになりました<a class="hash-link" href="#install-コマンドに---test-option-を追加し-filesrc-の設定が正しいかテストできるようになりました" title="Direct link to heading">​</a></h2><p>地味な更新ですが、 aqua の設定を更新した際に CI でテストするのに便利です。
<code>--test</code> option なしだと、 warning は出力しますが、 exit code は 0 になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="github-release-だけでなく任意の-url-から-tool-のダウンロードインストールができるようになりました">GitHub Release だけでなく、任意の URL から tool のダウンロード・インストールができるようになりました<a class="hash-link" href="#github-release-だけでなく任意の-url-から-tool-のダウンロードインストールができるようになりました" title="Direct link to heading">​</a></h2><p>ちなみに、 GitHub Release で公開されてないようなツールでも、
GitHub リポジトリで versioning されていて Renovate の <code>github_release</code> data source で自動更新できるケースは少なくないと思います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="breaking-change-inline_registry-の設定の形式を変更しました">Breaking Change: <code>inline_registry</code> の設定の形式を変更しました<a class="hash-link" href="#breaking-change-inline_registry-の設定の形式を変更しました" title="Direct link to heading">​</a></h2><p>小さな breaking change ですが、<code>inline_registry</code> の形式が変わりました。</p><p>AS IS</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx{{else}}{{.OS}}{{end}}-{{.Arch}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TO BE</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx{{else}}{{.OS}}{{end}}-{{.Arch}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-の設定の再利用性を高める-registry-という仕組みを導入しました">aqua の設定の再利用性を高める <code>Registry</code> という仕組みを導入しました<a class="hash-link" href="#aqua-の設定の再利用性を高める-registry-という仕組みを導入しました" title="Direct link to heading">​</a></h2><p>これが一番大きな更新です。
aqua を使うにはツールのインストール方法を YAML で記述しないといけませんが、
これはちょっとした手間ですし、新規ユーザーにとって障壁となるでしょう。</p><p>ツールとそのバージョンを定義したらインストールできてほしいものです。
ツールとそのバージョンの定義は <code>aqua.yaml</code> の <code>packages</code> の部分なので、それ以外の設定を如何に簡略化するかという話になります。</p><p>Registry はツールのインストール方法の設定を、プロジェクト固有のバージョン設定とは独立させ、再利用可能な形で共有する仕組みです。</p><p>Registry には現状 4 種類あります。</p><ul><li>inline regisry: aqua.yaml の中に直接 install 方法を定義する。 v0.1.0 からサポートされている方法</li><li>github_content registry: GitHub Repository にあるファイルを Registry として参照する方法</li><li>local registry: GitHub Repository にあるファイルを Regisry として参照する方法</li><li>standard registry: 自分がメンテしている github_content registry のエイリアス</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="inline-registry">inline registry<a class="hash-link" href="#inline-registry" title="Direct link to heading">​</a></h3><p>inline registry は従来からあるやつで、 aqua.yaml 内に定義する方法です。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx{{else}}{{.OS}}{{end}}-{{.Arch}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>シンプルではありますが、コピペする以外に再利用性がありません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="local-registry">local registry<a class="hash-link" href="#local-registry" title="Direct link to heading">​</a></h2><p>local registry はローカルにあるファイルを参照する registry です。
絶対パスか、 aqua.yaml からの相対パスを指定します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="github_content-registry">github_content registry<a class="hash-link" href="#github_content-registry" title="Direct link to heading">​</a></h2><p>ユーザーとしては次のように Registry を定義すればあとは <code>packages</code> で Registry を参照できます。
GitHub Access Token を環境変数 <code>GITHUB_TOKEN</code> として設定する必要があります。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzuki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shunsuke/aqua</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzuki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shunsuke</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aqua</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.27.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=open-policy-agent/conftest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="registry-を公開する">Registry を公開する<a class="hash-link" href="#registry-を公開する" title="Direct link to heading">​</a></h3><p>自分で Registry を公開したい場合は GitHub Repository に設定ファイルを置くだけで OK です。
e.g. <a href="https://github.com/suzuki-shunsuke/aqua-registry/blob/main/registry.yaml" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry/blob/main/registry.yaml</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="standard-registry">Standard Registry<a class="hash-link" href="#standard-registry" title="Direct link to heading">​</a></h2><p>Standard Registry も作りました。</p><p><a href="https://github.com/suzuki-shunsuke/aqua-registry" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry</a></p><p>jq や gh, kubectl, Terraform など有名なツールはこの Registry を使えばインストールできますが、
当然 PR も受け付けているので、追加してほしいツールがあれば PR を投げてください。</p><p>Official Registry を github_content Registry として利用することも当然できますが、
より簡潔に書けるように <code>type: standard</code> という Registry がサポートされています。</p><p>AS IS</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzuki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shunsuke</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aqua</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TO BE</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>上 2 つは等価ではありますが、後者のほうが簡潔です。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about aqua v0.1.0 から v0.5.0 での変更点" href="/aqua-v0.5"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/aqua">aqua - CLI ツールのバージョン管理</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-08-28T00:07:38.000Z" itemprop="datePublished">August 28, 2021</time> · <!-- -->16 min read</div></header><div class="markdown" itemprop="articleBody"><p>2021-09-04 追記: <a href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></p><p><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a> という OSS を開発しているので紹介します。</p><p>記事の内容は aqua v0.1.0 に基づきます。将来的に仕様が変わる可能性があります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-とは">aqua とは<a class="hash-link" href="#aqua-とは" title="Direct link to heading">​</a></h2><p>aqua は CLI ツールのバージョン管理のための CLI です。
aqua で管理する主な対象は GitHub Release で公開されているツールです。
YAML の設定ファイルを書いてコマンドを実行すると指定したツールをインストールすることができます。</p><p>例えば以下のような設定ファイルを書き、 <code>aqua install</code> というコマンドを実行すると
<a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a>, <a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a> などが GitHub Release からダウンロードされ、インストールされます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx-amd64{{else}}{{if eq .OS &quot;linux&quot;}}linux64{{else}}win64.exe{{end}}{{end}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> open</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ちなみに上記の設定ファイルの</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>の部分では Go の <a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener noreferrer">text/template</a> と <a href="http://masterminds.github.io/sprig/" target="_blank" rel="noopener noreferrer">sprig</a> が使われています。</p><p>ツールごとに URL を調べて download して tarball などを展開してインストールしてなどの面倒な作業を aqua で自動化できます。
update も基本的に設定ファイルの version を更新するだけで OK です。</p><p>aqua を使うと同じツールの複数のバージョンを管理してプロジェクトによってバージョンを切り替えるといったことも容易にできます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="3-つの主なユースケース">3 つの主なユースケース<a class="hash-link" href="#3-つの主なユースケース" title="Direct link to heading">​</a></h2><p>aqua では以下の 3 つの主なユースケースを想定しています。</p><ul><li>CI/CD で必要なツールの管理</li><li>ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理</li><li>特定のプロジェクト(リポジトリ)によらないツールの管理</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース1-cicd-で必要なツールの管理">ユースケース1: CI/CD で必要なツールの管理<a class="hash-link" href="#ユースケース1-cicd-で必要なツールの管理" title="Direct link to heading">​</a></h3><p>例えば Terraform の Monorepo の CI で以下のような様々なツールを使っていたとしましょう。</p><ul><li><a href="https://cli.github.com/" target="_blank" rel="noopener noreferrer">gh</a></li><li><a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a></li><li><a href="https://tfsec.dev/" target="_blank" rel="noopener noreferrer">tfsec</a></li><li><a href="https://github.com/terraform-linters/tflint" target="_blank" rel="noopener noreferrer">tflint</a></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a></li><li><a href="https://github.com/open-policy-agent/opa" target="_blank" rel="noopener noreferrer">opa</a></li><li><a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a></li><li><a href="https://github.com/mvdan/sh" target="_blank" rel="noopener noreferrer">shfmt</a></li><li><a href="https://github.com/koalaman/shellcheck" target="_blank" rel="noopener noreferrer">shellcheck</a></li><li><a href="https://github.com/suzuki-shunsuke/github-comment" target="_blank" rel="noopener noreferrer">github-comment</a></li></ul><p>これらを1個1個 curl などを使ってインストールするコードを書くのは面倒ですが、
aqua であれば設定ファイルを宣言的に書いて <code>aqua i</code> を実行すれば終わりです。
新たにツールを追加する場合でも設定ファイルに追記すればよく、スクリプトを更新する必要はありません。
バージョンを明示的に指定できるのでコードを変更してないのに急にツールが更新されることもありませんし、 <a href="https://docs.renovatebot.com/modules/manager/regex/" target="_blank" rel="noopener noreferrer">Renovate の Regex Manager</a> などを使えば更新を自動化することもできます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理">ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理<a class="hash-link" href="#ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理" title="Direct link to heading">​</a></h3><p>あるリポジトリのローカルでの開発に必要なツールを aqua で管理することができます。
リポジトリ直下に <code>aqua.yaml</code> を置いておけば OK です。
バージョンも指定されているので、人によってバージョンが違ったりする問題も解消できます。
<code>aqua.yaml</code> と同じディレクトリに <code>.aqua</code> が作成されるのでそれを .gitignore に追加し、 <code>.aqua/bin</code> を PATH に追加しましょう。
direnv を使い、リポジトリ直下に .envrc を置いて <code>.aqua/bin</code> を PATH に追加すると便利です。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">aqua.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.envrc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>.envrc</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PATH_add .aqua/bin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>.aqua/bin</code> を PATH に追加しなくても <code>aqua exec -- &lt;コマンド&gt; ...</code> で実行することもできます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース3-特定のプロジェクトリポジトリによらないツールの管理">ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理<a class="hash-link" href="#ユースケース3-特定のプロジェクトリポジトリによらないツールの管理" title="Direct link to heading">​</a></h3><p>特定のプロジェクトによらずにツールを laptop にインストールしたい場合にも使えます。
<code>~/.aqua/global/aqua.yaml</code> に設定ファイルを記述し、 <code>~/.aqua/global/.aqua/bin</code> を PATH に追加してください。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$HOME/.aqua/global/.aqua/bin:$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>そして <code>~/.aqua/global</code> 配下で <code>aqua i</code> を実行すればインストールができます。
<code>~/.aqua/global</code> を Git で管理して GitHub などでホスティングするのも良いでしょう。</p><p><a href="https://github.com/suzuki-shunsuke/my-aqua-config" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/my-aqua-config</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="akoi-との違い">akoi との違い<a class="hash-link" href="#akoi-との違い" title="Direct link to heading">​</a></h2><p>ところで、自分は aqua に似たツールとして <a href="http://github.com/suzuki-shunsuke/akoi" target="_blank" rel="noopener noreferrer">akoi</a> というツールを公開していて、自分もこれまでこのツールを使ってきました。
aqua と akoi は「CLI ツールのバージョン管理」という目的・ゴールは同じです。
akoi も結構便利なツールですが、 akoi が抱える様々な課題を解決するために aqua を開発しています。
aqua は akoi のいわば後継ツールです。
ただしコードは全く別物ですし、互換性もありません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="akoi-と比べた-aqua-の良い点">akoi と比べた aqua の良い点<a class="hash-link" href="#akoi-と比べた-aqua-の良い点" title="Direct link to heading">​</a></h3><ul><li>GitHub Access Token を使ったインストールをサポート<ul><li>private repository をサポート</li><li>akoi は anonymous なアクセスなので rate limit に引っかかりやすい</li></ul></li><li>管理対象のコマンド実行時にツールのインストールが可能</li><li>設定ファイルを更新したあとに install コマンドを実行する必要がない<ul><li>akoi は symbolic link を作り直すために install コマンドを実行する必要がある</li></ul></li><li>管理対象のツールの実体を共有できる<ul><li>project ごとにツールを install する必要がない(計算資源の効率化)</li><li>akoi と違って ツールによって実体のインストール先は一意に決まるので、干渉することがなく安全に共有できる</li></ul></li><li>事前に archive の中のパスを知っている必要がない<ul><li>akoi は install 時に archive を展開してファイルをコピーし、シンボリックリンクを作成する<ul><li>パスが間違っていると失敗し、 download からやり直しになる</li><li>そのため、新しいツールを akoi で管理する場合はまず archive の構造を調べる必要がある</li></ul></li><li>aqua は install したあとに ~/.aqua 配下を見て file.src を修正すれば良いし、間違っててコマンドの実行に失敗しても download のやり直しとかはない</li></ul></li><li><code>bin_path</code>, <code>link_path</code> ような設定について考えなくて良い<ul><li>akoi は設定ファイルでインストール先などを設定できるようになっている</li><li>どう設定すべきか悩ましいし、リポジトリによって設定が違ったりして設定を統一するのが難しい</li><li>aqua はインストール先などが設定できないのでユーザーが迷う必要がない</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="管理対象のツールの実体を共有できる">管理対象のツールの実体を共有できる<a class="hash-link" href="#管理対象のツールの実体を共有できる" title="Direct link to heading">​</a></h4><p>aqua はツールの実体を AQUA_ROOT_DIR <code>~/.aqua</code> にインストールし、共有することができます。
複数のリポジトリで同じバージョンの同じツールを使う場合に共有できるので、
インストールにかかる時間を短縮できますし、無駄にディスク容量を消費することもありません。
設定ファイルによって動的にバージョンを取得するので、共有していてもリポジトリごとに異なるバージョンを使うこともできます。</p><p>安全に共有できるようにツールの実体のインストール先はダウンロード元によってユニークかつ一意に決まるようになっています。
ユーザーがカスタマイズすることはできません(ルートディレクトリは変えられますが、ルート以下は変えられません)。</p><p>例えば OSX で jq-1.6 のインストール先は以下になります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/pkgs/github_release/github.com/stedolan/jq/jq-1.6/jq-osx-amd64/jq-osx-amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように GitHub Release からインストールする場合</p><ul><li>リポジトリのオーナー</li><li>リポジトリ名</li><li>tag</li><li>GitHub Release のアセット名</li></ul><p>などから一意に決まるため、あるリポジトリでは jq をフォークしたものを使うといった場合でも安全に共存することができます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="便利な---only-link-option">便利な <code>--only-link</code> option<a class="hash-link" href="#便利な---only-link-option" title="Direct link to heading">​</a></h2><p><code>aqua install</code> を実行するとツールごとに以下のことが実行されます。</p><ol><li><code>.aqua/bin</code> 配下にシンボリックリンクを作成</li><li>ダウンロード</li><li>tarball などの展開</li><li>~/.aqua 配下にインストール</li></ol><p>aqua.yaml の packages に大量のツールが定義されていると、
大量のツールが一度にインストールされることになり、
並列で実行されるとはいえ、都合が悪いこともあるでしょう。</p><p><code>--only-link</code> option をつけて実行すると、シンボリックリンクだけ作成しダウンロードなどは行わないので直ぐに終わります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua install --only-link</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>その状態でツールを実行すると、ツールが自動でインストールされてから実行されるので
本当に必要になってからインストールすることが可能であり、余計なインストールが発生しないので便利です。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="コマンド実行時の自動インストール動的なバージョン切り替えの仕組み">コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み<a class="hash-link" href="#コマンド実行時の自動インストール動的なバージョン切り替えの仕組み" title="Direct link to heading">​</a></h2><p>aqua は設定ファイルを更新すると <code>aqua install</code> 実行をしなくても更新が反映される、
ツールがまだインストールされていなくてもツールを実行時に自動でインストールされるという機能があります。</p><p>tfenv も .terraform-version を更新すればすぐ反映されますし、
terraform コマンドを実行時にまだ指定したバージョンがインストールされてなかったら自動でインストールされますが、それに似ていますね
(ただし tfenv の機能がどう実装されているかは調べてませんし、 aqua を実装する上で参考にしたりはしていません)。</p><p>上記の機能が aqua でどう実現されているか簡単に説明します。</p><p>例えば aqua で jq をインストールし、 <code>jq -h</code> を実行したとしましょう。
jq を実行すると aqua-proxy を経由して <code>aqua exec -- jq -h</code> が実行されます。
この辺の詳細は <a href="#aqua-proxy-%E3%81%A8%E3%81%AF">aqua-proxy とは</a> を参照してください。
<code>aqua exec</code> は aqua の設定ファイルで指定されたバージョンがインストールされているかチェックし、まだインストールされていなかったらインストールし、コマンド <code>jq -h</code> を実行します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-proxy-とは">aqua-proxy とは<a class="hash-link" href="#aqua-proxy-とは" title="Direct link to heading">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/aqua-proxy" target="_blank" rel="noopener noreferrer">aqua-proxy</a> は aqua が内部的に依存しているツールです。
コマンド実行時に aqua 及び aqua で管理するツールのバージョンを動的に変更するために作られました。
aqua のために開発されており、 aqua 以外で使われることは想定していません。</p><p>aqua-proxy は <code>aqua install</code> や <code>aqua exec</code> を実行した際に自動で <code>~/.aqua/bin/aqua-proxy</code> にインストールされます。
aqua はツールをインストールする際に <code>.aqua/bin/&lt;ツール&gt;</code> から <code>~/.aqua/bin/aqua-proxy</code> へのシンボリックリンクを作成するので、 <code>&lt;ツール&gt;</code> を実行すると <code>~/.aqua/bin/aqua-proxy</code> が呼ばれます。</p><p>aqua-proxy は <a href="https://pkg.go.dev/os#Args" target="_blank" rel="noopener noreferrer">os#Args</a> からツール名を取得し、
<code>aqua exec -- &lt;ツール名&gt; ...</code> を実行します。
これによりコマンド実行時に aqua 及び <code>&lt;ツール&gt;</code> のバージョンを動的に変更することを実現しています。</p><p><code>.aqua/bin/&lt;ツール&gt;</code> から aqua-proxy へのシンボリックリンクは静的であり、 aqua-proxy のバージョンを切り替えることは難しいです。
aqua-proxy の機能・責務が大きくなると aqua-proxy のバージョン管理や aqua との互換性を考えなくてはならなくなります。
aqua-proxy のバージョンをほぼ気にしなくて良いよう、 aqua-proxy は最小限の機能・責務しか持たず、安定的であまり変更されないように設計されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="プロセスツリーを確認してみる">プロセスツリーを確認してみる<a class="hash-link" href="#プロセスツリーを確認してみる" title="Direct link to heading">​</a></h2><p>既に説明したとおり <code>&lt;ツール&gt;</code> を実行した際には実はプロセスツリー的には
<code>aqua-proxy =&gt; aqua =&gt; &lt;ツール&gt;</code> という風になっています。</p><p><code>&lt;ツール&gt;</code> を直接実行した場合と挙動に違いが出ないように以下のようなことに気を配っています。</p><ul><li>SIGINT, SIGTERM などのシグナルが適切に <code>&lt;ツール&gt;</code> のプロセスまで伝達されるようにする</li><li><code>&lt;ツール&gt;</code> の exit code が伝達されるようにする</li></ul><p>試しに fzf を実行してみて別のターミナルでプロセスツリーを確認してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls | fzf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>fzf が起動しますが、そのままにしておいて別のターミナルでプロセスツリーを確認してみます。
Mac の <code>pstree</code> を使っています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-+- 83548 foo fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> \-+- 83549 foo aqua exec -- fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   \--- 83550 foo /Users/foo/.aqua/pkgs/github_release/github.com/junegunn/fzf/0.27.2/fzf-0.27.2-darwin_amd64.zip/fzf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>紛らわしいのですが、最初のプロセスの実体は fzf ではなくて aqua-proxy です。 fzf が aqua-proxy へのシンボリックになっているのでこうなっています。
ここで aqua-proxy に SIGTERM を送ると手元の Mac ではちゃんと子プロセスまで終了しました。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kill 83548</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>この辺のシグナルハンドリングは Windows だと正常に動かないかもしれません。</p><p><a href="https://pkg.go.dev/os#Signal" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/os#Signal</a></p><blockquote><p>The only signal values guaranteed to be present in the os package on all systems are os.Interrupt (send the process an interrupt) and os.Kill (force the process to exit).
On Windows, sending os.Interrupt to a process with os.Process.Signal is not implemented;
it will return an error instead of sending a signal.</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about aqua - CLI ツールのバージョン管理" href="/aqua"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b1f8b1b5.js"></script>
<script src="/assets/js/main.71a74257.js"></script>
</body>
</html>