<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">10 posts tagged with &quot;golang&quot; | Melody</title><meta data-rh="true" property="og:title" content="10 posts tagged with &quot;golang&quot; | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/tags/golang"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/tags/golang"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/golang" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/tags/golang" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.feeb6c7e.js" as="script">
<link rel="preload" href="/assets/js/main.8ecade6f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/github-re-request-review">Pull Request を再度 review してほしい場合は Re-request review をしましょう</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-04">2022-04 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-03">2022-03 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-02">2022-02 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2021-11">2021-11 やったこと</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>10 posts tagged with &quot;golang&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/go-timeout">go-timeout - command の timeout</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-11-04T01:00:21.000Z" itemprop="datePublished">November 4, 2019</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>作ったのは 2ヶ月くらい前の話ですが、
Go の command の timeout を実装するためのライブラリを作ったので紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/go-timeout" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-timeout</a></p><p>基本的には <a href="https://github.com/Songmu/timeout" target="_blank" rel="noopener noreferrer">https://github.com/Songmu/timeout</a> をオススメしますが、これだと上手くいかないパターンがあったので自作しました。</p><p>Go の command の timeout に関しては <a href="https://junkyard.song.mu/slides/gocon2019-spring/#24" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#24</a> がとても参考になります。</p><p>上記のスライドでは</p><ul><li>標準ライブラリの <a href="https://golang.org/pkg/os/exec/#CommandContext" target="_blank" rel="noopener noreferrer">exec.CommandContext</a> でも停止できるが、 SIGKILL で強制的に停止することになる<ul><li>子プロセスが停止しない</li></ul></li><li><a href="https://github.com/golang/go/issues/21135" target="_blank" rel="noopener noreferrer">公式見解</a> では、SIGKILL 以外は標準ライブラリではサポートしない。サードパーティでやればよい</li><li><a href="https://github.com/Songmu/timeout" target="_blank" rel="noopener noreferrer">Songmu/timeout</a> 使えば SIGKILL 以外でより安全に停止できる</li></ul><p>ということが丁寧に説明されています。</p><p>自分は <a href="https://github.com/suzuki-shunsuke/cmdx" target="_blank" rel="noopener noreferrer">cmdx</a> という task runner を開発していてその中で task の実行時に timeout を設定出来るようにしました。
当初 <a href="https://github.com/Songmu/timeout" target="_blank" rel="noopener noreferrer">Songmu/timeout</a> を使って実装したのですが、問題があることに気づきました。
それは、 command の中で <a href="https://github.com/junegunn/fzf" target="_blank" rel="noopener noreferrer">fzf</a> を使うと、上手く動かないというものでした。</p><ul><li><a href="https://github.com/suzuki-shunsuke/cmdx/issues/52" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/cmdx/issues/52</a></li><li><a href="https://twitter.com/szkdash/status/1165529415238815745" target="_blank" rel="noopener noreferrer">https://twitter.com/szkdash/status/1165529415238815745</a></li></ul><p>正直この辺の挙動はちゃんと理解できていないのですが、
調べてみると Songmu/timeout だと syscall.SysProcAttr の Setpgid を true に設定していて、そうすると fzf が上手く動かないようでした。</p><p><a href="https://junkyard.song.mu/slides/gocon2019-spring/#48" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#48</a></p><p><a href="https://junkyard.song.mu/slides/gocon2019-spring/#45" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#45</a></p><p>には timeout の実装方式として</p><ul><li>GNU timeout の場合</li><li>Songmu timeout の場合</li></ul><p>の 2 通り書いてありますが、 suzuki-shunsuke/go-timeout では GNU timeout のパターンで実装しています。 </p><p><a href="https://junkyard.song.mu/slides/gocon2019-spring/#46" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#46</a></p><p>に書いてあるとおり、少々乱暴な気もしますが、 <a href="https://github.com/suzuki-shunsuke/cmdx" target="_blank" rel="noopener noreferrer">cmdx</a> で使う分には特に問題ない気がします。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about go-timeout - command の timeout" href="/go-timeout"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-time">Golang での時刻の扱い方を整理する</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-08-14T11:28:56.000Z" itemprop="datePublished">August 14, 2019</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>今更ながら Golang での時刻の扱い方について改めて整理してみました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="Direct link to heading">​</a></h2><ul><li>time.Local は明示的に設定する(基本UTC)</li><li>DB などには 基本UTC で永続化する</li><li>出力時に必要になったらタイムゾーンを変更する<ul><li>location は出力時に問題になるので出力時に location を明示的に指定する</li><li>逆に言うと出力時以外は問題にならないので無理に location を UTC にしなくても良いかもしれない</li><li>サードパーティ(ex. ORM) に time.Time を渡す場合は location に注意が必要</li></ul></li><li>文字列として時刻の入力を受け付ける場合は location を明示的にセットする</li><li>サードパーティが time.Local に依存する場合、 time.Local を明示的に UTC にしたりする必要があるかもしれない</li><li>アプリケーションで利用する location が分かっている場合、location を取得するヘルパー関数を定義する</li><li><code>time.LoadLocation</code> は環境依存なので予め location が分かっているなら使わないほうがよい</li><li>文字列を time.Time に変換する場合、<code>time.ParseInLocation</code> で Location を指定して time.Time に変換後、time.Time.UTC() で UTC に変換する</li><li>time.Time を文字列に変換する場合、time.In で location を変換後、time.Time.Format で文字列に変換する</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="グローバルな-location">グローバルな location<a class="hash-link" href="#グローバルな-location" title="Direct link to heading">​</a></h2><p><a href="https://golang.org/pkg/time/#Location" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#Location</a></p><blockquote><p>Local represents the system&#x27;s local time zone.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="location-を設定する">location を設定する<a class="hash-link" href="#location-を設定する" title="Direct link to heading">​</a></h2><p><a href="https://crieit.net/posts/Go-time-LoadLocation" target="_blank" rel="noopener noreferrer">https://crieit.net/posts/Go-time-LoadLocation</a> に書いてあるとおり、
<code>time.LoadLocation</code> を下手に呼び出すと環境によっては <code>unknown time zone</code> エラーが起こるため
次のように time.FixedZone で Location を生成します。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">jp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FixedZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Asia/Tokyo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">60</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>FixedZone という関数名が紛らわしい気もしますが、新しい Location を生成しているだけで副作用はありません。</p><p>ちなみに time.FixedZone に渡す文字列は &quot;foo&quot; みたいな適当な文字列でも動くようです。</p><p><a href="https://golang.org/pkg/time/#FixedZone" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#FixedZone</a></p><p><a href="https://github.com/golang/go/blob/9e277f7d554455e16ba3762541c53e9bfc1d8188/src/time/zoneinfo.go#L263-L308" target="_blank" rel="noopener noreferrer">https://github.com/golang/go/blob/9e277f7d554455e16ba3762541c53e9bfc1d8188/src/time/zoneinfo.go#L263-L308</a></p><p>アプリケーションで利用する location が決まっている場合、次のように location を返すヘルパー関数を用意すると良さそうです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jp </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FixedZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Asia/Tokyo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">60</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Location </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> jp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="厳密に-utc-な-location-を取得する">厳密に UTC な Location を取得する<a class="hash-link" href="#厳密に-utc-な-location-を取得する" title="Direct link to heading">​</a></h2><p>厳密に言うと、<code>time.UTC</code> は変更可能なので UTC だとは限りません。
そのため、本来 <code>time.UTC</code> はゲッター関数であるべきだったんじゃないかなという気もします。</p><p>厳密に UTC な Location を取得するにはヘルパー関数を書くと良さそうです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    utc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    utc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FixedZone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;UTC&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UTC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Location </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> utc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="動作環境に依存しないコードにするために">動作環境に依存しないコードにするために<a class="hash-link" href="#動作環境に依存しないコードにするために" title="Direct link to heading">​</a></h2><p>動作環境によって <code>time.Local</code> の値が違うことで結果が変わってしまう場合があります。
それを防ぐために、プログラムの最初に <code>time.Local</code> を UTC にするという手もありそうです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UTC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ただし、それでもグローバル変数である以上、行儀の悪いサードパーティのライブラリによって変更されるかもしれませんし、
必要な箇所で location を明示的に指定してグローバル変数に依存しないようなコードを書くことを心がけたほうが良い気もします。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="文字列を-timetime-に変換する">文字列を time.Time に変換する<a class="hash-link" href="#文字列を-timetime-に変換する" title="Direct link to heading">​</a></h2><ul><li><a href="https://golang.org/pkg/time/#Parse" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#Parse</a></li><li><a href="https://golang.org/pkg/time/#ParseInLocation" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#ParseInLocation</a></li></ul><blockquote><p>ParseInLocation is like Parse but differs in two important ways.
First, in the absence of time zone information, Parse interprets a time as UTC;
ParseInLocation interprets the time as in the given location.
Second, when given a zone offset or abbreviation, Parse tries to match it against the Local location;
ParseInLocation uses the given location.</p></blockquote><p>ParseInLocation と Parse の違い</p><ul><li>文字列に location の情報がない場合、 Parse は UTC として扱う</li><li>zone offset が指定された場合、 Parse は Local location からの offset として扱う<ul><li>ParseInLocation で明示的に Location を指定したほうが良さそう</li></ul></li></ul><p>予め location がわかっている場合 time.ParseInLocation で location を指定して time.Time に変換した後 time.Time.In で UTC にするのが良さそうです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ParseInLocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;2006-01-02T15:04:05&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2019-08-13T21:30:00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UTC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="timetime-の-location-を変更する">time.Time の Location を変更する<a class="hash-link" href="#timetime-の-location-を変更する" title="Direct link to heading">​</a></h2><p><a href="https://golang.org/pkg/time/#Time.In" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#Time.In</a></p><blockquote><p>In returns a copy of t representing the same time instant,
but with the copy&#x27;s location information set to loc for display purposes.</p></blockquote><p>time.Time.In は time.Time の Location だけ変更したコピーを返します。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UTC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2019-08-14 12:08:44.150725 +0000 UTC m=+0.000212031</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">In</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">JP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2019-08-14 21:08:44.150725 +0900 Asia/Tokyo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="timetime-を文字列に変換する">time.Time を文字列に変換する<a class="hash-link" href="#timetime-を文字列に変換する" title="Direct link to heading">​</a></h2><p><a href="https://golang.org/pkg/time/#Time.Format" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#Time.Format</a></p><p>time.Time.In で location を変更した後 time.Time.Format で文字列に変換するのが良さそうです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="timenow-の-location">time.Now の location<a class="hash-link" href="#timenow-の-location" title="Direct link to heading">​</a></h2><p>Location は <code>time.Local</code> になります。</p><p><a href="https://golang.org/pkg/time/#Now" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/time/#Now</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="他のパッケージの-location-の扱い">他のパッケージの location の扱い<a class="hash-link" href="#他のパッケージの-location-の扱い" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="log">log<a class="hash-link" href="#log" title="Direct link to heading">​</a></h3><p>log パッケージで出力される時刻のフォーマットと location は log.SetFlags によってある程度変更できます。</p><p>デフォルトは 日時を time.Local で出力します。
log.LUTC をセットすることで UTC になります。</p><ul><li><a href="https://golang.org/pkg/log/#SetFlags" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/log/#SetFlags</a></li><li><a href="https://golang.org/pkg/log/#pkg-constants" target="_blank" rel="noopener noreferrer">https://golang.org/pkg/log/#pkg-constants</a></li></ul><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetFlags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Flags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LUTC</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="logrus">logrus<a class="hash-link" href="#logrus" title="Direct link to heading">​</a></h3><p><a href="https://github.com/Sirupsen/logrus" target="_blank" rel="noopener noreferrer">logrus</a> のログの時刻の location も time.Local なようです。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="robfigcron">robfig/cron<a class="hash-link" href="#robfigcron" title="Direct link to heading">​</a></h3><p><a href="https://github.com/robfig/cron" target="_blank" rel="noopener noreferrer">https://github.com/robfig/cron</a></p><blockquote><p>All interpretation and scheduling is done in the machine&#x27;s local time zone (as provided by the Go time package (<a href="http://www.golang.org/pkg/time" target="_blank" rel="noopener noreferrer">http://www.golang.org/pkg/time</a>).</p></blockquote><p>time.Local なようです。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="go-sql-drivermisql">go-sql-driver/misql<a class="hash-link" href="#go-sql-drivermisql" title="Direct link to heading">​</a></h3><ul><li><a href="https://github.com/go-sql-driver/mysql#timetime-support" target="_blank" rel="noopener noreferrer">https://github.com/go-sql-driver/mysql#timetime-support</a></li><li><a href="https://www.sambaiz.net/article/189/" target="_blank" rel="noopener noreferrer">https://www.sambaiz.net/article/189/</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="gorm">gorm<a class="hash-link" href="#gorm" title="Direct link to heading">​</a></h3><p><a href="https://github.com/jinzhu/gorm/wiki/How-To-Do-Time" target="_blank" rel="noopener noreferrer">https://github.com/jinzhu/gorm/wiki/How-To-Do-Time</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Golang での時刻の扱い方を整理する" href="/golang-time"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/fagott">Flute - Golang HTTP client testing framework</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-07-06T23:20:00.000Z" itemprop="datePublished">July 6, 2019</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="2019-07-17-追記">2019-07-17 追記<a class="hash-link" href="#2019-07-17-追記" title="Direct link to heading">​</a></h2><p>プロジェクト名が変わりました</p><p><a href="https://github.com/suzuki-shunsuke/flute/issues/20" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/flute/issues/20</a></p><hr><p>Go の HTTP client のテストフレームワークを作ったので紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/flute" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/flute</a></p><p>執筆時点のバージョンは v0.6.0 です。</p><ul><li>リクエストパラメータのテスト</li><li>HTTP サーバのモッキング</li></ul><p>を目的としています。</p><p>比較的実践的なサンプルとして、ユーザーを作成する簡単な API client とそのテストを書いたので参考にしてください。</p><ul><li><a href="https://github.com/suzuki-shunsuke/flute/blob/master/examples/create_user.go" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/flute/blob/master/examples/create_user.go</a></li><li><a href="https://github.com/suzuki-shunsuke/flute/blob/master/examples/create_user_test.go#L17-L53" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/flute/blob/master/examples/create_user_test.go#L17-L53</a></li></ul><p>元々自分はこの目的のために <a href="https://github.com/h2non/gock" target="_blank" rel="noopener noreferrer">h2non/gock</a> を使っていました。
ただ、 gock だとリクエストがマッチしなかったときに、なぜマッチしないのかがわからず、調査に困るという問題がありました。</p><p>そこで flute では request に対し、matcher と tester という概念を導入し、
matcher でマッチしたリクエストを tester でテストするというふうにしました。
テストでは内部で <a href="https://github.com/stretchr/testify" target="_blank" rel="noopener noreferrer">stretchr/testify</a> の assert を使っており、テストに失敗したときになぜ失敗したのかが分かりやすく出力されるようになっています。</p><p>例えば以下の例は、リクエストの Authorization header にトークンがセットされていなかった場合のエラーメッセージです。</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">=== RUN   TestClient_CreateUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- FAIL: TestClient_CreateUser (0.00s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tester.go:168:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Error Trace:    tester.go:168</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        tester.go:32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        transport.go:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        client.go:250</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        client.go:174</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        client.go:641</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        client.go:509</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        create_user.go:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        create_user_test.go:56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Error:          Not equal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                expected: []string{&quot;token XXXXX&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                actual  : []string{&quot;token &quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Diff:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                --- Expected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                +++ Actual</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                @@ -1,3 +1,3 @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 ([]string) (len=1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                - (string) (len=11) &quot;token XXXXX&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                + (string) (len=6) &quot;token &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Test:           TestClient_CreateUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Messages:       the request header &quot;Authorization&quot; should match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                service: http://example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                request name: create a user</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>また、当たり前かもしれませんが、モックとしてレスポンスも返します。</p><p>マッチングやテストで使える項目としては</p><ul><li>リクエストパス (ex. &quot;/users&quot;)</li><li>method (ex. &quot;GET&quot;, &quot;POST&quot;)</li><li>クエリパラメータ(パラメータの有無、値)</li><li>ヘッダー(ヘッダーの有無、値)</li><li>リクエストボディ<ul><li>文字列完全一致</li><li>JSONとしての等価性</li></ul></li><li>ユーザー定義のカスタム関数</li></ul><p>などがあります。</p><p>詳細は コード中にコメントを入れているので <a href="https://godoc.org/github.com/suzuki-shunsuke/flute/flute" target="_blank" rel="noopener noreferrer">godoc</a> を読んでください。</p><p>技術的には <a href="https://golang.org/pkg/net/http/#Client" target="_blank" rel="noopener noreferrer">*http.Client</a> の Transport に *flute.Transport を設定することで HTTP サーバのモッキングをしています。</p><p>API のデザイン面で考慮したこととしては、
グローバル変数である http.DefaultClient の変更をライブラリ側でやらないことです。
あくまで http.RoundTripper の実装を提供するだけで、それを http.DefaultClient に設定する場合、それのコントロールはユーザーに任せています。</p><ul><li>ライブラリでグローバル変数の変更を隠蔽し、ユーザーが無意識のうちに変更してたりするのは良くない<ul><li>gock では http.DefaultClient を変更しているが、それを理解しないまま使っているユーザーもいるはず</li><li>グローバル変数の変更には副作用もあるので、ユーザーが理解した上で明示的に行うべきである</li><li>明示的に <code>http.DefaultClient = client</code> のようにユーザーに書かせれば、理解しないまま使うことはないはず</li></ul></li><li>ライブラリの外からも変更できるグローバル変数をライブラリで完全に管理するのは不可能なので、ユーザーに任せる</li></ul><p>以上、簡単ですが自作の OSS <a href="https://github.com/suzuki-shunsuke/flute" target="_blank" rel="noopener noreferrer">flute</a> の紹介でした。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/flute">flute</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Flute - Golang HTTP client testing framework" href="/fagott"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/go-jsoneq">go-jsoneq - 2つの値がJSONとして等しいか比較するGoライブラリ</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-05-23T02:43:18.000Z" itemprop="datePublished">May 23, 2019</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/suzuki-shunsuke/go-jsoneq" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-jsoneq</a></p><p>2つの値がJSONとして等しいか比較するGoライブラリを開発したので紹介します。</p><p>「2つの値がJSONとして等しい」とは、2つの値をそれぞれJSON文字列に変換したら、2つが表現するデータがおなじになるという意味です。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Foo </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;foo&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Foo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>と</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>を JSON に変換したらともに</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;foo&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>になりますね。</p><p>json.Marshaler のテストや、
実際の JSON 文字列から構造体を定義したときにちゃんと定義できているかチェックするのに使えると思います。</p><p>jsoneq.Equal でやっていることは単純です。</p><ol><li>json.Marshal で []byte に変換</li><li>json.Unmarshal で []byte を map, array と primitive な型からなるオブジェクト(?)に変換</li><li>reflect.DeepEqual で比較</li></ol><p>引数が []byte の場合は 1 は飛ばします。</p><p>GoDoc やサンプルを見れば使い方は簡単にわかると思います。</p><p>以上、簡単ですが、自作ライブラリの紹介でした。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about go-jsoneq - 2つの値がJSONとして等しいか比較するGoライブラリ" href="/go-jsoneq"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/use-confita">Goの設定管理で viper の代わりに confita を使う</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-16T09:38:45.000Z" itemprop="datePublished">February 16, 2019</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Golang の設定管理のライブラリといえば <a href="https://github.com/spf13/viper" target="_blank" rel="noopener noreferrer">viper</a> が有名ですが、
<a href="https://github.com/heetch/confita" target="_blank" rel="noopener noreferrer">confita</a> も良さそうだったので紹介したいと思います。</p><p>confita の機能としては以下のようなものがあります。</p><ul><li>構造体に設定をマッピング</li><li>flag や環境変数、設定ファイルに対応</li><li>複数の設定ファイルに対応</li></ul><p>構造体に設定をマッピングすることで、<a href="https://github.com/go-playground/validator" target="_blank" rel="noopener noreferrer">https://github.com/go-playground/validator</a> のようなライブラリを使って設定のバリデーションが出来ます。</p><p>また viper は <a href="https://github.com/spf13/viper/tree/v1.3.1#reading-config-files" target="_blank" rel="noopener noreferrer">v1.3.1</a> の時点で複数の設定ファイルを扱いにくいです。</p><blockquote><p>Viper can search multiple paths, but currently a single Viper instance only supports a single configuration file.</p></blockquote><p>k8s で ConfigMap と Secret を設定ファイルとして扱う場合、複数のファイルを扱えないと不便です。
その点 confita は複数の設定ファイルを問題なく扱えます。</p><p>以下はフラグで指定した複数の設定ファイルから設定を読み込む簡単なサンプルです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;gopkg.in/go-playground/validator.v9&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/heetch/confita&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/heetch/confita/backend&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/heetch/confita/backend/file&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flag </span><span class="token string" style="color:#e3116c">&quot;github.com/spf13/pflag&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cps </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StringSliceP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;config&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;configuration file path&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileBackends </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">backend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Backend</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cps </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fileBackends </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileBackends</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewBackend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loader </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> confita</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileBackends</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cfg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">LogLevel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// default value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> loader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> validator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> validate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Struct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>以上、簡単な紹介でした。
viper 以外のライブラリを探している人は試してみてください。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Goの設定管理で viper の代わりに confita を使う" href="/use-confita"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-good-point">Go の好きなところ</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-10T08:49:58.000Z" itemprop="datePublished">February 10, 2019</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自分は 2017/8頃(曖昧)からメインで書く言語を Python から Go に変更しました。
Goを書き始めて割と早い段階でGoが一番好きになりました。
そこでなんで Go が好きなのかということを頑張って言語化しようと思います。</p><p>若干他の言語と比較する部分もありますが、決して他の言語をディスったり、
他の言語より優れているということが言いたいわけではないのでご了承ください。</p><ul><li>依存するものが小さく、バイナリ1つインストールするだけで良い<ul><li>Prometheus の exporter とかインストールするの簡単</li><li>Docker Imageも最小限になる</li></ul></li><li>静的型付け<ul><li>ビルド出来ている時点で一定の信頼性が担保されている</li><li>よく知らないコードを読んだり修正するときとかだいぶ有り難い</li></ul></li><li>GoDocが素晴らしい<ul><li>何もしなくてもライブラリのドキュメントが出来上がっている</li></ul></li><li>ライブラリの公開が容易<ul><li>GitHubに公開するだけ</li><li>npm や pypi のようなレジストリがないので楽</li></ul></li><li>go test とか go vet, gofmt みたいに標準ツールが揃っている</li><li>コーディング規約で悩む必要がない</li><li>lintツールが充実している<ul><li>gometalinter とか使っておけば OK</li><li>lintできる環境を構築するのにそこまで頑張らなくて良い</li></ul></li><li>エラーハンドリングが暗黙的に省略できないので信頼性が高い<ul><li>Goのエラーハンドリング嫌いって人もいるし、v2で改善されるって話も聞くけど、自分はむしろ好き(面倒なのは理解できるけど)</li></ul></li><li>言語仕様がシンプル(客観的な根拠はないし、難しい部分もあるけど、そんな気がする)<ul><li>メタプログラミング使った、魔術的なコードになりにくい</li></ul></li><li>interface 使ってコードを疎結合にするのが書いてて気持ちいい</li><li>並列処理が書きやすい</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Go の好きなところ" href="/golang-good-point"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-logging-error-handling-practice-0.2.0">go-error-handling-logging-practice v0.2</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-01T13:26:13.000Z" itemprop="datePublished">February 1, 2019</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>以前 Golang のロギング・エラーハンドリングについて書きました。</p><ul><li><a href="https://suzuki-shunsuke.github.io/golang-logging-error-handling-practice/" target="_blank" rel="noopener noreferrer">https://suzuki-shunsuke.github.io/golang-logging-error-handling-practice/</a></li><li><a href="https://github.com/suzuki-shunsuke/go-error-handling-logging-practice" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-error-handling-logging-practice</a></li></ul><p>それを少し v0.1 から v0.2 に互換性を壊す形でアップデートしようかと思います。
本記事ではその変更点について書きます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変更点">変更点<a class="hash-link" href="#変更点" title="Direct link to heading">​</a></h2><p><strong>関数のエラーに情報を付与する責務を関数に割り当てていたものを、呼び出し元に割り当てるようにします。</strong></p><p>具体的には元々</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">checkName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;age&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>だったものが</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">checkName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user name is invalid&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変更理由">変更理由<a class="hash-link" href="#変更理由" title="Direct link to heading">​</a></h2><p>メタ情報のフィールド名はコンテキストに依存します。
上記の例だとユーザー名というメタ情報のフィールド名は <code>name</code> より <code>user_name</code> や <code>admin_name</code>, <code>owner_name</code> としたほうが適切かもしれません。それは関数内部では分からず、呼び出し元でないと分かりません。呼び出し元でないとフィールド名の衝突が避けられないこともあるでしょう。</p><p>メッセージに関しても同様のことが言えます。
また、元々 v0.1 ではユーザーが定義した関数と</p><ul><li>標準関数やサードパーティのライブラリなど、プロジェクト外部で定義された関数</li><li>interface の関数やメソッド</li></ul><p>を区別し、前者では関数側でエラーに情報を付与させる一方、後者では呼び出し元で情報を付与させるというふうにしていました。</p><p>v0.2 では両者を区別せず、どちらの場合でも呼び出し元に付与させるというふうにすることでよりルールがシンプルになります。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about go-error-handling-logging-practice v0.2" href="/golang-logging-error-handling-practice-0.2.0"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-logging-error-handling-practice">Go におけるエラーハンドリングとロギングのプラクティス</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-25T12:51:41.000Z" itemprop="datePublished">December 25, 2018</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="2018-12-30-追記">2018-12-30 追記<a class="hash-link" href="#2018-12-30-追記" title="Direct link to heading">​</a></h2><p>この記事を元にドキュメントを書いてみました。</p><p><a href="https://github.com/suzuki-shunsuke/go-error-handling-logging-practice" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-error-handling-logging-practice</a></p><p>追記ここまで</p><hr><p>Go でエラーハンドリングとロギングをしてきて自分の中で固まりつつあるプラクティスを明文化します。
明文化することで以下のことを目指します。</p><ul><li>迷いをなくす</li><li>コードの一貫性を保つ</li><li>コーディング規約とすることでレビューの品質を上げる(自動化は出来ないけど)</li><li>コードの品質を上げる(コードがゴチャつかなくなる)</li><li>適切にエラーをロギングする(必要十分な情報をログとして残す)</li></ul><p>またエラーハンドリングとロギングのためのライブラリを自作しているのでそれも紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/go-errlog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-errlog</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ロギングに関する関連記事">ロギングに関する関連記事<a class="hash-link" href="#ロギングに関する関連記事" title="Direct link to heading">​</a></h2><p>この記事を書く前に軽くググってみただけでちゃんと読んでないのですが、
興味のある人は読んでみてください。</p><ul><li><a href="https://www.loggly.com/blog/think-differently-about-what-to-log-in-go-best-practices-examined/" target="_blank" rel="noopener noreferrer">https://www.loggly.com/blog/think-differently-about-what-to-log-in-go-best-practices-examined/</a></li><li><a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" target="_blank" rel="noopener noreferrer">https://dave.cheney.net/2015/11/05/lets-talk-about-logging</a></li><li><a href="https://postd.cc/go-best-practices-2016/#logging-and-instrumentation" target="_blank" rel="noopener noreferrer">https://postd.cc/go-best-practices-2016/#logging-and-instrumentation</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ログレベルは分ける">ログレベルは分ける<a class="hash-link" href="#ログレベルは分ける" title="Direct link to heading">​</a></h2><p>ログレベルでwarningとかいらないという意見もありますが、自分は必要だと思っています。
自分は以下のログレベルを使い分けます。</p><ul><li>debug: あまり使わない。調査目的で一時的に埋め込むログ。調査が終わったら出力しないようにする。一時的でないものはinfoにする</li><li>info: エラーでないログ。イベント、処理の開始時や終了を記録するのに使うことが多い</li><li>warn: 4xx系のエラー。それが起こっただけではアラートを飛ばさないが、数が通常時より多い場合はバグかUIに問題があってユーザーが間違えやすくなっている可能性があるのでアラートを飛ばす</li><li>error: 5xx系のエラー。アラートを飛ばす(閾値は調整)</li><li>fatal: 処理継続が不可能な致命的なエラー。システムを止める</li></ul><p>書いてから思いましたが、これに関しては標準的な使い分けのルールがありそうですね(要調査)。。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="logrus-を使ってログを構造化する">logrus を使ってログを構造化する<a class="hash-link" href="#logrus-を使ってログを構造化する" title="Direct link to heading">​</a></h2><p>前提としてwebシステムやバッチシステムなどを想定しています。CLIツールならば話は変わるでしょう。
JSONフォーマットで出力してfluentdでElasticsearchにフォワードするのが個人的によくあるパターンです。</p><p>go-errlogもlogrusの使用を前提としています。</p><p>ロギングのライブラリは他にも色々あるので、logrusで満足できない人は以下から探してみるとよいでしょう。</p><p><a href="https://github.com/avelino/awesome-go#logging" target="_blank" rel="noopener noreferrer">https://github.com/avelino/awesome-go#logging</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="エラーログは中央集権的に-main-に近い所で出力する">エラーログは中央集権的に main に近い所で出力する<a class="hash-link" href="#エラーログは中央集権的に-main-に近い所で出力する" title="Direct link to heading">​</a></h2><p>エラーログをどこで出力するかですが、原則中央集権的に main に近い所で出力します。
因みに中央集権的という表現は echo の centralized error handling からもじっています。</p><p><a href="https://echo.labstack.com/guide/error-handling" target="_blank" rel="noopener noreferrer">https://echo.labstack.com/guide/error-handling</a></p><p>error が発生してもすぐログを吐くのではなく、error を関数の戻り値として返し、ロギングする責務を親に委譲します。
Goでは以下のようなイディオムがよく見られますね。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="ロギングに必要な情報を戻り値のerrorに含める">ロギングに必要な情報を戻り値のerrorに含める<a class="hash-link" href="#ロギングに必要な情報を戻り値のerrorに含める" title="Direct link to heading">​</a></h2><p>上記のコードで問題なのは、エラーに関する情報が欠損することがあることです。</p><p>これに関しては以下の記事が参考になります。</p><p><a href="https://deeeet.com/writing/2016/04/25/go-pkg-errors/" target="_blank" rel="noopener noreferrer">https://deeeet.com/writing/2016/04/25/go-pkg-errors/</a></p><p>エラーに関する情報には2種類あると個人的に考えていて「メッセージ」と「メタ情報」なんて風に脳内で呼んでたりします。</p><ul><li>メッセージ: エラーの原因を示すhuman readable なテキスト(<a href="https://github.com/pkg/errors" target="_blank" rel="noopener noreferrer">pkg/errors</a>はこれに対応している)<ul><li>リストになる</li></ul></li><li>メタ情報: エラーに関する構造化されたデータ<ul><li>ハッシュになる</li></ul></li></ul><p>例えば foo というユーザー名が既に使われていてユーザーの作成に失敗した場合</p><ul><li>メッセージ<ul><li>username is already used</li><li>invalid username</li><li>failed to create a user</li></ul></li><li>メタ情報<ul><li>username: foo</li></ul></li></ul><p>と言った感じになります。
メッセージにメタ情報を含めて <code>&quot;foo&quot; is invalid username</code> といった風にも出来ますが、そうすると検索・集計しづらかったり、メッセージの生成に一手間かかったりするのでメッセージにはメタ情報を含めません。</p><p>pkg/errors だとメタ情報には対応できないので自分でライブラリを作りました。</p><p><a href="https://github.com/suzuki-shunsuke/go-errlog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-errlog</a></p><p>こんな感じになります。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;username&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="error-に含める情報の責務">error に含める情報の責務<a class="hash-link" href="#error-に含める情報の責務" title="Direct link to heading">​</a></h2><p>上記のように error に情報を含める場合、どこまで含めるかというのが問題になります。
ここでプラクティスとして、
<strong>関数がerrorを返す場合、その関数がもっている情報は全て含める責務があり、
逆に子関数から返ってきたerrorには子関数に渡っている情報が含まれているので呼び出し元で付与する必要はない</strong>というふうにしています。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;age&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>つまり上のコードでは子関数に渡っているメタ情報<code>name</code>や、<code>invalid username</code> のようなメッセージを <code>errlog.Wrap</code> に渡す必要はありません。
上記の例だとエラーに関係ない <code>age</code> も渡す必要はないのではないかとも考えられますが、原則ログに残すこととします。</p><p>ただし、子関数が標準関数やサードパーティのライブラリなど、プロジェクト外部で定義された関数であれば話は別です。
それらがどのようなエラーを返すかは保証がありません。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;filename&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> filename</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to open a file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>上記の例だと、<code>os.Open</code>に渡したメタ情報 <code>filename</code> や os.Openに失敗したことを示す <code>failed to open a file</code> といったメッセージも<code>errlog.Wrap</code>に渡しています。</p><p><code>errlog.Wrap</code> は複数のメッセージを渡せるようになっています。
メッセージの順番は左からイベントが発生した順になるようにします。
上記の例だと「ファイルのオープンに失敗」した結果、「ユーザの作成に失敗」するという順序になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="エラーのロギングはシンプルに">エラーのロギングはシンプルに<a class="hash-link" href="#エラーのロギングはシンプルに" title="Direct link to heading">​</a></h2><p>go-errlogではシンプルにロギングを記述できます。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">logger </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// err != nil なら logging する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// err がメタ情報を持ってたら logrusで構造化してロギングする</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// メッセージも pkg/errors のように一つのテキストに連結してロギング</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="その他-go-errlog-の機能">その他 go-errlog の機能<a class="hash-link" href="#その他-go-errlog-の機能" title="Direct link to heading">​</a></h2><p>メタ情報やメッセージによって条件分岐したり出来るようにヘルパー関数を幾つか提供しています。</p><ul><li>CheckField</li><li>HasField</li><li>HasMsg</li></ul><p>詳細は<a href="https://godoc.org/github.com/suzuki-shunsuke/go-errlog" target="_blank" rel="noopener noreferrer">GoDoc</a>やソースコードを見てください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="最後に">最後に<a class="hash-link" href="#最後に" title="Direct link to heading">​</a></h2><p>色々書いてしまいましたが、一番言いたかったことは</p><blockquote><p><strong>関数がerrorを返す場合、その関数がもっている情報は全て含める責務があり、
逆に子関数から返ってきたerrorには子関数に渡っている情報が含まれているので呼び出し元で付与する必要はない</strong>というふうにしています。</p><p>ただし、子関数が標準関数やサードパーティのライブラリなど、プロジェクト外部で定義された関数であれば話は別です。</p></blockquote><p>の部分です。この辺は元々自分の中でルールが決まってなくてずっとモヤモヤしてて、
コードを書くたびにぶれてたのですが、「こうすればいけるんじゃないか」と思いつき、その実装を補助するライブラリを開発し、
実践したところ今の所そこそこうまく行っています。
ただまだ日が浅いので少しずつブラッシュアップされていく部分もあると思いますが、
その場合でも「なんとなく」ではなく、可能な限り明文化していくことで、迷いをなくし、コードとログの品質を上げていきたいと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/logging">logging</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Go におけるエラーハンドリングとロギングのプラクティス" href="/golang-logging-error-handling-practice"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/gomic">gomic - Goのモックジェネレータ</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-10-29T23:35:16.000Z" itemprop="datePublished">October 29, 2018</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自作のOSS <a href="https://github.com/suzuki-shunsuke/gomic" target="_blank" rel="noopener noreferrer">gomic</a> の紹介をします。</p><ul><li>なぜわざわざこんなものを作ったのか</li><li>生成されたモックの簡単な使い方</li></ul><p>を主に説明したいと思います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="まとめ">まとめ<a class="hash-link" href="#まとめ" title="Direct link to heading">​</a></h2><ul><li>gomic は Goのinterfaceを実装したモックを生成するCLIツール</li><li>モックを手で書くのが辛すぎた &amp; 既存ツールで満足できなかったため作った<ul><li>自動生成できるコードは自動生成すべき</li></ul></li><li>設定ファイルで管理するため、interfaceの更新に合わせてmockの更新が容易</li><li>生成されるモックはシンプルなAPIのみ提供するので学習コストが低い</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="gomic-とは">gomic とは<a class="hash-link" href="#gomic-とは" title="Direct link to heading">​</a></h2><p>gomic は Goのinterfaceを実装したモックを生成するCLIツールです。
これによってモックを使ったテストの作成を効率化します。
単調な作業を自動化し、本来注力すべきことに注力できるようにするためのツールです。</p><p>Goで書かれています。</p><p><a href="https://github.com/suzuki-shunsuke/gomic/releases" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/releases</a> からバイナリをダウンロードしてインストールできます。</p><p>同様のツールは幾つかあります。</p><ul><li><a href="https://github.com/avelino/awesome-go#testing" target="_blank" rel="noopener noreferrer">https://github.com/avelino/awesome-go#testing</a></li><li><a href="https://github.com/golang/mock" target="_blank" rel="noopener noreferrer">https://github.com/golang/mock</a> (以下 gomock)</li><li><a href="https://github.com/gojuno/minimock" target="_blank" rel="noopener noreferrer">https://github.com/gojuno/minimock</a> (以下 minimock)</li></ul><p>特に gomock は有名ですね。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="なぜ作ったのか">なぜ作ったのか<a class="hash-link" href="#なぜ作ったのか" title="Direct link to heading">​</a></h2><p>上述のように既に同様のツールはありますし、 gomock と minimock は試しました。
しかしあまり満足のいくものではなかったため、自分で作ることにしました。</p><p>自分が欲しかったのは学習コストの低いシンプルなAPIです。
interfaceのメソッドを実装した関数をモックに渡すことで
簡単にメソッドの実装を切り替えたいのです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Getwd メソッドのモック</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetFuncGetwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/tmp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Getwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// &quot;/tmp&quot;, nil</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これは非常にシンプルで分かりやすく、柔軟性のあるパターンです(minimockはこのパターンもサポートしています)。</p><p>gomock や minimock では</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mockSample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EXPECT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hoge&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Return</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>のように 関数のパラメータと戻り値のペアを渡してモックを実装するパターン(何か名前があるのでしょうか？)をサポートしています。
このパターンを gomic はサポートしていません。
このパターンはごく簡単なサンプルでは有効かもしれませんが、実際には使えないことが多いかなと感じています。</p><p>また、gomock はそれ以外にも <a href="https://godoc.org/github.com/golang/mock/gomock#InOrder" target="_blank" rel="noopener noreferrer">gomock.InOrder</a> や <a href="https://godoc.org/github.com/golang/mock/gomock#Call.After" target="_blank" rel="noopener noreferrer">gomock#Call.After</a> など、色々便利なAPIを提供していますが、
それらは学習コストを上げてしまう要因になると思います。
gomicはそういったAPIは提供していません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="素のgoで良いのではgomicいらなくない">素のGoで良いのでは(gomicいらなくない)?<a class="hash-link" href="#素のgoで良いのではgomicいらなくない" title="Direct link to heading">​</a></h3><p>上述のように関数を渡すだけの実装なら gomic なんて使わなくても素のGoで良いのではないかという意見もありそうですね。</p><p><a href="http://haya14busa.com/golang-how-to-write-mock-of-interface-for-testing/" target="_blank" rel="noopener noreferrer">http://haya14busa.com/golang-how-to-write-mock-of-interface-for-testing/</a></p><p>でも似たようなモッキングの方法がライブラリに依存しないでmockを書くパターンとして紹介されています
(似たようなというか、<a href="https://github.com/suzuki-shunsuke/gomic/blob/v0.4.0/examples/os_mock_test.go#L20-L22" target="_blank" rel="noopener noreferrer">gomicも v0.4.0 までは構造体のフィールドに代入していました</a>)。</p><p>Goではライブラリに依存しないで標準ライブラリだけで書くのが良いという思想・意見がよく見られます。
そのため、gomicのようなツールを好まない方がいるのは承知しています。</p><p>ただ、自分はこのパターンの実装を手で愚直に書くのは辛いし、生産的ではないのでツールによって自動生成すべきだと思っています。</p><p>以下は2つのメソッドのみ持つシンプルなインタフェースとそのモックです。</p><ul><li><a href="https://github.com/suzuki-shunsuke/gomic/blob/master/examples/os.go" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/blob/master/examples/os.go</a></li><li><a href="https://github.com/suzuki-shunsuke/gomic/blob/master/examples/os_mock.go" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/blob/master/examples/os_mock.go</a></li></ul><p>とてもシンプルな interface とそのモックですが、それでもモックを実装するのはそこそこ面倒です。
メソッド、interfaceの数に比例してどんどん面倒になります。
golintのようなlinterでエラーにならないようにコードコメントを書くのも地味に大変です。</p><p>interfaceを更新すればmockも更新しないといけません。</p><p>ツールによって自動化すべきです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="モックの使い方">モックの使い方<a class="hash-link" href="#モックの使い方" title="Direct link to heading">​</a></h2><p>生成されたモックの使い方について軽く説明します。
<a href="https://github.com/suzuki-shunsuke/gomic/releases/tag/v0.5.0" target="_blank" rel="noopener noreferrer">v0.5.0</a> 時点のものなので古くなっているかもしれません。
最新の使い方は</p><ul><li><a href="https://github.com/suzuki-shunsuke/gomic" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic</a></li><li><a href="https://github.com/suzuki-shunsuke/gomic/tree/master/examples" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/tree/master/examples</a></li></ul><p>をご確認ください。</p><p>以下のサンプルは <a href="https://github.com/suzuki-shunsuke/gomic/tree/v0.5.0/examples" target="_blank" rel="noopener noreferrer">v0.5.0のサンプル</a> を元にしています。</p><p>まず mock を生成します(以下このモックを生成する関数を&quot;コンストラクタ&quot;と呼びます)。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mock </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> examples</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewOSMock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>第一引数は <em>testing.T で、通常のテストならテスト関数の引数をそのまま渡せば良いし、そうでなければ nil を渡せば良いと思います。
第二引数は `func(t </em>testing.T, intfName, methodName string)` 型の関数で、interfaceのメソッドの実装がセットされていない場合に呼び出されます。nil を渡すと代わりに<a href="https://godoc.org/github.com/suzuki-shunsuke/gomic/gomic#DefaultCallbackNotImplemented" target="_blank" rel="noopener noreferrer">gomic.DefaultCallbackNotImplemented</a> が呼び出されます。</p><p>mockは interface を実装しています。</p><p>次にinterfaceのメソッドを実装した関数をmockにセットします。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetFuncGetwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/tmp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>mock.Getwd</code> を呼び出すと <code>SetFuncGetwd</code> に渡した関数が呼び出されます。</p><p>上記のサンプルのように決まった値を返すだけの fake はよくあるので、以下のように簡単に書けるようにしています。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetReturnGetwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/tmp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>モックの <code>SetFuncXXX</code> 及び <code>SetReturnXXX</code> はモック自身を返すのでメソッドチェーンが出来るようになっています。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mock </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> examples</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewOSMock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">SetReturnMkdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetFuncGetwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/tmp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>実装がセットされていない状態でモックのメソッドを呼び出すと
コンストラクタの第二引数で渡した関数が呼び出されます。</p><p>コンストラクタの第二引数がnilだと <a href="https://godoc.org/github.com/suzuki-shunsuke/gomic/gomic#DefaultCallbackNotImplemented" target="_blank" rel="noopener noreferrer">gomic.DefaultCallbackNotImplemented</a> が呼びだされます。
gomic.DefaultCallbackNotImplemented は コンストラクタの第一引数が nil だと <a href="https://golang.org/pkg/log/#Fatal" target="_blank" rel="noopener noreferrer">log.Fatal</a> を、そうでなければ <a href="https://golang.org/pkg/testing/#T.Fatal" target="_blank" rel="noopener noreferrer">testing.T#Fatal</a> を呼び出し、そこで処理を停止します。</p><p>コンストラクタの第二引数で渡した関数で log.Fatal や testing.Fatal によって処理を止めなければ、interfaceのメソッドを実装していない場合、<a href="https://golang.org/ref/spec#The_zero_value" target="_blank" rel="noopener noreferrer">zero value</a> を返す fake になります。</p><p>一番簡単なのは <a href="https://godoc.org/github.com/suzuki-shunsuke/gomic/gomic#DoNothing" target="_blank" rel="noopener noreferrer">gomic.DoNothing</a> を渡すことです。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> mock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Getwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoNothing</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>上で説明したことは</p><p><a href="https://github.com/suzuki-shunsuke/gomic/blob/v0.5.0/examples/os_mock.go#L27-L67" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/blob/v0.5.0/examples/os_mock.go#L27-L67</a></p><p>を見てもらえばわかると思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gomic">gomic</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about gomic - Goのモックジェネレータ" href="/gomic"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/go-gencfg">go-gencfg - viperの個々のアプリケーション用のラッパーのコードジェネレータ</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-09-06T14:59:35.000Z" itemprop="datePublished">September 6, 2018</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自作のOSS <a href="https://github.com/suzuki-shunsuke/go-gencfg" target="_blank" rel="noopener noreferrer">go-gencfg</a> を紹介します。
Golang で <a href="https://github.com/spf13/viper" target="_blank" rel="noopener noreferrer">viper</a> という汎用的な設定管理ライブラリがありますが、
特定のアプリケーション用に viper のラッパーを生成するCLIツールです。</p><p>使い方や開発の背景を書こうかと思いましたが、だいたい README に書いてあるので
そちらを御覧ください。</p><p><a href="https://github.com/suzuki-shunsuke/go-gencfg/blob/master/README.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-gencfg/blob/master/README.md</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about go-gencfg - viperの個々のアプリケーション用のラッパーのコードジェネレータ" href="/go-gencfg"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.feeb6c7e.js"></script>
<script src="/assets/js/main.8ecade6f.js"></script>
</body>
</html>