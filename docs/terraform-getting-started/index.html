<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">Terraform 入門 | Melody</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/terraform-getting-started"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Terraform 入門 | Melody"><meta data-rh="true" name="description" content="参考"><meta data-rh="true" property="og:description" content="参考"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-01-16T00:25:05.000Z"><meta data-rh="true" property="article:tag" content="terraform"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/terraform-getting-started"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/terraform-getting-started" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/terraform-getting-started" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.7f2e8645.js" as="script">
<link rel="preload" href="/assets/js/main.32c33db3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2021-11">2021-11 やったこと</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/update-aqua-v0.7.16">aqua の最近の update (v0.7.4 ~ v0.7.16)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2021-10">2021-10 やったこと</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2021-09">2021-09 やったこと</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/aqua-global-configs">aqua で組織・チームのツール群を管理</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Terraform 入門</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-16T00:25:05.000Z" itemprop="datePublished">January 16, 2020</time> · <!-- -->26 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="参考">参考<a class="hash-link" href="#参考" title="Direct link to heading">​</a></h2><ul><li><a href="https://qiita.com/Chanmoro/items/55bf0da3aaf37dc26f73" target="_blank" rel="noopener noreferrer">10分で理解するTerraform | Qiita</a></li><li><a href="https://qiita.com/fukubaka0825/items/68506b1e6644404d6cc0" target="_blank" rel="noopener noreferrer">Terraform入門資料(v0.12.0対応) ~基本知識から設計や運用、知っておくべきtipsまで~ | Qiita</a></li><li><a href="https://dev.classmethod.jp/cloud/terraform-getting-started-with-aws/" target="_blank" rel="noopener noreferrer">AWSでTerraformに入門 | Developers.io</a></li><li><a href="https://qiita.com/minamijoyo/items/1f57c62bed781ab8f4d7" target="_blank" rel="noopener noreferrer">Terraform職人入門: 日々の運用で学んだ知見を淡々とまとめる | Qiita</a></li></ul><p>手を動かしたい方は <a href="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/" target="_blank" rel="noopener noreferrer">Terraform ハンズオン with MySQL Provider</a> も参考にしてください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="前提">前提<a class="hash-link" href="#前提" title="Direct link to heading">​</a></h2><ul><li>執筆時点 (2020/01/05) で Terraform の最新バージョンは v0.12.18 です</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-とは">Terraform とは<a class="hash-link" href="#terraform-とは" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> は Infrastructure as Code を実現する汎用的なCLIツールです。
インフラの状態を設定ファイルに定義し、コマンドを実行することで、
実際のインフラの状態と設定ファイルの差分を検知し、設定ファイルに記述されたとおりになるようにインフラを変更(CRUD)します。</p><p><a href="https://www.hashicorp.com/" target="_blank" rel="noopener noreferrer">Hashicorp</a> という企業がホストしている OSS になります。
Go で書かれています。 <a href="https://github.com/hashicorp/terraform" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-のインストール">Terraform のインストール<a class="hash-link" href="#terraform-のインストール" title="Direct link to heading">​</a></h2><p>Terraform は Go 製なので 1 バイナリをダウンロードしてインストールするだけです。</p><p><a href="https://www.terraform.io/downloads.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/downloads.html</a></p><p>tfenv を使うと管理が楽です。</p><p><a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer">https://github.com/tfutils/tfenv</a></p><p>tfenv は Terraform のバージョン管理ツールです。
pyenv や rbenv の Terraform 版みたいなものです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="用語集">用語集<a class="hash-link" href="#用語集" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="provider">Provider<a class="hash-link" href="#provider" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html#terraform-provider" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#terraform-provider</a></p><p>Terraform を「汎用的な」ツールといいましたが、ここでいう「汎用的」とは、 AWS などの特定のサービス専用ではなく、様々なサービスを同じように扱うことが出来るという意味です。
実際に AWS などのインフラを操作する場合にはインフラが提供する API を利用するわけですが、
サービス固有の API 呼び出しなどの処理を <code>Provider</code> という形で Terraform 本体から切り出すことでこの汎用性は実現されています。
Provider は AWS や GCP などの Hashicorp 公式のものもあれば、サードパーティ製のものもありますし、自分で作ってしまうことも出来ます。</p><ul><li>公式 Provider<ul><li><a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/index.html</a></li><li><a href="https://github.com/terraform-providers" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers</a></li></ul></li><li>サードパーティ Provider<ul><li><a href="https://www.terraform.io/docs/providers/type/community-index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/type/community-index.html</a></li><li>[宣伝][Graylog]<!-- -->(<a href="https://www.graylog.org/products/open-source" target="_blank" rel="noopener noreferrer">https://www.graylog.org/products/open-source</a>) の Provider <a href="https://github.com/suzuki-shunsuke/go-graylog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog</a></li></ul></li></ul><p>少し突っ込んだ話をすると、 Terraform 本体同様 Provider も実態は Golang で書かれた1バイナリであり、本体から Provider を RPC によって呼び出すという形でプラグイン機構を実現しています。
<a href="https://github.com/hashicorp/go-plugin" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/go-plugin</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="余談-provider-の自作">余談: Provider の自作<a class="hash-link" href="#余談-provider-の自作" title="Direct link to heading">​</a></h3><p>Provider の自作に興味のある方は <a href="https://www.terraform.io/docs/extend/writing-custom-providers.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/extend/writing-custom-providers.html</a> を読むと良いでしょう。
ただし、それを読めば全てわかるということはなく、作りながら Terraform 本体や AWSなどの公式の Provider のソースコードや GoDoc を読みつつ試行錯誤することになると思います。</p><ul><li><a href="https://github.com/terraform-providers/terraform-provider-aws/tree/master/aws" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers/terraform-provider-aws/tree/master/aws</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#Schema" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#Schema</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#ResourceData" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#ResourceData</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソース">リソース<a class="hash-link" href="#リソース" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html#resource" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#resource</a></p><p>Terraform ではインフラを構成する最小の構成要素を <code>リソース</code> と呼びます。
例えばサーバが 3 台あればそれぞれが別々のリソースと言えます。
リソースごとに設定を記述します。
<code>terraform apply</code> コマンドを実行すると各リソースについて設定と実際のインフラの状態の差分が検知され、リソースごとに CRUD 処理が実行されます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="設定ファイル">設定ファイル<a class="hash-link" href="#設定ファイル" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/configuration/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/index.html</a></li><li><a href="https://github.com/hashicorp/hcl/blob/hcl2/hclsyntax/spec.md" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/hcl/blob/hcl2/hclsyntax/spec.md</a></li></ul><p>設定ファイルは <a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener noreferrer">HCL</a> という言語で記述します。
HCL は Hashicorp Configuration Language の略で、 Hashicorp が開発している JSON や YAML のような設定を記述する言語です。</p><p>Terraform v0.12 では HCL の v2 を使います。 v1 は古いので注意してください。</p><p>設定ファイルの拡張子は基本 <code>.tf</code> です。
次のような形でリソースを定義します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># resource &quot;リソースの種類&quot; &quot;リソース名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_instance&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 属性名 = 属性値</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ami           = &quot;ami-2757f631&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_type = &quot;t2.micro&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>余談ですが、 <a href="https://github.github.com/gfm/" target="_blank" rel="noopener noreferrer">GFM (GitHub Flavored Markdown)</a> では <code>hcl</code> でシンタックスハイライトができます。</p><p>各リソース定義はパスによって識別されます。
上記のようなシンプルなリソースの定義の場合 <code>リソースの種類.リソース名</code> (<code>aws_instance.example</code>) です。パスは一意でなければいけません。</p><p>設定ファイルは同じ1つのディレクトリに置きます。
<code>terraform plan</code> などのコマンドはカレントディレクトリ直下のファイルしか見ません。</p><p>リソースの属性はリソースの種類によって異なります。
各Provider のドキュメントを参照しましょう。</p><p>例えば AWS の EC2 instance のドキュメントはこちらです。 <a href="https://www.terraform.io/docs/providers/aws/r/instance.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/aws/r/instance.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの属性の参照">リソースの属性の参照<a class="hash-link" href="#リソースの属性の参照" title="Direct link to heading">​</a></h2><p>あるリソースの設定で他のリソースの属性値を参照することが出来ます。</p><p>サンプルを示します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_instance_profile&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # リソース aws_iam_role.example の属性 name の値を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role = aws_iam_role.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="state">State<a class="hash-link" href="#state" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/index.html</a></p><p>設定ファイルと実際のインフラの差分を検知するには、設定ファイルのリソース定義と実際のインフラのマッピングが必要になります。
設定ファイル上ではリソースはパスによって識別されますが、実際のインフラのリソースはインフラ固有の ID などで識別されます。
設定ファイル上のリソースのパスと、実際のインフラのリソースの ID とのマッピングを保存するストレージが <code>State</code> になります。
ただし State の役割はマッピングだけではありません。詳細は <a href="https://www.terraform.io/docs/state/purpose.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/purpose.html</a> を参照してください。
「ストレージ」といいましたがその実態はデフォルトではただの JSON ファイルです。
デフォルトでは <code>terraform apply</code> などを実行すると勝手に <code>terraform.tfstate</code> という名前のファイルがカレントディレクトリに作成、更新されます。
State の保存先は S3 を含め色々サポートされています。</p><p><a href="https://www.terraform.io/docs/backends/types/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/index.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-state-を持たないツールとの違い">発展: State を持たないツールとの違い<a class="hash-link" href="#発展-state-を持たないツールとの違い" title="Direct link to heading">​</a></h3><p>Terraform の他にもインフラを管理するツールはありますが、その中には State のようなマッピングを持たないものもあります。
マッピングを持たないツールだと、ツールを使わずに作ったリソースがツールによって削除される可能性があります。
一方、 Terraform ではツールを使わずに作ったリソースは変更の対象になりません。
変更の対象にしたい場合はそのリソースの情報を State に追加する必要があります。
ただの JSON ファイルなので手で修正することも出来ますが、 <a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">terraform import</a> という専用のコマンドがあるのでそれを使うほうが安全です。</p><p><a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a></p><p>逆に、あまりないケースではありますが、あるリソースについて Terraform で管理するのをやめたい場合、
そのリソースを設定ファイルだけでなく State からも削除する必要があります。
単純に設定ファイルから削除するだけだと、 Terraform によって実際のインフラのリソースが削除されてしまいます。
State から削除するには <a href="https://www.terraform.io/docs/commands/state/rm.html" target="_blank" rel="noopener noreferrer">terraform state rm</a> というコマンドを使います。</p><p>その他 State を管理するためのコマンドが色々あるのでドキュメントを参照してください。</p><p><a href="https://www.terraform.io/docs/commands/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/index.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-remote-state-を使うか否か">発展: Remote State を使うか否か<a class="hash-link" href="#発展-remote-state-を使うか否か" title="Direct link to heading">​</a></h3><p>Terraform を CI/CD によって実行する前提です。
基本的に remote state を使うべきだと思います。</p><p>remote state を使わない場合、 <code>terraform.tfstate</code> を Git で管理することになるでしょう。
その場合、 feature branch の terraform.tfstate と実際のインフラの状態の乖離が起こりえます。
チームの規模が大きく複数の開発が並行して行われれば行われるほど、乖離の弊害が大きくなり、 remote state を使ったほうが良いということになるでしょう。</p><p>また、 CI/CD で更新された <code>terraform.tfstate</code> を commit &amp; push する必要があります。
<code>terraform apply</code> で失敗した場合、一部のリソースの更新には成功し、State が更新されているかもしれません。
<code>terraform apply</code> が失敗しても即座に終了させずに <code>terraform.tfstate</code> を commit &amp; push する必要があります。
これは CI/CD のコードで気をつければ問題ないのでデメリットと言うほどではないですが、昔自分は何度か commit &amp; push し損ねて面倒くさいことになりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変数">変数<a class="hash-link" href="#変数" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/glossary.html#variables" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#variables</a></li><li><a href="https://learn.hashicorp.com/terraform/getting-started/variables.html" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/terraform/getting-started/variables.html</a></li></ul><p>設定ファイルでは変数が使えます。
変数を使うには宣言が必要です。宣言では型なども指定できます。</p><p><a href="https://www.terraform.io/docs/configuration/types.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/types.html</a></p><p>変数の宣言はつぎのようにします。 <code>.tf</code> のどこに書いても大丈夫です。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># variable &quot;変数名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = &quot;string&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>変数の値の設定は次のようにします。 <code>terraform.tfvars</code> というファイル名に書いておくとコマンド実行時に自動で読み込まれます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ami = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;us-east-1&quot; = &quot;ami-abc123&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;us-west-2&quot; = &quot;ami-def456&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>コマンドライン引数で渡すことも出来ます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="provider-の設定">Provider の設定<a class="hash-link" href="#provider-の設定" title="Direct link to heading">​</a></h2><p>Provider を使うには設定が必要です。
設定の属性は Provider によって違います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># provider &quot;Provider名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;google&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = &quot;acme-app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = &quot;us-central1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="module">Module<a class="hash-link" href="#module" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/modules/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/modules/index.html</a>
<a href="https://www.terraform.io/docs/configuration/modules.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/modules.html</a></p><p>複数のリソースの設定をまとめて再利用可能な形でパッケージングする仕組みとして Module があります。
リソースが1つだけでも、チーム固有の設定を Module のデフォルト値として設定したり、チームでは使わないリソースの属性を隠蔽したり用途はあるかと思います。</p><p>Module の作り方は通常の Terraform の設定ファイルの記述と同様、 1つのディレクトリ直下にパッケージングするリソースの設定ファイルを記述するだけです。</p><p>Module は次のように使います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># module &quot;名前&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;servers&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # モジュールへのパス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./app-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # モジュールのパラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  servers = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Module のパスは <code>module.モジュール名</code> (module.servers) になります。</p><p>Module の <code>source</code> としてはローカルのディレクトリへのパス以外にも様々なものをサポートしています。</p><p><a href="https://www.terraform.io/docs/modules/sources.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/modules/sources.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="コミュニティの-module">コミュニティの Module<a class="hash-link" href="#コミュニティの-module" title="Direct link to heading">​</a></h3><p>コミュニティによって様々な Module が提供されています。</p><ul><li><a href="https://registry.terraform.io/" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/</a></li><li><a href="https://registry.terraform.io/modules/terraform-aws-modules" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/modules/terraform-aws-modules</a></li><li><a href="https://github.com/terraform-community-modules" target="_blank" rel="noopener noreferrer">https://github.com/terraform-community-modules</a></li><li><a href="https://github.com/terraform-aws-modules" target="_blank" rel="noopener noreferrer">https://github.com/terraform-aws-modules</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-化するべきか否か">Module 化するべきか否か<a class="hash-link" href="#module-化するべきか否か" title="Direct link to heading">​</a></h3><p>Go や Python などのプログラミング言語でのモジュール(ライブラリやパッケージ等呼び方は様々ですが)化と比べ、
Terraform の Module 化は慎重でなければなりません。
理由はいくつかありますが、</p><ul><li>Module を変更すると State の変更も必要になる場合もある</li><li>Terraform の設定は中々パワフルだとは思いますが、プログラミング言語に比べると柔軟性が足らず、変更に弱く、複雑になるとメンテナンス性が悪くなります</li></ul><p>偏見かもしれませんが、プログラミング言語に比べると、 Terraform に「精通」している人はそれほど多くないと思います。
初心者は直ぐ Module 化に飛びつくのはやめた方が良いと思います(尤も使ってみないと理解が深まらないという意味では使ったほうが良いですが)。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/outputs.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/outputs.html</a></p><p>Module で定義したリソースの属性は基本的に外部から隠蔽されます。
リソースの属性を参照できるようにするには、次のように個別に Output として宣言する必要があります。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;instance_ip_addr&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_instance.server.private_ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これはモジュールで定義したリソース <code>aws_instance.server</code> の属性 <code>private_ip</code> を Module の属性 <code>instance_ip_addr</code> として外部に公開するという意味です。
Module のパスが module.servers だとすると、 <code>module.servers.instance_ip_addr</code> で参照できます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="data-source">Data Source<a class="hash-link" href="#data-source" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/data-sources.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/data-sources.html</a></p><p>Data source は Terraform で管理していない(あるいは他の State で管理している)リソースの属性を参照するための仕組みです。</p><p>次のように記述します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># data &quot;リソースの種類&quot; &quot;リソース名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;aws_ami&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # リソースを一意に識別するためのクエリ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  most_recent = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  owners = [&quot;self&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name   = &quot;app-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tested = &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Data source では属性によって実際のインフラのリソースを検索します。検索にマッチするリソースは必ず1つでなければならず、
複数マッチしたり1つもマッチしなかったりすると失敗します(厳密には Provider の実装次第ですが)。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="他の-state-で管理されているリソースの属性を-data-source-として参照する">他の State で管理されているリソースの属性を Data source として参照する<a class="hash-link" href="#他の-state-で管理されているリソースの属性を-data-source-として参照する" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/providers/terraform/d/remote_state.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/terraform/d/remote_state.html</a></p><p>他の State で管理されているリソースの属性を Data source を使って参照するために <code>terraform_remote_state</code> があります。
参照するには Module 同様 その属性が Output によって外部に公開されている必要があります。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;terraform_remote_state&quot; &quot;vpc&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;remote&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    organization = &quot;hashicorp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspaces = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name = &quot;vpc-prod&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="workspace">workspace<a class="hash-link" href="#workspace" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/state/workspaces.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/workspaces.html</a></li><li><a href="https://blog.mosuke.tech/entry/2018/06/16/terraform-workspaces/" target="_blank" rel="noopener noreferrer">Terraform workspaceを利用して環境毎のリソース名の変更を行う</a></li><li><a href="http://kenzo0107.hatenablog.com/entry/2019/04/17/103558" target="_blank" rel="noopener noreferrer">Terraform 運用ベストプラクティス 2019 ~workspace をやめてみた等諸々~</a></li></ul><p>Terraform には workspace という機能がありますが、こちらの機能は自分は使ったことがないので簡単に触れるだけに留めます。
workspace の代表的なユースケースは production や staging などの異なる環境で同じ設定ファイルを共有しつつ State を switch することだと思います。</p><p>workspace を使わない場合環境ごとにディレクトリ及び設定ファイルを完全に分けることになると思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>workspace を使うと設定ファイルを共有できます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform.tfstate.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform.tfstate</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>環境ごとの設定の微妙な違いは設定ファイル内で分岐することになるのでしょう。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-workspace-を使うべきか">発展: workspace を使うべきか<a class="hash-link" href="#発展-workspace-を使うべきか" title="Direct link to heading">​</a></h3><p>workspace を使うべきか否かは意見が分かれている様に思えます。
恐らくユースケースやチームメンバーの Terraform への成熟度にもよるでしょう。</p><p>現状自分は「使わない」というスタンスです。</p><p>自分がこれまで関わってきたチーム事情だと Terraform に全員が精通しているというよりは、むしろ Terraform にそこまで詳しくない人も触ることが多いです。
偏見かもしれませんが、そういうチームは少なくないのではないでしょうか？
そういうチーム状況では、 workspace を使って DRY になるというメリット以上に、 workspace そのものへの学習コストや環境によって設定ファイル内で分岐する学習コストを省き、
Terraform に精通していなくても理解できるくらいシンプルに保つことのほうが大事なのではないかなと思います。</p><p>特に、これまで Terraform を特定のサービス横断的なチームで管理していた状態から各サービスの担当者に ownership を委譲しようとする場合、上述の学習コスト・複雑さが弊害になるのではないかなと感じています。</p><p>ただし、繰り返しになりますが自分は workspace を使ったことがありません。
上記の自分の認識が間違っているかもしれませんし、今後 workspace を使ってみたら考えが変わるかもしれません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-command-の基本的な使い方">Terraform command の基本的な使い方<a class="hash-link" href="#terraform-command-の基本的な使い方" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/index.html</a></p><p>設定ファイルを書いた上で基本的なコマンドの使い方について説明します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-init">terraform init<a class="hash-link" href="#terraform-init" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/init.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/init.html</a></p><p>まず、 <code>terraform init</code> を実行する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform init</code> によって、依存する Provider がインストールされたりします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-fmt">terraform fmt<a class="hash-link" href="#terraform-fmt" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/fmt.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/fmt.html</a></p><p><code>terraform fmt</code> によってコードを整形することが出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform fmt [-check] [-recursive]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-check</code> をつけると、コードを整形する代わりに、コードが整形されていなかったら exit code が non 0 で終了します。
CI でコードが整形されているかのチェックに使えます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-plan">terraform plan<a class="hash-link" href="#terraform-plan" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/plan.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/plan.html</a></p><p><code>terraform plan</code> によって <code>terraform apply</code> の dry run が出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan [-refresh=false]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>実際のインフラは変更されず、 <code>apply</code> を実行した場合にどのような変更が行われるか出力されます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-apply">terraform apply<a class="hash-link" href="#terraform-apply" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/apply.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/apply.html</a></p><p>実際にインフラを設定ファイルに合わせて変更します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply [-auto-approve]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>デフォルトでは最初に plan の実行結果が出力されて本当に変更を適用してよいか確認があります。
<code>-auto-approve</code> を指定すると確認を skip 出来ます。</p><p><code>plan</code> に成功しても <code>apply</code> には失敗する場合もあります。
簡単な例としては更新する権限がない場合です。
<code>apply</code> に失敗すると一部のリソースだけ更新されるということは起こりえます。
そうなってもロールバックとかは出来ない(terraform に rollback の機能はない)ので注意してください。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-destroy">terraform destroy<a class="hash-link" href="#terraform-destroy" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/destroy.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/destroy.html</a></p><p>Terraform で作成したインフラを削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>恐らく実際の運用でこれを使うことはあまりないと思います。
削除したいなら設定ファイルからそのリソースを消して apply するでしょう。
Terraform の勉強がてら遊びで作ったものを丸っと消すとか主にそういう用途で使われる気がします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-refresh">terraform refresh<a class="hash-link" href="#terraform-refresh" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/refresh.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/refresh.html</a></p><p>State を実際のインフラの状態に合わせて更新します。
インフラは更新されません。
手動でインフラを変更した場合に、その変更を State に反映させるのに使えます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform refresh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-import">terraform import<a class="hash-link" href="#terraform-import" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/import.html</a>
<a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a></p><p>Terraform で管理されていないリソースのデータを State にインポートします。
State はリソースパスとインフラのID のマッピングを管理すると言いましたが、 import コマンドの引数ではこの2つを渡すことでマッピングできるようにします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># リソースパス ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import aws_instance.example i-abcd1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ちなみに、一部のリソースは import をサポートしてません。
サポートしているかどうかは Provider の実装に依存します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state">terraform state<a class="hash-link" href="#terraform-state" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/index.html</a></p><p>State を操作するためのコマンドです。様々なサブコマンドがあります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-の-cicd">Terraform の CI/CD<a class="hash-link" href="#terraform-の-cicd" title="Direct link to heading">​</a></h2><p>terraform apply は原則 CD によって実行されるべきだし、
CI によって <code>terraform fmt -check</code> や <code>terraform plan</code> は実行されるべきだと思っています。</p><p>逆に <code>terraform plan</code> や <code>apply</code> は CI/CD でやってるけど、
<code>terraform state</code> や <code>terraform import</code> はローカルから実行しているというチームも少なくはないのかなという気がしています。</p><p>課題となりうるのは</p><ul><li>Credential の管理</li><li>IP制限</li></ul><p>かなと思います。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="credential-の管理">Credential の管理<a class="hash-link" href="#credential-の管理" title="Direct link to heading">​</a></h3><p>Terraform で使うクレデンシャルは強力な権限を持ちがちなので扱いに注意しないといけません。
権限を絞るのが理想ですが、結構難しかったりします。</p><p>例えば PR の CI では <code>terraform apply</code> を実行しないのであれば、 PR の CI 用に Read Only なクレデンシャルを用意するとかもありかもしれません。</p><p>例えば AWS のインフラ管理を Terraform + CircleCI で行う場合、
AWS のクレデンシャルを CircleCI で参照できるようにする必要があります。
CircleCI では SSH でコンテナにログインできるため、クレデンシャルを盗もうと盗めますし、
CircleCI に限らず悪意のあるコードを CI で実行して外部にクレデンシャルを送ることも出来ます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ip-制限">IP 制限<a class="hash-link" href="#ip-制限" title="Direct link to heading">​</a></h3><p>CI で Terraform を使う場合、 CI の実行環境からインフラの API にアクセスできる必要があります。
IP 制限をかけている場合、 CI の実行環境からはアクセスできるようにするなどの工夫が必要です。
CI の実行環境の IP range が定まってない場合、話は更に難しくなります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="発展-設定ファイル中で使える関数">発展: 設定ファイル中で使える関数<a class="hash-link" href="#発展-設定ファイル中で使える関数" title="Direct link to heading">​</a></h2><p>設定ファイル内ではビルドイン関数が使えます。
公式ドキュメントを参照してください。</p><p><a href="https://www.terraform.io/docs/configuration/functions.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/functions.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="余談-awesome-terraform">余談: awesome-terraform<a class="hash-link" href="#余談-awesome-terraform" title="Direct link to heading">​</a></h2><p><a href="https://github.com/shuaibiyy/awesome-terraform" target="_blank" rel="noopener noreferrer">https://github.com/shuaibiyy/awesome-terraform</a></p><p>Terraform 関連の awesome なツールのリンク集です。</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/terraform-hands-on-with-mysql-provider"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Terraform ハンズオン with MySQL Provider</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/terraform-state-locking"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Terraform の State Locking の概要</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li><li><a href="#前提" class="table-of-contents__link toc-highlight">前提</a></li><li><a href="#terraform-とは" class="table-of-contents__link toc-highlight">Terraform とは</a></li><li><a href="#terraform-のインストール" class="table-of-contents__link toc-highlight">Terraform のインストール</a></li><li><a href="#用語集" class="table-of-contents__link toc-highlight">用語集</a></li><li><a href="#provider" class="table-of-contents__link toc-highlight">Provider</a><ul><li><a href="#余談-provider-の自作" class="table-of-contents__link toc-highlight">余談: Provider の自作</a></li></ul></li><li><a href="#リソース" class="table-of-contents__link toc-highlight">リソース</a></li><li><a href="#設定ファイル" class="table-of-contents__link toc-highlight">設定ファイル</a></li><li><a href="#リソースの属性の参照" class="table-of-contents__link toc-highlight">リソースの属性の参照</a></li><li><a href="#state" class="table-of-contents__link toc-highlight">State</a><ul><li><a href="#発展-state-を持たないツールとの違い" class="table-of-contents__link toc-highlight">発展: State を持たないツールとの違い</a></li><li><a href="#発展-remote-state-を使うか否か" class="table-of-contents__link toc-highlight">発展: Remote State を使うか否か</a></li></ul></li><li><a href="#変数" class="table-of-contents__link toc-highlight">変数</a></li><li><a href="#provider-の設定" class="table-of-contents__link toc-highlight">Provider の設定</a></li><li><a href="#module" class="table-of-contents__link toc-highlight">Module</a><ul><li><a href="#コミュニティの-module" class="table-of-contents__link toc-highlight">コミュニティの Module</a></li><li><a href="#module-化するべきか否か" class="table-of-contents__link toc-highlight">Module 化するべきか否か</a></li></ul></li><li><a href="#output" class="table-of-contents__link toc-highlight">Output</a></li><li><a href="#data-source" class="table-of-contents__link toc-highlight">Data Source</a><ul><li><a href="#他の-state-で管理されているリソースの属性を-data-source-として参照する" class="table-of-contents__link toc-highlight">他の State で管理されているリソースの属性を Data source として参照する</a></li></ul></li><li><a href="#workspace" class="table-of-contents__link toc-highlight">workspace</a><ul><li><a href="#発展-workspace-を使うべきか" class="table-of-contents__link toc-highlight">発展: workspace を使うべきか</a></li></ul></li><li><a href="#terraform-command-の基本的な使い方" class="table-of-contents__link toc-highlight">Terraform command の基本的な使い方</a><ul><li><a href="#terraform-init" class="table-of-contents__link toc-highlight">terraform init</a></li><li><a href="#terraform-fmt" class="table-of-contents__link toc-highlight">terraform fmt</a></li><li><a href="#terraform-plan" class="table-of-contents__link toc-highlight">terraform plan</a></li><li><a href="#terraform-apply" class="table-of-contents__link toc-highlight">terraform apply</a></li><li><a href="#terraform-destroy" class="table-of-contents__link toc-highlight">terraform destroy</a></li><li><a href="#terraform-refresh" class="table-of-contents__link toc-highlight">terraform refresh</a></li><li><a href="#terraform-import" class="table-of-contents__link toc-highlight">terraform import</a></li><li><a href="#terraform-state" class="table-of-contents__link toc-highlight">terraform state</a></li></ul></li><li><a href="#terraform-の-cicd" class="table-of-contents__link toc-highlight">Terraform の CI/CD</a><ul><li><a href="#credential-の管理" class="table-of-contents__link toc-highlight">Credential の管理</a></li><li><a href="#ip-制限" class="table-of-contents__link toc-highlight">IP 制限</a></li></ul></li><li><a href="#発展-設定ファイル中で使える関数" class="table-of-contents__link toc-highlight">発展: 設定ファイル中で使える関数</a></li><li><a href="#余談-awesome-terraform" class="table-of-contents__link toc-highlight">余談: awesome-terraform</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7f2e8645.js"></script>
<script src="/assets/js/main.32c33db3.js"></script>
</body>
</html>