<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">Blog | Melody</title><meta data-rh="true" property="og:title" content="Blog | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud//page/8"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud//page/8"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud//page/8" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud//page/8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.24bd547c.css">
<link rel="preload" href="/assets/js/runtime~main.c5c9b8c5.js" as="script">
<link rel="preload" href="/assets/js/main.f7990f4d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-12">Look back at Dec 2022</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-11">My Activity in 2022-11</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-10">My Activity in 2022-10</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-09">My Activity in 2022-09</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-08">2022-08 振り返り</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/skaffold-generator">Skaffold で特定のサービスだけ動かすためのツールを作った</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-04-05T09:53:25.000Z" itemprop="datePublished">April 5, 2020</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自作の CLI ツール <a href="https://github.com/suzuki-shunsuke/skaffold-generator" target="_blank" rel="noopener noreferrer">skaffold-generator</a> の紹介です。
プロトタイピングみたいなノリで半日くらいで割と手早く作れました。
名前が長くて適当なのでもっと良い名前ないかなと思ってます。</p><p><a href="https://github.com/suzuki-shunsuke/skaffold-generator" target="_blank" rel="noopener noreferrer">Skaffold</a> に欲しい機能がないので補完する感じで作ったのですが、「それ〇〇で出来るよ」とかあったら(GitHub issue とか Twitter で)教えていただけると幸いです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="どんなツールか">どんなツールか<a class="hash-link" href="#どんなツールか" title="Direct link to heading">​</a></h2><p>設定ファイル <code>skaffold-generator.yaml</code> を監視して変更があったら <code>skaffold.yaml</code> を生成するツールです。設定ファイルでサービスの依存関係を定義できたり、コマンドライン引数で指定したサービス及びそれが依存するサービスに関連した設定だけを使って <code>skaffold.yaml</code> を更新します。
このツールは <code>skaffold.yaml</code> を生成するだけなので実際にアプリケーションをビルド・デプロイするには <code>skaffold</code> と組み合わせて使います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="なぜ作ったか">なぜ作ったか<a class="hash-link" href="#なぜ作ったか" title="Direct link to heading">​</a></h2><p>元々ローカルでアプリケーションを動かしながら開発するために Docker Compose を使ってるリポジトリがあるのですが、それを skaffold に移行出来ないか検証しています。
まだ skaffold を触り始めたばかりで理解が浅いのですが、
本番環境は k8s で動いてるからローカルも k8s で動かせるといいかなと思ったり、あとは変更を検知して自動でビルド・デプロイしてくれたりして便利そうかなと思いました。
まぁ結果的に移行しないことになったとしても、 Skaffold と現状の仕組みについて理解が深まればいいかなくらいのつもりです。</p><p>検証の過程で、 以下のようなことが Docker Compose だと出来るけど Skaffold だと難しそうだと思いました。</p><ul><li>サービスの依存関係を定義すること<ul><li>Skaffold というより k8s の問題かとは思いますが</li><li>Docker Compose だと依存するものを自動で起動してくれて便利</li></ul></li><li>コマンドライン引数で指定したサービスだけ起動すること<ul><li>Skaffold だと skafffold.yaml で定義したものすべてがビルド・デプロイされるという認識</li></ul></li></ul><p>サービスの数が少なければ全部ビルド・デプロイでもいいですが、
マイクロサービスをモノレポで管理しているような場合、
すべてのマイクロサービスをビルド・デプロイするのは無駄が大きかったりします。</p><p>そこで <code>skaffold.yaml</code> の元となる設定ファイルを用意し、コマンドライン引数でサービスを指定して必要最小限の <code>skaffold.yaml</code> を生成するツールを作ってみました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="インストール">インストール<a class="hash-link" href="#インストール" title="Direct link to heading">​</a></h2><p>Go のバイナリをダウンロードしてきてください。 <a href="https://github.com/suzuki-shunsuke/skaffold-generator/releases" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/skaffold-generator/releases</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="使い方">使い方<a class="hash-link" href="#使い方" title="Direct link to heading">​</a></h2><p>使い方は簡単です。サブコマンドもありません。
リポジトリにサンプルがあるのでそれを見ましょう。</p><ul><li><a href="https://github.com/suzuki-shunsuke/skaffold-generator#getting-started" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/skaffold-generator#getting-started</a></li><li><a href="https://github.com/suzuki-shunsuke/skaffold-generator/tree/master/examples" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/skaffold-generator/tree/master/examples</a></li></ul><p>まずは <code>skaffold-generator.yaml</code> を用意します。</p><p><code>skaffold-generator.yaml</code> は <code>base</code> と <code>services</code> からなります。</p><p><code>base</code> は生成される <code>skaffold.yaml</code> のベースとなるものです。
<code>deploy.kubectl.manifests</code> と <code>build.artifacts</code> は上書きされるので指定しないでください。</p><p><code>services</code> ではサービスのリストを定義します。
各サービスは以下の属性を持ちます。</p><ul><li>name: サービス名。コマンドライン引数と <code>depends_on</code> でサービスを指定するのに使う。ユニークにする</li><li>manifests: skaffold.yaml の <code>deploy.kubectl.manifests</code> </li><li>artifacts: skaffold.yaml の  <code>build.artifacts</code></li><li>depends_on: サービスが依存するサービス名のリスト</li></ul><p>用意したら <code>skaffold-generator</code> を実行します。 skaffold.yaml が生成(既にあれば上書き)され、 <code>skaffold-generator.yaml</code> の変更を監視した状態になります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold-generator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020/04/05 18:19:37 start to watch skaffold-generator.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>コマンドライン引数でサービス名を指定しない場合、すべてのサービスが <code>skaffold.yaml</code> に反映されます。
別のターミナルで <code>skaffold dev</code> を実行すれば
生成された <code>skaffold.yaml</code> を使ってアプリケーションをビルド・デプロイ出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold dev</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>skaffold-generator.yaml</code> を変更すれば、その変更を検知し <code>skaffold.yaml</code> が更新され、そして <code>skaffold dev</code> が <code>skaffold.yaml</code> の変更を検知しアプリケーションがビルド・デプロイされます。</p><p>引数無しですべてのサービスをデプロイするとこのツールの意味がないので、コマンドライン引数でサービス名を指定しましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold-generator api</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうするとサービス <code>api</code> と <code>api</code> が依存するサービス(依存関係は再帰的に処理されます)だけが <code>skaffold.yaml</code> に反映されます。
依存関係は循環してても大丈夫です。</p><p>使い方は以上です。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="docker-compose-みたいにできないこと">Docker Compose みたいにできないこと<a class="hash-link" href="#docker-compose-みたいにできないこと" title="Direct link to heading">​</a></h2><p>Docker Compose みたいに依存関係を定義できるようになりましたが、
Docker Compose みたいにデプロイの順序は考慮されません。
まぁこのツールは <code>skaffold.yaml</code> を生成するだけなので仕方ないですね。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="最後に">最後に<a class="hash-link" href="#最後に" title="Direct link to heading">​</a></h2><p>以上、 <code>skaffold-generator</code> の紹介でした。
まだ作ったばっかで自分でも使えてないので本当に使い物になるのかは分かりませんが、
興味ある人は触ってみてください。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/k-8-s">k8s</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/skaffold">skaffold</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/skaffold-generator">skaffold-generator</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-hands-on-with-mysql-provider">Terraform ハンズオン with MySQL Provider</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-17T00:14:08.000Z" itemprop="datePublished">January 17, 2020</time> · <!-- -->40 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform を勉強するには実際に使ってみるのが一番手っ取り早いですが、
では手頃な題材はあるかと言われると少し難しいです。</p><p><a href="https://learn.hashicorp.com/terraform/getting-started/build" target="_blank" rel="noopener noreferrer">公式の Getting Started では AWS が使われています</a>が、
AWS のアカウントやクレデンシャルが必要ですしお金もかかってしまいます(無料枠はありますが)。
もう少し手軽なものが欲しいところです。</p><p>そこで公式の Provider で丁度いいものはないか探したところ、 <a href="https://www.terraform.io/docs/providers/mysql/" target="_blank" rel="noopener noreferrer">MySQL Provider</a> が良さそうでした。
MySQL のユーザーや Database を Terraform で管理したいとは自分は思いませんが、 Terraform の入門で遊ぶにはちょうどよいでしょう。</p><p>ちなみに公式の Provider のリストはこちらです。</p><ul><li><a href="https://github.com/terraform-providers" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers</a></li><li><a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/index.html</a></li></ul><p>また、 Terraform に関しては <a href="https://techblog.szksh.cloud/terraform-getting-started/" target="_blank" rel="noopener noreferrer">Terraform 入門</a> も参照してください。</p><p>今回の作業用に適当にディレクトリを作成し、そこで作業しましょう。</p><p>以降、コマンドの実行結果は一部省略することがあります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir workspace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd workspace</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-のバージョンと-tfenv">Terraform のバージョンと tfenv<a class="hash-link" href="#terraform-のバージョンと-tfenv" title="Direct link to heading">​</a></h2><p>Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で <code>terraform plan</code> などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。
そういう意味では、 <a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer">tfenv</a> によってバージョン管理するのが良いです。</p><p><code>.terraform-version</code> を作成します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo 0.12.19 &gt; .terraform-version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tfenv install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform v0.12.19</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="mysql-を-docker-で動かす">MySQL を Docker で動かす<a class="hash-link" href="#mysql-を-docker-で動かす" title="Direct link to heading">​</a></h2><p>では MySQL を Docker で動かします。</p><p><a href="https://hub.docker.com/_/mysql?tab=description" target="_blank" rel="noopener noreferrer">https://hub.docker.com/_/mysql?tab=description</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="docker-compose-使う場合">Docker Compose 使う場合<a class="hash-link" href="#docker-compose-使う場合" title="Direct link to heading">​</a></h3><p>docker-compose.yml</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5.7.28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;23306:3306&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">MYSQL_ROOT_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose up -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose ps  # コンテナが起動しているか確認</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>不要になったら削除しましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose rm -sf mysql</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これから Terraform で MySQL の Database を作成します。
作成されているか確認するために MySQL に接続しておきます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose exec mysql mysql -u root -p -P 23306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;  # database の一覧を確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="docker-compose-を使わない場合">Docker Compose を使わない場合<a class="hash-link" href="#docker-compose-を使わない場合" title="Direct link to heading">​</a></h3><p>基本的に Docker Compose 使う場合と変わりません。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run --name terraform-mysql -p &quot;23306:3306&quot; -e MYSQL_ROOT_PASSWORD=password -d mysql:5.7.28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -ti terraform-mysql mysql -u root -p -P 23306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker rm -vf terraform-mysql</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの作成">リソースの作成<a class="hash-link" href="#リソースの作成" title="Direct link to heading">​</a></h2><p>次のような設定ファイルを用意します。</p><p>main.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;mysql&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpoint = &quot;localhost:23306&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username = &quot;root&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password = &quot;password&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>設定できる属性やその意味などはドキュメントを確認してください。</p><p><a href="https://www.terraform.io/docs/providers/mysql/r/database.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/mysql/r/database.html</a></p><p>MySQL Provider の設定として MySQL に接続するための情報と、Terraform によって作成するデータベース <code>foo</code> の設定が定義されています。
password が平文で書かれているのが気になるかもしれませんが、一旦スルーしてください。</p><p>この状態で <code>terraform plan</code> を実行してみます。 <code>terraform plan</code> は <code>terraform apply</code> によるリソースの作成を DRY RUN するコマンドです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Could not satisfy plugin requirements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plugin reinitialization required. Please run &quot;terraform init&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plugins are external binaries that Terraform uses to access and manipulate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resources. The configuration provided requires plugins which can&#x27;t be located,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">don&#x27;t satisfy the version constraints, or are otherwise incompatible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform automatically discovers provider requirements from your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configuration, including providers used in child modules. To see the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">requirements and constraints from each module, run &quot;terraform providers&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: provider.mysql: no suitable version installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version requirements: &quot;(any version)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  versions installed: none</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。</p><blockquote><p>Plugin reinitialization required. Please run &quot;terraform init&quot;.</p></blockquote><p>とある通り、 <code>terraform plan</code> や <code>apply</code> などのコマンドを実行する前に <code>terraform init</code> を実行する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Initializing the backend...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Initializing provider plugins...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Checking for available provider plugins...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Downloading plugin for provider &quot;mysql&quot; (terraform-providers/mysql) 1.9.0...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The following providers do not have any version constraints in configuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">so the latest version was installed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To prevent automatic upgrades to new major versions that may contain breaking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes, it is recommended to add version = &quot;...&quot; constraints to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">corresponding provider blocks in configuration, with the constraint strings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">suggested below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* provider.mysql: version = &quot;~&gt; 1.9&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform has been successfully initialized!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You may now begin working with Terraform. Try running &quot;terraform plan&quot; to see</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">any changes that are required for your infrastructure. All Terraform commands</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">should now work.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you ever set or change modules or backend configuration for Terraform,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rerun this command to reinitialize your working directory. If you forget, other</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">commands will detect it and remind you to do so if necessary.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Provider のダウンロードが行われています。
<code>terraform init</code> を実行すると <code>.terraform</code> というディレクトリが作成されます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.terraform  .terraform-version  main.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform init</code> は何度でも安全に実行できます。
<code>.terraform</code> を削除した場合でももう一度 <code>terraform init</code> を実行すれば問題ありません。</p><p>次に <code>terraform plan</code> を実行します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Refreshing Terraform state in-memory prior to plan...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The refreshed state will be used to calculate this plan, but will not be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persisted to local or remote state storage.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">An execution plan has been generated and is shown below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resource actions are indicated with the following symbols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note: You didn&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">can&#x27;t guarantee that exactly these actions will be performed if</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;terraform apply&quot; is subsequently run.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>Plan: 1 to add, 0 to change, 0 to destroy.</p></blockquote><p>とある通り、リソースが 1 つ作成されるようです。 DRY RUN なのでまだ作成されてません。</p><p>では実際に作成してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">An execution plan has been generated and is shown below.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resource actions are indicated with the following symbols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you want to perform these actions?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will perform the actions described above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Only &#x27;yes&#x27; will be accepted to approve.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creation complete after 0s [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>途中確認があるので <code>yes</code> と入力すると実際に変更が適用されます。</p><p>本当に Database が作られているか確認します。
MySQL クエリを叩きます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5 rows in set (0.01 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;foo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | foo         | utf8                       | utf8_general_ci        | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ありました。</p><p>すると <code>terraform.tfstate</code> というファイルが作られているはずです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose.yml main.tf  terraform.tfstate</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こんな JSON ファイルになります。</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;terraform_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.12.19&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;serial&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;lineage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;7011a551-bfa1-96a5-4153-2c9d6f32251c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;outputs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;resources&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;managed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mysql_database&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;provider.mysql&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;instances&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;schema_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;attributes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_character_set&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_collation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8_general_ci&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bnVsbA==&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>管理されているリソースの情報と、 Terraform のバージョンなどのメタ情報が保存されています。
このファイルは基本的に terraform によって更新されるものであり、人間が手で修正するものではありません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="古い-terraform-を使ってみる">古い Terraform を使ってみる<a class="hash-link" href="#古い-terraform-を使ってみる" title="Direct link to heading">​</a></h2><p>ここであえて古いバージョンの Terraform を使って <code>terraform plan</code> を実行してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo 0.12.12 &gt; .terraform-version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tfenv install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error locking state: Error acquiring the state lock: state snapshot was created by Terraform v0.12.19, which is newer than current v0.12.12; upgrade to Terraform v0.12.19 or greater to work with this state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform acquires a state lock to protect the state from being written</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">by multiple users at the same time. Please resolve the issue above and try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">again. For most commands, you can disable locking with the &quot;-lock=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag, but this is not recommended.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。 State の lock に失敗したようです。 State の lock については <a href="https://techblog.szksh.cloud/terraform-state-locking/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/terraform-state-locking/</a> も参照してください。</p><p>このように古いバージョンの terraform は使えません。
一方新しいバージョンを使うには問題なく使えますが、 State の <code>terraform_version</code> が更新され、それまでのバージョンを使ってた人が突然 <code>terraform plan</code> などができなくなりますので、注意が必要です。</p><p>これが前述した意味になります。</p><blockquote><p>Terraform を複数人で使う場合、 Terraform のバージョンを揃えるのが重要です。 理由の一つとして、 Terraform の State は State を作成した Terraform のバージョンを記録しており、それより古いバージョンの Terraform で <code>terraform plan</code> などを実行すると失敗するようになっていることが挙げられます(この点については後でも触れます)。</p></blockquote><p>では元のバージョンに戻しましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo 0.12.19 &gt; .terraform-version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの更新">リソースの更新<a class="hash-link" href="#リソースの更新" title="Direct link to heading">​</a></h2><p>同じ調子でもう一つ Database を作ってみましょう。
Database foo の設定をコピーして <code>terraform plan</code> を実行します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Duplicate resource &quot;mysql_database&quot; configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 11:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11: resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A mysql_database resource named &quot;foo&quot; was already declared at main.tf:7,1-32.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resource names must be unique per type in each module.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。エラーメッセージの通り、リソースパスはユニークでないといけません。
修正しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;bar&quot; { # &quot;foo&quot; を &quot;bar&quot; に変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>作成されるようです。 apply してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error 1007: Can&#x27;t create database &#x27;foo&#x27;; database exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 11, in resource &quot;mysql_database&quot; &quot;bar&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11: resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。同じ名前のデータベースは作成できないので当然です。
このように plan に成功しても apply に失敗することはあります。</p><p>では name を修正しましょう。ついでに database foo の default character set を修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot; # default character set を修正。デフォルトは utf8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;bar&quot; # 名前を foo から bar に変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8&quot; -&gt; &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Modifying... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Creation complete after 0s [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error 1253: COLLATION &#x27;utf8_general_ci&#x27; is not valid for CHARACTER SET &#x27;utf8mb4&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 7, in resource &quot;mysql_database&quot; &quot;foo&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   7: resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>mysql_database.foo の変更に失敗しました。一方 mysql_database.bar の作成には成功しています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| bar                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6 rows in set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;foo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | foo         | utf8                       | utf8_general_ci        | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように、一部の変更の適用に失敗にしても、その他の変更は適用されるという、ある意味中途半端に apply される場合があります。こういった場合に rollback するようなコマンドはないので気をつけましょう。適用された変更はちゃんと State に反映されています。</p><p>では mysql_database.foo の変更に失敗したので、適切に設定を変更しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot; # utf8_general_ci から変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>apply に <code>--auto-approve</code> というオプションをつけると確認なしに適用されます。CIで実行する場合には基本これをつけることになると思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Modifying... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Modifications complete after 0s [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 0 added, 1 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>変更できました。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;foo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | foo         | utf8mb4                    | utf8mb4_general_ci     | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraformtfstatebackup">terraform.tfstate.backup<a class="hash-link" href="#terraformtfstatebackup" title="Direct link to heading">​</a></h2><p>ところで <code>terraform.tfstate.backup</code> というファイルが作られています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose.yml main.tf  terraform.tfstate  terraform.state.backup</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これは名前の通り <code>terraform.tfstate</code> のバックアップです。
<code>terraform.tfstate</code> が terraform のコマンドによって更新される前に自動的にバックアップが作成されます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの-recreate">リソースの recreate<a class="hash-link" href="#リソースの-recreate" title="Direct link to heading">​</a></h2><p>今度は database の名前を変更してみましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot; # foo から変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo must be replaced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-/+ resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ id                    = &quot;foo&quot; -&gt; (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ name                  = &quot;foo&quot; -&gt; &quot;foo2&quot; # forces replacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 1 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>先程 default_collation と default_character_set を変更した際は既存のデータベースが更新されましたが、今度は新しく作り直されるようです。
これはリソースの定義に依存します。ソースコードを確認しましょう。</p><p><a href="https://github.com/terraform-providers/terraform-provider-mysql/blob/v1.9.0/mysql/resource_database.go#L31" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers/terraform-provider-mysql/blob/v1.9.0/mysql/resource_database.go#L31</a></p><p>属性の定義で <code>ForceNew: true</code> となっている場合、その属性が変更されるとリソースが作り直されます。デフォルトだと既存のリソースの更新になります。
新しく作り直されるということは、テーブルなどは消えるはずです。試しにテーブルを作っておいて、 apply してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Empty set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; create table foo.zoo (id int);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 0 rows affected (0.03 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Tables_in_foo |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| zoo           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Destroying... [id=foo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creating...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Creation complete after 0s [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 1 added, 0 changed, 1 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>mysql_database.foo: Destroying... <!-- -->[id=foo]</p></blockquote><p>とあるように一度削除されています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR 1049 (42000): Unknown database &#x27;foo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables from foo2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Empty set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>新しいデータベースには先程作成したテーブルがありません。このように recreate は危険な操作なのでやるときには注意を払いましょう。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変数の利用">変数の利用<a class="hash-link" href="#変数の利用" title="Direct link to heading">​</a></h2><p>変数を使ってみましょう。設定を修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = var.default_character_set  # 変数 default_character_set を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Reference to undeclared input variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 9, in resource &quot;mysql_database&quot; &quot;foo&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   9:   default_character_set = var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">An input variable with the name &quot;default_character_set&quot; has not been declared.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This variable can be declared with a variable &quot;default_character_set&quot; {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">block.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>エラーになりました。変数を利用するには宣言が必要です。
<code>variables.tf</code> というファイルを作成しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;default_character_set&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>値の入力を求められました。これは変数の値が設定されていないからです。
ここでは <code>foo</code> と入力してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8mb4&quot; -&gt; &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-input=false</code> にすると入力を求められずにエラーを返します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -input=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: No value for required variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on variables.tf line 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1: variable &quot;default_character_set&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The root module input variable &quot;default_character_set&quot; is not set, and has no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default value. Use a -var or -var-file command line argument to provide a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value for this variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform.tfvars</code> というファイルを作成し、値を設定しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">default_character_set = &quot;utf8mb4&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform.tfvars</code> は特別なファイル名で、カレントディレクトリにこのファイルがあると自動で読み込まれます。</p><p>ファイル名を変えて terraform plan をしてみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mv terraform.tfvars main.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>聞かれました。 main.tfvars が読み込まれていません。 <code>-var-file</code> オプションでファイルを指定すれば main.tfvars を読み込めます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -var-file=main.tfvars</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>もとに戻しておきます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mv main.tfvars terraform.tfvars</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="他のリソースの属性の参照">他のリソースの属性の参照<a class="hash-link" href="#他のリソースの属性の参照" title="Direct link to heading">​</a></h2><p>設定を修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = mysql_database.foo.default_character_set  # 他のリソースの属性を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;  # default_character_set に合わせて変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8&quot; -&gt; &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;utf8_general_ci&quot; -&gt; &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Modifying... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Modifications complete after 0s [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 0 added, 1 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state-rm">terraform state rm<a class="hash-link" href="#terraform-state-rm" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/state/rm.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/rm.html</a></p><p>Terraform は State によって設定ファイル中のリソースと実際のリソースをマッピングしています。
State からリソースを削除して <code>terraform plan</code> を実行してみると、 Terraform はそのリソースを新規で作成しようとします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform state rm mysql_database.bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Removed mysql_database.bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully removed 1 resource instance(s).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>実際には同じ名前のデータベースは作成できないので <code>apply</code> で失敗するはずです。
<code>terraform state rm</code> は元々 Terraform で管理していたものを Terraform で管理するのを止めたり、あるいは手動で削除してしまったリソースを State からも削除するのに使えます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-import">terraform import<a class="hash-link" href="#terraform-import" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a>
<a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/import.html</a></p><p><code>terraform import</code> は Terraform で管理されていないリソースを Terraform で管理するために State にリソースのデータを取り込むコマンドです。
ちょうど <code>mysql_database.bar</code> を State から消してしまったので、 import することにしましょう。</p><p><a href="https://www.terraform.io/docs/providers/mysql/r/database.html#import" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/mysql/r/database.html#import</a> にある通り、データベースはデータベース名を指定すれば import 出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import mysql_database.bar bar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Importing from ID &quot;bar&quot;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Import prepared!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Prepared mysql_database for import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Import successful!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The resources that were imported are shown above. These resources are now in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">your Terraform state and will henceforth be managed by Terraform.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Import 出来ました。 <code>terraform plan</code> を実行して差分がなくなっていることを確認します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>次に手動で Database を作成してそれを import してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; create database zoo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 1 row affected (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import mysql_database.zoo zoo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: resource address &quot;mysql_database.zoo&quot; does not exist in the configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before importing this resource, please create its configuration in the root module. For example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # (resource arguments)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。 <code>mysql_database.zoo</code> が存在しないからです。
空で良いのでリソースの設定を追加しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import mysql_database.zoo zoo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Importing from ID &quot;zoo&quot;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Import prepared!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Prepared mysql_database for import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Refreshing state... [id=zoo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Import successful!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The resources that were imported are shown above. These resources are now in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">your Terraform state and will henceforth be managed by Terraform.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Import 出来たので zoo を Terraform で管理できるようになりました。
<code>terraform plan</code> を実行してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Missing required argument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 19, in resource &quot;mysql_database&quot; &quot;zoo&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  19: resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The argument &quot;name&quot; is required, but no definition was found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>zoo の設定が空で name が設定されていないので失敗しました。
修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;latin1&quot; -&gt; &quot;utf8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;latin1_swedish_ci&quot; -&gt; &quot;utf8_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>まだ差分が出てしまいました。</p><p>Import は State にはリソースのデータを反映してくれますが、設定ファイルには反映してくれないので自分で反映させる必要があります。
一部の Provider では、設定ファイルに自動で反映させるためのサードパーティのツールもあります。</p><p>修正します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;latin1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;latin1_swedish_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>無事差分がなくなりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの削除">リソースの削除<a class="hash-link" href="#リソースの削除" title="Direct link to heading">​</a></h2><p>次にリソースを削除してみます。</p><p><code>terraform destroy</code> もありますが、今回は設定をコメントアウトします。
ちなみに Terraform の設定ファイルの記述言語である HCL ではコメントアウトは <code>#</code> でも <code>//</code> でもどちらでも良いです。</p><p><a href="https://github.com/hashicorp/hcl#syntax" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/hcl#syntax</a></p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   name                  = &quot;bar&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   default_character_set = mysql_database.foo.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.bar will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;bar&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;bar&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;bar&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 0 to change, 1 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Refreshing state... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Destroying... [id=bar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.bar: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 0 added, 0 changed, 1 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo2               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| zoo                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>確かに削除されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state-mv">terraform state mv<a class="hash-link" href="#terraform-state-mv" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/state/mv.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/mv.html</a></p><p>ここで リソースの名前を変えて <code>terraform plan</code> してみましょう。名前を変えたくなることはまぁあると思います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;foo2&quot; { # foo から foo2 に変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = var.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;foo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;foo2&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;foo2&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.foo2 will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;foo2&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 1 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>既存のデータベースが削除されて新しいデータベースが作成されてしまいそうです。
State に記録されているリソースのパスを修正する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform state mv mysql_database.foo mysql_database.foo2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Move &quot;mysql_database.foo&quot; to &quot;mysql_database.foo2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully moved 1 object(s).</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>差分がなくなりました。</p><p>このようにコマンドによって State を更新する必要があるので、特に複数人で作業する場合は安易にリソースパスを変更するべきではありません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-refresh">terraform refresh<a class="hash-link" href="#terraform-refresh" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/refresh.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/refresh.html</a></p><p><code>terraform refresh</code> は実際のインフラの情報を取得して State に反映させるコマンドです。
Terraform を使わずに加えた変更を State に反映させるのに使えます。
Terraform を使ってインフラを管理している以上、 Terraform を使わずにインフラを変更するのは望ましくないですが、実際のところはよくある話かと思います。</p><p>Terraform を使わずに default_character_set を変更してみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; ALTER DATABASE zoo DEFAULT CHARACTER SET utf8mb4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query OK, 1 row affected (0.01 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select * from INFORMATION_SCHEMA.SCHEMATA where SCHEMA_NAME=&#x27;zoo&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| def          | zoo         | utf8mb4                    | utf8mb4_general_ci     | NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+-------------+----------------------------+------------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>default_character_set を変えると自動で DEFAULT_COLLATION_NAME も変わりました。
設定ファイルにも変更を反映させましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-refresh=false</code> をつけて terraform plan を実行してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -refresh=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;latin1&quot; -&gt; &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;latin1_swedish_ci&quot; -&gt; &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Resource targeting is in effect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You are creating a plan with the -target option, which means that the result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of this plan may not represent all of the changes requested by the current</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The -target option is not for routine use, and is provided only for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exceptional situations such as recovering from errors or mistakes, or when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform specifically suggests to use it as part of an error message.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>差分が出てしまいました。これは State が更新されていないからです。
terraform.tfstate を確認してみましょう。</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;managed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mysql_database&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;provider.mysql&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;instances&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;schema_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;attributes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_character_set&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latin1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_collation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latin1_swedish_ci&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-refresh=false</code> を取ると今度は差分がなくなるはずです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これは、実は terraform plan はデフォルトでは State の内容と設定ファイルを比較する前に実際のインフラの情報を取得し State の内容をインメモリで更新した上で設定ファイルと比較しているからです。
ただし、インメモリでの更新であり、実際の State が更新されているわけではないです。</p><p>今までスルーしてきましたが、そのことは terraform plan の結果でも説明されています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Refreshing Terraform state in-memory prior to plan...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The refreshed state will be used to calculate this plan, but will not be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">persisted to local or remote state storage.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ではなんで <code>-refresh=false</code> が必要になるかというと、理由の一つとして <code>terraform plan</code> が速くなることが挙げられます。
むしろ <code>-refresh=false</code> をつけないと、管理するリソースの数が増えれば増えるほど情報を取得してくるのに時間がかかるようになりますし、
場合によっては API の rate limit に引っかかるなんてこともあるかもしれません。</p><p>なので普段 <code>-refresh=false</code> をつけて <code>terraform plan</code> を実行するようにしていると Terraform を使わずに加えたインフラの修正を State に取り込むために <code>terraform refresh</code> を実行する必要が出てきたりします。</p><p>State は更新されていないので <code>-refresh=false</code> とすれば相変わらず差分は出ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -refresh=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be updated in-place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ~ resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_character_set = &quot;utf8mb4&quot; -&gt; &quot;latin1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; &quot;latin1_swedish_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id                    = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 1 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>差分が出ました。 <code>terraform refresh</code> を実行すると State が更新され、差分がなくなるはずです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform refresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Refreshing state... [id=app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Refreshing state... [id=zoo]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;managed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mysql_database&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;provider.mysql&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;instances&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;schema_version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;attributes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_character_set&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8mb4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;default_collation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;utf8mb4_general_ci&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zoo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJzY2hlbWFfdmVyc2lvbiI6IjAifQ==&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan -refresh=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="module">Module<a class="hash-link" href="#module" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/modules.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/modules.html</a></p><p>簡単なモジュールを作ってみましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi database/database.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>では Module を使って database を作ってみます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Module not installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 25:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  25: module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This module is not yet installed. Run &quot;terraform init&quot; to install all modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">required by this configuration.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>失敗しました。 <code>terraform init</code> する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # module.app.mysql_database.db will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-パラメータ">Module パラメータ<a class="hash-link" href="#module-パラメータ" title="Direct link to heading">​</a></h3><p>これで Module を使って Database を作れましたが、 name が &quot;app&quot; 固定なので使いづらいですね。名前を変えられるようにしましょう。</p><p>database/database.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = var.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>database/variables.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Missing required argument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on main.tf line 25, in module &quot;app&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  25: module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The argument &quot;name&quot; is required, but no definition was found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>必須パラメータを指定していないので失敗しました。デフォルト値を設定しましょう。</p><p><a href="https://www.terraform.io/docs/configuration/variables.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/variables.html</a></p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>パラメータを渡して name を変更しましょう。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name   = &quot;app2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # module.app.mysql_database.db must be replaced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-/+ resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ id                    = &quot;app&quot; -&gt; (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ~ name                  = &quot;app&quot; -&gt; &quot;app2&quot; # forces replacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>パラメータを渡せました。もとに戻しておきます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;app&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name   = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-output">Module Output<a class="hash-link" href="#module-output" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/configuration/outputs.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/outputs.html</a></p><p>mysql_database.bar から mysql_database.foo の属性を参照したように、 <code>module.app</code> で作成したデータベースの属性を参照するにはどうしたらよいでしょうか？
モジュール内であれば普通に参照できますが、モジュールの外から参照するには、 Module 側で明示的に公開する必要があります。不便な側面もあるかもしれませんが、カプセル化とも言えますね。</p><p>default_character_set を公開しましょう。</p><p>database/output.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;default_character_set&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = mysql_database.db.default_character_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>そして参照します。</p><p>main.tf</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = module.app.default_character_set  # 参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No changes. Infrastructure is up-to-date.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-destroy">terraform destroy<a class="hash-link" href="#terraform-destroy" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/destroy.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/destroy.html</a></p><p>ここまでお疲れさまでした。
ハンズオンの最後にこれまで作ったデータベースを削除してしまいましょう。
<code>-target</code> オプションでリソースパスを指定して特定のリソースだけ削除できます。
<code>-target</code> オプションは複数回指定することで複数のリソースを指定できます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy -target=module.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # module.app.mysql_database.db will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;db&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;app&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;app&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 0 to change, 2 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you really want to destroy all resources?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will destroy all your managed infrastructure, as shown above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>module.app を消そうとしたら、 mysql_database.zoo も削除されそうになっています。
これは mysql_database.zoo が module.app の属性に依存しているからです。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_character_set = module.app.default_character_set  # module.app に依存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-target</code> オプションで <code>mysql_database.zoo</code> を指定すればそれだけ削除されます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy -target=mysql_database.zoo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be destroyed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_character_set = &quot;utf8mb4&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - default_collation     = &quot;utf8mb4_general_ci&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - id                    = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name                  = &quot;zoo&quot; -&gt; null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 0 to add, 0 to change, 1 to destroy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you really want to destroy all resources?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will destroy all your managed infrastructure, as shown above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  There is no undo. Only &#x27;yes&#x27; will be accepted to confirm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>確認されるので、 yes と入力して削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Destroying... [id=zoo]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.zoo: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Applied changes may be incomplete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The plan was created with the -target option in effect, so some changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">requested in the configuration may have been ignored and the output values may</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">not be fully updated. Run the following command to verify that no other</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes are pending:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note that the -target option is not suitable for routine use, and is provided</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">only for exceptional situations such as recovering from errors or mistakes, or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">when Terraform specifically suggests to use it as part of an error message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destroy complete! Resources: 1 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| app                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| foo2               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>確かに消えています。
設定ファイルからは消えていないので <code>terraform plan</code> を実行すると Create しようとします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform will perform the following actions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # mysql_database.zoo will be created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  + resource &quot;mysql_database&quot; &quot;zoo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_character_set = &quot;utf8mb4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + default_collation     = &quot;utf8mb4_general_ci&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + id                    = (known after apply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      + name                  = &quot;zoo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plan: 1 to add, 0 to change, 0 to destroy.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>リソースパスを指定しないと全てのリソースを削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy --auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Refreshing state... [id=app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Refreshing state... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Destroying... [id=foo2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Destroying... [id=app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module.app.mysql_database.db: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql_database.foo2: Destruction complete after 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destroy complete! Resources: 2 destroyed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show databases;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Database           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| information_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| mysql              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| performance_schema |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| sys                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 rows in set (0.00 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>全部消えました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-getting-started">Terraform 入門</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-16T00:25:05.000Z" itemprop="datePublished">January 16, 2020</time> · <!-- -->26 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="参考">参考<a class="hash-link" href="#参考" title="Direct link to heading">​</a></h2><ul><li><a href="https://qiita.com/Chanmoro/items/55bf0da3aaf37dc26f73" target="_blank" rel="noopener noreferrer">10分で理解するTerraform | Qiita</a></li><li><a href="https://qiita.com/fukubaka0825/items/68506b1e6644404d6cc0" target="_blank" rel="noopener noreferrer">Terraform入門資料(v0.12.0対応) ~基本知識から設計や運用、知っておくべきtipsまで~ | Qiita</a></li><li><a href="https://dev.classmethod.jp/cloud/terraform-getting-started-with-aws/" target="_blank" rel="noopener noreferrer">AWSでTerraformに入門 | Developers.io</a></li><li><a href="https://qiita.com/minamijoyo/items/1f57c62bed781ab8f4d7" target="_blank" rel="noopener noreferrer">Terraform職人入門: 日々の運用で学んだ知見を淡々とまとめる | Qiita</a></li></ul><p>手を動かしたい方は <a href="https://techblog.szksh.cloud/terraform-hands-on-with-mysql-provider/" target="_blank" rel="noopener noreferrer">Terraform ハンズオン with MySQL Provider</a> も参考にしてください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="前提">前提<a class="hash-link" href="#前提" title="Direct link to heading">​</a></h2><ul><li>執筆時点 (2020/01/05) で Terraform の最新バージョンは v0.12.18 です</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-とは">Terraform とは<a class="hash-link" href="#terraform-とは" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a> は Infrastructure as Code を実現する汎用的なCLIツールです。
インフラの状態を設定ファイルに定義し、コマンドを実行することで、
実際のインフラの状態と設定ファイルの差分を検知し、設定ファイルに記述されたとおりになるようにインフラを変更(CRUD)します。</p><p><a href="https://www.hashicorp.com/" target="_blank" rel="noopener noreferrer">Hashicorp</a> という企業がホストしている OSS になります。
Go で書かれています。 <a href="https://github.com/hashicorp/terraform" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-のインストール">Terraform のインストール<a class="hash-link" href="#terraform-のインストール" title="Direct link to heading">​</a></h2><p>Terraform は Go 製なので 1 バイナリをダウンロードしてインストールするだけです。</p><p><a href="https://www.terraform.io/downloads.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/downloads.html</a></p><p>tfenv を使うと管理が楽です。</p><p><a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener noreferrer">https://github.com/tfutils/tfenv</a></p><p>tfenv は Terraform のバージョン管理ツールです。
pyenv や rbenv の Terraform 版みたいなものです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="用語集">用語集<a class="hash-link" href="#用語集" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="provider">Provider<a class="hash-link" href="#provider" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html#terraform-provider" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#terraform-provider</a></p><p>Terraform を「汎用的な」ツールといいましたが、ここでいう「汎用的」とは、 AWS などの特定のサービス専用ではなく、様々なサービスを同じように扱うことが出来るという意味です。
実際に AWS などのインフラを操作する場合にはインフラが提供する API を利用するわけですが、
サービス固有の API 呼び出しなどの処理を <code>Provider</code> という形で Terraform 本体から切り出すことでこの汎用性は実現されています。
Provider は AWS や GCP などの Hashicorp 公式のものもあれば、サードパーティ製のものもありますし、自分で作ってしまうことも出来ます。</p><ul><li>公式 Provider<ul><li><a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/index.html</a></li><li><a href="https://github.com/terraform-providers" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers</a></li></ul></li><li>サードパーティ Provider<ul><li><a href="https://www.terraform.io/docs/providers/type/community-index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/type/community-index.html</a></li><li>[宣伝][Graylog]<!-- -->(<a href="https://www.graylog.org/products/open-source" target="_blank" rel="noopener noreferrer">https://www.graylog.org/products/open-source</a>) の Provider <a href="https://github.com/suzuki-shunsuke/go-graylog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog</a></li></ul></li></ul><p>少し突っ込んだ話をすると、 Terraform 本体同様 Provider も実態は Golang で書かれた1バイナリであり、本体から Provider を RPC によって呼び出すという形でプラグイン機構を実現しています。
<a href="https://github.com/hashicorp/go-plugin" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/go-plugin</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="余談-provider-の自作">余談: Provider の自作<a class="hash-link" href="#余談-provider-の自作" title="Direct link to heading">​</a></h3><p>Provider の自作に興味のある方は <a href="https://www.terraform.io/docs/extend/writing-custom-providers.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/extend/writing-custom-providers.html</a> を読むと良いでしょう。
ただし、それを読めば全てわかるということはなく、作りながら Terraform 本体や AWSなどの公式の Provider のソースコードや GoDoc を読みつつ試行錯誤することになると思います。</p><ul><li><a href="https://github.com/terraform-providers/terraform-provider-aws/tree/master/aws" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers/terraform-provider-aws/tree/master/aws</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#Schema" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#Schema</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#ResourceData" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#ResourceData</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソース">リソース<a class="hash-link" href="#リソース" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/glossary.html#resource" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#resource</a></p><p>Terraform ではインフラを構成する最小の構成要素を <code>リソース</code> と呼びます。
例えばサーバが 3 台あればそれぞれが別々のリソースと言えます。
リソースごとに設定を記述します。
<code>terraform apply</code> コマンドを実行すると各リソースについて設定と実際のインフラの状態の差分が検知され、リソースごとに CRUD 処理が実行されます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="設定ファイル">設定ファイル<a class="hash-link" href="#設定ファイル" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/configuration/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/index.html</a></li><li><a href="https://github.com/hashicorp/hcl/blob/hcl2/hclsyntax/spec.md" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/hcl/blob/hcl2/hclsyntax/spec.md</a></li></ul><p>設定ファイルは <a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener noreferrer">HCL</a> という言語で記述します。
HCL は Hashicorp Configuration Language の略で、 Hashicorp が開発している JSON や YAML のような設定を記述する言語です。</p><p>Terraform v0.12 では HCL の v2 を使います。 v1 は古いので注意してください。</p><p>設定ファイルの拡張子は基本 <code>.tf</code> です。
次のような形でリソースを定義します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># resource &quot;リソースの種類&quot; &quot;リソース名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_instance&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # 属性名 = 属性値</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ami           = &quot;ami-2757f631&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_type = &quot;t2.micro&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>余談ですが、 <a href="https://github.github.com/gfm/" target="_blank" rel="noopener noreferrer">GFM (GitHub Flavored Markdown)</a> では <code>hcl</code> でシンタックスハイライトができます。</p><p>各リソース定義はパスによって識別されます。
上記のようなシンプルなリソースの定義の場合 <code>リソースの種類.リソース名</code> (<code>aws_instance.example</code>) です。パスは一意でなければいけません。</p><p>設定ファイルは同じ1つのディレクトリに置きます。
<code>terraform plan</code> などのコマンドはカレントディレクトリ直下のファイルしか見ません。</p><p>リソースの属性はリソースの種類によって異なります。
各Provider のドキュメントを参照しましょう。</p><p>例えば AWS の EC2 instance のドキュメントはこちらです。 <a href="https://www.terraform.io/docs/providers/aws/r/instance.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/aws/r/instance.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="リソースの属性の参照">リソースの属性の参照<a class="hash-link" href="#リソースの属性の参照" title="Direct link to heading">​</a></h2><p>あるリソースの設定で他のリソースの属性値を参照することが出来ます。</p><p>サンプルを示します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_instance_profile&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # リソース aws_iam_role.example の属性 name の値を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role = aws_iam_role.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="state">State<a class="hash-link" href="#state" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/index.html</a></p><p>設定ファイルと実際のインフラの差分を検知するには、設定ファイルのリソース定義と実際のインフラのマッピングが必要になります。
設定ファイル上ではリソースはパスによって識別されますが、実際のインフラのリソースはインフラ固有の ID などで識別されます。
設定ファイル上のリソースのパスと、実際のインフラのリソースの ID とのマッピングを保存するストレージが <code>State</code> になります。
ただし State の役割はマッピングだけではありません。詳細は <a href="https://www.terraform.io/docs/state/purpose.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/purpose.html</a> を参照してください。
「ストレージ」といいましたがその実態はデフォルトではただの JSON ファイルです。
デフォルトでは <code>terraform apply</code> などを実行すると勝手に <code>terraform.tfstate</code> という名前のファイルがカレントディレクトリに作成、更新されます。
State の保存先は S3 を含め色々サポートされています。</p><p><a href="https://www.terraform.io/docs/backends/types/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/index.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-state-を持たないツールとの違い">発展: State を持たないツールとの違い<a class="hash-link" href="#発展-state-を持たないツールとの違い" title="Direct link to heading">​</a></h3><p>Terraform の他にもインフラを管理するツールはありますが、その中には State のようなマッピングを持たないものもあります。
マッピングを持たないツールだと、ツールを使わずに作ったリソースがツールによって削除される可能性があります。
一方、 Terraform ではツールを使わずに作ったリソースは変更の対象になりません。
変更の対象にしたい場合はそのリソースの情報を State に追加する必要があります。
ただの JSON ファイルなので手で修正することも出来ますが、 <a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">terraform import</a> という専用のコマンドがあるのでそれを使うほうが安全です。</p><p><a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a></p><p>逆に、あまりないケースではありますが、あるリソースについて Terraform で管理するのをやめたい場合、
そのリソースを設定ファイルだけでなく State からも削除する必要があります。
単純に設定ファイルから削除するだけだと、 Terraform によって実際のインフラのリソースが削除されてしまいます。
State から削除するには <a href="https://www.terraform.io/docs/commands/state/rm.html" target="_blank" rel="noopener noreferrer">terraform state rm</a> というコマンドを使います。</p><p>その他 State を管理するためのコマンドが色々あるのでドキュメントを参照してください。</p><p><a href="https://www.terraform.io/docs/commands/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/index.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-remote-state-を使うか否か">発展: Remote State を使うか否か<a class="hash-link" href="#発展-remote-state-を使うか否か" title="Direct link to heading">​</a></h3><p>Terraform を CI/CD によって実行する前提です。
基本的に remote state を使うべきだと思います。</p><p>remote state を使わない場合、 <code>terraform.tfstate</code> を Git で管理することになるでしょう。
その場合、 feature branch の terraform.tfstate と実際のインフラの状態の乖離が起こりえます。
チームの規模が大きく複数の開発が並行して行われれば行われるほど、乖離の弊害が大きくなり、 remote state を使ったほうが良いということになるでしょう。</p><p>また、 CI/CD で更新された <code>terraform.tfstate</code> を commit &amp; push する必要があります。
<code>terraform apply</code> で失敗した場合、一部のリソースの更新には成功し、State が更新されているかもしれません。
<code>terraform apply</code> が失敗しても即座に終了させずに <code>terraform.tfstate</code> を commit &amp; push する必要があります。
これは CI/CD のコードで気をつければ問題ないのでデメリットと言うほどではないですが、昔自分は何度か commit &amp; push し損ねて面倒くさいことになりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変数">変数<a class="hash-link" href="#変数" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/glossary.html#variables" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/glossary.html#variables</a></li><li><a href="https://learn.hashicorp.com/terraform/getting-started/variables.html" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/terraform/getting-started/variables.html</a></li></ul><p>設定ファイルでは変数が使えます。
変数を使うには宣言が必要です。宣言では型なども指定できます。</p><p><a href="https://www.terraform.io/docs/configuration/types.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/types.html</a></p><p>変数の宣言はつぎのようにします。 <code>.tf</code> のどこに書いても大丈夫です。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># variable &quot;変数名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = &quot;string&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>変数の値の設定は次のようにします。 <code>terraform.tfvars</code> というファイル名に書いておくとコマンド実行時に自動で読み込まれます。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ami = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;us-east-1&quot; = &quot;ami-abc123&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;us-west-2&quot; = &quot;ami-def456&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>コマンドライン引数で渡すことも出来ます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="provider-の設定">Provider の設定<a class="hash-link" href="#provider-の設定" title="Direct link to heading">​</a></h2><p>Provider を使うには設定が必要です。
設定の属性は Provider によって違います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># provider &quot;Provider名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;google&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = &quot;acme-app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = &quot;us-central1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="module">Module<a class="hash-link" href="#module" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/modules/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/modules/index.html</a>
<a href="https://www.terraform.io/docs/configuration/modules.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/modules.html</a></p><p>複数のリソースの設定をまとめて再利用可能な形でパッケージングする仕組みとして Module があります。
リソースが1つだけでも、チーム固有の設定を Module のデフォルト値として設定したり、チームでは使わないリソースの属性を隠蔽したり用途はあるかと思います。</p><p>Module の作り方は通常の Terraform の設定ファイルの記述と同様、 1つのディレクトリ直下にパッケージングするリソースの設定ファイルを記述するだけです。</p><p>Module は次のように使います。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># module &quot;名前&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;servers&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # モジュールへのパス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./app-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # モジュールのパラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  servers = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Module のパスは <code>module.モジュール名</code> (module.servers) になります。</p><p>Module の <code>source</code> としてはローカルのディレクトリへのパス以外にも様々なものをサポートしています。</p><p><a href="https://www.terraform.io/docs/modules/sources.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/modules/sources.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="コミュニティの-module">コミュニティの Module<a class="hash-link" href="#コミュニティの-module" title="Direct link to heading">​</a></h3><p>コミュニティによって様々な Module が提供されています。</p><ul><li><a href="https://registry.terraform.io/" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/</a></li><li><a href="https://registry.terraform.io/modules/terraform-aws-modules" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/modules/terraform-aws-modules</a></li><li><a href="https://github.com/terraform-community-modules" target="_blank" rel="noopener noreferrer">https://github.com/terraform-community-modules</a></li><li><a href="https://github.com/terraform-aws-modules" target="_blank" rel="noopener noreferrer">https://github.com/terraform-aws-modules</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-化するべきか否か">Module 化するべきか否か<a class="hash-link" href="#module-化するべきか否か" title="Direct link to heading">​</a></h3><p>Go や Python などのプログラミング言語でのモジュール(ライブラリやパッケージ等呼び方は様々ですが)化と比べ、
Terraform の Module 化は慎重でなければなりません。
理由はいくつかありますが、</p><ul><li>Module を変更すると State の変更も必要になる場合もある</li><li>Terraform の設定は中々パワフルだとは思いますが、プログラミング言語に比べると柔軟性が足らず、変更に弱く、複雑になるとメンテナンス性が悪くなります</li></ul><p>偏見かもしれませんが、プログラミング言語に比べると、 Terraform に「精通」している人はそれほど多くないと思います。
初心者は直ぐ Module 化に飛びつくのはやめた方が良いと思います(尤も使ってみないと理解が深まらないという意味では使ったほうが良いですが)。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/outputs.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/outputs.html</a></p><p>Module で定義したリソースの属性は基本的に外部から隠蔽されます。
リソースの属性を参照できるようにするには、次のように個別に Output として宣言する必要があります。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;instance_ip_addr&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_instance.server.private_ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これはモジュールで定義したリソース <code>aws_instance.server</code> の属性 <code>private_ip</code> を Module の属性 <code>instance_ip_addr</code> として外部に公開するという意味です。
Module のパスが module.servers だとすると、 <code>module.servers.instance_ip_addr</code> で参照できます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="data-source">Data Source<a class="hash-link" href="#data-source" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/configuration/data-sources.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/data-sources.html</a></p><p>Data source は Terraform で管理していない(あるいは他の State で管理している)リソースの属性を参照するための仕組みです。</p><p>次のように記述します。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># data &quot;リソースの種類&quot; &quot;リソース名&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;aws_ami&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # リソースを一意に識別するためのクエリ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  most_recent = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  owners = [&quot;self&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name   = &quot;app-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tested = &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Data source では属性によって実際のインフラのリソースを検索します。検索にマッチするリソースは必ず1つでなければならず、
複数マッチしたり1つもマッチしなかったりすると失敗します(厳密には Provider の実装次第ですが)。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="他の-state-で管理されているリソースの属性を-data-source-として参照する">他の State で管理されているリソースの属性を Data source として参照する<a class="hash-link" href="#他の-state-で管理されているリソースの属性を-data-source-として参照する" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/providers/terraform/d/remote_state.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/terraform/d/remote_state.html</a></p><p>他の State で管理されているリソースの属性を Data source を使って参照するために <code>terraform_remote_state</code> があります。
参照するには Module 同様 その属性が Output によって外部に公開されている必要があります。</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;terraform_remote_state&quot; &quot;vpc&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;remote&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    organization = &quot;hashicorp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspaces = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name = &quot;vpc-prod&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="workspace">workspace<a class="hash-link" href="#workspace" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.terraform.io/docs/state/workspaces.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/state/workspaces.html</a></li><li><a href="https://blog.mosuke.tech/entry/2018/06/16/terraform-workspaces/" target="_blank" rel="noopener noreferrer">Terraform workspaceを利用して環境毎のリソース名の変更を行う</a></li><li><a href="http://kenzo0107.hatenablog.com/entry/2019/04/17/103558" target="_blank" rel="noopener noreferrer">Terraform 運用ベストプラクティス 2019 ~workspace をやめてみた等諸々~</a></li></ul><p>Terraform には workspace という機能がありますが、こちらの機能は自分は使ったことがないので簡単に触れるだけに留めます。
workspace の代表的なユースケースは production や staging などの異なる環境で同じ設定ファイルを共有しつつ State を switch することだと思います。</p><p>workspace を使わない場合環境ごとにディレクトリ及び設定ファイルを完全に分けることになると思います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>workspace を使うと設定ファイルを共有できます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ec2.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform.tfstate.d/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terraform.tfstate</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>環境ごとの設定の微妙な違いは設定ファイル内で分岐することになるのでしょう。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="発展-workspace-を使うべきか">発展: workspace を使うべきか<a class="hash-link" href="#発展-workspace-を使うべきか" title="Direct link to heading">​</a></h3><p>workspace を使うべきか否かは意見が分かれている様に思えます。
恐らくユースケースやチームメンバーの Terraform への成熟度にもよるでしょう。</p><p>現状自分は「使わない」というスタンスです。</p><p>自分がこれまで関わってきたチーム事情だと Terraform に全員が精通しているというよりは、むしろ Terraform にそこまで詳しくない人も触ることが多いです。
偏見かもしれませんが、そういうチームは少なくないのではないでしょうか？
そういうチーム状況では、 workspace を使って DRY になるというメリット以上に、 workspace そのものへの学習コストや環境によって設定ファイル内で分岐する学習コストを省き、
Terraform に精通していなくても理解できるくらいシンプルに保つことのほうが大事なのではないかなと思います。</p><p>特に、これまで Terraform を特定のサービス横断的なチームで管理していた状態から各サービスの担当者に ownership を委譲しようとする場合、上述の学習コスト・複雑さが弊害になるのではないかなと感じています。</p><p>ただし、繰り返しになりますが自分は workspace を使ったことがありません。
上記の自分の認識が間違っているかもしれませんし、今後 workspace を使ってみたら考えが変わるかもしれません。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-command-の基本的な使い方">Terraform command の基本的な使い方<a class="hash-link" href="#terraform-command-の基本的な使い方" title="Direct link to heading">​</a></h2><p><a href="https://www.terraform.io/docs/commands/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/index.html</a></p><p>設定ファイルを書いた上で基本的なコマンドの使い方について説明します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-init">terraform init<a class="hash-link" href="#terraform-init" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/init.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/init.html</a></p><p>まず、 <code>terraform init</code> を実行する必要があります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>terraform init</code> によって、依存する Provider がインストールされたりします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-fmt">terraform fmt<a class="hash-link" href="#terraform-fmt" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/fmt.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/fmt.html</a></p><p><code>terraform fmt</code> によってコードを整形することが出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform fmt [-check] [-recursive]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-check</code> をつけると、コードを整形する代わりに、コードが整形されていなかったら exit code が non 0 で終了します。
CI でコードが整形されているかのチェックに使えます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-plan">terraform plan<a class="hash-link" href="#terraform-plan" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/plan.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/plan.html</a></p><p><code>terraform plan</code> によって <code>terraform apply</code> の dry run が出来ます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan [-refresh=false]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>実際のインフラは変更されず、 <code>apply</code> を実行した場合にどのような変更が行われるか出力されます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-apply">terraform apply<a class="hash-link" href="#terraform-apply" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/apply.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/apply.html</a></p><p>実際にインフラを設定ファイルに合わせて変更します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform apply [-auto-approve]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>デフォルトでは最初に plan の実行結果が出力されて本当に変更を適用してよいか確認があります。
<code>-auto-approve</code> を指定すると確認を skip 出来ます。</p><p><code>plan</code> に成功しても <code>apply</code> には失敗する場合もあります。
簡単な例としては更新する権限がない場合です。
<code>apply</code> に失敗すると一部のリソースだけ更新されるということは起こりえます。
そうなってもロールバックとかは出来ない(terraform に rollback の機能はない)ので注意してください。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-destroy">terraform destroy<a class="hash-link" href="#terraform-destroy" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/destroy.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/destroy.html</a></p><p>Terraform で作成したインフラを削除します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform destroy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>恐らく実際の運用でこれを使うことはあまりないと思います。
削除したいなら設定ファイルからそのリソースを消して apply するでしょう。
Terraform の勉強がてら遊びで作ったものを丸っと消すとか主にそういう用途で使われる気がします。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-refresh">terraform refresh<a class="hash-link" href="#terraform-refresh" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/refresh.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/refresh.html</a></p><p>State を実際のインフラの状態に合わせて更新します。
インフラは更新されません。
手動でインフラを変更した場合に、その変更を State に反映させるのに使えます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform refresh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-import">terraform import<a class="hash-link" href="#terraform-import" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/import.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/import.html</a>
<a href="https://www.terraform.io/docs/import/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/import/index.html</a></p><p>Terraform で管理されていないリソースのデータを State にインポートします。
State はリソースパスとインフラのID のマッピングを管理すると言いましたが、 import コマンドの引数ではこの2つを渡すことでマッピングできるようにします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># リソースパス ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import aws_instance.example i-abcd1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ちなみに、一部のリソースは import をサポートしてません。
サポートしているかどうかは Provider の実装に依存します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="terraform-state">terraform state<a class="hash-link" href="#terraform-state" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/commands/state/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/commands/state/index.html</a></p><p>State を操作するためのコマンドです。様々なサブコマンドがあります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-の-cicd">Terraform の CI/CD<a class="hash-link" href="#terraform-の-cicd" title="Direct link to heading">​</a></h2><p>terraform apply は原則 CD によって実行されるべきだし、
CI によって <code>terraform fmt -check</code> や <code>terraform plan</code> は実行されるべきだと思っています。</p><p>逆に <code>terraform plan</code> や <code>apply</code> は CI/CD でやってるけど、
<code>terraform state</code> や <code>terraform import</code> はローカルから実行しているというチームも少なくはないのかなという気がしています。</p><p>課題となりうるのは</p><ul><li>Credential の管理</li><li>IP制限</li></ul><p>かなと思います。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="credential-の管理">Credential の管理<a class="hash-link" href="#credential-の管理" title="Direct link to heading">​</a></h3><p>Terraform で使うクレデンシャルは強力な権限を持ちがちなので扱いに注意しないといけません。
権限を絞るのが理想ですが、結構難しかったりします。</p><p>例えば PR の CI では <code>terraform apply</code> を実行しないのであれば、 PR の CI 用に Read Only なクレデンシャルを用意するとかもありかもしれません。</p><p>例えば AWS のインフラ管理を Terraform + CircleCI で行う場合、
AWS のクレデンシャルを CircleCI で参照できるようにする必要があります。
CircleCI では SSH でコンテナにログインできるため、クレデンシャルを盗もうと盗めますし、
CircleCI に限らず悪意のあるコードを CI で実行して外部にクレデンシャルを送ることも出来ます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ip-制限">IP 制限<a class="hash-link" href="#ip-制限" title="Direct link to heading">​</a></h3><p>CI で Terraform を使う場合、 CI の実行環境からインフラの API にアクセスできる必要があります。
IP 制限をかけている場合、 CI の実行環境からはアクセスできるようにするなどの工夫が必要です。
CI の実行環境の IP range が定まってない場合、話は更に難しくなります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="発展-設定ファイル中で使える関数">発展: 設定ファイル中で使える関数<a class="hash-link" href="#発展-設定ファイル中で使える関数" title="Direct link to heading">​</a></h2><p>設定ファイル内ではビルドイン関数が使えます。
公式ドキュメントを参照してください。</p><p><a href="https://www.terraform.io/docs/configuration/functions.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/functions.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="余談-awesome-terraform">余談: awesome-terraform<a class="hash-link" href="#余談-awesome-terraform" title="Direct link to heading">​</a></h2><p><a href="https://github.com/shuaibiyy/awesome-terraform" target="_blank" rel="noopener noreferrer">https://github.com/shuaibiyy/awesome-terraform</a></p><p>Terraform 関連の awesome なツールのリンク集です。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-state-locking">Terraform の State Locking の概要</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-10T07:18:05.000Z" itemprop="datePublished">January 10, 2020</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform の <a href="https://www.terraform.io/docs/state/locking.html" target="_blank" rel="noopener noreferrer">State Locking</a> という機能の概要について説明します。
ただし、自分もちゃんと理解しているわけではないので、推測も混じります。
基本的には公式ドキュメントに書いてある内容なのでそちらをご参照ください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="state-locking-とは">State Locking とは<a class="hash-link" href="#state-locking-とは" title="Direct link to heading">​</a></h2><p><code>terraform plan</code> などのコマンドは State を変更する場合があります。
その処理は atomic ではないため、同時に複数のコマンドが State を書き換えようとすると不整合が生じる可能性があります。</p><hr><p>例えば S3 backend の state を state rm で更新する場合を考えます。
これはコマンド内部で</p><ol><li>現在の State を取得する (READ)</li><li>修正した State を S3 に push する (WRITE)</li></ol><p>という処理を行っているはずであり、複数のコマンドを実行した場合、READ と WRITE の間に他のコマンドによって WRITE されると、その WRITE による変更が消えてしまいます。</p><hr><p>そこで State Locking を使うと各コマンドで State を変更する前に lock を取り、WRITE 後に lock を解除します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="コマンドラインオプション">コマンドラインオプション<a class="hash-link" href="#コマンドラインオプション" title="Direct link to heading">​</a></h2><p>plan, apply, refresh, state rm, state mv, state push には次のようなオプションがあります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-lock=true          Lock the state file when locking is supported.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-lock-timeout=0s    Duration to retry a state lock.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>-lock</code> はデフォルトで true なので State Locking のことを知らなくても実は State Locking 使ってたということもありえますが、 Backend type によっては State Locking のための設定をしていないと State Locking が無効になっている可能性があります。</p><p>例えば S3 backend で State Locking をするには DynamoDB が必要であり、 DynamoDB の設定 <code>dynamodb_table</code> が設定されていないと State Locking は無効になります。</p><p>また、<code>-lock=false</code> で無効化できますが、公式的に非推奨になります。</p><p><code>-lock-timeout</code> は lock の取得に失敗した場合に何秒後にリトライするかの設定になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="force-unlock">force-unlock<a class="hash-link" href="#force-unlock" title="Direct link to heading">​</a></h2><p>lock の解放に失敗した場合のために、 <a href="https://www.terraform.io/docs/commands/force-unlock.html" target="_blank" rel="noopener noreferrer">force-unlock</a> というコマンドがあります。
何らかのトラブルで lock が解放されない場合に使います。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform force-unlock LOCK_ID</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>例えば plan を実行中にキャンセルすると lock が解放されないことがあるようです。</p><p>lock が解放されていない状態で plan などを実行すると lock の取得に失敗し、次のようなエラーが起こります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Acquiring state lock. This may take a few moments...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: Error locking state: Error acquiring the state lock: ConditionalCheckFailedException: The conditional request failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status code: 400, request id: xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lock Info:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ID:        xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Path:      terraform.tfstate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Operation: OperationTypePlan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Who:       xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version:   0.12.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Created:   2020-01-09 09:30:37.41120929 +0000 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Info:      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform acquires a state lock to protect the state from being written</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">by multiple users at the same time. Please resolve the issue above and try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">again. For most commands, you can disable locking with the &quot;-lock=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag, but this is not recommended.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ここで出力される ID を force-unlock の引数として指定します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform force-unlock xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you really want to force-unlock?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Terraform will remove the lock on the remote state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  This will allow local Terraform commands to modify this state, even though it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  may be still be in use. Only &#x27;yes&#x27; will be accepted to confirm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Enter a value: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terraform state has been successfully unlocked!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The state has been unlocked, and Terraform commands should now be able to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obtain a new lock on the remote state.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="s3-backend">S3 backend<a class="hash-link" href="#s3-backend" title="Direct link to heading">​</a></h2><p>State Locking をサポートしているかは Backend type によりますが、 S3 の場合、 DynamoDB を使えばできます。</p><p><a href="https://www.terraform.io/docs/backends/types/s3.html#configuration-variables" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/s3.html#configuration-variables</a></p><p>backend の設定で <code>dynamodb_table</code> を設定する必要があります。</p><p><a href="https://www.terraform.io/docs/backends/types/s3.html#dynamodb_table" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/s3.html#dynamodb_table</a></p><blockquote><p>dynamodb_table - (Optional) The name of a DynamoDB table to use for state locking and consistency. The table must have a primary key named LockID. If not present, locking will be disabled.</p></blockquote><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx hcl"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;terraform_remote_state&quot; &quot;network&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend = &quot;s3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket = &quot;terraform-state-prod&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key    = &quot;network/terraform.tfstate&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # state locking の設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dynamodb_table = &quot;???&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>IAMの権限としては <a href="https://www.terraform.io/docs/backends/types/s3.html#dynamodb-table-permissions" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/backends/types/s3.html#dynamodb-table-permissions</a> が必要です。</p><p>DynamoDB のテーブルには <code>LockID</code> という Primary Key が必要です。 型は <code>文字列</code> です。</p><p>そして State Locking を有効にした状態で plan などを実行すると
DynamoDB のテーブルにレコードが State ごとに作られるようです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="state-locking-をすれば安全というわけではない">State Locking をすれば安全、というわけではない<a class="hash-link" href="#state-locking-をすれば安全というわけではない" title="Direct link to heading">​</a></h2><p>State Locking 自体は安全性に寄与する仕組みではありますが、 State Locking さえすれば安全かというとそうではないと思います。</p><p>複数人が同時に plan や apply などを実行する環境では、別のロック機構も必要だと思います。</p><p>詳細はまた別途書こうと思いますが、CI/CD で plan, apply などを実行する場合、 apply 実行中はそれが終わるまで他の plan や apply の実行を wait するような仕組みがないと危険です。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/dd-time">dd-time - コマンドの実行時間を Datadog に送るツール</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-11-30T04:54:47.000Z" itemprop="datePublished">November 30, 2019</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>コマンドの実行時間を Datadog に送る <a href="https://github.com/suzuki-shunsuke/dd-time" target="_blank" rel="noopener noreferrer">dd-time</a> というツールを作りました。</p><p>このツールは <a href="https://github.com/yuya-takeyama/circle-dd-bench" target="_blank" rel="noopener noreferrer">circle-dd-bench</a> にインスパイアされていますが、 CircleCI 以外でも需要あると思ったり、他にも幾つか改善したい部分があったので自作することにしました。</p><p>circle-dd-bench については circle-dd-bench の作者が書いたブログ <a href="https://blog.yuyat.jp/post/circle-dd-bench/" target="_blank" rel="noopener noreferrer">https://blog.yuyat.jp/post/circle-dd-bench/</a> も参考にしてください。</p><p>dd-time は Go 製なので <a href="https://github.com/suzuki-shunsuke/dd-time/releases" target="_blank" rel="noopener noreferrer">GitHub Releases</a> からバイナリをダウンロードしてインストールすれば使えます。</p><p>使い方はシンプルで実行時間を計測したいコマンドの前に <code>dd-time --</code> をつけるだけです。
例えば Docker image のビルドの時間を計測したい場合次のような感じになります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ dd-time -t command:docker-build -- docker build .</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Datadog の API key を環境変数 <code>DATADOG_API_KEY</code> として設定する必要があります。
こうすると <a href="https://docs.datadoghq.com/api/?lang=python#post-timeseries-points" target="_blank" rel="noopener noreferrer">Datadog の Post timeseries points API</a> を使い、<code>command_execution_time</code> というメトリックス名(変更可能)でコマンドの実行時間が送られます。</p><p>メトリックスの名前や host, tags はそれぞれ <code>--metric-name (-m)</code>, <code>--host</code>, <code>--tag (-t)</code> で指定できます。
<code>--tag</code> は複数回指定可能で、 <code>key:value</code> というフォーマットで指定します。</p><p>CircleCI で実行した場合、 CircleCI のビルドイン環境変数が tag として勝手に設定されますが、 CircleCI 以外でも使えます。</p><p>dd-time を作る上で意識したことは、<code>透過的にする(元のコードにほとんど影響を与えずに使えるようにする)</code>ということです。
具体的には以下のような点です。</p><ul><li>標準入力をそのままコマンドに渡す</li><li>コマンドの標準出力・標準エラー出力をそのまま出力する</li><li>コマンドの exit code をそのまま dd-time の exit code とする</li><li>Datadog への送信に失敗しても dd-time の exit code は 0 とする
(option で non zero にもできるようにするのもありだが、現状はそうしてない)</li><li>Datadog への送信に失敗した場合のエラーメッセージをファイルに吐き出せる(コマンドの出力と混ざらないようにできる)<ul><li>デフォルトは標準エラー出力だが、 <code>--output (-o)</code> と <code>--apend (-a)</code> オプションで変更できる</li><li><code>--append</code> を指定すると追記モードで出力できる</li></ul></li><li>適切にシグナルハンドリングする(本当に適切と言えるかは分かりませんが)</li></ul><p>以上、簡単ですが dd-time の紹介でした。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/datadog">datadog</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/mobreview">モブレビューやっていきたい</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-11-10T09:31:05.000Z" itemprop="datePublished">November 10, 2019</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>最近モブレビュー取り入れたいと感じていて、なんで取り入れたいかなどについて書いてみました。
モブレビュー自体まだ 2, 3 回しかやってないので説得力にかけますが、ご容赦ください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="想定">想定<a class="hash-link" href="#想定" title="Direct link to heading">​</a></h2><ul><li>チームは 6 人以下</li><li>Pull Request (以下 PR) をマージするには必ず他の誰かが approve しないといけない</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="目的">目的<a class="hash-link" href="#目的" title="Direct link to heading">​</a></h2><ul><li>チーム内の情報共有<ul><li>属人化の解消</li><li>退職や異動などによる情報の喪失(誰も分からない状態)を防ぐ</li><li>チーム外の人とのコミュニケーションにも活用できる</li></ul></li><li>レビュー待ちの短縮</li><li>レビューの品質の改善</li><li>仕事を評価してもらうことで承認欲求を満たす</li><li>オンボーディングの改善<ul><li>レビューを通じて必要な知識を吸収してもらう</li><li>オンボーディングに限ったことではないが、オンボーディングにも有効ではないか</li></ul></li><li>最後までやりきる</li></ul><p>箇条書した内容を補足します。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="情報共有">情報共有<a class="hash-link" href="#情報共有" title="Direct link to heading">​</a></h3><p>属人化の解消は結構重要だと自分は思っていて、特定の人じゃないと出来ないこと、わからないことというのは
ボトルネックや技術的負債だったり、障害対応時に致命的になりかねません(深夜に障害が起こってAさんに聞かないとわからないのに、Aさんと連絡が取れないとか最悪)。
チーム全員とはいかなくても 3 人ぐらいは出来る・分かってる必要があるかなと思います。</p><p>まぁ、当初は 3 人ぐらい分かってても、時間が経って異動やら退職やらで気づいたら分かっている人いなくなってたというのは
ありえなくないので、そういったリスクをどうやって防ぐかというのは考える必要がありますが、今回の話とは外れるので割愛します。</p><p>また、チーム外の人とのコミュニケーションにも活用できると思っていて、
例えばランチや飲み会でチーム外の人とのコミュニケーションを取る際に自分のチームの他の人が対応した件とかが話題に上がったときに
ちゃんと情報共有できてないと、自分は担当外なので分かりませんとなってしまうでしょう。
知っていればむしろ自分から話題にできるかもしれません。
そこから発展して更に新しいタスクの話もできるかもしれません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="レビューの改善">レビューの改善<a class="hash-link" href="#レビューの改善" title="Direct link to heading">​</a></h3><p>せっかくいい仕事をしても中々レビューしてもらえないとなると不満がたまります。
モブレビューを実施することでレビューを促進し、レビュー待ちの時間を短くできることを期待します。
レビューしたくても良くわからなくてレビューできないというパターンもあると思うので、
わからない部分をモブレビューで解消されてレビューが進むと良いですね。</p><p>また、ちゃんと複数人でレビューすることで目先の問題を解決するだけの本質的でない問題解決を防ぐことが出来ることもあると思います。
「いや、それそもそもPRの前提がおかしくない？前提となっている仕様を見直すべきなのでは」
みたいなこともあるかもしれません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="仕事を評価してもらうことで承認欲求を満たす">仕事を評価してもらうことで承認欲求を満たす<a class="hash-link" href="#仕事を評価してもらうことで承認欲求を満たす" title="Direct link to heading">​</a></h3><p>いい仕事したら他の人にも知ってもらいたいというのは自然なことでしょう。
いい仕事を褒めるのは良いチーム・環境であり働きやすさというところにつながるのではないでしょうか。</p><p>ちなみに現職だと Slack で他のチームにも共有して emoji で褒め称えるというのが結構やられていて
気持ちのいい環境だなと思っています。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="オンボーディングへの活用">オンボーディングへの活用<a class="hash-link" href="#オンボーディングへの活用" title="Direct link to heading">​</a></h3><p>そもそもオンボーディングというものをちゃんと受けたのが現職が初めてで、
現職でもオンボーディングについてはまだまだ検討中であり、「何をもってオンボーディングは終わりと言えるのか」みたいな議論が Slack でされてたりして、
自分もよくわかってないのですが、モブレビューがオンボーディングにも活用できるんじゃないかなという気がしています。</p><p>色々なにも分かってない状態の New Joiner でも理解できるように、背景とかを説明したりすることで
会社固有のドメイン知識などを補い、戦力化を促すことが出来るんじゃないかなと思います。
会社固有の略語などが当たり前に使われてたりすると New Joiner には理解できないのですが、そういうのも含めてフォローしてあげる良い機会になると思います。
マイクロサービス化なんかをやっていると New Joiner には名前を聞いただけでは理解できないものも出てきますしね。</p><p>まぁあまり細かな話までしだすとそれはまだ New Joiner には早いということにもなるので、ケースバイケースかもしれません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="最後までやりきる">最後までやりきる<a class="hash-link" href="#最後までやりきる" title="Direct link to heading">​</a></h3><p>PR を投げた後、レビューしてもらえない、説明を書いているのに読んでもらえないといったときに</p><ul><li>自分はやるべきことをやっている</li><li>レビューしない人たちが悪い</li><li>説明を読まない人たちが悪い</li></ul><p>としてそれ以上なにもしないというのはもったいないと思います。
「結果がすべて」だと考えると説明を書いても読んでもらえなかったらそれは書いてないと同じなので
モブレビューという形で読んでもらう努力をするのがより建設的なのでしょう。
モブレビューしてみたら「レビューしようと思ったけど、ここが良くわからなくてやめちゃったんだよね」ということもあったので、
自分の説明も足りてなかったんだなと見直す良い機会にもなります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="解決したい課題">解決したい課題<a class="hash-link" href="#解決したい課題" title="Direct link to heading">​</a></h2><ul><li>他の人が何やってるのかよくわからない</li><li>他の人のをレビューしようとしても良くわからなくてそっとタブを閉じてしまう<ul><li>分からないことを理解する成長チャンスを無駄にしているのでは</li></ul></li><li>レビュー待ちが長い<ul><li>細かく PR を投げたくても前のがマージされてないと先に進めない</li><li>マージされないまま master が更新されて逐一 rebase しないといけない</li></ul></li><li>レビューの品質の低下<ul><li>よくわからないけどマージしてしまえ: レビューの意味がない</li></ul></li><li>issue や PR の説明やコメントが足りてない<ul><li>説明を英語で書かないといけないとかだと、説明不足になりやすい</li><li>モブレビューで口頭で説明してみると、 issue や PR に書いてない情報が出てくる
その情報を追記することで(口頭で説明するだけではだめ。後からその場にいなかった人も見返すもの)改善できる</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="実施方法">実施方法<a class="hash-link" href="#実施方法" title="Direct link to heading">​</a></h2><p>定例を組むのもありですが、個人的には予定を押さえなくても場所を確保できるのなら(フリースペースとかにモニターがあってサッと出来るなら理想的)不定期がいいと思います。
やりたくなったらその旨を Slack でサッと共有し、その場で直ぐできるならやり、
できない場合カレンダー見て空いてそうな枠を見つけて予定を押さえるか、Slackのリマインダーをセットします。
モブレビューで話している内容や、質疑応答などは Slack のスレッドにでもメモっておくと良さそうです。
issue や PR の説明に書いてないことが出てきたら、説明を修正して追記すると良いでしょう。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="定期的に予定をいれる懸念点">定期的に予定をいれる懸念点<a class="hash-link" href="#定期的に予定をいれる懸念点" title="Direct link to heading">​</a></h3><ul><li>定例は少ないほうが良い</li><li>形式的になる</li><li>定例まで待たなくて良いのでは</li><li>定例までレビューしないというモチベーションが働く場合もあるのでは</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="やりたくなったらやる場合の懸念点">やりたくなったらやる場合の懸念点<a class="hash-link" href="#やりたくなったらやる場合の懸念点" title="Direct link to heading">​</a></h3><ul><li>カレンダーをチェックするのが面倒くさい(コストがかかる)</li><li>人によっては躊躇してしまう</li><li>場所を確保できないかも</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="懸念点">懸念点<a class="hash-link" href="#懸念点" title="Direct link to heading">​</a></h2><ul><li>複数人の時間を拘束して実施することのコスト</li><li>口頭で説明することに甘えてちゃんと issue や PR に書かなくなる<ul><li>レビューの段階で指摘する</li></ul></li><li>場所を押さえられるか<ul><li>会議室足りない問題</li></ul></li><li>モブレビューの意義を共有できるか<ul><li>人によっては時間の無駄と思う人がいてもおかしくない</li><li>不満や提案があったときにちゃんとそれを言える環境でありたい</li></ul></li></ul><p>ちゃんと文章化するのをめんどくさがって口頭での説明で済ましたがるようになったらよろしくないですね。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="自分の反省点">自分の反省点<a class="hash-link" href="#自分の反省点" title="Direct link to heading">​</a></h2><p>ここまで書いて出てきた自分の反省点としては、 issue や PR の説明でちゃんと Context や Background をもっとちゃんと書かないと駄目かなということです。
口頭で説明する際にはそのへんを最初に意識して話すようにしていますが、説明には書いてないことが少なくないのでちゃんと書くようにしようと思いました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="むすび">むすび<a class="hash-link" href="#むすび" title="Direct link to heading">​</a></h2><p>今回モブレビューについてあれこれ考えてみました。
まだモブレビューは 2, 3 回やった程度なので、ちゃんと取り組んでみて PDCA 回して改善出来たら良いなと思います。
例えば、今の所定期ではやりたくないと思ってますが、やってみたらちゃんと定期じゃないと駄目だったということもあるかもしれませんし、
モブレビューは目的じゃなくて手段なので、他にもっとよい手段があってモブレビュー不要だったということもあるかもしれません。</p><p>やらないと始まらないのでやれたらいいかなと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/go-timeout">go-timeout - command の timeout</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-11-04T01:00:21.000Z" itemprop="datePublished">November 4, 2019</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>作ったのは 2ヶ月くらい前の話ですが、
Go の command の timeout を実装するためのライブラリを作ったので紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/go-timeout" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-timeout</a></p><p>基本的には <a href="https://github.com/Songmu/timeout" target="_blank" rel="noopener noreferrer">https://github.com/Songmu/timeout</a> をオススメしますが、これだと上手くいかないパターンがあったので自作しました。</p><p>Go の command の timeout に関しては <a href="https://junkyard.song.mu/slides/gocon2019-spring/#24" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#24</a> がとても参考になります。</p><p>上記のスライドでは</p><ul><li>標準ライブラリの <a href="https://golang.org/pkg/os/exec/#CommandContext" target="_blank" rel="noopener noreferrer">exec.CommandContext</a> でも停止できるが、 SIGKILL で強制的に停止することになる<ul><li>子プロセスが停止しない</li></ul></li><li><a href="https://github.com/golang/go/issues/21135" target="_blank" rel="noopener noreferrer">公式見解</a> では、SIGKILL 以外は標準ライブラリではサポートしない。サードパーティでやればよい</li><li><a href="https://github.com/Songmu/timeout" target="_blank" rel="noopener noreferrer">Songmu/timeout</a> 使えば SIGKILL 以外でより安全に停止できる</li></ul><p>ということが丁寧に説明されています。</p><p>自分は <a href="https://github.com/suzuki-shunsuke/cmdx" target="_blank" rel="noopener noreferrer">cmdx</a> という task runner を開発していてその中で task の実行時に timeout を設定出来るようにしました。
当初 <a href="https://github.com/Songmu/timeout" target="_blank" rel="noopener noreferrer">Songmu/timeout</a> を使って実装したのですが、問題があることに気づきました。
それは、 command の中で <a href="https://github.com/junegunn/fzf" target="_blank" rel="noopener noreferrer">fzf</a> を使うと、上手く動かないというものでした。</p><ul><li><a href="https://github.com/suzuki-shunsuke/cmdx/issues/52" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/cmdx/issues/52</a></li><li><a href="https://twitter.com/szkdash/status/1165529415238815745" target="_blank" rel="noopener noreferrer">https://twitter.com/szkdash/status/1165529415238815745</a></li></ul><p>正直この辺の挙動はちゃんと理解できていないのですが、
調べてみると Songmu/timeout だと syscall.SysProcAttr の Setpgid を true に設定していて、そうすると fzf が上手く動かないようでした。</p><p><a href="https://junkyard.song.mu/slides/gocon2019-spring/#48" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#48</a></p><p><a href="https://junkyard.song.mu/slides/gocon2019-spring/#45" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#45</a></p><p>には timeout の実装方式として</p><ul><li>GNU timeout の場合</li><li>Songmu timeout の場合</li></ul><p>の 2 通り書いてありますが、 suzuki-shunsuke/go-timeout では GNU timeout のパターンで実装しています。 </p><p><a href="https://junkyard.song.mu/slides/gocon2019-spring/#46" target="_blank" rel="noopener noreferrer">https://junkyard.song.mu/slides/gocon2019-spring/#46</a></p><p>に書いてあるとおり、少々乱暴な気もしますが、 <a href="https://github.com/suzuki-shunsuke/cmdx" target="_blank" rel="noopener noreferrer">cmdx</a> で使う分には特に問題ない気がします。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/cmdx">cmdx - task runner</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-08-23T02:35:13.000Z" itemprop="datePublished">August 23, 2019</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>最近自作した OSS, cmdx の紹介です。</p><p><a href="https://github.com/suzuki-shunsuke/cmdx" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/cmdx</a></p><p>cmdx は task runner です。</p><p><code>task runner</code> の定義はググってもわからなかったので、 cmdx を <code>task runner</code> と呼ぶのが適切かわかりませんが、
ここではプロジェクト固有のタスク</p><ul><li>依存するライブラリのインストール</li><li>ビルド</li><li>テスト</li><li>コード整形</li><li>lint</li><li>etc</li></ul><p>などを管理するものとします。</p><p>類似するものとしては以下のようなものがあります。</p><ul><li>Make</li><li><a href="https://docs.npmjs.com/misc/scripts" target="_blank" rel="noopener noreferrer">npm scripts</a></li><li><a href="https://taskfile.dev/" target="_blank" rel="noopener noreferrer">Task</a></li><li><a href="https://github.com/tj/robo" target="_blank" rel="noopener noreferrer">tj/robo</a></li><li><a href="https://github.com/mumoshu/variant" target="_blank" rel="noopener noreferrer">mumoshu/variant</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="使い方">使い方<a class="hash-link" href="#使い方" title="Direct link to heading">​</a></h2><p>詳細は <a href="https://github.com/suzuki-shunsuke/cmdx/blob/master/README.md" target="_blank" rel="noopener noreferrer">README</a> を読んでください。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cmdx -i</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>で設定ファイルの雛形を生成します。</p><p>そして設定ファイルに task を定義していきます。
設定に関しては <a href="https://github.com/suzuki-shunsuke/cmdx/blob/master/README.md" target="_blank" rel="noopener noreferrer">README</a> を参照してください。</p><p>そうすると <code>cmdx -l</code> でタスクの一覧とその説明が見れます。</p><p>例えば次は <a href="https://github.com/suzuki-shunsuke/cmdx" target="_blank" rel="noopener noreferrer">cmdx</a> のリポジトリでの実行結果です。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cmdx -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">init, i - setup git hooks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coverage, c - test a package (fzf is required)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test, t - test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt - format the go code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vet, v - go vet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lint, l - lint the go code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">release, r - release the new version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">durl - check dead links (durl is required)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ci-local - run the Drone pipeline at localhost (drone-cli is required)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>これにより新しくプロジェクトに参画した人もどのような task があるのか直ぐわかります。
例えば test を実行したければ <code>cmdx t</code> を実行すればいいことがわかります。
<code>cmdx help test</code> とすればここのタスクのより詳細なヘルプが見れます。</p><p>ドキュメントに task について書いても、ドキュメントがちゃんと更新されずドキュメントと実態が乖離するなんてことはよくありますが、
cmdx の設定ファイルからヘルプを生成することで乖離しにくくなります(実際に使われてない task が残ってたり、task の description や usage が間違ってたら駄目ですが)。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="なぜ-cmdx-か">なぜ cmdx か<a class="hash-link" href="#なぜ-cmdx-か" title="Direct link to heading">​</a></h2><p>自分は今まで task runner として基本的に npm scripts を使ってきていて、ブログにも書いています。</p><p><a href="https://techblog.szksh.cloud/use-npm/" target="_blank" rel="noopener noreferrer">JS以外でのnpmの活用</a></p><p>しかし、 npm scripts に対しては以下のような不満がありました。</p><ul><li>security alert が定期的に飛んできて対応が面倒くさい<ul><li>これは husky や commitlint などを使っているのが原因なのであって、 npm scripts の問題ではないですが</li></ul></li><li>task に対するヘルプメッセージがない<ul><li>今までは README に書いてたが、本来は help コマンドで自動生成・サポートされるべきだと思っている</li></ul></li></ul><p>他のツールによってこれらの不満は解消できるのですが、他のツールにもそれぞれ微妙に不満があり、
完全に自分のニーズに合うものがなかったので作ることにしました。</p><p>一例ですが、 npm scripts は</p><ul><li>設定ファイル (package.json) を探索</li><li>設定ファイルのあるディレクトリでコマンドを実行</li></ul><p>します。これにより</p><ul><li>カレントディレクトリを意識する必要がない<ul><li>設定ファイルのパスを指定する必要がない</li><li>コマンドの実行ディレクトリがカレントディレクトリに依存しない(逆に言うとカレントディレクトリに依存した処理を実行しにくいという面もありますが)</li></ul></li></ul><p>という良さがあり、 これが意外と他のツールではサポートされてなく(例えば Make だったら <code>-F</code> オプションで Makefile のパスを指定する必要がある)、不満でした。</p><p>また、 Make や Task では task の依存関係を定義し、一回のコマンドで複数のタスクを実行できますが、
cmdx ではそのような機能はサポートしていません。
自分が普段そのような機能をあまり必要としていないからです。</p><p>cmdx では上のような npm scripts の不満を解消するだけでなく、折角なので幾つか細かな機能を追加しています。</p><ul><li>シェルスクリプトだと面倒なオプション引数をサポート</li><li>リッチなプロンプトのサポート</li><li>タイムアウト</li><li>etc</li></ul><p>cmdx から npm scripts に乗り換えた場合の問題点としては husky や commitlint のようなツールが使えなくなることですが、
必須のツールでもないので許容しています。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/risk-of-drone-extension">Drone Extension のリスク</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-08-14T22:54:23.000Z" itemprop="datePublished">August 14, 2019</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Drone v1 では Extension という仕組みが導入されました。</p><p>これは文字通り Drone を拡張する仕組みで、仕様に従って作れば自由に Drone を拡張できます。</p><p><a href="https://docs.drone.io/extensions/overview/" target="_blank" rel="noopener noreferrer">https://docs.drone.io/extensions/overview/</a></p><p>全てを本体でやるのではなく、拡張する仕組みを提供し、あとはコミュニティに委ねるというのが Drone の一つの方針とも言えると思います。</p><p>Extension は非常に面白い仕組みだと思いますが、 Drone を運用する立場からすると中々頭が痛い仕組みな気がしてて、
自分は導入に対し慎重な立場です。
単なる杞憂で済めば良いのですが、その懸念について書きたいと思います。</p><p>根本は Drone Extension 固有の問題と言うより、一般的な拡張機構全般に言えることだと思います。
ただし、 Drone Extension は全てのビルドに影響を及ぼす、
CI/CDシステムが動かなくなるとサービスのリリースに影響を及ぼしかねないということからよりリスクの高いものになっています。</p><ul><li>本体の drone/drone と比べ、開発は活発ではなく、サードパーティの extension はいつ開発が止まってもおかしくない</li><li>本体の drone/drone と比べ、ドキュメントやサポート体制が貧弱だと思われる(drone に関しては <a href="https://discourse.drone.io" target="_blank" rel="noopener noreferrer">https://discourse.drone.io</a> でサポートされているが、サードパーティの extension では難しい)</li><li>ユーザーからの extension に関する要望を受け付けるようになると、管理者の負担になる</li><li>extension のクォリティはマチマチであり、例外処理が甘かったり、ちゃんとエラーを吐かないものもあるだろう</li><li>トラブルシューティングが難しいと思われる</li><li>extension の仕組み上、extension を必要としないビルドにも影響を及ぼしうる</li><li>一度追加し、依存しだすと消すのが難しくなる</li><li>extension が落ちると全 build に影響するので、耐障害性(冗長化)、モニタリングが必要</li><li>etc</li></ul><p>勿論、上記の懸念点は Extension によって提供される機能とトレードオフであり、
Extension の導入方針は Drone が運用される環境によって大きく依存すると思います。</p><p>例えば全員が顔見知りのような小さな組織で特定のサービス専用に Drone を使っていてかつ Drone の運用体制(人員)に十分余裕があるなら
積極的に Extension を導入しても問題ないかもしれません。</p><p>一方大きな組織で色々なサービスで同じ Drone を使っていてかつ Drone の運用体制が不十分(人手不足)ならば、 Extension の導入には慎重にならざるを得ないのではないかと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/drone">drone</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/drone-v1-deprecate-grpc">Drone v1 で gRPC が使われなくなった</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-08-14T22:39:18.000Z" itemprop="datePublished">August 14, 2019</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>v0.8 では server - agent 間の通信に gPRC が使われていましたが、 v1 では使われなくなりました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="理由">理由<a class="hash-link" href="#理由" title="Direct link to heading">​</a></h2><ul><li><a href="https://discourse.drone.io/t/curious-about-decision-to-drop-grpc/3987" target="_blank" rel="noopener noreferrer">https://discourse.drone.io/t/curious-about-decision-to-drop-grpc/3987</a><ul><li>gRPC関連のトラブルの問い合わせが多すぎてサポートしきれないので止めた</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="v1-での通信方法">v1 での通信方法<a class="hash-link" href="#v1-での通信方法" title="Direct link to heading">​</a></h2><ul><li><a href="https://discourse.drone.io/t/drone-agents-keep-closing-connections-with-499-code/5197/2" target="_blank" rel="noopener noreferrer">https://discourse.drone.io/t/drone-agents-keep-closing-connections-with-499-code/5197/2</a><ul><li>agent がロングポーリングしている</li><li>30秒後、なんのビルドもなければコネクションを切って、再接続する(張りっぱなしにしてると、LBやファイアウォールにコネクション切られるため)</li></ul></li></ul><hr><p>自分も v0.8 から Drone を運用していて最近 v1 に upgrade しましたが、
v0.8 では gRPC 関連のトラブルが頻発していました。
server のログでは絶えず gRPC 関連のエラーを吐いていましたし、
server - agent 間の TCP connection が切れっぱなしになって戻らくなって agent 数がどんどん減っていったり
ビルドが pending のままになったり、色々ありました。</p><p>関連する issue はあり、幾つか対策を打ってみたりしましたが、結局解決しませんでした。</p><ul><li><a href="https://github.com/drone/drone/issues/2090" target="_blank" rel="noopener noreferrer">https://github.com/drone/drone/issues/2090</a></li><li><a href="https://github.com/drone/drone/issues/2246" target="_blank" rel="noopener noreferrer">https://github.com/drone/drone/issues/2246</a></li><li><a href="https://github.com/drone/drone/pull/2294" target="_blank" rel="noopener noreferrer">https://github.com/drone/drone/pull/2294</a></li><li><a href="https://www.reddit.com/r/droneci/comments/8opifu/drone_stops_working_after_some_little_time/e06d1gn/" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/droneci/comments/8opifu/drone_stops_working_after_some_little_time/e06d1gn/</a></li></ul><p>それが v1 にアップグレードして gRPC が使われなくなってから解消し、個人的にはとても助かりました。
管理者的にはアップグレードして一番嬉しい点ですね。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/drone">drone</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/grpc">grpc</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a href="//page/7" target="_blank" rel="noopener noreferrer" class="pagination-nav__link"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a href="//page/9" target="_blank" rel="noopener noreferrer" class="pagination-nav__link"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c5c9b8c5.js"></script>
<script src="/assets/js/main.f7990f4d.js"></script>
</body>
</html>