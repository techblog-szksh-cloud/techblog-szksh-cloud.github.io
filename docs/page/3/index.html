<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">Blog | Melody</title><meta data-rh="true" property="og:title" content="Blog | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud//page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud//page/3"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud//page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud//page/3" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.00932b7a.js" as="script">
<link rel="preload" href="/assets/js/main.71a74257.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-09">My Activity at 2022-09</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-08">2022-08 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-07">2022-07 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-06">2022-06 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-05">2022-05 振り返り</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/what-i-did-2021-07">2021-07 やったこと</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-07-27T21:58:45.000Z" itemprop="datePublished">July 27, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>今まで仕事に限定して書いてきましたが、 OSS 活動なんかにも触れてもいいんじゃないかと思ったので分かる範囲で書きます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="仕事">仕事<a class="hash-link" href="#仕事" title="Direct link to heading">​</a></h2><ul><li>Docker Image を Docker Hub から ECR へ移行</li><li>Terraform<ul><li>.terraform.lock.hcl を CI の中で自動で更新(commit, push)できるようにした<ul><li>Terraform に詳しくない人も使うので、自動化したほうが良いと判断</li></ul></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a> を CI に導入</li><li>(in progress) Terraform Modules を Terraform の Monorepo とは別リポジトリで管理して versioning するようにした</li><li>Route53 の管理を <a href="https://github.com/codenize-tools/roadworker" target="_blank" rel="noopener noreferrer">Roadworker</a> から Terraform へ移行</li><li>tfmigrate を使ったリファクタリング</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="event">Event<a class="hash-link" href="#event" title="Direct link to heading">​</a></h2><ul><li><a href="https://mercari.connpass.com/event/211073/" target="_blank" rel="noopener noreferrer">Open Policy Agent Rego Knowledge Sharing Meetup</a> で登壇<ul><li><a href="https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e" target="_blank" rel="noopener noreferrer">https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="oss-contribution">OSS Contribution<a class="hash-link" href="#oss-contribution" title="Direct link to heading">​</a></h2><p>AWS AppConfig を Terraform で管理できるようにする PR が無事マージされました。</p><ul><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/20172" target="_blank" rel="noopener noreferrer">feat: add aws_appconfig_deployment</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/20176" target="_blank" rel="noopener noreferrer">fix: add the attribute &quot;environment_id&quot; to aws_appconfig_environment</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19359" target="_blank" rel="noopener noreferrer">feat: support AppConfig Deployment Strategy</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19324" target="_blank" rel="noopener noreferrer">feat: support AppConfig Hosted Configuration Version</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19320" target="_blank" rel="noopener noreferrer">feat: add appconfig_configuration_profile</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19307" target="_blank" rel="noopener noreferrer">feat: add aws_appconfig_application and aws_appconfig_environment</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="新たに作った-oss">新たに作った OSS<a class="hash-link" href="#新たに作った-oss" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/tfmigrator/cli" target="_blank" rel="noopener noreferrer">tfmigrator/cli</a>: CLI to Migrate Terraform Configuration and State with terraform state command and hcledit</li><li><a href="https://github.com/suzuki-shunsuke/renovate-github-tags-datasource-repositories" target="_blank" rel="noopener noreferrer">Renovate github-tags Datasource Repositories</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="tfmigrator">tfmigrator<a class="hash-link" href="#tfmigrator" title="Direct link to heading">​</a></h3><p>Terraform Configuration と State をマイグレーションする tfmigrator の CLI をリリースしました。
tfmigrator には紆余曲折有り(?)、時系列的に</p><ul><li><a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfmigrator</a> を開発。 CLI</li><li>YAML の設定ファイルの表現力に限界を感じ、 suzuki-shunsuke/tfmigrator をフォークして Go のライブラリ <a href="https://github.com/tfmigrator/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator/tfmigrator</a> を開発<ul><li>簡単に CLI を実装できるように API も提供</li><li>ついでに色々改良<ul><li><a href="https://github.com/minamijoyo/hcledit" target="_blank" rel="noopener noreferrer">hcledit</a> のインストールが不要</li><li>ファイルの in place の更新をサポート</li><li>dry run のサポート</li><li>複数のリソースをまとめて扱えるような API も提供 <a href="https://pkg.go.dev/github.com/tfmigrator/tfmigrator@v0.5.1/tfmigrator#QuickRunBatch" target="_blank" rel="noopener noreferrer">QuickRunBatch</a></li><li>etc</li></ul></li></ul></li><li>実際に tfmigrator/tfmigrator を使ってみると Go を書くのがちょっと面倒くさい<ul><li>そもそも複雑な rule を一度に適用しようとするのが間違っていると感じた</li></ul></li><li>tfmigrator/tfmigrator を使い、 CLI も実装 tfmigrator/cli<ul><li>やはり基本的なユースケースでは YAML 書くほうが楽</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="renovate-github-tags-datasource-repositories">Renovate github-tags Datasource Repositories<a class="hash-link" href="#renovate-github-tags-datasource-repositories" title="Direct link to heading">​</a></h3><p>Renovate の Datasource や Manager でサポートされていない package を Renovate で update するために、
package ように GitHub Repository を作って package のバージョンに合わせて GitHub tag を更新し、
<code>github-tags</code> Datasource として使おうというプロジェクトです。
現状 AWS RDS や AWS Elasticache の engine version 用のリポジトリを作っています。
tag は GitHub Actions を毎日定期実行することで更新します。
詳細はリポジトリの README でも読んでください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="新しいバージョンをリリースした-oss">新しいバージョンをリリースした OSS<a class="hash-link" href="#新しいバージョンをリリースした-oss" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a><ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases/tag/v2.0.0-0" target="_blank" rel="noopener noreferrer">v2.0.0-0</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases/tag/v1.1.0" target="_blank" rel="noopener noreferrer">v1.1.0</a><ul><li><a href="https://twitter.com/szkdash/status/1416263752475836416" target="_blank" rel="noopener noreferrer">https://twitter.com/szkdash/status/1416263752475836416</a></li></ul></li></ul></li></ul><p>terraform v0.15.4 から Terraform 以外での変更も plan に出力されるようになって
わかりにくいと感じたので、 tfcmt でテンプレート変数追加して見やすくできるようにしました。
Refreshing state のログを除外したり、warning 目立たせたりもできて便利です。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog">Blog<a class="hash-link" href="#blog" title="Direct link to heading">​</a></h2><ul><li><a href="https://techblog.szksh.cloud/archives/2021/07/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/archives/2021/07/</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/06/01/job-06-30">仕事でやったこと 2021-06-01 ~ 2021-06-30</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-07-12T20:47:11.000Z" itemprop="datePublished">July 12, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>GCP を Terraform で管理するための developer support</li><li>miam を Terraform に移行</li><li>Docker Hub から ECR への移行</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/opa-table-driven-test">OPA で Table Driven Tests っぽいことをしてみる</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-07-09T10:38:55.000Z" itemprop="datePublished">July 9, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>OPA で Table Driven Tests っぽく Policy を Test する方法について考えたので紹介します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="背景">背景<a class="hash-link" href="#背景" title="Direct link to heading">​</a></h2><p>先日 <a href="https://mercari.connpass.com/event/211073/" target="_blank" rel="noopener noreferrer">Open Policy Agent Rego Knowledge Sharing Meetup</a> で発表する機会を頂きました。
発表の資料は<a href="https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e" target="_blank" rel="noopener noreferrer">こちら</a>。
普段他社の事例を聞いたり OPA について話たりする機会がないので、非常に貴重な時間になりました。</p><p>その中で <a href="https://twitter.com/deeeet" target="_blank" rel="noopener noreferrer">deeeet</a> さんが <a href="https://github.com/golang/go/wiki/TableDrivenTests" target="_blank" rel="noopener noreferrer">Table Driven Tests</a> っぽくテストしたいというようなことをおっしゃっていました。</p><p>だいたいこの辺: <a href="https://youtu.be/0YpJhrz6L0A?t=2990" target="_blank" rel="noopener noreferrer">https://youtu.be/0YpJhrz6L0A?t=2990</a></p><p>その話を受けて改めて自分で考えてみたところ、できなくはないんじゃないかなという気がしたのでちょっとやってみることにしました。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="サンプル">サンプル<a class="hash-link" href="#サンプル" title="Direct link to heading">​</a></h2><p>せっかくなので簡単なサンプルを GitHub に用意しました。</p><p><a href="https://github.com/suzuki-shunsuke/example-opa-table-driven-tests" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-opa-table-driven-tests</a></p><p>今回は aws_cloud_watch_log_group の retention_in_days が設定されていることをチェックする Rule の Test をします。</p><ul><li>Rule: <a href="https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days.rego" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days.rego</a></li><li>Policy Test: <a href="https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days_test.rego" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days_test.rego</a></li></ul><p>テストケースを <code>seeds</code> という list で定義し、どれか一つでも false だったら fail するようにしています。
テストケースの中身は</p><ul><li>msg: テストケースを示すメッセージ。テストが失敗したときの trace に含める</li><li>resource: rule の input</li><li>exp: rule の評価結果の期待値</li></ul><p>になっています。</p><p>test の中身は別の rule を否定しているだけになっていますね。</p><div class="codeBlockContainer_I0IT language-rego theme-code-block"><div class="codeBlockContent_wNvx rego"><pre tabindex="0" class="prism-code language-rego codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">test_deny_aws_cloudwatch_log_grop_retention_in_days {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    not any_deny_aws_cloudwatch_log_grop_retention_in_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>この書き方は <a href="https://www.openpolicyagent.org/docs/latest/policy-language/#universal-quantification-for-all" target="_blank" rel="noopener noreferrer">Universal Quantification (FOR ALL)</a> で説明されています。</p><p>Set の比較は <code>!=</code>, <code>==</code> で大丈夫です。 <a href="https://www.openpolicyagent.org/docs/latest/policy-language/#sets" target="_blank" rel="noopener noreferrer">https://www.openpolicyagent.org/docs/latest/policy-language/#sets</a></p><div class="codeBlockContainer_I0IT language-rego theme-code-block"><div class="codeBlockContent_wNvx rego"><pre tabindex="0" class="prism-code language-rego codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    result != seed.exp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>test に失敗した場合に、どのテストケースでなぜ失敗したのかわかりやすいように必要な情報を trace で出力するようにしています。</p><div class="codeBlockContainer_I0IT language-rego theme-code-block"><div class="codeBlockContent_wNvx rego"><pre tabindex="0" class="prism-code language-rego codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    trace(sprintf(&quot;FAIL %s (%d): %s, wanted %v, got %v&quot;, [&quot;test_deny_aws_cloudwatch_log_grop_retention_in_days&quot;, i, seed.msg, seed.exp, result]))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Conftest の場合、 <code>--trace</code> をつけると出力されます。 <code>Note</code> で grep するとわかりやすいです。</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ conftest verify --trace | grep Note</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRAC   | | | | Note &quot;FAIL test_deny_aws_cloudwatch_log_grop_retention_in_days (1): retention_in_days should be greater than 0, wanted {\&quot;aws_cloudwatch_log_group.main: retention_in_days should be set and greater than 0\&quot;}, got set()&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>以上、簡単ですが Rego で Table Driven Tests っぽく test を書く方法を紹介しました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/opa">opa</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/conftest">conftest</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/rego">rego</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/create-empty-lambda-by-terraform">Terraform で空の AWS Lambda Function を作る方法</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-06-24T12:25:24.000Z" itemprop="datePublished">June 24, 2021</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform で空の AWS Lambda Function を作ろうとした際にちょっとハマったのでやり方を書いておきます。</p><p>「空の Lambda Function」という表現は適切ではないかもしれませんが、
Lambda で実行するコードのデプロイは Terraform 以外のツールでやるけど、
Lambda Function の作成は Terraform で行うので、 dummy のコードを指定して Terraform で Lambda を作るという話です。</p><p>自分は今は <a href="https://github.com/fujiwara/lambroll" target="_blank" rel="noopener noreferrer">lambroll</a> というツールで Lambda をデプロイしています。
lambroll は Lambda Function も作ってくれるので Terraform で作る必要は必ずしもありません。</p><p>しかし Lambda Function に関連するリソースを Terraform で管理する場合、
Lambda Function も Terraform で作ると Lambda Function の ARN や Invoke ARN を参照できます。</p><p>また lambroll でデプロイする場合も先に Terraform で IAM Role を作成する必要がありますが、
Terraform で aws_lambda_permission のようなリソースを作成するには Lambda Function が先に作られている必要があるので、
互いに依存関係が発生し、面倒なことになります。</p><p>また Lambda Function の削除も Terraform でできるようになります。</p><p>なので、 Terraform で Lambda Function を作っておいたほうが色々都合が良いです。</p><p>Terraform で作成と削除は行うものの、更新をしたいわけではないので、 <code>ignore_changes = all</code> を指定します。</p><p><a href="https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes</a></p><p>Lambda Function を Web UI などから作る場合 Function code はなくても大丈夫ですが、
Terraform で Lambda Function を作る場合、 <code>filename</code> や <code>image_uri</code>, <code>s3_bucket</code> のいずれかが必須になります。
これは issue もありますが、仕様のようにみえます。</p><p><a href="https://github.com/hashicorp/terraform-provider-aws/issues/5945" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-aws/issues/5945</a></p><p>ECR や S3 に dummy のコードを用意するというのも一つの手ですが、環境に依存するのがあまり良い気がしないので、
archive_file data source を使って dummy の zip ファイルを生成するという方法を取ることにしました。</p><p><a href="https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file</a></p><p>次のようなコードで CI で terraform apply を実行しましたが、 zip file がないと言われて失敗しました。</p><div class="codeBlockContainer_I0IT language-tf theme-code-block"><div class="codeBlockContent_wNvx tf"><pre tabindex="0" class="prism-code language-tf codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_lambda_function&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Terraform can create and destroy the remote object but will never propose updates to it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_changes = all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function_name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role          = aws_iam_role.main.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handler  = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runtime  = &quot;provided.al2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename = data.archive_file.dummy.output_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;archive_file&quot; &quot;dummy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = &quot;zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_path = &quot;${path.module}/dummy.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content  = &quot;dummy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Error: unable to load &quot;lambda-base/dummy.zip&quot;: open lambda-base/dummy.zip: no such file or directory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>しかしローカルで terraform plan, apply を実行してみても再現しませんでした。</p><p>CI では Pull Request で plan file を生成して S3 に plan file を upload し、 PR をマージした default branch では terraform plan を実行せずに S3 から plan file をダウンロードして terraform apply を実行しています。</p><p><a href="https://blog.studysapuri.jp/entry/2021/03/10/080000" target="_blank" rel="noopener noreferrer">Pull Request の terraform plan の実行結果を S3 に保存して安全に apply | Quipper Product Team Blog</a></p><p>plan file を指定して terraform apply を実行した際には zip file が作成されず、上記のエラーが発生することがわかりました。</p><p>関連する issue もありました。 <a href="https://github.com/hashicorp/terraform-provider-archive/issues/39" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-archive/issues/39</a></p><p>この issue では幾つかの解決方法が紹介されています。ちなみに 2021-06-24 現在 Hashicorp 側からは特に反応がないように見えます。
random_uuid や random_string を使った方法もありますが、 Lambda を作成するだけなら null_resource に依存させるだけで十分のように思えました。</p><div class="codeBlockContainer_I0IT language-tf theme-code-block"><div class="codeBlockContent_wNvx tf"><pre tabindex="0" class="prism-code language-tf codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;archive_file&quot; &quot;dummy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = &quot;zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_path = &quot;${path.module}/dummy.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content  = &quot;dummy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    null_resource.main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;null_resource&quot; &quot;main&quot; {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように null_resource に依存させると terraform plan では zip file が作られず、 terraform apply ではじめて zip file が作られるため、
terraform apply が失敗することはなくなりました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/lambda">lambda</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/05/01/job-05-31">仕事でやったこと 2021-05-01 ~ 2021-05-31</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-05-29T23:19:32.000Z" itemprop="datePublished">May 29, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>SRE チームの新メンバーのオンボーディングのサポート</li><li>GCP<ul><li>dev からのリクエストに応じて権限付与したり対応</li><li>Terraform による GCP の管理 CI/CD の整備</li><li>Workload Identity Federation について調べた</li><li>Terraform による IAM 管理の仕方を検討</li></ul></li><li>Conftest<ul><li><code>opa fmt</code> によるフォーマット(CI も導入)</li><li>Policy Testing (CI も導入)</li></ul></li><li>Upgrade Terraform to v0.15.4</li><li>miam の Terraform 移行を検証</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/04/01/job-04-30">仕事でやったこと 2021-04-01 ~ 2021-04-30</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-04-28T00:28:01.000Z" itemprop="datePublished">April 28, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>SRE チームの新メンバーのオンボーディングのサポート</li><li>Lambda の Monorepo<ul><li>幾つか実際に Function 作った(developer support)</li><li>幾つかの Release Strategy の実装・検証<ul><li>シンプルな GitHub Flow</li><li>Git Flow をアレンジしたリリースフロー</li><li>Canary Release</li><li>WIP: AWS AppConfig を用いた Dark Launch</li></ul></li></ul></li><li>IAM User の初期パスワード送信の自動化</li><li>Terraform<ul><li>Renovate による Terraform の patch update の自動化</li><li>Docker を使ったローカル開発環境の改善</li><li>ローカルで terraform init したら .terraform.lock.hcl が更新される問題の対応 <a href="https://techblog.szksh.cloud/terraform-providers-lock/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/terraform-providers-lock/</a></li></ul></li><li>GCP の Terraform 管理<ul><li>調査</li><li>WIP</li></ul></li><li>Conftest<ul><li>社内の Rego の活用事例をまとめた</li><li><code>opa fmt</code> によるフォーマット(CI も導入)</li><li>Policy Testing (CI も導入)</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/example-github-actions-dynamic-matrix">PR で変更されたファイルや PR Label に応じて matrix build を実行する Github Actions の Workflow のサンプルを書いてみた</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-04-25T07:09:47.000Z" itemprop="datePublished">April 25, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>GitHub Actions の勉強がてら Pull Request (以下 PR) で変更されたファイルや PR Label に応じて
Matrix build を実行する Github Actions の Workflow のサンプルを書いてみました。</p><p><a href="https://github.com/suzuki-shunsuke/example-github-actions-dynamic-matrix" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-github-actions-dynamic-matrix</a></p><p>Monorepo で同じ Job を PR で変更されたものに対してだけ実行したい、
けど workflow をサービスごとに定義するのはめんどいみたいな場合に使えるかもしれません。</p><p>勉強がてらちょっと書いてみて軽く動作確認しただけなので、バグってる、あるいは実用的ではないかもしれません。</p><p>ここでは Monorepo の CI を GitHub Actions で実行する場合を考えます。</p><p>GitHub Actions では path filter を用いて workflow の実行有無を制御することができます。
そこでサービスごとに workflow を作成し、 path filter を設定することでそのサービスが更新されたときのみそのサービスの CI を実行するということが簡単にできます。</p><p>しかし多くのサービスが含まれる Monorepo で各サービスに同じ Job を実行したい場合を考えてみましょう。
その場合サービスを追加するたびに workflow を追加していく必要があります。
まぁ .github/workflows 配下に 1 つ YAML をコピペで作成するだけといえばそれまでなのですが、それすらも省略したいとしましょう。</p><p><a href="https://blog.studysapuri.jp/entry/2020/12/03/080000" target="_blank" rel="noopener noreferrer">Terraform の CI/CD を CodeBuild に移行した話</a>では CodeBuild の Batch Build の buildspec を
PR で変更されたファイルおよび PR Label に応じて動的に生成しています。
これの良いところは、サービスを追加したり、リネームしたり、削除したりしても CI をイジる必要がまったくないところです。</p><p>それと似たようなことを GitHub Actions でもやってみました。</p><p>foo と bar という 2 つのサービス(Go のアプリケーション)があり、
CI では setup job で CI を実行するサービスのリストを動的に生成し、後続の build job で対象サービスの build を実行しています。
例えばリポジトリ直下の README.md だけを更新した場合、どのサービスのビルドも実行されません。
サービス foo の main.go だけを更新した場合、サービス foo のビルドだけ実行され、 bar のビルドは実行されません。
<code>target/&lt;サービス名&gt;</code> という PR Label をつけて CI を実行すると指定したサービスのコードが変更されていなくてもビルドを実行できます。</p><p>主に以下のツールを使いつつ、シェルスクリプトで実装しています。</p><ul><li><a href="https://github.com/suzuki-shunsuke/ci-info" target="_blank" rel="noopener noreferrer">ci-info</a></li><li><a href="https://github.com/suzuki-shunsuke/matchfile" target="_blank" rel="noopener noreferrer">matchfile</a></li><li>jq</li></ul><p>詳細は <a href="https://github.com/suzuki-shunsuke/example-github-actions-dynamic-matrix" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-github-actions-dynamic-matrix</a> のコードと <a href="https://github.com/suzuki-shunsuke/example-github-actions-dynamic-matrix/pulls?q=is%3Apr+is%3Aopen+label%3Ademo" target="_blank" rel="noopener noreferrer">Demo 用の PR</a> を見てください。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/github-actions">github-actions</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-providers-lock">terraform init で lock ファイルが更新される問題の対応</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-04-24T12:57:27.000Z" itemprop="datePublished">April 24, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform v0.14 で local で <code>terraform init</code> すると lock ファイルが更新されてしまう問題に対応しました。</p><p>結論を最初に言うと、 <a href="https://blog.studysapuri.jp/entry/2021/03/12/080000" target="_blank" rel="noopener noreferrer">100 以上の Terraform 環境をいい感じに v0.14 に upgrade した方法</a>で紹介している方法で Renovate で Terraform Provider を update する際に <code>terraform init -upgrade</code> を実行して lock ファイルを更新してコミット・プッシュしているのですが、
その際に <code>terraform providers lock -platform=darwin_amd64</code> を実行するようにしました。</p><p>Terraform v0.14 で lock ファイル <code>.terraform.lock.hcl</code> が導入されました。
Renovate で Terraform Provider を update する際にも lock ファイルを更新する必要があるので、
<code>terraform init -upgrade</code> を実行して lock ファイルを更新してコミット・プッシュしています。
なのですが、ローカルで <code>terraform init</code> を実行するとなんか lock ファイルが更新されることが良くありました。しばらく放置していたのですが、 developer から「なんかファイル更新されたんだけど、これコミットしていいの？」と聞かれ、このまま放っておいて困惑させたりもやっとさせたりするのは良くないなと思い、調べてみました。</p><p>lock ファイルについて <a href="https://speakerdeck.com/minamijoyo/how-to-update-terraform-dot-lock-dot-hcl-efficiently" target="_blank" rel="noopener noreferrer">.terraform.lock.hcl 完全に理解した</a>で詳しく解説されていたので大変助かりました。</p><ul><li>lock ファイルには provider の hash 値が記録されている</li><li>lock ファイルは <code>terraform init</code> で自動的に更新される</li><li>hash 値は platform (Mac, Linux, etc) によって違う</li><li><code>terraform init</code> 実行時に、その platform の hash 値が lock ファイルになければ追加される<ul><li>デフォルトでは実行環境以外の Platform の hash 値は追加されない</li></ul></li><li>CI は Linux 上で実行しているので、 Linux の hash 値だけが記録される</li><li>ローカルで Mac 上で <code>terraform init</code> すると Mac の hash 値が追加され、 lock ファイルに差分が生じる</li></ul><p>なので差分が出てしまった場合はコミットするで良いとは思いますが、そもそも CI で lock ファイルを更新する際に Mac の hash 値も追加してしまえばローカルで Mac 上で <code>terraform init</code> しても差分が出なくなります。ちなみに Windows 上で <code>terraform init</code> する人は自分の周りにはいなさそうなので、 Windows は対応しないことにしました。</p><p><a href="https://blog.studysapuri.jp/entry/2021/03/12/080000" target="_blank" rel="noopener noreferrer">100 以上の Terraform 環境をいい感じに v0.14 に upgrade した方法</a>で紹介しているようにすでに lock ファイルを更新してコミット・プッシュする仕組みはあるので、変更としては 1 (正確にはコードコメント入れて4)行追加するだけでした。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">github-comment exec -- terraform providers lock -platform=darwin_amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-module-template">Terraform Module の Template という使い方</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-04-03T02:04:25.000Z" itemprop="datePublished">April 3, 2021</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform Module の使い方として Terraform Module のテンプレートをコピペして使うというアプローチを紹介します。</p><p>Terraform の設定ファイル(以下 tfファイル) を書く際、毎回一から書くのは大変です。
多くの場合、既存のコードを再利用したほうが楽でしょう。</p><p>Terraform のコードの再利用の仕組みとして、 Module があります。
Module は勿論便利なのですが、使い方には注意が必要で、「安易に Module 化するな。使うな」というふうな考え方もあるでしょう。
自分も基本的に同意見で、 Module を共用するようになると Module への変更がしづらくなったり、パラメータがどんどん増えて複雑になったりします。</p><p>例えば次のように共用の local Module を作成するアプローチがあります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lambda-base/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  foo/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf # リポジトリ直下の modules/lambda-base を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf # リポジトリ直下の modules/lambda-base を参照</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると modules 配下の Module を変更した際にその Module を使っているすべてのサービスに影響が出てしまい、
サービスのオーナーが様々だったり、曖昧だったり不在だったりすると変更が難しいですし、どんどん Module が複雑になったりします。</p><p>Module を別のリポジトリでバージョニングして管理し、バージョンを指定するようにするというやり方もありますが、
結構複雑というか考えることが多いアプローチだとは思います。</p><p>Terraform にそこまで詳しくない developer にも書いてもらうとなると、シンプルなアプローチにするのが望ましいでしょう(当然これは組織によりますが)。</p><p>そこで Module のテンプレートを用意し、 Module を使いたくなったらそれをコピペして使うというアプローチがあります。
例えば <code>lambda-base</code> という Module の Template を foo というサービスの staging 環境と production 環境で使う場合、次のような感じになります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">services/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  foo/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    staging/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lambda-base/ # templates からコピー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    production/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lambda-base/ # templates からコピー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">templates/ # Module のテンプレートを置いておく</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lambda-base/ # 中身は普通の Module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputs.tf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると 2 つの Module はそれぞれ独立しているため、変更がしやすくなりますし、シンプルに保つことが出来ます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="テンプレートエンジンとかは使わない">テンプレートエンジンとかは使わない<a class="hash-link" href="#テンプレートエンジンとかは使わない" title="Direct link to heading">​</a></h2><p>Module の Template をコピペする際に、コードに変数を埋め込んでコピペする際に置換したりとか、高度なテンプレートエンジンを使って動的に内容を変えたりといったことも考えられますが、
個人的には複雑度が上がるのでやらないほうが良いかなと思っています。
変数であれば Module の input variable として渡せばよいし、テンプレートエンジン使いたいのであれば、テンプレートを分けたり、 HCL で表現したりすればよいのではという気がします。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="考えられるデメリット">考えられるデメリット<a class="hash-link" href="#考えられるデメリット" title="Direct link to heading">​</a></h2><p>通常の Module と比べて、デメリットとしては以下のようなことが考えられます。</p><ul><li>コード量が増える(DRY じゃない)</li><li>Module を一箇所で管理できない<ul><li>一括して変更を加えることが出来ない</li><li>設定を強制することができない</li></ul></li></ul><p>しかし、個人的にはこれは大した問題じゃないと思っています。</p><p>コードが増えることに関しては、それはそうとしか言いようがありません。
一括して変更を加えることが出来ないのは、トレードオフだと思っていて、むしろ対処のサービスを限定しながら Module に変更を加えられるというメリットのほうが大きいと思っています。
設定を強制することができないのは、たしかにそれはあると思っていて、コピペした Module に一括して変更を加えたり Conftest などでテストする仕組みが必要かなと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/03/01/job-03-31">仕事でやったこと 2021-03-01 ~ 2021-03-31</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-03-28T14:36:55.000Z" itemprop="datePublished">March 28, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>ブログの執筆<ul><li><a href="https://blog.studysapuri.jp/entry/2021/03/12/080000" target="_blank" rel="noopener noreferrer">100 以上の Terraform 環境をいい感じに v0.14 に upgrade した方法</a></li><li><a href="https://blog.studysapuri.jp/entry/2021/03/10/080000" target="_blank" rel="noopener noreferrer">Pull Request の terraform plan の実行結果を S3 に保存して安全に apply</a></li></ul></li><li>Terraform のドキュメント作成<ul><li>CI/CD でやってること</li><li>ローカルでの開発環境 setup</li><li>etc</li></ul></li><li>CI の改善<ul><li>CircleCI の job の branch filter を設定して余計な job が実行されないようにした</li><li>(進行中) デプロイをサービスごとに分割</li></ul></li><li>(進行中) Lambda を爆速でデプロイするためのプラットフォームづくり<ul><li>Terraform + lambroll + AWS CodeBuild</li></ul></li><li>MongoDB upgrade (Atlas)</li><li>On Boarding のドキュメントの整理</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/job">job</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a href="//page/2" target="_blank" rel="noopener noreferrer" class="pagination-nav__link"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a href="//page/4" target="_blank" rel="noopener noreferrer" class="pagination-nav__link"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.00932b7a.js"></script>
<script src="/assets/js/main.71a74257.js"></script>
</body>
</html>