<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Blog | Melody</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Melody"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/page/3"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/page/3" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><link rel="stylesheet" href="/assets/css/styles.bf1fb70d.css">
<link rel="preload" href="/assets/js/runtime~main.939a8634.js" as="script">
<link rel="preload" href="/assets/js/main.01eb5cf4.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_ToTc themedImage--light_HNdA"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/what-i-did-2022">2022 年振り返り</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/what-i-did-2022-12">Looking back at Dec 2022</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/what-i-did-2022-11">My Activity in 2022-11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/what-i-did-2022-10">My Activity in 2022-10</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/what-i-did-2022-09">My Activity in 2022-09</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="先日 aqua v0.1.0 をリリースした記事を書いたばかりですが、"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-09-04T02:58:42.000Z" itemprop="datePublished">September 4, 2021</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="/aqua/">先日 aqua v0.1.0 をリリースした記事を書いた</a>ばかりですが、
そこから更に開発を続けて v0.5.0 をリリースしたので、変更点を紹介します。</p><p>基本的に <a href="https://github.com/suzuki-shunsuke/aqua/releases" target="_blank" rel="noopener noreferrer">Release Note</a> に書いてあるとおりです。</p><ul><li>PATH を project (aqua.yaml) 毎に設定する必要がなくなりました<ul><li><code>~/.aqua/bin</code> を PATH に追加すればよくなりました</li><li>direnv などを使って環境変数を追加する必要がなくなりました</li></ul></li><li><code>install</code> コマンドに <code>--test</code> option を追加し、 <code>file.src</code> の設定が正しいかテストできるようになりました<ul><li>CI で aqua の設定をテストするのに便利</li></ul></li><li>GitHub Release だけでなく、任意の URL から tool のダウンロード・インストールができるようになりました<ul><li>Go や helm, Hashicorp の product のような公式サイトからダウンロードするタイプのツールも install できるようになりました</li></ul></li><li>Breaking Change: <code>inline_registry</code> の設定の形式を変更しました</li><li>aqua の設定の再利用性を高める <code>Registry</code> という仕組みを導入しました<ul><li>standard <code>Registry</code> を公開しました <a href="https://github.com/suzuki-shunsuke/aqua-registry" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry</a></li></ul></li><li>簡単な slide を公開しました: <a href="https://speakerdeck.com/szksh/introduction-of-aqua" target="_blank" rel="noopener noreferrer">https://speakerdeck.com/szksh/introduction-of-aqua</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="path-を-project-aquayaml-毎に設定する必要がなくなりました">PATH を project (aqua.yaml) 毎に設定する必要がなくなりました<a href="#path-を-project-aquayaml-毎に設定する必要がなくなりました" class="hash-link" aria-label="Direct link to PATH を project (aqua.yaml) 毎に設定する必要がなくなりました" title="Direct link to PATH を project (aqua.yaml) 毎に設定する必要がなくなりました">​</a></h2><p>aqua v0.1.0 では symbolic link を aqua.yaml のあるディレクトリの <code>.aqua/bin</code> 配下に作成しており、ここを PATH に追加する必要がありました。
direnv とかを使うと便利ですが、間接的に(?) aqua が direnv のようなツールに依存している形になり、微妙でした。</p><p>aqua v0.5.0 では symbolic link を <code>~/.aqua/bin</code> 配下に作成するため、 .bashrc などで <code>~/.aqua/bin</code> を PATH に追加しておけば project ごとに環境変数を追加する必要はなくなりました。
ちなみに作成される symbolic link は aqua-proxy へのリンクであり、ツールのバージョンには依存しないので <code>~/.aqua/bin</code> を共有しても干渉することはありません。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="応用-aquabin-配下に-symbolic-link-を作る上での課題とそれの解決法">[応用]<!-- --> <code>~/.aqua/bin</code> 配下に symbolic link を作る上での課題とそれの解決法<a href="#応用-aquabin-配下に-symbolic-link-を作る上での課題とそれの解決法" class="hash-link" aria-label="Direct link to 応用-aquabin-配下に-symbolic-link-を作る上での課題とそれの解決法" title="Direct link to 応用-aquabin-配下に-symbolic-link-を作る上での課題とそれの解決法">​</a></h3><p><code>~/.aqua/bin</code> 配下に symbolic link を作って PATH に追加する場合、一つ大きな課題があります
(だからこそ v0.1.0 ではプロジェクトごとに symbolic link を作っていました)。
<code>~/.aqua/bin</code> 配下に symbolic link を作って PATH に追加すると、基本的にそのファイルが呼ばれることになります。
そのツールを aqua で管理しているプロジェクト配下ならそれで良いですが、そうでない場合、本来 aqua 以外でインストールしたものを実行したくても実行できません。
例えば homebrew で jq を install していて、あるプロジェクトでは aqua を使ってバージョンを固定したものを使いたいが、それ以外では homebrew で install したものを使いたいといった場合に問題になります。</p><p>この問題を解決するため、 aqua ではツールを呼び出す際に <code>PATH</code> をチェックして aqua-proxy へのリンクとなっているものは除外するというハック(?)のようなことをしています。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-コマンドに---test-option-を追加し-filesrc-の設定が正しいかテストできるようになりました"><code>install</code> コマンドに <code>--test</code> option を追加し、 <code>file.src</code> の設定が正しいかテストできるようになりました<a href="#install-コマンドに---test-option-を追加し-filesrc-の設定が正しいかテストできるようになりました" class="hash-link" aria-label="Direct link to install-コマンドに---test-option-を追加し-filesrc-の設定が正しいかテストできるようになりました" title="Direct link to install-コマンドに---test-option-を追加し-filesrc-の設定が正しいかテストできるようになりました">​</a></h2><p>地味な更新ですが、 aqua の設定を更新した際に CI でテストするのに便利です。
<code>--test</code> option なしだと、 warning は出力しますが、 exit code は 0 になります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-release-だけでなく任意の-url-から-tool-のダウンロードインストールができるようになりました">GitHub Release だけでなく、任意の URL から tool のダウンロード・インストールができるようになりました<a href="#github-release-だけでなく任意の-url-から-tool-のダウンロードインストールができるようになりました" class="hash-link" aria-label="Direct link to GitHub Release だけでなく、任意の URL から tool のダウンロード・インストールができるようになりました" title="Direct link to GitHub Release だけでなく、任意の URL から tool のダウンロード・インストールができるようになりました">​</a></h2><p>ちなみに、 GitHub Release で公開されてないようなツールでも、
GitHub リポジトリで versioning されていて Renovate の <code>github_release</code> data source で自動更新できるケースは少なくないと思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="breaking-change-inline_registry-の設定の形式を変更しました">Breaking Change: <code>inline_registry</code> の設定の形式を変更しました<a href="#breaking-change-inline_registry-の設定の形式を変更しました" class="hash-link" aria-label="Direct link to breaking-change-inline_registry-の設定の形式を変更しました" title="Direct link to breaking-change-inline_registry-の設定の形式を変更しました">​</a></h2><p>小さな breaking change ですが、<code>inline_registry</code> の形式が変わりました。</p><p>AS IS</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx{{else}}{{.OS}}{{end}}-{{.Arch}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TO BE</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx{{else}}{{.OS}}{{end}}-{{.Arch}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aqua-の設定の再利用性を高める-registry-という仕組みを導入しました">aqua の設定の再利用性を高める <code>Registry</code> という仕組みを導入しました<a href="#aqua-の設定の再利用性を高める-registry-という仕組みを導入しました" class="hash-link" aria-label="Direct link to aqua-の設定の再利用性を高める-registry-という仕組みを導入しました" title="Direct link to aqua-の設定の再利用性を高める-registry-という仕組みを導入しました">​</a></h2><p>これが一番大きな更新です。
aqua を使うにはツールのインストール方法を YAML で記述しないといけませんが、
これはちょっとした手間ですし、新規ユーザーにとって障壁となるでしょう。</p><p>ツールとそのバージョンを定義したらインストールできてほしいものです。
ツールとそのバージョンの定義は <code>aqua.yaml</code> の <code>packages</code> の部分なので、それ以外の設定を如何に簡略化するかという話になります。</p><p>Registry はツールのインストール方法の設定を、プロジェクト固有のバージョン設定とは独立させ、再利用可能な形で共有する仕組みです。</p><p>Registry には現状 4 種類あります。</p><ul><li>inline regisry: aqua.yaml の中に直接 install 方法を定義する。 v0.1.0 からサポートされている方法</li><li>github_content registry: GitHub Repository にあるファイルを Registry として参照する方法</li><li>local registry: GitHub Repository にあるファイルを Regisry として参照する方法</li><li>standard registry: 自分がメンテしている github_content registry のエイリアス</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="inline-registry">inline registry<a href="#inline-registry" class="hash-link" aria-label="Direct link to inline registry" title="Direct link to inline registry">​</a></h3><p>inline registry は従来からあるやつで、 aqua.yaml 内に定義する方法です。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx{{else}}{{.OS}}{{end}}-{{.Arch}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>シンプルではありますが、コピペする以外に再利用性がありません。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="local-registry">local registry<a href="#local-registry" class="hash-link" aria-label="Direct link to local registry" title="Direct link to local registry">​</a></h2><p>local registry はローカルにあるファイルを参照する registry です。
絶対パスか、 aqua.yaml からの相対パスを指定します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github_content-registry">github_content registry<a href="#github_content-registry" class="hash-link" aria-label="Direct link to github_content registry" title="Direct link to github_content registry">​</a></h2><p>ユーザーとしては次のように Registry を定義すればあとは <code>packages</code> で Registry を参照できます。
GitHub Access Token を環境変数 <code>GITHUB_TOKEN</code> として設定する必要があります。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzuki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shunsuke/aqua</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzuki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shunsuke</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aqua</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.27.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=open-policy-agent/conftest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="registry-を公開する">Registry を公開する<a href="#registry-を公開する" class="hash-link" aria-label="Direct link to Registry を公開する" title="Direct link to Registry を公開する">​</a></h3><p>自分で Registry を公開したい場合は GitHub Repository に設定ファイルを置くだけで OK です。
e.g. <a href="https://github.com/suzuki-shunsuke/aqua-registry/blob/main/registry.yaml" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry/blob/main/registry.yaml</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="standard-registry">Standard Registry<a href="#standard-registry" class="hash-link" aria-label="Direct link to Standard Registry" title="Direct link to Standard Registry">​</a></h2><p>Standard Registry も作りました。</p><p><a href="https://github.com/suzuki-shunsuke/aqua-registry" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/aqua-registry</a></p><p>jq や gh, kubectl, Terraform など有名なツールはこの Registry を使えばインストールできますが、
当然 PR も受け付けているので、追加してほしいツールがあれば PR を投げてください。</p><p>Official Registry を github_content Registry として利用することも当然できますが、
より簡潔に書けるように <code>type: standard</code> という Registry がサポートされています。</p><p>AS IS</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzuki</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">shunsuke</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aqua</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TO BE</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.2.0 </span><span class="token comment" style="color:#999988;font-style:italic"># renovate: depName=suzuki-shunsuke/aqua-registry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上 2 つは等価ではありますが、後者のほうが簡潔です。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/oss">oss</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aqua">aqua</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="仕事"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/what-i-did-2021-08">2021-08 やったこと</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-09-02T05:33:16.000Z" itemprop="datePublished">September 2, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="仕事">仕事<a href="#仕事" class="hash-link" aria-label="Direct link to 仕事" title="Direct link to 仕事">​</a></h2><ul><li>AWS IAM User を削除する際に force_destroy が true になっているか Conftest でテスト</li><li>Terraform の State 分割</li><li>Terraform Modules を別リポジトリで管理して versioning</li><li>git-secrets を secretlint に移行<ul><li>git-secrets がメンテされてなくて、既知バグが放置されているから</li></ul></li><li>CI で terraform fmt によるフォーマットの自動化</li><li>WIP: AWS WAF の COUNT, BLOCK ログを Firehose で抽出</li><li>WIP: AWS CodeBuild で Provisioning Error が発生したら自動で Retry</li><li>WIP: AWS CodeBuild のための GitHub App の開発</li><li>WIP: AWS SSO について調査</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="oss-contribution">OSS Contribution<a href="#oss-contribution" class="hash-link" aria-label="Direct link to OSS Contribution" title="Direct link to OSS Contribution">​</a></h2><p>Renovate の GitHub Actions のドキュメントの修正をしました。
ドキュメント中に書かれたバージョンを Renovate で自動 update するようにしました。</p><ul><li><a href="https://github.com/renovatebot/github-action/pull/556" target="_blank" rel="noopener noreferrer">docs: fix broken links and update GitHub Actions</a></li><li><a href="https://github.com/renovatebot/github-action/pull/557" target="_blank" rel="noopener noreferrer">chore: update GitHub Actions in README by Renovate</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新たに作った-oss">新たに作った OSS<a href="#新たに作った-oss" class="hash-link" aria-label="Direct link to 新たに作った OSS" title="Direct link to 新たに作った OSS">​</a></h2><ul><li><a href="https://github.com/suzuki-shunsuke/logrus-error" target="_blank" rel="noopener noreferrer">logrus-error</a>: <a href="https://github.com/sirupsen/logrus" target="_blank" rel="noopener noreferrer">logrus</a>.Fields を error に埋め込む Go の薄いライブラリ</li><li><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a>: Command Line Tools Version Manager<ul><li><a href="https://github.com/suzuki-shunsuke/aqua-proxy" target="_blank" rel="noopener noreferrer">aqua-proxy</a>: aqua の内部ツール </li><li><a href="https://github.com/suzuki-shunsuke/aqua-installer" target="_blank" rel="noopener noreferrer">aqua-installer</a>: aqua をインストールするスクリプトと GitHub Actions</li></ul></li><li><a href="https://github.com/suzuki-shunsuke/go-checkout-github-merged-commit" target="_blank" rel="noopener noreferrer">go-checkout-github-merged-commit</a>: PR の merged commit を checkout する Go のライブラリ</li><li><a href="https://github.com/suzuki-shunsuke/aws-codebuild-retry" target="_blank" rel="noopener noreferrer">aws-codebuild-retry</a>: AWS CodeBuild を Retry する Lambda Function</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="blog">Blog<a href="#blog" class="hash-link" aria-label="Direct link to Blog" title="Direct link to Blog">​</a></h2><ul><li><a href="https://techblog.szksh.cloud/archives/2021/08/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/archives/2021/08/</a><ul><li><a href="https://techblog.szksh.cloud/aqua/" target="_blank" rel="noopener noreferrer">aqua - CLI ツールのバージョン管理</a></li><li><a href="https://techblog.szksh.cloud/github-app-for-codebuild/" target="_blank" rel="noopener noreferrer">AWS CodeBuild を実行する Github App を作る</a></li></ul></li><li>Quipper<ul><li><a href="https://blog.studysapuri.jp/entry/2021/08/11/080000" target="_blank" rel="noopener noreferrer">Terraform の CI に tfmigrate を導入した話</a></li><li><a href="https://blog.studysapuri.jp/entry/2021/08/02/080000" target="_blank" rel="noopener noreferrer">AWS IAM の管理を miam から Terraform に移行した話</a></li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/job">job</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/oss">oss</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="2021-09-04 追記: aqua v0.1.0 から v0.5.0 での変更点"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/aqua">aqua - CLI ツールのバージョン管理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-08-28T00:07:38.000Z" itemprop="datePublished">August 28, 2021</time> · <!-- -->16 min read</div></header><div class="markdown" itemprop="articleBody"><p>2021-09-04 追記: <a href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></p><p><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a> という OSS を開発しているので紹介します。</p><p>記事の内容は aqua v0.1.0 に基づきます。将来的に仕様が変わる可能性があります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aqua-とは">aqua とは<a href="#aqua-とは" class="hash-link" aria-label="Direct link to aqua とは" title="Direct link to aqua とは">​</a></h2><p>aqua は CLI ツールのバージョン管理のための CLI です。
aqua で管理する主な対象は GitHub Release で公開されているツールです。
YAML の設定ファイルを書いてコマンドを実行すると指定したツールをインストールすることができます。</p><p>例えば以下のような設定ファイルを書き、 <code>aqua install</code> というコマンドを実行すると
<a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a>, <a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a> などが GitHub Release からダウンロードされ、インストールされます。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx-amd64{{else}}{{if eq .OS &quot;linux&quot;}}linux64{{else}}win64.exe{{end}}{{end}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> open</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ちなみに上記の設定ファイルの</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>の部分では Go の <a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener noreferrer">text/template</a> と <a href="http://masterminds.github.io/sprig/" target="_blank" rel="noopener noreferrer">sprig</a> が使われています。</p><p>ツールごとに URL を調べて download して tarball などを展開してインストールしてなどの面倒な作業を aqua で自動化できます。
update も基本的に設定ファイルの version を更新するだけで OK です。</p><p>aqua を使うと同じツールの複数のバージョンを管理してプロジェクトによってバージョンを切り替えるといったことも容易にできます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-つの主なユースケース">3 つの主なユースケース<a href="#3-つの主なユースケース" class="hash-link" aria-label="Direct link to 3 つの主なユースケース" title="Direct link to 3 つの主なユースケース">​</a></h2><p>aqua では以下の 3 つの主なユースケースを想定しています。</p><ul><li>CI/CD で必要なツールの管理</li><li>ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理</li><li>特定のプロジェクト(リポジトリ)によらないツールの管理</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース1-cicd-で必要なツールの管理">ユースケース1: CI/CD で必要なツールの管理<a href="#ユースケース1-cicd-で必要なツールの管理" class="hash-link" aria-label="Direct link to ユースケース1: CI/CD で必要なツールの管理" title="Direct link to ユースケース1: CI/CD で必要なツールの管理">​</a></h3><p>例えば Terraform の Monorepo の CI で以下のような様々なツールを使っていたとしましょう。</p><ul><li><a href="https://cli.github.com/" target="_blank" rel="noopener noreferrer">gh</a></li><li><a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a></li><li><a href="https://tfsec.dev/" target="_blank" rel="noopener noreferrer">tfsec</a></li><li><a href="https://github.com/terraform-linters/tflint" target="_blank" rel="noopener noreferrer">tflint</a></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a></li><li><a href="https://github.com/open-policy-agent/opa" target="_blank" rel="noopener noreferrer">opa</a></li><li><a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a></li><li><a href="https://github.com/mvdan/sh" target="_blank" rel="noopener noreferrer">shfmt</a></li><li><a href="https://github.com/koalaman/shellcheck" target="_blank" rel="noopener noreferrer">shellcheck</a></li><li><a href="https://github.com/suzuki-shunsuke/github-comment" target="_blank" rel="noopener noreferrer">github-comment</a></li></ul><p>これらを1個1個 curl などを使ってインストールするコードを書くのは面倒ですが、
aqua であれば設定ファイルを宣言的に書いて <code>aqua i</code> を実行すれば終わりです。
新たにツールを追加する場合でも設定ファイルに追記すればよく、スクリプトを更新する必要はありません。
バージョンを明示的に指定できるのでコードを変更してないのに急にツールが更新されることもありませんし、 <a href="https://docs.renovatebot.com/modules/manager/regex/" target="_blank" rel="noopener noreferrer">Renovate の Regex Manager</a> などを使えば更新を自動化することもできます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理">ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理<a href="#ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理" class="hash-link" aria-label="Direct link to ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理" title="Direct link to ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理">​</a></h3><p>あるリポジトリのローカルでの開発に必要なツールを aqua で管理することができます。
リポジトリ直下に <code>aqua.yaml</code> を置いておけば OK です。
バージョンも指定されているので、人によってバージョンが違ったりする問題も解消できます。
<code>aqua.yaml</code> と同じディレクトリに <code>.aqua</code> が作成されるのでそれを .gitignore に追加し、 <code>.aqua/bin</code> を PATH に追加しましょう。
direnv を使い、リポジトリ直下に .envrc を置いて <code>.aqua/bin</code> を PATH に追加すると便利です。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aqua.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.envrc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>.envrc</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PATH_add .aqua/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>.aqua/bin</code> を PATH に追加しなくても <code>aqua exec -- &lt;コマンド&gt; ...</code> で実行することもできます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース3-特定のプロジェクトリポジトリによらないツールの管理">ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理<a href="#ユースケース3-特定のプロジェクトリポジトリによらないツールの管理" class="hash-link" aria-label="Direct link to ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理" title="Direct link to ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理">​</a></h3><p>特定のプロジェクトによらずにツールを laptop にインストールしたい場合にも使えます。
<code>~/.aqua/global/aqua.yaml</code> に設定ファイルを記述し、 <code>~/.aqua/global/.aqua/bin</code> を PATH に追加してください。</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$HOME/.aqua/global/.aqua/bin:$PATH</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>そして <code>~/.aqua/global</code> 配下で <code>aqua i</code> を実行すればインストールができます。
<code>~/.aqua/global</code> を Git で管理して GitHub などでホスティングするのも良いでしょう。</p><p><a href="https://github.com/suzuki-shunsuke/my-aqua-config" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/my-aqua-config</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="akoi-との違い">akoi との違い<a href="#akoi-との違い" class="hash-link" aria-label="Direct link to akoi との違い" title="Direct link to akoi との違い">​</a></h2><p>ところで、自分は aqua に似たツールとして <a href="http://github.com/suzuki-shunsuke/akoi" target="_blank" rel="noopener noreferrer">akoi</a> というツールを公開していて、自分もこれまでこのツールを使ってきました。
aqua と akoi は「CLI ツールのバージョン管理」という目的・ゴールは同じです。
akoi も結構便利なツールですが、 akoi が抱える様々な課題を解決するために aqua を開発しています。
aqua は akoi のいわば後継ツールです。
ただしコードは全く別物ですし、互換性もありません。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="akoi-と比べた-aqua-の良い点">akoi と比べた aqua の良い点<a href="#akoi-と比べた-aqua-の良い点" class="hash-link" aria-label="Direct link to akoi と比べた aqua の良い点" title="Direct link to akoi と比べた aqua の良い点">​</a></h3><ul><li>GitHub Access Token を使ったインストールをサポート<ul><li>private repository をサポート</li><li>akoi は anonymous なアクセスなので rate limit に引っかかりやすい</li></ul></li><li>管理対象のコマンド実行時にツールのインストールが可能</li><li>設定ファイルを更新したあとに install コマンドを実行する必要がない<ul><li>akoi は symbolic link を作り直すために install コマンドを実行する必要がある</li></ul></li><li>管理対象のツールの実体を共有できる<ul><li>project ごとにツールを install する必要がない(計算資源の効率化)</li><li>akoi と違って ツールによって実体のインストール先は一意に決まるので、干渉することがなく安全に共有できる</li></ul></li><li>事前に archive の中のパスを知っている必要がない<ul><li>akoi は install 時に archive を展開してファイルをコピーし、シンボリックリンクを作成する<ul><li>パスが間違っていると失敗し、 download からやり直しになる</li><li>そのため、新しいツールを akoi で管理する場合はまず archive の構造を調べる必要がある</li></ul></li><li>aqua は install したあとに ~/.aqua 配下を見て file.src を修正すれば良いし、間違っててコマンドの実行に失敗しても download のやり直しとかはない</li></ul></li><li><code>bin_path</code>, <code>link_path</code> ような設定について考えなくて良い<ul><li>akoi は設定ファイルでインストール先などを設定できるようになっている</li><li>どう設定すべきか悩ましいし、リポジトリによって設定が違ったりして設定を統一するのが難しい</li><li>aqua はインストール先などが設定できないのでユーザーが迷う必要がない</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="管理対象のツールの実体を共有できる">管理対象のツールの実体を共有できる<a href="#管理対象のツールの実体を共有できる" class="hash-link" aria-label="Direct link to 管理対象のツールの実体を共有できる" title="Direct link to 管理対象のツールの実体を共有できる">​</a></h4><p>aqua はツールの実体を AQUA_ROOT_DIR <code>~/.aqua</code> にインストールし、共有することができます。
複数のリポジトリで同じバージョンの同じツールを使う場合に共有できるので、
インストールにかかる時間を短縮できますし、無駄にディスク容量を消費することもありません。
設定ファイルによって動的にバージョンを取得するので、共有していてもリポジトリごとに異なるバージョンを使うこともできます。</p><p>安全に共有できるようにツールの実体のインストール先はダウンロード元によってユニークかつ一意に決まるようになっています。
ユーザーがカスタマイズすることはできません(ルートディレクトリは変えられますが、ルート以下は変えられません)。</p><p>例えば OSX で jq-1.6 のインストール先は以下になります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/pkgs/github_release/github.com/stedolan/jq/jq-1.6/jq-osx-amd64/jq-osx-amd64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このように GitHub Release からインストールする場合</p><ul><li>リポジトリのオーナー</li><li>リポジトリ名</li><li>tag</li><li>GitHub Release のアセット名</li></ul><p>などから一意に決まるため、あるリポジトリでは jq をフォークしたものを使うといった場合でも安全に共存することができます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="便利な---only-link-option">便利な <code>--only-link</code> option<a href="#便利な---only-link-option" class="hash-link" aria-label="Direct link to 便利な---only-link-option" title="Direct link to 便利な---only-link-option">​</a></h2><p><code>aqua install</code> を実行するとツールごとに以下のことが実行されます。</p><ol><li><code>.aqua/bin</code> 配下にシンボリックリンクを作成</li><li>ダウンロード</li><li>tarball などの展開</li><li>~/.aqua 配下にインストール</li></ol><p>aqua.yaml の packages に大量のツールが定義されていると、
大量のツールが一度にインストールされることになり、
並列で実行されるとはいえ、都合が悪いこともあるでしょう。</p><p><code>--only-link</code> option をつけて実行すると、シンボリックリンクだけ作成しダウンロードなどは行わないので直ぐに終わります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua install --only-link</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>その状態でツールを実行すると、ツールが自動でインストールされてから実行されるので
本当に必要になってからインストールすることが可能であり、余計なインストールが発生しないので便利です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="コマンド実行時の自動インストール動的なバージョン切り替えの仕組み">コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み<a href="#コマンド実行時の自動インストール動的なバージョン切り替えの仕組み" class="hash-link" aria-label="Direct link to コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み" title="Direct link to コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み">​</a></h2><p>aqua は設定ファイルを更新すると <code>aqua install</code> 実行をしなくても更新が反映される、
ツールがまだインストールされていなくてもツールを実行時に自動でインストールされるという機能があります。</p><p>tfenv も .terraform-version を更新すればすぐ反映されますし、
terraform コマンドを実行時にまだ指定したバージョンがインストールされてなかったら自動でインストールされますが、それに似ていますね
(ただし tfenv の機能がどう実装されているかは調べてませんし、 aqua を実装する上で参考にしたりはしていません)。</p><p>上記の機能が aqua でどう実現されているか簡単に説明します。</p><p>例えば aqua で jq をインストールし、 <code>jq -h</code> を実行したとしましょう。
jq を実行すると aqua-proxy を経由して <code>aqua exec -- jq -h</code> が実行されます。
この辺の詳細は <a href="#aqua-proxy-%E3%81%A8%E3%81%AF">aqua-proxy とは</a> を参照してください。
<code>aqua exec</code> は aqua の設定ファイルで指定されたバージョンがインストールされているかチェックし、まだインストールされていなかったらインストールし、コマンド <code>jq -h</code> を実行します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aqua-proxy-とは">aqua-proxy とは<a href="#aqua-proxy-とは" class="hash-link" aria-label="Direct link to aqua-proxy とは" title="Direct link to aqua-proxy とは">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/aqua-proxy" target="_blank" rel="noopener noreferrer">aqua-proxy</a> は aqua が内部的に依存しているツールです。
コマンド実行時に aqua 及び aqua で管理するツールのバージョンを動的に変更するために作られました。
aqua のために開発されており、 aqua 以外で使われることは想定していません。</p><p>aqua-proxy は <code>aqua install</code> や <code>aqua exec</code> を実行した際に自動で <code>~/.aqua/bin/aqua-proxy</code> にインストールされます。
aqua はツールをインストールする際に <code>.aqua/bin/&lt;ツール&gt;</code> から <code>~/.aqua/bin/aqua-proxy</code> へのシンボリックリンクを作成するので、 <code>&lt;ツール&gt;</code> を実行すると <code>~/.aqua/bin/aqua-proxy</code> が呼ばれます。</p><p>aqua-proxy は <a href="https://pkg.go.dev/os#Args" target="_blank" rel="noopener noreferrer">os#Args</a> からツール名を取得し、
<code>aqua exec -- &lt;ツール名&gt; ...</code> を実行します。
これによりコマンド実行時に aqua 及び <code>&lt;ツール&gt;</code> のバージョンを動的に変更することを実現しています。</p><p><code>.aqua/bin/&lt;ツール&gt;</code> から aqua-proxy へのシンボリックリンクは静的であり、 aqua-proxy のバージョンを切り替えることは難しいです。
aqua-proxy の機能・責務が大きくなると aqua-proxy のバージョン管理や aqua との互換性を考えなくてはならなくなります。
aqua-proxy のバージョンをほぼ気にしなくて良いよう、 aqua-proxy は最小限の機能・責務しか持たず、安定的であまり変更されないように設計されています。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="プロセスツリーを確認してみる">プロセスツリーを確認してみる<a href="#プロセスツリーを確認してみる" class="hash-link" aria-label="Direct link to プロセスツリーを確認してみる" title="Direct link to プロセスツリーを確認してみる">​</a></h2><p>既に説明したとおり <code>&lt;ツール&gt;</code> を実行した際には実はプロセスツリー的には
<code>aqua-proxy =&gt; aqua =&gt; &lt;ツール&gt;</code> という風になっています。</p><p><code>&lt;ツール&gt;</code> を直接実行した場合と挙動に違いが出ないように以下のようなことに気を配っています。</p><ul><li>SIGINT, SIGTERM などのシグナルが適切に <code>&lt;ツール&gt;</code> のプロセスまで伝達されるようにする</li><li><code>&lt;ツール&gt;</code> の exit code が伝達されるようにする</li></ul><p>試しに fzf を実行してみて別のターミナルでプロセスツリーを確認してみます。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls | fzf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>fzf が起動しますが、そのままにしておいて別のターミナルでプロセスツリーを確認してみます。
Mac の <code>pstree</code> を使っています。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-+- 83548 foo fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> \-+- 83549 foo aqua exec -- fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   \--- 83550 foo /Users/foo/.aqua/pkgs/github_release/github.com/junegunn/fzf/0.27.2/fzf-0.27.2-darwin_amd64.zip/fzf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>紛らわしいのですが、最初のプロセスの実体は fzf ではなくて aqua-proxy です。 fzf が aqua-proxy へのシンボリックになっているのでこうなっています。
ここで aqua-proxy に SIGTERM を送ると手元の Mac ではちゃんと子プロセスまで終了しました。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kill 83548</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>この辺のシグナルハンドリングは Windows だと正常に動かないかもしれません。</p><p><a href="https://pkg.go.dev/os#Signal" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/os#Signal</a></p><blockquote><p>The only signal values guaranteed to be present in the os package on all systems are os.Interrupt (send the process an interrupt) and os.Kill (force the process to exit).
On Windows, sending os.Interrupt to a process with os.Process.Signal is not implemented;
it will return an error instead of sending a signal.</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/oss">oss</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aqua">aqua</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="GitHub Repository の CI に CodeBuild を使う場合、 CodeBuild の Webhook integration (以下 CodeBuild GitHub integration と呼ぶことにします) を使うのが一番自然でしょう。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/github-app-for-codebuild">AWS CodeBuild を実行する Github App を作る</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-08-16T00:10:51.000Z" itemprop="datePublished">August 16, 2021</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>GitHub Repository の CI に CodeBuild を使う場合、 <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/github-webhook.html" target="_blank" rel="noopener noreferrer">CodeBuild の Webhook integration</a> (以下 <code>CodeBuild GitHub integration</code> と呼ぶことにします) を使うのが一番自然でしょう。
基本的なユースケースならこれでよいのですが、 GitHub App を活用することでより高度な CI を実現することができます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="解決したい課題">解決したい課題<a href="#解決したい課題" class="hash-link" aria-label="Direct link to 解決したい課題" title="Direct link to 解決したい課題">​</a></h2><ul><li>Batch Build の課題<ul><li>起動・終了が遅い</li><li>全 build が成功した Batch Build を Retry できない</li><li>Web UI がわかりにくい<ul><li>余計な build が起動する</li><li>build 単体を Retry できない</li></ul></li><li>build ごとに条件設定とかできない</li><li>buildspec を動的に生成できない</li></ul></li><li><code>CodeBuild GitHub integration</code> の課題<ul><li>Build Project ごとに Repository Webhook が 1 つ作られる<ul><li><a href="https://docs.github.com/en/developers/webhooks-and-events/webhooks/about-webhooks" target="_blank" rel="noopener noreferrer">webhook 1 repository あたり 20 個までしか作れない</a></li><li>(これを裏付ける客観的なソースはないですが) webhook の数が増えると build の動作が不安定になるのを観測しています</li></ul></li><li>Filter の条件が限られている(例えば PR label で filter とかできない)</li><li>複数の build を実行できない(Batch Build も 1 つとみなした場合の話)</li></ul></li><li>CodeBuild の課題<ul><li>Retry した場合 webhook で起動したときの環境変数が設定されない</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-app">GitHub App<a href="#github-app" class="hash-link" aria-label="Direct link to GitHub App" title="Direct link to GitHub App">​</a></h2><p>Amazon API Gateway と Lambda を使って GitHub App を構築します。
Lambda で webhook を受け取り、 AWS SDK を使って build を実行します。</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/13323303/129534257-391da6ac-9690-46df-b6df-53605d3c0c6a.png" alt="codebuilder-architecture" class="img_ev3q"></p><p>GitHub App を作成し、 Webhook URL として API Gateway の endpoint を指定します。
internet facing な API Gateway は Repository ごとに作るのではなく、共有で 1 つ作るようにしたほうが良いかと思います。
Lambda は Repository ごとに分けたほうが権限を絞れるし、 Function がシンプルになるし、あるリポジトリのための変更が他のリポジトリに影響することがないので良いでしょう。</p><p>Batch Build を使う代わりに Build を複数並列で起動することで、 Batch Build の課題を解決できます。
実行時に<a href="https://docs.aws.amazon.com/sdk-for-go/api/service/codebuild/#CodeBuild.StartBuildWithContext" target="_blank" rel="noopener noreferrer">パラメータ</a>を変えることもできます。
Webhook の Payload も参照できるので、 Payload から得たデータ(PR 番号、 label、PR Author 名、 etc)を環境変数として build にわたすこともできます。</p><p>従来は build 内で GitHub API を使って取得していた PR の情報を環境変数として渡せることで
build の処理が簡略化されますし、 GitHub API の call 数を減らすこともできます(これは API の rate limit が問題になる場合に重要です)。</p><p>PR label による build のフィルタリングなど、 <code>CodeBuild GitHub integration</code> では難しいより複雑な filter も実現できます。</p><p>GitHub App であれば Repository Webhook が作られることもありませんし、 Build Project ごとに webhook の設定をする必要もありません。</p><p>Assume Role することで別の AWS Account の Build Project の build を実行することもできます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="merged-event-で-merged-commit-sha-で-build-を実行">merged event で merged commit sha で build を実行<a href="#merged-event-で-merged-commit-sha-で-build-を実行" class="hash-link" aria-label="Direct link to merged event で merged commit sha で build を実行" title="Direct link to merged event で merged commit sha で build を実行">​</a></h2><p>PR がマージされたら merged commit の SHA で CI を実行したい場合、 push event を hook するのがおそらく一般的かと思います。</p><p><code>CodeBuild GitHub integration</code> では <code>merged</code> event を hook することもできますが、
この場合 PR の head branch の SHA で build が実行されてしまいますし、 base branch の commit status が更新されません。</p><p>しかし <code>push</code> event では関連する PR の情報が取れない(build の環境変数として PR の情報が渡されない)という問題があります。
<a href="https://docs.github.com/en/rest/reference/repos#list-pull-requests-associated-with-a-commit" target="_blank" rel="noopener noreferrer">GitHub API でコミットと関連した PR の一覧が取れます</a>が、複数の PR と関連づいている場合、どの PR なのか特定することができません(特定の条件付きであればできますが)。</p><p>そこで GitHub App で <code>merged</code> event (正確には <code>closed</code> event で PR がマージ済の場合) を hook しつつ、
build 起動時に source version として merged commit sha を指定することで
webhook から PR の情報を取得しつつ merged commit の SHA で CI を実行できます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-の-personal-access-token-の代わりに-github-app-installation-access-token-を使う">GitHub の Personal Access Token の代わりに GitHub App installation access token を使う<a href="#github-の-personal-access-token-の代わりに-github-app-installation-access-token-を使う" class="hash-link" aria-label="Direct link to GitHub の Personal Access Token の代わりに GitHub App installation access token を使う" title="Direct link to GitHub の Personal Access Token の代わりに GitHub App installation access token を使う">​</a></h2><p>CodeBuild の build 内で GitHub API を使いたい場合、 Personal Access Token を発行するのがシンプルですが、 Personal Access Token にはいくつか課題があります。</p><ul><li>token 流出のリスク<ul><li>rotation が難しいので有効期限が設定されてない場合が多い</li></ul></li><li>rate limit<ul><li>token が organization で広く共有されたりするようになると問題になりやすい</li><li>rate limit は account 単位なので、同じ account の token を別に作っても意味がない</li><li>account を増やして org に追加すると、 org のメンバーが増えるのでお金がかかる(まぁ金額的に無視してもよいかもしれませんが)</li></ul></li></ul><p>GitHub App では rotation などを考えなくても一時的な token を発行できるので、セキュリティ的にリスクが低いですし、
GitHub App を作ってもお金はかかりません。
token を発行するには</p><ul><li>App ID</li><li>Installation ID (webhook の payload に含まれている)</li><li>Private key</li></ul><p>が必要で、 build 実行時に installation id を環境変数として渡すことで Lambda だけでなく Codebuild でも installation access token が使えます。</p><p>もちろん GitHub App を使っても rate limit に引っかかることはありますが、 Personal Access Token に比べて回避しやすいかとは思います。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lambda-から-repository-のコードを参照する">Lambda から Repository のコードを参照する<a href="#lambda-から-repository-のコードを参照する" class="hash-link" aria-label="Direct link to Lambda から Repository のコードを参照する" title="Direct link to Lambda から Repository のコードを参照する">​</a></h2><p><a href="https://blog.studysapuri.jp/entry/2020/12/03/080000" target="_blank" rel="noopener noreferrer">https://blog.studysapuri.jp/entry/2020/12/03/080000</a> では CodeBuild でリポジトリのコードを checkout し、
build の中で動的に buildspec を生成して batch build を実行しています。</p><p>同じようなことを Lambda でやろうとした場合、色々制約があります。
Lambda ではリポジトリを checkout してくる代わりに、 build を実行するのに必要な情報を静的に生成してリポジトリにコミットしておきそれを GitHub API で取得するというやり方があります。
その場合、ファイルを生成するコマンドをリポジトリに用意しておき、 ちゃんとファイルが最新になっているか CI の中でチェックし、
なっていなければ CI を fail させるか自動で更新してコミットするというのをやるのが良さそうです。
Git の pre-push hook などで check するのもありかもしれません。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-app-の開発をいかに楽にするか">GitHub App の開発をいかに楽にするか<a href="#github-app-の開発をいかに楽にするか" class="hash-link" aria-label="Direct link to GitHub App の開発をいかに楽にするか" title="Direct link to GitHub App の開発をいかに楽にするか">​</a></h2><p>ようは webhook を受け取って build を実行する Lambda Function を実装すればいいだけなのですが、
毎回 0 からコードを書くのはちょっとした手間なので、 Go の簡単な library を作っています。</p><p><a href="https://github.com/suzuki-shunsuke/go-github-app-for-aws-codebuild" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-github-app-for-aws-codebuild</a></p><p>このライブラリ自体は大したものではないので、皆さんのユースケースや言語に合わせて独自に作っても良いでしょう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル">サンプル<a href="#サンプル" class="hash-link" aria-label="Direct link to サンプル" title="Direct link to サンプル">​</a></h2><p>簡単なサンプルも書いています。</p><p><a href="https://github.com/suzuki-shunsuke/example-github-app-for-aws-codebuild" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-github-app-for-aws-codebuild</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aws">aws</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/codebuild">codebuild</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/github-app">github-app</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="今まで仕事に限定して書いてきましたが、 OSS 活動なんかにも触れてもいいんじゃないかと思ったので分かる範囲で書きます。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/what-i-did-2021-07">2021-07 やったこと</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-27T21:58:45.000Z" itemprop="datePublished">July 27, 2021</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>今まで仕事に限定して書いてきましたが、 OSS 活動なんかにも触れてもいいんじゃないかと思ったので分かる範囲で書きます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="仕事">仕事<a href="#仕事" class="hash-link" aria-label="Direct link to 仕事" title="Direct link to 仕事">​</a></h2><ul><li>Docker Image を Docker Hub から ECR へ移行</li><li>Terraform<ul><li>.terraform.lock.hcl を CI の中で自動で更新(commit, push)できるようにした<ul><li>Terraform に詳しくない人も使うので、自動化したほうが良いと判断</li></ul></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a> を CI に導入</li><li>(in progress) Terraform Modules を Terraform の Monorepo とは別リポジトリで管理して versioning するようにした</li><li>Route53 の管理を <a href="https://github.com/codenize-tools/roadworker" target="_blank" rel="noopener noreferrer">Roadworker</a> から Terraform へ移行</li><li>tfmigrate を使ったリファクタリング</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="event">Event<a href="#event" class="hash-link" aria-label="Direct link to Event" title="Direct link to Event">​</a></h2><ul><li><a href="https://mercari.connpass.com/event/211073/" target="_blank" rel="noopener noreferrer">Open Policy Agent Rego Knowledge Sharing Meetup</a> で登壇<ul><li><a href="https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e" target="_blank" rel="noopener noreferrer">https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="oss-contribution">OSS Contribution<a href="#oss-contribution" class="hash-link" aria-label="Direct link to OSS Contribution" title="Direct link to OSS Contribution">​</a></h2><p>AWS AppConfig を Terraform で管理できるようにする PR が無事マージされました。</p><ul><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/20172" target="_blank" rel="noopener noreferrer">feat: add aws_appconfig_deployment</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/20176" target="_blank" rel="noopener noreferrer">fix: add the attribute &quot;environment_id&quot; to aws_appconfig_environment</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19359" target="_blank" rel="noopener noreferrer">feat: support AppConfig Deployment Strategy</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19324" target="_blank" rel="noopener noreferrer">feat: support AppConfig Hosted Configuration Version</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19320" target="_blank" rel="noopener noreferrer">feat: add appconfig_configuration_profile</a></li><li><a href="https://github.com/hashicorp/terraform-provider-aws/pull/19307" target="_blank" rel="noopener noreferrer">feat: add aws_appconfig_application and aws_appconfig_environment</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新たに作った-oss">新たに作った OSS<a href="#新たに作った-oss" class="hash-link" aria-label="Direct link to 新たに作った OSS" title="Direct link to 新たに作った OSS">​</a></h2><ul><li><a href="https://github.com/tfmigrator/cli" target="_blank" rel="noopener noreferrer">tfmigrator/cli</a>: CLI to Migrate Terraform Configuration and State with terraform state command and hcledit</li><li><a href="https://github.com/suzuki-shunsuke/renovate-github-tags-datasource-repositories" target="_blank" rel="noopener noreferrer">Renovate github-tags Datasource Repositories</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tfmigrator">tfmigrator<a href="#tfmigrator" class="hash-link" aria-label="Direct link to tfmigrator" title="Direct link to tfmigrator">​</a></h3><p>Terraform Configuration と State をマイグレーションする tfmigrator の CLI をリリースしました。
tfmigrator には紆余曲折有り(?)、時系列的に</p><ul><li><a href="https://github.com/suzuki-shunsuke/tfmigrator" target="_blank" rel="noopener noreferrer">suzuki-shunsuke/tfmigrator</a> を開発。 CLI</li><li>YAML の設定ファイルの表現力に限界を感じ、 suzuki-shunsuke/tfmigrator をフォークして Go のライブラリ <a href="https://github.com/tfmigrator/tfmigrator" target="_blank" rel="noopener noreferrer">tfmigrator/tfmigrator</a> を開発<ul><li>簡単に CLI を実装できるように API も提供</li><li>ついでに色々改良<ul><li><a href="https://github.com/minamijoyo/hcledit" target="_blank" rel="noopener noreferrer">hcledit</a> のインストールが不要</li><li>ファイルの in place の更新をサポート</li><li>dry run のサポート</li><li>複数のリソースをまとめて扱えるような API も提供 <a href="https://pkg.go.dev/github.com/tfmigrator/tfmigrator@v0.5.1/tfmigrator#QuickRunBatch" target="_blank" rel="noopener noreferrer">QuickRunBatch</a></li><li>etc</li></ul></li></ul></li><li>実際に tfmigrator/tfmigrator を使ってみると Go を書くのがちょっと面倒くさい<ul><li>そもそも複雑な rule を一度に適用しようとするのが間違っていると感じた</li></ul></li><li>tfmigrator/tfmigrator を使い、 CLI も実装 tfmigrator/cli<ul><li>やはり基本的なユースケースでは YAML 書くほうが楽</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="renovate-github-tags-datasource-repositories">Renovate github-tags Datasource Repositories<a href="#renovate-github-tags-datasource-repositories" class="hash-link" aria-label="Direct link to Renovate github-tags Datasource Repositories" title="Direct link to Renovate github-tags Datasource Repositories">​</a></h3><p>Renovate の Datasource や Manager でサポートされていない package を Renovate で update するために、
package ように GitHub Repository を作って package のバージョンに合わせて GitHub tag を更新し、
<code>github-tags</code> Datasource として使おうというプロジェクトです。
現状 AWS RDS や AWS Elasticache の engine version 用のリポジトリを作っています。
tag は GitHub Actions を毎日定期実行することで更新します。
詳細はリポジトリの README でも読んでください。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新しいバージョンをリリースした-oss">新しいバージョンをリリースした OSS<a href="#新しいバージョンをリリースした-oss" class="hash-link" aria-label="Direct link to 新しいバージョンをリリースした OSS" title="Direct link to 新しいバージョンをリリースした OSS">​</a></h2><ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a><ul><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases/tag/v2.0.0-0" target="_blank" rel="noopener noreferrer">v2.0.0-0</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt/releases/tag/v1.1.0" target="_blank" rel="noopener noreferrer">v1.1.0</a><ul><li><a href="https://twitter.com/szkdash/status/1416263752475836416" target="_blank" rel="noopener noreferrer">https://twitter.com/szkdash/status/1416263752475836416</a></li></ul></li></ul></li></ul><p>terraform v0.15.4 から Terraform 以外での変更も plan に出力されるようになって
わかりにくいと感じたので、 tfcmt でテンプレート変数追加して見やすくできるようにしました。
Refreshing state のログを除外したり、warning 目立たせたりもできて便利です。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="blog">Blog<a href="#blog" class="hash-link" aria-label="Direct link to Blog" title="Direct link to Blog">​</a></h2><ul><li><a href="https://techblog.szksh.cloud/archives/2021/07/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/archives/2021/07/</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/job">job</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/oss">oss</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="* GCP を Terraform で管理するための developer support"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2021/06/01/job-06-30">仕事でやったこと 2021-06-01 ~ 2021-06-30</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-12T20:47:11.000Z" itemprop="datePublished">July 12, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>GCP を Terraform で管理するための developer support</li><li>miam を Terraform に移行</li><li>Docker Hub から ECR への移行</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/job">job</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="OPA で Table Driven Tests っぽく Policy を Test する方法について考えたので紹介します。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/opa-table-driven-test">OPA で Table Driven Tests っぽいことをしてみる</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-09T10:38:55.000Z" itemprop="datePublished">July 9, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>OPA で Table Driven Tests っぽく Policy を Test する方法について考えたので紹介します。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="Direct link to 背景" title="Direct link to 背景">​</a></h2><p>先日 <a href="https://mercari.connpass.com/event/211073/" target="_blank" rel="noopener noreferrer">Open Policy Agent Rego Knowledge Sharing Meetup</a> で発表する機会を頂きました。
発表の資料は<a href="https://gist.github.com/suzuki-shunsuke/9372337aa62a6f8394bb136582ec068e" target="_blank" rel="noopener noreferrer">こちら</a>。
普段他社の事例を聞いたり OPA について話たりする機会がないので、非常に貴重な時間になりました。</p><p>その中で <a href="https://twitter.com/deeeet" target="_blank" rel="noopener noreferrer">deeeet</a> さんが <a href="https://github.com/golang/go/wiki/TableDrivenTests" target="_blank" rel="noopener noreferrer">Table Driven Tests</a> っぽくテストしたいというようなことをおっしゃっていました。</p><p>だいたいこの辺: <a href="https://youtu.be/0YpJhrz6L0A?t=2990" target="_blank" rel="noopener noreferrer">https://youtu.be/0YpJhrz6L0A?t=2990</a></p><p>その話を受けて改めて自分で考えてみたところ、できなくはないんじゃないかなという気がしたのでちょっとやってみることにしました。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="サンプル">サンプル<a href="#サンプル" class="hash-link" aria-label="Direct link to サンプル" title="Direct link to サンプル">​</a></h2><p>せっかくなので簡単なサンプルを GitHub に用意しました。</p><p><a href="https://github.com/suzuki-shunsuke/example-opa-table-driven-tests" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-opa-table-driven-tests</a></p><p>今回は aws_cloud_watch_log_group の retention_in_days が設定されていることをチェックする Rule の Test をします。</p><ul><li>Rule: <a href="https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days.rego" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days.rego</a></li><li>Policy Test: <a href="https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days_test.rego" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example-opa-table-driven-tests/blob/main/policy/cloudwatch_log_retention_in_days_test.rego</a></li></ul><p>テストケースを <code>seeds</code> という list で定義し、どれか一つでも false だったら fail するようにしています。
テストケースの中身は</p><ul><li>msg: テストケースを示すメッセージ。テストが失敗したときの trace に含める</li><li>resource: rule の input</li><li>exp: rule の評価結果の期待値</li></ul><p>になっています。</p><p>test の中身は別の rule を否定しているだけになっていますね。</p><div class="language-rego codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rego codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test_deny_aws_cloudwatch_log_grop_retention_in_days {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    not any_deny_aws_cloudwatch_log_grop_retention_in_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>この書き方は <a href="https://www.openpolicyagent.org/docs/latest/policy-language/#universal-quantification-for-all" target="_blank" rel="noopener noreferrer">Universal Quantification (FOR ALL)</a> で説明されています。</p><p>Set の比較は <code>!=</code>, <code>==</code> で大丈夫です。 <a href="https://www.openpolicyagent.org/docs/latest/policy-language/#sets" target="_blank" rel="noopener noreferrer">https://www.openpolicyagent.org/docs/latest/policy-language/#sets</a></p><div class="language-rego codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rego codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    result != seed.exp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>test に失敗した場合に、どのテストケースでなぜ失敗したのかわかりやすいように必要な情報を trace で出力するようにしています。</p><div class="language-rego codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rego codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    trace(sprintf(&quot;FAIL %s (%d): %s, wanted %v, got %v&quot;, [&quot;test_deny_aws_cloudwatch_log_grop_retention_in_days&quot;, i, seed.msg, seed.exp, result]))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Conftest の場合、 <code>--trace</code> をつけると出力されます。 <code>Note</code> で grep するとわかりやすいです。</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ conftest verify --trace | grep Note</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TRAC   | | | | Note &quot;FAIL test_deny_aws_cloudwatch_log_grop_retention_in_days (1): retention_in_days should be greater than 0, wanted {\&quot;aws_cloudwatch_log_group.main: retention_in_days should be set and greater than 0\&quot;}, got set()&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上、簡単ですが Rego で Table Driven Tests っぽく test を書く方法を紹介しました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/opa">opa</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/conftest">conftest</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/rego">rego</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Terraform で空の AWS Lambda Function を作ろうとした際にちょっとハマったのでやり方を書いておきます。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/create-empty-lambda-by-terraform">Terraform で空の AWS Lambda Function を作る方法</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-24T12:25:24.000Z" itemprop="datePublished">June 24, 2021</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Terraform で空の AWS Lambda Function を作ろうとした際にちょっとハマったのでやり方を書いておきます。</p><p>「空の Lambda Function」という表現は適切ではないかもしれませんが、
Lambda で実行するコードのデプロイは Terraform 以外のツールでやるけど、
Lambda Function の作成は Terraform で行うので、 dummy のコードを指定して Terraform で Lambda を作るという話です。</p><p>自分は今は <a href="https://github.com/fujiwara/lambroll" target="_blank" rel="noopener noreferrer">lambroll</a> というツールで Lambda をデプロイしています。
lambroll は Lambda Function も作ってくれるので Terraform で作る必要は必ずしもありません。</p><p>しかし Lambda Function に関連するリソースを Terraform で管理する場合、
Lambda Function も Terraform で作ると Lambda Function の ARN や Invoke ARN を参照できます。</p><p>また lambroll でデプロイする場合も先に Terraform で IAM Role を作成する必要がありますが、
Terraform で aws_lambda_permission のようなリソースを作成するには Lambda Function が先に作られている必要があるので、
互いに依存関係が発生し、面倒なことになります。</p><p>また Lambda Function の削除も Terraform でできるようになります。</p><p>なので、 Terraform で Lambda Function を作っておいたほうが色々都合が良いです。</p><p>Terraform で作成と削除は行うものの、更新をしたいわけではないので、 <code>ignore_changes = all</code> を指定します。</p><p><a href="https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes</a></p><p>Lambda Function を Web UI などから作る場合 Function code はなくても大丈夫ですが、
Terraform で Lambda Function を作る場合、 <code>filename</code> や <code>image_uri</code>, <code>s3_bucket</code> のいずれかが必須になります。
これは issue もありますが、仕様のようにみえます。</p><p><a href="https://github.com/hashicorp/terraform-provider-aws/issues/5945" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-aws/issues/5945</a></p><p>ECR や S3 に dummy のコードを用意するというのも一つの手ですが、環境に依存するのがあまり良い気がしないので、
archive_file data source を使って dummy の zip ファイルを生成するという方法を取ることにしました。</p><p><a href="https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file</a></p><p>次のようなコードで CI で terraform apply を実行しましたが、 zip file がないと言われて失敗しました。</p><div class="language-tf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_lambda_function&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://www.terraform.io/docs/language/meta-arguments/lifecycle.html#ignore_changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Terraform can create and destroy the remote object but will never propose updates to it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_changes = all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function_name = &quot;foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role          = aws_iam_role.main.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handler  = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runtime  = &quot;provided.al2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename = data.archive_file.dummy.output_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;archive_file&quot; &quot;dummy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = &quot;zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_path = &quot;${path.module}/dummy.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content  = &quot;dummy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error: unable to load &quot;lambda-base/dummy.zip&quot;: open lambda-base/dummy.zip: no such file or directory</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>しかしローカルで terraform plan, apply を実行してみても再現しませんでした。</p><p>CI では Pull Request で plan file を生成して S3 に plan file を upload し、 PR をマージした default branch では terraform plan を実行せずに S3 から plan file をダウンロードして terraform apply を実行しています。</p><p><a href="https://blog.studysapuri.jp/entry/2021/03/10/080000" target="_blank" rel="noopener noreferrer">Pull Request の terraform plan の実行結果を S3 に保存して安全に apply | Quipper Product Team Blog</a></p><p>plan file を指定して terraform apply を実行した際には zip file が作成されず、上記のエラーが発生することがわかりました。</p><p>関連する issue もありました。 <a href="https://github.com/hashicorp/terraform-provider-archive/issues/39" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-archive/issues/39</a></p><p>この issue では幾つかの解決方法が紹介されています。ちなみに 2021-06-24 現在 Hashicorp 側からは特に反応がないように見えます。
random_uuid や random_string を使った方法もありますが、 Lambda を作成するだけなら null_resource に依存させるだけで十分のように思えました。</p><div class="language-tf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;archive_file&quot; &quot;dummy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = &quot;zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output_path = &quot;${path.module}/dummy.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content  = &quot;dummy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename = &quot;bootstrap&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    null_resource.main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;null_resource&quot; &quot;main&quot; {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このように null_resource に依存させると terraform plan では zip file が作られず、 terraform apply ではじめて zip file が作られるため、
terraform apply が失敗することはなくなりました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/terraform">terraform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/lambda">lambda</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="* SRE チームの新メンバーのオンボーディングのサポート"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2021/05/01/job-05-31">仕事でやったこと 2021-05-01 ~ 2021-05-31</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-05-29T23:19:32.000Z" itemprop="datePublished">May 29, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>SRE チームの新メンバーのオンボーディングのサポート</li><li>GCP<ul><li>dev からのリクエストに応じて権限付与したり対応</li><li>Terraform による GCP の管理 CI/CD の整備</li><li>Workload Identity Federation について調べた</li><li>Terraform による IAM 管理の仕方を検討</li></ul></li><li>Conftest<ul><li><code>opa fmt</code> によるフォーマット(CI も導入)</li><li>Policy Testing (CI も導入)</li></ul></li><li>Upgrade Terraform to v0.15.4</li><li>miam の Terraform 移行を検証</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/job">job</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="* SRE チームの新メンバーのオンボーディングのサポート"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/2021/04/01/job-04-30">仕事でやったこと 2021-04-01 ~ 2021-04-30</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-04-28T00:28:01.000Z" itemprop="datePublished">April 28, 2021</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">Platform Engineer / OSS Developer / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>SRE チームの新メンバーのオンボーディングのサポート</li><li>Lambda の Monorepo<ul><li>幾つか実際に Function 作った(developer support)</li><li>幾つかの Release Strategy の実装・検証<ul><li>シンプルな GitHub Flow</li><li>Git Flow をアレンジしたリリースフロー</li><li>Canary Release</li><li>WIP: AWS AppConfig を用いた Dark Launch</li></ul></li></ul></li><li>IAM User の初期パスワード送信の自動化</li><li>Terraform<ul><li>Renovate による Terraform の patch update の自動化</li><li>Docker を使ったローカル開発環境の改善</li><li>ローカルで terraform init したら .terraform.lock.hcl が更新される問題の対応 <a href="https://techblog.szksh.cloud/terraform-providers-lock/" target="_blank" rel="noopener noreferrer">https://techblog.szksh.cloud/terraform-providers-lock/</a></li></ul></li><li>GCP の Terraform 管理<ul><li>調査</li><li>WIP</li></ul></li><li>Conftest<ul><li>社内の Rego の活用事例をまとめた</li><li><code>opa fmt</code> によるフォーマット(CI も導入)</li><li>Policy Testing (CI も導入)</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/job">job</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/page/2"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/page/4"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.939a8634.js"></script>
<script src="/assets/js/main.01eb5cf4.js"></script>
</body>
</html>