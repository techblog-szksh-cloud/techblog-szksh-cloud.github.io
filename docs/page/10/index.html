<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">Blog | Melody</title><meta data-rh="true" property="og:title" content="Blog | Melody"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud//page/10"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud//page/10"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud//page/10" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud//page/10" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.aa8dd679.js" as="script">
<link rel="preload" href="/assets/js/main.038f1787.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-10">My Activity in 2022-10</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-09">My Activity in 2022-09</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-08">2022-08 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-07">2022-07 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-06">2022-06 振り返り</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/use-npm">JS以外でのnpmの活用</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-14T12:34:22.000Z" itemprop="datePublished">February 14, 2019</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>npm は Node.js のパッケージマネージャーですが、自分はJS以外のプロジェクトでも使えると思っています。
実際、Goのアプリケーション、OSS、ansible role, playbook など種類を問わず、自分が管理している多くのリポジトリで使っています。
ただ、GoのOSSで npm 使っているのは自分以外で見たことはないですし、
正直あまり賛同はされないかなと思いますが、こういう考え方もあると思っていただけたらと思います。</p><p>npm を使う理由は</p><ul><li>Node製のツールを使うため</li><li>npm scripts を使うため (今回書きたいのはこっち)</li></ul><p>の2つあります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="node製のツール">Node製のツール<a class="hash-link" href="#node製のツール" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/typicode/husky" target="_blank" rel="noopener noreferrer">husky</a>: Git Hookを設定</li><li><a href="https://conventional-changelog.github.io/commitlint/#/" target="_blank" rel="noopener noreferrer">commitlint</a>: commit メッセージのlint</li><li><a href="https://github.com/conventional-changelog/standard-version" target="_blank" rel="noopener noreferrer">standard-version</a>: コミットログによって Change Log を生成</li></ul><p>などを使っています。
Nodeはバージョンの変化が速く、互換性が壊れたりとかも多い印象ですが、
グローバルにインストールしなくてもリポジトリごとに install 出来る(package.jsonで管理できる)のでその点は(特にチーム開発では)良いと思います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="npm-scripts">npm scripts<a class="hash-link" href="#npm-scripts" title="Direct link to heading">​</a></h2><p>npm scripts によってそのリポジトリの開発に使うコマンド群を管理するということを自分はしています。</p><p><a href="https://github.com/suzuki-shunsuke/gomic/blob/v0.5.7/package.json" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/blob/v0.5.7/package.json</a></p><p>なにもツールを使わない場合に比べ、こうすることでチーム全体でコマンドを統一できますし、一連のコマンドをスクリプト化して npm scripts で実行できるようにするなど、自動化も促進されます。</p><p>ごく簡単な自動化の例ですが、tag を打つと同時にソースコード中のバージョン番号を更新するのを <code>npm run tag v1.1.0</code> といったコマンドで出来るようにしています。
こうすることで tag とversionコマンドで出力されるバージョンが違うなんてことを防ぐことが出来ます。</p><p><a href="https://github.com/suzuki-shunsuke/gomic/blob/v0.5.7/scripts/tag.sh" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/gomic/blob/v0.5.7/scripts/tag.sh</a></p><p>また、オプションによって動作が変わるようなコマンドは npm scripts によって実行することでオプションを統一できます。
例えば <code>gofmt</code> は <code>-s</code> オプションの有無で結果が変わります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="make-でいいのでは">Make でいいのでは<a class="hash-link" href="#make-でいいのでは" title="Direct link to heading">​</a></h2><p>npm scripts ではなくて Make のほうがいいんじゃないのという意見もあるかと思います。</p><ul><li>npm が特定の言語のパッケージマネージャーなのに対し、Makeはより汎用的なツールなので、Node以外ではMakeのほうが適切では</li><li>Makeのほうがnpm scriptsより多機能<ul><li>依存関係のあるタスクを管理する場合はMakeのほうが良い</li></ul></li><li>package.jsonはjsonなのでコメントを書けないのが不便</li></ul><p>ただ、Makeよりnpm scriptsのほうが良いと感じている部分が少なからずあります。</p><ul><li>Makeには派生がある(BSD, GNU, etc)</li><li>Makeは複雑すぎる(1冊の本になるくらい)<ul><li>npm scripts は機能が少ない分、とてもシンプル</li></ul></li><li>npm scripts はカレントディレクトリに依存しない(package.jsonがあるディレクトリから実行される)<ul><li>MakeではカレントディレクトリにMakefile がない場合、Makefileのパスを指定する必要がある</li></ul></li><li>Makeは引数が渡しづらい(make FOO=foo みたいに引数名を指定する必要がある)</li></ul><p>そのため、自分は npm scripts を使っています(huskyとかを使うからというのもありますが)。</p><p>それ以外のツールとの比較はしていません。
npm はかなり一般的なツールであり、そのへんのツールよりは導入障壁が低いと思います。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="npm-scripts-の関数エイリアス">npm scripts の関数・エイリアス<a class="hash-link" href="#npm-scripts-の関数エイリアス" title="Direct link to heading">​</a></h2><p>npm scripts をよく使う場合、関数やエイリアスを設定すると便利です。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">nx() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  npm --silent run $1 -- ${@:2}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alias npm=&quot;npm --silent&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>--silent</code> オプションは、ログレベルの設定です。 <a href="https://docs.npmjs.com/misc/config#loglevel" target="_blank" rel="noopener noreferrer">https://docs.npmjs.com/misc/config#loglevel</a>
ログレベルを特に指定しないと、Nodeに関するログも出力されてしまい、見通しが悪くなります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ /usr/local/bin/npm run vet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; @ vet /Users/suzuki-shunsuke/repos/src/github.com/suzuki-shunsuke/gomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; go vet ./...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com/suzuki-shunsuke/gomic/internal/usecase/gencmd/output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/usecase/gencmd/output/output.go:9:14: undefined: imports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! code ELIFECYCLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! errno 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! @ vet: `go vet ./...`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! Exit status 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! Failed at the @ vet script.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! This is probably not a problem with npm. There is likely additional logging output above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR! A complete log of this run can be found in:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm ERR!     /Users/suzuki-shunsuke/.npm/_logs/2019-02-14T22_44_50_065Z-debug.log</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>--silent</code> をつけるとすっきりします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ /usr/local/bin/npm --silent run vet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com/suzuki-shunsuke/gomic/internal/usecase/gencmd/output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/usecase/gencmd/output/output.go:9:14: undefined: imports</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ただこのオプションつけると、npm scripts で間違ったコマンドを指定してもなんのエラーも出力してくれなくなるので注意してください。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/npm">npm</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-good-point">Go の好きなところ</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-10T08:49:58.000Z" itemprop="datePublished">February 10, 2019</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>自分は 2017/8頃(曖昧)からメインで書く言語を Python から Go に変更しました。
Goを書き始めて割と早い段階でGoが一番好きになりました。
そこでなんで Go が好きなのかということを頑張って言語化しようと思います。</p><p>若干他の言語と比較する部分もありますが、決して他の言語をディスったり、
他の言語より優れているということが言いたいわけではないのでご了承ください。</p><ul><li>依存するものが小さく、バイナリ1つインストールするだけで良い<ul><li>Prometheus の exporter とかインストールするの簡単</li><li>Docker Imageも最小限になる</li></ul></li><li>静的型付け<ul><li>ビルド出来ている時点で一定の信頼性が担保されている</li><li>よく知らないコードを読んだり修正するときとかだいぶ有り難い</li></ul></li><li>GoDocが素晴らしい<ul><li>何もしなくてもライブラリのドキュメントが出来上がっている</li></ul></li><li>ライブラリの公開が容易<ul><li>GitHubに公開するだけ</li><li>npm や pypi のようなレジストリがないので楽</li></ul></li><li>go test とか go vet, gofmt みたいに標準ツールが揃っている</li><li>コーディング規約で悩む必要がない</li><li>lintツールが充実している<ul><li>gometalinter とか使っておけば OK</li><li>lintできる環境を構築するのにそこまで頑張らなくて良い</li></ul></li><li>エラーハンドリングが暗黙的に省略できないので信頼性が高い<ul><li>Goのエラーハンドリング嫌いって人もいるし、v2で改善されるって話も聞くけど、自分はむしろ好き(面倒なのは理解できるけど)</li></ul></li><li>言語仕様がシンプル(客観的な根拠はないし、難しい部分もあるけど、そんな気がする)<ul><li>メタプログラミング使った、魔術的なコードになりにくい</li></ul></li><li>interface 使ってコードを疎結合にするのが書いてて気持ちいい</li><li>並列処理が書きやすい</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-logging-error-handling-practice-0.2.0">go-error-handling-logging-practice v0.2</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-01T13:26:13.000Z" itemprop="datePublished">February 1, 2019</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>以前 Golang のロギング・エラーハンドリングについて書きました。</p><ul><li><a href="https://suzuki-shunsuke.github.io/golang-logging-error-handling-practice/" target="_blank" rel="noopener noreferrer">https://suzuki-shunsuke.github.io/golang-logging-error-handling-practice/</a></li><li><a href="https://github.com/suzuki-shunsuke/go-error-handling-logging-practice" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-error-handling-logging-practice</a></li></ul><p>それを少し v0.1 から v0.2 に互換性を壊す形でアップデートしようかと思います。
本記事ではその変更点について書きます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変更点">変更点<a class="hash-link" href="#変更点" title="Direct link to heading">​</a></h2><p><strong>関数のエラーに情報を付与する責務を関数に割り当てていたものを、呼び出し元に割り当てるようにします。</strong></p><p>具体的には元々</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">checkName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;age&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>だったものが</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">checkName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user name is invalid&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="変更理由">変更理由<a class="hash-link" href="#変更理由" title="Direct link to heading">​</a></h2><p>メタ情報のフィールド名はコンテキストに依存します。
上記の例だとユーザー名というメタ情報のフィールド名は <code>name</code> より <code>user_name</code> や <code>admin_name</code>, <code>owner_name</code> としたほうが適切かもしれません。それは関数内部では分からず、呼び出し元でないと分かりません。呼び出し元でないとフィールド名の衝突が避けられないこともあるでしょう。</p><p>メッセージに関しても同様のことが言えます。
また、元々 v0.1 ではユーザーが定義した関数と</p><ul><li>標準関数やサードパーティのライブラリなど、プロジェクト外部で定義された関数</li><li>interface の関数やメソッド</li></ul><p>を区別し、前者では関数側でエラーに情報を付与させる一方、後者では呼び出し元で情報を付与させるというふうにしていました。</p><p>v0.2 では両者を区別せず、どちらの場合でも呼び出し元に付与させるというふうにすることでよりルールがシンプルになります。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/terraform-provider-graylog-import">Terraform Providerで import を実装する方法</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-01-25T13:38:28.000Z" itemprop="datePublished">January 25, 2019</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>terraform provider graylog で alert condition と stream rule の import を実装しました。</p><ul><li><a href="https://github.com/suzuki-shunsuke/go-graylog/pull/59" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/pull/59</a></li><li><a href="https://github.com/suzuki-shunsuke/go-graylog/pull/60" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/pull/60</a></li></ul><p>そこで import を実装する方法を紹介したいと思います。</p><p>terraform でリソースをimportするにはリソースがimportをサポートしている必要があります。
<a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#Resource" target="_blank" rel="noopener noreferrer">schema.Resource の Importer フィールド</a>ですね。リソースがIDだけでGet出来る場合、<a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#ImportStatePassthrough" target="_blank" rel="noopener noreferrer">schema.ImportStatePassthrough</a>を使えば終わりです。
一方、Graylogのalert condition や stream rule はIDだけでなく、stream id も必要になります。
terraform import コマンドは1つの引数しか取らないため、サポートできないのでは？と以前まで思っていました。
そういった場合、次のようにStateFuncを実装すればサポートできます。</p><p><a href="https://github.com/suzuki-shunsuke/go-graylog/pull/59/commits/baee1165f49d2bc21b6ea7551ceff6b7daf01543#diff-f41be2a3640efd12ad4e808d77c5c8d5" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/pull/59/commits/baee1165f49d2bc21b6ea7551ceff6b7daf01543#diff-f41be2a3640efd12ad4e808d77c5c8d5</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;/&quot; で区切って stream id と ID を渡す</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform import graylog_alarm_callback.test 5bb1b4b5c9e77bbbbbbbbbbb/5c4acaefc9e77bbbbbbbbbbb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>区切り文字は何でも良いのでしょうが、公式のprovider が &quot;/&quot; で区切っていたのでそれに従うことにしました。</p><p><a href="https://www.terraform.io/docs/providers/google/r/spanner_database.html#import" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/google/r/spanner_database.html#import</a></p><p><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema#ImportStatePassthrough" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema#ImportStatePassthrough</a> の実装を見てみれば分かりますが、
StateFunc の中では GET API を叩いてリソースを取得したりはしません。
<code>terraform import</code> コマンドの標準出力を見ると分かりますが refresh を実行しているのでそこでGETしているようです。
StateFunc は *schema.ResourceData の配列を返しますが、これは1度のGETで複数のリソースを取得するようなAPIをサポートするためのようです。</p><p>以上、terraform import の実装方法について紹介しました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/graylog">graylog</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/downgrade-github-plan">GithubをFree Planにダウングレードした</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-01-20T03:27:26.000Z" itemprop="datePublished">January 20, 2019</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>GitHub のプラン体系が変わり、無料プランでも無制限でprivate repositoryが作れるようになりました。</p><p><a href="https://github.blog/2019-01-07-new-year-new-github/" target="_blank" rel="noopener noreferrer">https://github.blog/2019-01-07-new-year-new-github/</a></p><p>そこで無料プランにダウングレードすることにしました。</p><ul><li><a href="https://help.github.com/articles/downgrading-your-github-billing-plan/" target="_blank" rel="noopener noreferrer">https://help.github.com/articles/downgrading-your-github-billing-plan/</a></li><li><a href="https://blog.jnito.com/entry/2019/01/09/081913" target="_blank" rel="noopener noreferrer">https://blog.jnito.com/entry/2019/01/09/081913</a></li></ul><p>無料プランではwikiはpublic repositoryでしか使えないので、
private repository の wiki を 移行することにしました。</p><p>private なソースコード(サービス)のためのwikiではなく、
個人的なメモが書いてあるだけだったので移行することに特に問題はありませんでした。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="全-private-repository-の-wiki-を-clone">全 private repository の wiki を clone<a class="hash-link" href="#全-private-repository-の-wiki-を-clone" title="Direct link to heading">​</a></h2><p>そこでまずはそういった wiki を clone して一つのリポジトリにまとめることにしました。</p><p><a href="https://github.com/suzuki-shunsuke/foo" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/foo</a> の wiki は
<a href="https://github.com/suzuki-shunsuke/foo.wiki" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/foo.wiki</a> で clone できます。</p><p>次のようなコマンドを実行し、private repositoryのwikiを全部cloneしました。</p><p><a href="https://developer.github.com/v3/repos/#list-your-repositories" target="_blank" rel="noopener noreferrer">https://developer.github.com/v3/repos/#list-your-repositories</a></p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl &quot;https://api.github.com/user/repos?access_token=$GITHUB_TOKEN&amp;visibility=private&quot; | jq -r &#x27;.[].html_url&#x27; | xargs -I{} -n 1 git clone {}.wiki</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>wikiが存在しないものに関しては clone に失敗します。
API で wiki のリストが取得できると良かったんですが、
wikiに関するAPIはなさそうです。</p><p>また <code>/user/repos</code> API のレスポンスの <code>has_wiki</code> はwikiが存在しなくても、wikiが無効化されてなければ true なようです。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="wiki-を-notable-に移植">wiki を notable に移植<a class="hash-link" href="#wiki-を-notable-に移植" title="Direct link to heading">​</a></h2><p>clone した wiki を <a href="https://github.com/fabiospampinato/notable" target="_blank" rel="noopener noreferrer">notable</a> に移植します。</p><p>notable は <a href="https://www.moongift.jp/2019/01/notable-%E6%B7%BB%E4%BB%98%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%82%E4%BD%BF%E3%81%88%E3%82%8Bmarkdown%E8%A8%98%E6%B3%95%E3%81%AE%E3%83%A1%E3%83%A2/" target="_blank" rel="noopener noreferrer">moon gift で最近紹介されていて良さそうだった</a>ので使ってみます。</p><p>Hugo に移植しても良かったのですが notable が気になったので notable にしました。
notable を使ってみてダメそうだったら Hugo も検討します。</p><p>Hugo に比べてnotableが良いところは</p><ul><li>シンタクスハイライト</li><li>tagによる絞り込み</li><li>検索</li></ul><p>がデフォルトで(特に手を加えたりしなくても)いい感じに使えることです。</p><p>notable の data directory を private repository で管理します(Dropbox などのクラウドストレージで管理しても良いと思います)。</p><p>専用の private repository を1つ作成し、data directory を作成し、notable の設定で作成したdata directory をnotable の data directory にします。</p><p>notable の data directory にはバイナリではなく、plain text として wiki が作られるようなので移植も header の部分を notable に合わせて data directory に放り込むだけで良いので簡単でした。</p><p>header はこんな感じです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title: Ansible action plugin について</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags: [ansible]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>意外と移行対象のwikiが少なかったので1, 2時間で終わりました。
終わったあとプランを無料プランに変更して作業は終了しました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/github">github</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/golang-logging-error-handling-practice">Go におけるエラーハンドリングとロギングのプラクティス</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-25T12:51:41.000Z" itemprop="datePublished">December 25, 2018</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="2018-12-30-追記">2018-12-30 追記<a class="hash-link" href="#2018-12-30-追記" title="Direct link to heading">​</a></h2><p>この記事を元にドキュメントを書いてみました。</p><p><a href="https://github.com/suzuki-shunsuke/go-error-handling-logging-practice" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-error-handling-logging-practice</a></p><p>追記ここまで</p><hr><p>Go でエラーハンドリングとロギングをしてきて自分の中で固まりつつあるプラクティスを明文化します。
明文化することで以下のことを目指します。</p><ul><li>迷いをなくす</li><li>コードの一貫性を保つ</li><li>コーディング規約とすることでレビューの品質を上げる(自動化は出来ないけど)</li><li>コードの品質を上げる(コードがゴチャつかなくなる)</li><li>適切にエラーをロギングする(必要十分な情報をログとして残す)</li></ul><p>またエラーハンドリングとロギングのためのライブラリを自作しているのでそれも紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/go-errlog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-errlog</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ロギングに関する関連記事">ロギングに関する関連記事<a class="hash-link" href="#ロギングに関する関連記事" title="Direct link to heading">​</a></h2><p>この記事を書く前に軽くググってみただけでちゃんと読んでないのですが、
興味のある人は読んでみてください。</p><ul><li><a href="https://www.loggly.com/blog/think-differently-about-what-to-log-in-go-best-practices-examined/" target="_blank" rel="noopener noreferrer">https://www.loggly.com/blog/think-differently-about-what-to-log-in-go-best-practices-examined/</a></li><li><a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" target="_blank" rel="noopener noreferrer">https://dave.cheney.net/2015/11/05/lets-talk-about-logging</a></li><li><a href="https://postd.cc/go-best-practices-2016/#logging-and-instrumentation" target="_blank" rel="noopener noreferrer">https://postd.cc/go-best-practices-2016/#logging-and-instrumentation</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ログレベルは分ける">ログレベルは分ける<a class="hash-link" href="#ログレベルは分ける" title="Direct link to heading">​</a></h2><p>ログレベルでwarningとかいらないという意見もありますが、自分は必要だと思っています。
自分は以下のログレベルを使い分けます。</p><ul><li>debug: あまり使わない。調査目的で一時的に埋め込むログ。調査が終わったら出力しないようにする。一時的でないものはinfoにする</li><li>info: エラーでないログ。イベント、処理の開始時や終了を記録するのに使うことが多い</li><li>warn: 4xx系のエラー。それが起こっただけではアラートを飛ばさないが、数が通常時より多い場合はバグかUIに問題があってユーザーが間違えやすくなっている可能性があるのでアラートを飛ばす</li><li>error: 5xx系のエラー。アラートを飛ばす(閾値は調整)</li><li>fatal: 処理継続が不可能な致命的なエラー。システムを止める</li></ul><p>書いてから思いましたが、これに関しては標準的な使い分けのルールがありそうですね(要調査)。。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="logrus-を使ってログを構造化する">logrus を使ってログを構造化する<a class="hash-link" href="#logrus-を使ってログを構造化する" title="Direct link to heading">​</a></h2><p>前提としてwebシステムやバッチシステムなどを想定しています。CLIツールならば話は変わるでしょう。
JSONフォーマットで出力してfluentdでElasticsearchにフォワードするのが個人的によくあるパターンです。</p><p>go-errlogもlogrusの使用を前提としています。</p><p>ロギングのライブラリは他にも色々あるので、logrusで満足できない人は以下から探してみるとよいでしょう。</p><p><a href="https://github.com/avelino/awesome-go#logging" target="_blank" rel="noopener noreferrer">https://github.com/avelino/awesome-go#logging</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="エラーログは中央集権的に-main-に近い所で出力する">エラーログは中央集権的に main に近い所で出力する<a class="hash-link" href="#エラーログは中央集権的に-main-に近い所で出力する" title="Direct link to heading">​</a></h2><p>エラーログをどこで出力するかですが、原則中央集権的に main に近い所で出力します。
因みに中央集権的という表現は echo の centralized error handling からもじっています。</p><p><a href="https://echo.labstack.com/guide/error-handling" target="_blank" rel="noopener noreferrer">https://echo.labstack.com/guide/error-handling</a></p><p>error が発生してもすぐログを吐くのではなく、error を関数の戻り値として返し、ロギングする責務を親に委譲します。
Goでは以下のようなイディオムがよく見られますね。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="ロギングに必要な情報を戻り値のerrorに含める">ロギングに必要な情報を戻り値のerrorに含める<a class="hash-link" href="#ロギングに必要な情報を戻り値のerrorに含める" title="Direct link to heading">​</a></h2><p>上記のコードで問題なのは、エラーに関する情報が欠損することがあることです。</p><p>これに関しては以下の記事が参考になります。</p><p><a href="https://deeeet.com/writing/2016/04/25/go-pkg-errors/" target="_blank" rel="noopener noreferrer">https://deeeet.com/writing/2016/04/25/go-pkg-errors/</a></p><p>エラーに関する情報には2種類あると個人的に考えていて「メッセージ」と「メタ情報」なんて風に脳内で呼んでたりします。</p><ul><li>メッセージ: エラーの原因を示すhuman readable なテキスト(<a href="https://github.com/pkg/errors" target="_blank" rel="noopener noreferrer">pkg/errors</a>はこれに対応している)<ul><li>リストになる</li></ul></li><li>メタ情報: エラーに関する構造化されたデータ<ul><li>ハッシュになる</li></ul></li></ul><p>例えば foo というユーザー名が既に使われていてユーザーの作成に失敗した場合</p><ul><li>メッセージ<ul><li>username is already used</li><li>invalid username</li><li>failed to create a user</li></ul></li><li>メタ情報<ul><li>username: foo</li></ul></li></ul><p>と言った感じになります。
メッセージにメタ情報を含めて <code>&quot;foo&quot; is invalid username</code> といった風にも出来ますが、そうすると検索・集計しづらかったり、メッセージの生成に一手間かかったりするのでメッセージにはメタ情報を含めません。</p><p>pkg/errors だとメタ情報には対応できないので自分でライブラリを作りました。</p><p><a href="https://github.com/suzuki-shunsuke/go-errlog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-errlog</a></p><p>こんな感じになります。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;username&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="error-に含める情報の責務">error に含める情報の責務<a class="hash-link" href="#error-に含める情報の責務" title="Direct link to heading">​</a></h2><p>上記のように error に情報を含める場合、どこまで含めるかというのが問題になります。
ここでプラクティスとして、
<strong>関数がerrorを返す場合、その関数がもっている情報は全て含める責務があり、
逆に子関数から返ってきたerrorには子関数に渡っている情報が含まれているので呼び出し元で付与する必要はない</strong>というふうにしています。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;age&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>つまり上のコードでは子関数に渡っているメタ情報<code>name</code>や、<code>invalid username</code> のようなメッセージを <code>errlog.Wrap</code> に渡す必要はありません。
上記の例だとエラーに関係ない <code>age</code> も渡す必要はないのではないかとも考えられますが、原則ログに残すこととします。</p><p>ただし、子関数が標準関数やサードパーティのライブラリなど、プロジェクト外部で定義された関数であれば話は別です。
それらがどのようなエラーを返すかは保証がありません。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;filename&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> filename</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to open a file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;failed to create a user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>上記の例だと、<code>os.Open</code>に渡したメタ情報 <code>filename</code> や os.Openに失敗したことを示す <code>failed to open a file</code> といったメッセージも<code>errlog.Wrap</code>に渡しています。</p><p><code>errlog.Wrap</code> は複数のメッセージを渡せるようになっています。
メッセージの順番は左からイベントが発生した順になるようにします。
上記の例だと「ファイルのオープンに失敗」した結果、「ユーザの作成に失敗」するという順序になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="エラーのロギングはシンプルに">エラーのロギングはシンプルに<a class="hash-link" href="#エラーのロギングはシンプルに" title="Direct link to heading">​</a></h2><p>go-errlogではシンプルにロギングを記述できます。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx go"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">logger </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> errlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// err != nil なら logging する</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// err がメタ情報を持ってたら logrusで構造化してロギングする</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// メッセージも pkg/errors のように一つのテキストに連結してロギング</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">createUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="その他-go-errlog-の機能">その他 go-errlog の機能<a class="hash-link" href="#その他-go-errlog-の機能" title="Direct link to heading">​</a></h2><p>メタ情報やメッセージによって条件分岐したり出来るようにヘルパー関数を幾つか提供しています。</p><ul><li>CheckField</li><li>HasField</li><li>HasMsg</li></ul><p>詳細は<a href="https://godoc.org/github.com/suzuki-shunsuke/go-errlog" target="_blank" rel="noopener noreferrer">GoDoc</a>やソースコードを見てください。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="最後に">最後に<a class="hash-link" href="#最後に" title="Direct link to heading">​</a></h2><p>色々書いてしまいましたが、一番言いたかったことは</p><blockquote><p><strong>関数がerrorを返す場合、その関数がもっている情報は全て含める責務があり、
逆に子関数から返ってきたerrorには子関数に渡っている情報が含まれているので呼び出し元で付与する必要はない</strong>というふうにしています。</p><p>ただし、子関数が標準関数やサードパーティのライブラリなど、プロジェクト外部で定義された関数であれば話は別です。</p></blockquote><p>の部分です。この辺は元々自分の中でルールが決まってなくてずっとモヤモヤしてて、
コードを書くたびにぶれてたのですが、「こうすればいけるんじゃないか」と思いつき、その実装を補助するライブラリを開発し、
実践したところ今の所そこそこうまく行っています。
ただまだ日が浅いので少しずつブラッシュアップされていく部分もあると思いますが、
その場合でも「なんとなく」ではなく、可能な限り明文化していくことで、迷いをなくし、コードとログの品質を上げていきたいと思います。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/logging">logging</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/graylog-alert-issue">GraylogのAlertの課題</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-19T12:02:11.000Z" itemprop="datePublished">December 19, 2018</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Graylogを運用してきて感じているAlert機能周りの課題をリストアップします。
自分のGraylogの理解が不十分で勘違いしている部分もあるかもしれませんが、ご了承ください。
Graylogのバージョンは 2.5.0 です。
ここでいう「メンション」とは、Slackのようなチャットツールのメンションを指します。
リストの詳細を書きだしてみたものの、リストだけでだいたい言いたいことが言えてしまっていたのと、単なる愚痴っぽくなってしまったので、
リストだけに留めます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="2018-12-31-追記">2018-12-31 追記<a class="hash-link" href="#2018-12-31-追記" title="Direct link to heading">​</a></h2><p>元々 Alert Condition, Notification の APIがないと勘違いしていたのですが、
実はちゃんとあったので terraform で管理できるように go-graylog を更新しました。</p><ul><li><a href="https://github.com/suzuki-shunsuke/go-graylog/pull/50" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/pull/50</a></li><li><a href="https://github.com/suzuki-shunsuke/go-graylog/pull/52" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/pull/52</a></li><li><a href="https://github.com/suzuki-shunsuke/go-graylog/blob/v11.0.0/docs/resources/alarm_callback.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/blob/v11.0.0/docs/resources/alarm_callback.md</a></li><li><a href="https://github.com/suzuki-shunsuke/go-graylog/blob/v11.0.0/docs/resources/alert_condition.md" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog/blob/v11.0.0/docs/resources/alert_condition.md</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="課題リスト">課題リスト<a class="hash-link" href="#課題リスト" title="Direct link to heading">​</a></h2><ul><li><del>APIでAlert Condition, Notificationを管理できない</del><ul><li><del>APIがないので terraform でサポートも出来ない</del></li><li><del>数が増えるとWeb UIでは管理が辛い・修正漏れや設定ミスが出やすい</del></li></ul></li><li>Condition, NotificationがStreamに紐づく<ul><li>ConditionによってNotificationを変えられない<ul><li>条件に応じてアラートの文面・通知先・メンション先・メンションの有無を変えられない
(正確にはテンプレートエンジンで頑張ればある程度対応できるかもしれないが、個人的にはテンプレートそのものを切り替えたい)</li></ul></li><li>ConditionやNotificationを複数のStreamで使い回せない</li></ul></li><li>(少なくとも標準機能では)時間帯によってアラートの挙動を変更できない<ul><li>夜中にはアラートを飛ばさない・メンションをつけないといったことが出来ない</li><li><a href="https://github.com/Graylog2/graylog2-server/issues/3182" target="_blank" rel="noopener noreferrer">一時的にアラートを止められない</a></li></ul></li><li>Pluginを使うにしてもどれを使ったら良いか分からない<ul><li>もっとGraylogがメジャーになれば状況も変わるかもしれない</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/graylog">graylog</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/graylog-terraform-ci">Graylog の Terraform を CI/CDで実行する</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-06T23:22:49.000Z" itemprop="datePublished">December 6, 2018</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>以前 Graylog を Terraform で管理する記事を書きました。</p><p><a href="https://suzuki-shunsuke.github.io/graylog-terraform/" target="_blank" rel="noopener noreferrer">https://suzuki-shunsuke.github.io/graylog-terraform/</a></p><p>今回はそれを CI/CD で実行できるようにした話です。</p><p>ただし、今回の内容は Graylog に限らず Terraform を CI/CD で実行する方法として使えると思います。</p><p>今回実現したのは以下のことです。</p><ul><li>PR時にテストをする</li><li><code>plan/*</code> tag を push すると <code>terraform plan</code> が実行される</li><li><code>apply/*</code> tag を push すると <code>terraform apply</code> が実行され、tfstate がコミット、プッシュされる</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ソースコード">ソースコード<a class="hash-link" href="#ソースコード" title="Direct link to heading">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/example/tree/master/graylog-terraform" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/tree/master/graylog-terraform</a> に置いておきました。</p><ul><li><a href="https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/role.tf#L13-L25" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/role.tf#L13-L25</a></li><li><a href="https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/user.tf#L12-L21" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/user.tf#L12-L21</a></li><li><a href="https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/.drone.yml" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/.drone.yml</a></li><li><a href="https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/terraform.tfvars.tpl" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/terraform.tfvars.tpl</a></li><li><a href="https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/drone_pipeline_commands/git.sh" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/blob/master/graylog-terraform/drone_pipeline_commands/git.sh</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="cicd用の-user-role-を作成する">CI/CD用の user, role を作成する<a class="hash-link" href="#cicd用の-user-role-を作成する" title="Direct link to heading">​</a></h2><p>まずは role を作成します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;graylog_role&quot; &quot;terraform&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  permissions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dashboards:*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;indexsets:*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;inputs:*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles:*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;streams:*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;users:*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>permission は terraform で管理するリソースのみ付与しますが、
それでも結構強い権限を付与するので取扱に注意してください。</p><p>よりちゃんと権限管理するのであれば project ごとに role, user を分けるという手もありそうですが、そうすると管理も大変そうです。</p><p>次に user を作成します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;graylog_user&quot; &quot;terraform&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email     = &quot;terraform@example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  full_name = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;terraform&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Reader&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Reader か Admin は必須らしいのでReaderを付与しています。</p><p><a href="http://docs.graylog.org/en/2.5/pages/users_and_roles/permission_system.html" target="_blank" rel="noopener noreferrer">http://docs.graylog.org/en/2.5/pages/users_and_roles/permission_system.html</a></p><blockquote><p>Every user needs to at least have the standard “Reader” permissions
but those do not provide any access to data or maintenance functionalities.</p></blockquote><p>次にこのユーザーの token を発行します。</p><p><a href="http://docs.graylog.org/en/2.5/pages/configuration/rest_api.html#creating-and-using-access-token" target="_blank" rel="noopener noreferrer">http://docs.graylog.org/en/2.5/pages/configuration/rest_api.html#creating-and-using-access-token</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -u &lt;username&gt;:&lt;password&gt; -H &#x27;Accept: application/json&#x27; -X POST &#x27;https://graylog.example.com/api/users/&lt;username&gt;/tokens/&lt;tokenname&gt;?pretty=true&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>発行したトークンを CI/CD にクレデンシャルとしてセットします。
やり方は利用するCI/CDによって変わります。</p><p>以降は <a href="https://drone.io/" target="_blank" rel="noopener noreferrer">drone ci</a> という CI/CD プラットフォームを前提に書きますが、
travis ci や circle ci, jenkins など他のCI/CDでも考え方は一緒だと思います。</p><p>.drone.yml は 以下のようになります。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pipeline</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">envsubst</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzukishunsuke/alpine</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">envsubst</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> envsubst &lt; terraform.tfvars.tpl </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> terraform.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform_token_prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> graylog_auth_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">plan</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token important">&amp;terraform_image</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;suzukishunsuke/terraform-graylog:0.1.2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> refs/tags/plan/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apply</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token important">*terraform_image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auto</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> refs/tags/apply/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">git</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plugins/git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> sh drone_pipeline_commands/git.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> refs/tags/apply/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">validate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token important">*terraform_image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TF_VAR_auth_name=dummy&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TF_VAR_auth_password=token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TF_VAR_web_endpoint_uri=https://graylog.example.com/api&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pull_request</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>まずは terraform を実行するための Docker Image を用意しました。</p><p><a href="https://hub.docker.com/r/suzukishunsuke/terraform-graylog/" target="_blank" rel="noopener noreferrer">https://hub.docker.com/r/suzukishunsuke/terraform-graylog/</a></p><p>PR時のテストでは terraform validate と terraform fmt を実行します。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">validate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token important">*terraform_image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TF_VAR_auth_name=dummy&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TF_VAR_auth_password=token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TF_VAR_web_endpoint_uri=https://graylog.example.com/api&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pull_request</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>TF_VAR_</code> で始まるのが terraform の変数です。</p><p><a href="https://www.terraform.io/docs/configuration/variables.html#environment-variables" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/configuration/variables.html#environment-variables</a></p><p>token は適当な文字列をセットしてください。PR時には実際にgraylog の API を呼ばないので適当なので問題ありません。</p><p>次に <code>plan/*</code> と tag を push すると <code>terraform plan</code> が実行されます。
この結果を見て <code>terraform apply</code> を実行します。</p><p>これは <a href="https://0-8-0.docs.drone.io/manage-secrets/" target="_blank" rel="noopener noreferrer">drone の secrets</a> の都合なのですが、secrets の環境変数は全部大文字になってしまうため <code>TF_VAR_auth_name</code> という環境変数をセットできません。そのため <a href="https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html" target="_blank" rel="noopener noreferrer">envsubst</a> を使って terraform.tfvars に token を書き込んでいます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">envsubst</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzukishunsuke/alpine</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">envsubst</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> envsubst &lt; terraform.tfvars.tpl </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> terraform.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> terraform_token_prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> graylog_auth_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>terraform.tfvars.tpl はこんな感じです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">web_endpoint_uri = &quot;https://graylog.example.com/api&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth_name = &quot;$GRAYLOG_AUTH_NAME&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth_password = &quot;token&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>plan を実行する step です。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">plan</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token important">&amp;terraform_image</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;suzukishunsuke/terraform-graylog:0.1.2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> refs/tags/plan/*</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>apply/*</code> と tag を push すると <code>terraform apply</code> が実行されます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apply</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token important">*terraform_image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform fmt </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> terraform apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auto</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> refs/tags/apply/*</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>terraform.tfstate をコミット, プッシュします。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">git</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plugins/git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commands</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> sh drone_pipeline_commands/git.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">when</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> refs/tags/apply/*</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>drone_pipeline_commands/git.sh はこんな感じです。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git status --porcelain || exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if `git diff --exit-code --quiet terraform.tfstate`; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;terraform.tfstate isn&#x27;t changed&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exit 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  git config user.name drone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  git config user.email drone@example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  git add . || exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  git commit -m &quot;build: commit by drone&quot; || exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  git push origin HEAD:master || exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>terraform.tfstate に変化があった場合のみ コミット・プッシュするようにしています。
この辺のやり方はもっとうまいやり方があるかもしれません
(自分のシェルスクリプト力が低いため)。</p><p><code>terraform plan</code> の <code>-detailed-exitcode</code> オプションを使うのが良い気がします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  -detailed-exitcode  Return detailed exit codes when the command exits. This</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      will change the meaning of exit codes to:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      0 - Succeeded, diff is empty (no changes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      1 - Errored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      2 - Succeeded, there is a diff</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>以上 Graylog の Terraform を CI/CD で実行する方法を紹介しました。
Graylog に限らず、 Terraform を CI/CD で実行する方法として使えると思うので参考になれば幸いです。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/graylog">graylog</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci">ci</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/ansible-molecule">molecule でansible の role と playbook をテストする</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-06T14:08:04.000Z" itemprop="datePublished">December 6, 2018</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>ansible 専用の testing ツール <a href="https://molecule.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">molecule</a> を紹介します。
molecule の公式ドキュメント以外の情報は少ないので、参考になれば幸いです。</p><p>以前 Docker を使って ansible のテストをする方法を紹介しました。</p><p><a href="https://suzuki-shunsuke.github.io/test-ansible-on-docker/" target="_blank" rel="noopener noreferrer">https://suzuki-shunsuke.github.io/test-ansible-on-docker/</a></p><p>この際は Docker Compose と簡単なシェルスクリプトを使って実現しました。
これはこれでブラックボックスな部分がなく、学習コストも低くて悪くないので興味のある方はそちらもご参照ください。</p><p>molecule は ansible 専用の testing ツールです。
基本的に playbook というより role 用のツールですが、playbookのテストも工夫すれば出来ます。</p><ul><li>情報が少ない</li><li>公式ドキュメントも分かりづらい部分がある</li><li>コマンドがエラー吐いて失敗した際に、ググっても情報が出てこないので辛い</li></ul><p>という風に辛い部分もありますが、</p><ul><li>star数はそれなりにある</li><li>ansible の公式のプロジェクトである <a href="https://github.com/ansible/molecule/" target="_blank" rel="noopener noreferrer">https://github.com/ansible/molecule/</a></li><li><a href="https://github.com/geerlingguy" target="_blank" rel="noopener noreferrer">geerlingguy</a> さんも使ってる</li></ul><p>という風に良い面もあります。</p><p>それでは使っていきましょう。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="インストール">インストール<a class="hash-link" href="#インストール" title="Direct link to heading">​</a></h2><p><a href="https://molecule.readthedocs.io/en/latest/installation.html" target="_blank" rel="noopener noreferrer">https://molecule.readthedocs.io/en/latest/installation.html</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ pip install molecule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Docker を使う場合 <code>docker-py</code> も必要です。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ pip install docker-py</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="role-のテスト">role のテスト<a class="hash-link" href="#role-のテスト" title="Direct link to heading">​</a></h2><p>playbookに比べて role のテストは簡単です。</p><p>role のディレクトリ(tasksやfilesなどがあるディレクトリ)に移動してコマンドを実行します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule init scenario -r &lt;role name&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>こうすると <code>molecule</code> ディレクトリが生成されます。</p><p><code>molecule/default/molecule.yml</code> を修正します。</p><p><a href="https://molecule.readthedocs.io/en/latest/configuration.html" target="_blank" rel="noopener noreferrer">https://molecule.readthedocs.io/en/latest/configuration.html</a></p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dependency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> galaxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 依存する role がある場合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">role-file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> roles.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">driver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">lint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yamllint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># https://molecule.readthedocs.io/en/latest/configuration.html#platforms</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">platforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> server  </span><span class="token comment" style="color:#999988;font-style:italic"># コンテナの名前になる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 必要に応じて image を変更</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 今回は ansibleのremote user を非rootにするために自作の Docker Image を指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># https://hub.docker.com/r/suzukishunsuke/ansible-test-centos/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> suzukishunsuke/ansible</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">centos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># systemd を使ったりする場合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># https://molecule.readthedocs.io/en/latest/examples.html#systemd-container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privileged</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /sbin/init  </span><span class="token comment" style="color:#999988;font-style:italic"># systemd を使う場合必要</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">USER</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo </span><span class="token comment" style="color:#999988;font-style:italic"># DockerだとUSER環境変数が空になってしまうようなので明示的に設定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">provisioner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># https://molecule.readthedocs.io/en/latest/configuration.html#id12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ansible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">lint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ansible</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo </span><span class="token comment" style="color:#999988;font-style:italic"># 非rootユーザーで実行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">inventory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">group_vars</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># variables を指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">all</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">nginx_server_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mysql_host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mysql_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3306</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mysql_database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mysql_user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mysql_password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scenario</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">verifier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> testinfra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">lint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flake8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>test の前にまずは lint します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule lint [-s &lt;senario name&gt;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>すると yamllint の設定ファイル <code>.yamllint</code> が作られていると思うので、必要に応じて修正します。</p><p><a href="https://yamllint.readthedocs.io/en/stable/configuration.html" target="_blank" rel="noopener noreferrer">https://yamllint.readthedocs.io/en/stable/configuration.html</a></p><p>ansible-lint で引っかかった人はこちらを参照してください。</p><p><a href="https://github.com/ansible/ansible-lint" target="_blank" rel="noopener noreferrer">https://github.com/ansible/ansible-lint</a></p><p>そして test コマンドを実行します。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule test [-s &lt;senario name&gt;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>test</code> コマンドではコンテナが削除されるため、デバッグが難しかったりします。</p><p>その場合、 <code>converge</code> コマンドを実行すればコンテナは消えません。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule converge [-s &lt;senario name&gt;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>消したくなったら destroy コマンドで消しましょう。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule destroy [-s &lt;senario name&gt;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="playbook-のテスト">playbook のテスト<a class="hash-link" href="#playbook-のテスト" title="Direct link to heading">​</a></h2><p>次に playbook のテストです。割とこれが本題だったりします。
molecule は基本的に playbook というより role 用のツールなので若干工夫が必要です。</p><p>自分はよく ansible playbook のディレクトリ構成を以下のようにします。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">hello-molecule/  # ルートディレクトリ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agent.yml # agent グループ用の playbook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  group_vars/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all.yml  # 共通のvariables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent.yml  # agent グループ用の variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles/  # role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inventories/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prod.yml # production用のinventory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles.yml  # 依存する role のリスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ansible.cfg</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このときに playbook <code>agent.yml</code> のテストがしたいとします。
molecule のためにこの構成を弄ったりは極力したくありません。</p><p>playbook のディレクトリで <code>molecule init</code> を実行します。
default シナリオは必須のようです。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule init scenario -r hello-molecule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ molecule init scenario -s agent -r hello-molecule</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>するとこうなります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">hello-molecule/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agent.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  group_vars/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inventories/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prod.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  roles.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ansible.cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  molecule/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      molecule.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      playbook.yml # これは使わない。消す</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ここから molecule.yml を修正していきます。
一部抜粋します。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dependency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> galaxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">role-file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> roles.yml </span><span class="token comment" style="color:#999988;font-style:italic"># ルートディレクトリからの相対パス</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">platforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> server  </span><span class="token comment" style="color:#999988;font-style:italic"># group名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> centos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">provisioner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ansible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">playbooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">converge</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ../../server.yml </span><span class="token comment" style="color:#999988;font-style:italic"># ルートディレクトリにある playbookを指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ANSIBLE_ROLES_PATH</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ../../roles</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">../../_roles  </span><span class="token comment" style="color:#999988;font-style:italic"># roleのパスを修正</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scenario</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> server</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように playbookや role のパスを修正すればあとは role のテストと同じ要領でいけると思います。</p><p>以上、簡単ですが molecule の使い方を紹介しました。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ansible">ansible</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/molecule">molecule</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/graylog-terraform">GraylogをTerraformで管理する</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-01T05:56:00.000Z" itemprop="datePublished">December 1, 2018</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Shunsuke Suzuki</span></a></div><small class="avatar__subtitle" itemprop="description">SRE / OSS Contributor / Tool Maker / Go / Terraform</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Graylogのリソースを terraform で管理するために作った terraform provider を紹介します。
<a href="https://www.graylog.org/" target="_blank" rel="noopener noreferrer">Graylog</a>とは何かは<a href="/graylog/">こちら</a>を読んでください。</p><p>Graylogには様々なリソースがあります。</p><ul><li>User</li><li>Role</li><li>Input</li><li>Index Set</li><li>Stream</li><li>Stream Rule</li><li>Dashboard</li><li>Alert</li><li>etc</li></ul><p>これらのリソースはWeb UIから作成したり出来るわけですが、
Web UIでポチポチするのは疲れますし、ソースコードで管理したいものです(Infrastructure as Code)。
また、Web UIからでは細かな権限管理は出来ず(限られた権限管理しか出来ない)、APIを使ってする必要があります。</p><p>APIを使って管理できるツールを探したものの見つからなかったので、
APIを使ってGraylog用のterraform providerを自作しています。</p><p><a href="https://github.com/suzuki-shunsuke/go-graylog" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/go-graylog</a></p><p>GraylogのAPIの種類は非常に多く、残念ながらカバーできているのは一部だけですが、以下のようなものをサポートしています。</p><ul><li>Alert Condition</li><li>Alert Notification (Alarm Callback)</li><li>Input</li><li>User</li><li>Role</li><li>Index Set</li><li>Stream</li><li>Stream Rule</li><li>Dashboard</li><li>Ldap Setting</li></ul><p>Role はサポートしているので権限管理は問題なく出来ます。
Dashboard Widget もサポートしたいです。</p><p><del>出来れば Alert の設定も出来ると良いのですが、Alertに関するCRUD APIが提供されていない(GETのみ)ので、サポートできません。</del></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-を使った管理方法">terraform を使った管理方法<a class="hash-link" href="#terraform-を使った管理方法" title="Direct link to heading">​</a></h2><p>以下では自分の管理方法を紹介します。</p><p><a href="https://github.com/suzuki-shunsuke/example/tree/master/graylog-terraform" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/example/tree/master/graylog-terraform</a></p><p>にサンプルが置いてあります。</p><p>基本はプロジェクトごとに</p><ol><li>Index Set, Stream, Role といったリソースを作成</li><li>User に Role を付与</li></ol><p>という流れになります。</p><p>1のプロジェクトごとの設定は <a href="https://www.terraform.io/docs/modules/index.html" target="_blank" rel="noopener noreferrer">terraform の module</a> という形でまとめてしまい、プロジェクトごとにディレクトリを作成しています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="terraform-provider-の開発について">terraform provider の開発について<a class="hash-link" href="#terraform-provider-の開発について" title="Direct link to heading">​</a></h2><p>terraform provider の開発はドキュメントが少なく動かしつつ手探りで書いていたりしています。
terraform provider の開発に興味のある方はこの辺を見てみると良いと思います。</p><ul><li><a href="https://www.terraform.io/docs/plugins/provider.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/plugins/provider.html</a></li><li><a href="https://www.terraform.io/guides/writing-custom-terraform-providers.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/guides/writing-custom-terraform-providers.html</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/schema" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/schema</a></li><li><a href="https://godoc.org/github.com/hashicorp/terraform/helper/resource#TestCase" target="_blank" rel="noopener noreferrer">https://godoc.org/github.com/hashicorp/terraform/helper/resource#TestCase</a></li></ul><p>あとは <a href="https://github.com/terraform-providers/terraform-provider-google" target="_blank" rel="noopener noreferrer">https://github.com/terraform-providers/terraform-provider-google</a> のような公式の provider のソースコードも参考になります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="最後に">最後に<a class="hash-link" href="#最後に" title="Direct link to heading">​</a></h2><p>API を使って terraform provider を開発することで、Infrastructure as Code をある程度実現できました。</p><ul><li><del>Stream Rule と Dashboard をサポートできていない</del></li><li><del>Alertに関するCRUD APIが提供されていない(GETのみ)ので、サポートできない</del></li></ul><p>という問題がクリア出来てないので、そこをクリアしたいです。</p><p>また、</p><ul><li><del>まだ terraform を CI で出来ていない(ローカルから実行している)</del></li><li>新しいプロジェクトやユーザーの追加の際に雛形を自動生成できるツールを作りたい(特に、新しく参画した人のためにあると良い)</li></ul><p>といった点も改善したいです(出来たら記事にしたいと思います)。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="2018-12-03-追記">2018-12-03 追記<a class="hash-link" href="#2018-12-03-追記" title="Direct link to heading">​</a></h2><ul><li>Stream Rule サポートしました</li><li><a href="/graylog-terraform-ci">terraform を CI で実行するようにしました(気が向いたら記事書きます)</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="2018-12-31-追記">2018-12-31 追記<a class="hash-link" href="#2018-12-31-追記" title="Direct link to heading">​</a></h2><ul><li>Alert Condition, Notification をサポートしました</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/graylog">graylog</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a href="//page/9" target="_blank" rel="noopener noreferrer" class="pagination-nav__link"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a href="//page/11" target="_blank" rel="noopener noreferrer" class="pagination-nav__link"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.aa8dd679.js"></script>
<script src="/assets/js/main.038f1787.js"></script>
</body>
</html>