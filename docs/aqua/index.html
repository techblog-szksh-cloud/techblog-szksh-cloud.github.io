<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Melody RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Melody Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Melody JSON Feed"><title data-rh="true">aqua - CLI ツールのバージョン管理 | Melody</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://techblog.szksh.cloud/aqua"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="aqua - CLI ツールのバージョン管理 | Melody"><meta data-rh="true" name="description" content="2021-09-04 追記: aqua v0.1.0 から v0.5.0 での変更点"><meta data-rh="true" property="og:description" content="2021-09-04 追記: aqua v0.1.0 から v0.5.0 での変更点"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-08-28T00:07:38.000Z"><meta data-rh="true" property="article:tag" content="oss,aqua"><link data-rh="true" rel="icon" href="http://github.com/suzuki-shunsuke.png"><link data-rh="true" rel="canonical" href="https://techblog.szksh.cloud/aqua"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/aqua" hreflang="en"><link data-rh="true" rel="alternate" href="https://techblog.szksh.cloud/aqua" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.53be142c.css">
<link rel="preload" href="/assets/js/runtime~main.32bb3848.js" as="script">
<link rel="preload" href="/assets/js/main.88921da3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--light_TfLj"><img src="http://github.com/suzuki-shunsuke.png" alt="Shunsuke Suzuki" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Melody</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/techblog-szksh-cloud/techblog-szksh-cloud.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub User Profile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="http://github.com/suzuki-shunsuke/resume" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Resume<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/job-change-2022-06">転職します</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/github-re-request-review">Pull Request を再度 review してほしい場合は Re-request review をしましょう</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-04">2022-04 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-03">2022-03 振り返り</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/what-i-did-2022-02">2022-02 振り返り</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">aqua - CLI ツールのバージョン管理</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-08-28T00:07:38.000Z" itemprop="datePublished">August 28, 2021</time> · <!-- -->16 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>2021-09-04 追記: <a href="/aqua-v0.5">aqua v0.1.0 から v0.5.0 での変更点</a></p><p><a href="https://github.com/suzuki-shunsuke/aqua" target="_blank" rel="noopener noreferrer">aqua</a> という OSS を開発しているので紹介します。</p><p>記事の内容は aqua v0.1.0 に基づきます。将来的に仕様が変わる可能性があります。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-とは">aqua とは<a class="hash-link" href="#aqua-とは" title="Direct link to heading">​</a></h2><p>aqua は CLI ツールのバージョン管理のための CLI です。
aqua で管理する主な対象は GitHub Release で公開されているツールです。
YAML の設定ファイルを書いてコマンドを実行すると指定したツールをインストールすることができます。</p><p>例えば以下のような設定ファイルを書き、 <code>aqua install</code> というコマンドを実行すると
<a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a>, <a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a> などが GitHub Release からダウンロードされ、インストールされます。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v0.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">inline_registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> stedolan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;jq-{{if eq .OS &quot;darwin&quot;}}osx-amd64{{else}}{{if eq .OS &quot;linux&quot;}}linux64{{else}}win64.exe{{end}}{{end}}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github_release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> open</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">policy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repo_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conftest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>ちなみに上記の設定ファイルの</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">asset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;conftest_{{trimPrefix &quot;v&quot; .Package.Version}}_{{title .OS}}_x86_64.tar.gz&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>の部分では Go の <a href="https://pkg.go.dev/text/template" target="_blank" rel="noopener noreferrer">text/template</a> と <a href="http://masterminds.github.io/sprig/" target="_blank" rel="noopener noreferrer">sprig</a> が使われています。</p><p>ツールごとに URL を調べて download して tarball などを展開してインストールしてなどの面倒な作業を aqua で自動化できます。
update も基本的に設定ファイルの version を更新するだけで OK です。</p><p>aqua を使うと同じツールの複数のバージョンを管理してプロジェクトによってバージョンを切り替えるといったことも容易にできます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="3-つの主なユースケース">3 つの主なユースケース<a class="hash-link" href="#3-つの主なユースケース" title="Direct link to heading">​</a></h2><p>aqua では以下の 3 つの主なユースケースを想定しています。</p><ul><li>CI/CD で必要なツールの管理</li><li>ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理</li><li>特定のプロジェクト(リポジトリ)によらないツールの管理</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース1-cicd-で必要なツールの管理">ユースケース1: CI/CD で必要なツールの管理<a class="hash-link" href="#ユースケース1-cicd-で必要なツールの管理" title="Direct link to heading">​</a></h3><p>例えば Terraform の Monorepo の CI で以下のような様々なツールを使っていたとしましょう。</p><ul><li><a href="https://cli.github.com/" target="_blank" rel="noopener noreferrer">gh</a></li><li><a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a></li><li><a href="https://tfsec.dev/" target="_blank" rel="noopener noreferrer">tfsec</a></li><li><a href="https://github.com/terraform-linters/tflint" target="_blank" rel="noopener noreferrer">tflint</a></li><li><a href="https://github.com/minamijoyo/tfmigrate" target="_blank" rel="noopener noreferrer">tfmigrate</a></li><li><a href="https://github.com/suzuki-shunsuke/tfcmt" target="_blank" rel="noopener noreferrer">tfcmt</a></li><li><a href="https://github.com/open-policy-agent/opa" target="_blank" rel="noopener noreferrer">opa</a></li><li><a href="https://www.conftest.dev/" target="_blank" rel="noopener noreferrer">conftest</a></li><li><a href="https://github.com/mvdan/sh" target="_blank" rel="noopener noreferrer">shfmt</a></li><li><a href="https://github.com/koalaman/shellcheck" target="_blank" rel="noopener noreferrer">shellcheck</a></li><li><a href="https://github.com/suzuki-shunsuke/github-comment" target="_blank" rel="noopener noreferrer">github-comment</a></li></ul><p>これらを1個1個 curl などを使ってインストールするコードを書くのは面倒ですが、
aqua であれば設定ファイルを宣言的に書いて <code>aqua i</code> を実行すれば終わりです。
新たにツールを追加する場合でも設定ファイルに追記すればよく、スクリプトを更新する必要はありません。
バージョンを明示的に指定できるのでコードを変更してないのに急にツールが更新されることもありませんし、 <a href="https://docs.renovatebot.com/modules/manager/regex/" target="_blank" rel="noopener noreferrer">Renovate の Regex Manager</a> などを使えば更新を自動化することもできます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理">ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理<a class="hash-link" href="#ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理" title="Direct link to heading">​</a></h3><p>あるリポジトリのローカルでの開発に必要なツールを aqua で管理することができます。
リポジトリ直下に <code>aqua.yaml</code> を置いておけば OK です。
バージョンも指定されているので、人によってバージョンが違ったりする問題も解消できます。
<code>aqua.yaml</code> と同じディレクトリに <code>.aqua</code> が作成されるのでそれを .gitignore に追加し、 <code>.aqua/bin</code> を PATH に追加しましょう。
direnv を使い、リポジトリ直下に .envrc を置いて <code>.aqua/bin</code> を PATH に追加すると便利です。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">aqua.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.envrc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>.envrc</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PATH_add .aqua/bin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>.aqua/bin</code> を PATH に追加しなくても <code>aqua exec -- &lt;コマンド&gt; ...</code> で実行することもできます。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ユースケース3-特定のプロジェクトリポジトリによらないツールの管理">ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理<a class="hash-link" href="#ユースケース3-特定のプロジェクトリポジトリによらないツールの管理" title="Direct link to heading">​</a></h3><p>特定のプロジェクトによらずにツールを laptop にインストールしたい場合にも使えます。
<code>~/.aqua/global/aqua.yaml</code> に設定ファイルを記述し、 <code>~/.aqua/global/.aqua/bin</code> を PATH に追加してください。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$HOME/.aqua/global/.aqua/bin:$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>そして <code>~/.aqua/global</code> 配下で <code>aqua i</code> を実行すればインストールができます。
<code>~/.aqua/global</code> を Git で管理して GitHub などでホスティングするのも良いでしょう。</p><p><a href="https://github.com/suzuki-shunsuke/my-aqua-config" target="_blank" rel="noopener noreferrer">https://github.com/suzuki-shunsuke/my-aqua-config</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="akoi-との違い">akoi との違い<a class="hash-link" href="#akoi-との違い" title="Direct link to heading">​</a></h2><p>ところで、自分は aqua に似たツールとして <a href="http://github.com/suzuki-shunsuke/akoi" target="_blank" rel="noopener noreferrer">akoi</a> というツールを公開していて、自分もこれまでこのツールを使ってきました。
aqua と akoi は「CLI ツールのバージョン管理」という目的・ゴールは同じです。
akoi も結構便利なツールですが、 akoi が抱える様々な課題を解決するために aqua を開発しています。
aqua は akoi のいわば後継ツールです。
ただしコードは全く別物ですし、互換性もありません。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="akoi-と比べた-aqua-の良い点">akoi と比べた aqua の良い点<a class="hash-link" href="#akoi-と比べた-aqua-の良い点" title="Direct link to heading">​</a></h3><ul><li>GitHub Access Token を使ったインストールをサポート<ul><li>private repository をサポート</li><li>akoi は anonymous なアクセスなので rate limit に引っかかりやすい</li></ul></li><li>管理対象のコマンド実行時にツールのインストールが可能</li><li>設定ファイルを更新したあとに install コマンドを実行する必要がない<ul><li>akoi は symbolic link を作り直すために install コマンドを実行する必要がある</li></ul></li><li>管理対象のツールの実体を共有できる<ul><li>project ごとにツールを install する必要がない(計算資源の効率化)</li><li>akoi と違って ツールによって実体のインストール先は一意に決まるので、干渉することがなく安全に共有できる</li></ul></li><li>事前に archive の中のパスを知っている必要がない<ul><li>akoi は install 時に archive を展開してファイルをコピーし、シンボリックリンクを作成する<ul><li>パスが間違っていると失敗し、 download からやり直しになる</li><li>そのため、新しいツールを akoi で管理する場合はまず archive の構造を調べる必要がある</li></ul></li><li>aqua は install したあとに ~/.aqua 配下を見て file.src を修正すれば良いし、間違っててコマンドの実行に失敗しても download のやり直しとかはない</li></ul></li><li><code>bin_path</code>, <code>link_path</code> ような設定について考えなくて良い<ul><li>akoi は設定ファイルでインストール先などを設定できるようになっている</li><li>どう設定すべきか悩ましいし、リポジトリによって設定が違ったりして設定を統一するのが難しい</li><li>aqua はインストール先などが設定できないのでユーザーが迷う必要がない</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="管理対象のツールの実体を共有できる">管理対象のツールの実体を共有できる<a class="hash-link" href="#管理対象のツールの実体を共有できる" title="Direct link to heading">​</a></h4><p>aqua はツールの実体を AQUA_ROOT_DIR <code>~/.aqua</code> にインストールし、共有することができます。
複数のリポジトリで同じバージョンの同じツールを使う場合に共有できるので、
インストールにかかる時間を短縮できますし、無駄にディスク容量を消費することもありません。
設定ファイルによって動的にバージョンを取得するので、共有していてもリポジトリごとに異なるバージョンを使うこともできます。</p><p>安全に共有できるようにツールの実体のインストール先はダウンロード元によってユニークかつ一意に決まるようになっています。
ユーザーがカスタマイズすることはできません(ルートディレクトリは変えられますが、ルート以下は変えられません)。</p><p>例えば OSX で jq-1.6 のインストール先は以下になります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">.aqua/pkgs/github_release/github.com/stedolan/jq/jq-1.6/jq-osx-amd64/jq-osx-amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>このように GitHub Release からインストールする場合</p><ul><li>リポジトリのオーナー</li><li>リポジトリ名</li><li>tag</li><li>GitHub Release のアセット名</li></ul><p>などから一意に決まるため、あるリポジトリでは jq をフォークしたものを使うといった場合でも安全に共存することができます。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="便利な---only-link-option">便利な <code>--only-link</code> option<a class="hash-link" href="#便利な---only-link-option" title="Direct link to heading">​</a></h2><p><code>aqua install</code> を実行するとツールごとに以下のことが実行されます。</p><ol><li><code>.aqua/bin</code> 配下にシンボリックリンクを作成</li><li>ダウンロード</li><li>tarball などの展開</li><li>~/.aqua 配下にインストール</li></ol><p>aqua.yaml の packages に大量のツールが定義されていると、
大量のツールが一度にインストールされることになり、
並列で実行されるとはいえ、都合が悪いこともあるでしょう。</p><p><code>--only-link</code> option をつけて実行すると、シンボリックリンクだけ作成しダウンロードなどは行わないので直ぐに終わります。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aqua install --only-link</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>その状態でツールを実行すると、ツールが自動でインストールされてから実行されるので
本当に必要になってからインストールすることが可能であり、余計なインストールが発生しないので便利です。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="コマンド実行時の自動インストール動的なバージョン切り替えの仕組み">コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み<a class="hash-link" href="#コマンド実行時の自動インストール動的なバージョン切り替えの仕組み" title="Direct link to heading">​</a></h2><p>aqua は設定ファイルを更新すると <code>aqua install</code> 実行をしなくても更新が反映される、
ツールがまだインストールされていなくてもツールを実行時に自動でインストールされるという機能があります。</p><p>tfenv も .terraform-version を更新すればすぐ反映されますし、
terraform コマンドを実行時にまだ指定したバージョンがインストールされてなかったら自動でインストールされますが、それに似ていますね
(ただし tfenv の機能がどう実装されているかは調べてませんし、 aqua を実装する上で参考にしたりはしていません)。</p><p>上記の機能が aqua でどう実現されているか簡単に説明します。</p><p>例えば aqua で jq をインストールし、 <code>jq -h</code> を実行したとしましょう。
jq を実行すると aqua-proxy を経由して <code>aqua exec -- jq -h</code> が実行されます。
この辺の詳細は <a href="#aqua-proxy-%E3%81%A8%E3%81%AF">aqua-proxy とは</a> を参照してください。
<code>aqua exec</code> は aqua の設定ファイルで指定されたバージョンがインストールされているかチェックし、まだインストールされていなかったらインストールし、コマンド <code>jq -h</code> を実行します。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="aqua-proxy-とは">aqua-proxy とは<a class="hash-link" href="#aqua-proxy-とは" title="Direct link to heading">​</a></h2><p><a href="https://github.com/suzuki-shunsuke/aqua-proxy" target="_blank" rel="noopener noreferrer">aqua-proxy</a> は aqua が内部的に依存しているツールです。
コマンド実行時に aqua 及び aqua で管理するツールのバージョンを動的に変更するために作られました。
aqua のために開発されており、 aqua 以外で使われることは想定していません。</p><p>aqua-proxy は <code>aqua install</code> や <code>aqua exec</code> を実行した際に自動で <code>~/.aqua/bin/aqua-proxy</code> にインストールされます。
aqua はツールをインストールする際に <code>.aqua/bin/&lt;ツール&gt;</code> から <code>~/.aqua/bin/aqua-proxy</code> へのシンボリックリンクを作成するので、 <code>&lt;ツール&gt;</code> を実行すると <code>~/.aqua/bin/aqua-proxy</code> が呼ばれます。</p><p>aqua-proxy は <a href="https://pkg.go.dev/os#Args" target="_blank" rel="noopener noreferrer">os#Args</a> からツール名を取得し、
<code>aqua exec -- &lt;ツール名&gt; ...</code> を実行します。
これによりコマンド実行時に aqua 及び <code>&lt;ツール&gt;</code> のバージョンを動的に変更することを実現しています。</p><p><code>.aqua/bin/&lt;ツール&gt;</code> から aqua-proxy へのシンボリックリンクは静的であり、 aqua-proxy のバージョンを切り替えることは難しいです。
aqua-proxy の機能・責務が大きくなると aqua-proxy のバージョン管理や aqua との互換性を考えなくてはならなくなります。
aqua-proxy のバージョンをほぼ気にしなくて良いよう、 aqua-proxy は最小限の機能・責務しか持たず、安定的であまり変更されないように設計されています。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="プロセスツリーを確認してみる">プロセスツリーを確認してみる<a class="hash-link" href="#プロセスツリーを確認してみる" title="Direct link to heading">​</a></h2><p>既に説明したとおり <code>&lt;ツール&gt;</code> を実行した際には実はプロセスツリー的には
<code>aqua-proxy =&gt; aqua =&gt; &lt;ツール&gt;</code> という風になっています。</p><p><code>&lt;ツール&gt;</code> を直接実行した場合と挙動に違いが出ないように以下のようなことに気を配っています。</p><ul><li>SIGINT, SIGTERM などのシグナルが適切に <code>&lt;ツール&gt;</code> のプロセスまで伝達されるようにする</li><li><code>&lt;ツール&gt;</code> の exit code が伝達されるようにする</li></ul><p>試しに fzf を実行してみて別のターミナルでプロセスツリーを確認してみます。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls | fzf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>fzf が起動しますが、そのままにしておいて別のターミナルでプロセスツリーを確認してみます。
Mac の <code>pstree</code> を使っています。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-+- 83548 foo fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> \-+- 83549 foo aqua exec -- fzf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   \--- 83550 foo /Users/foo/.aqua/pkgs/github_release/github.com/junegunn/fzf/0.27.2/fzf-0.27.2-darwin_amd64.zip/fzf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>紛らわしいのですが、最初のプロセスの実体は fzf ではなくて aqua-proxy です。 fzf が aqua-proxy へのシンボリックになっているのでこうなっています。
ここで aqua-proxy に SIGTERM を送ると手元の Mac ではちゃんと子プロセスまで終了しました。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kill 83548</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>この辺のシグナルハンドリングは Windows だと正常に動かないかもしれません。</p><p><a href="https://pkg.go.dev/os#Signal" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/os#Signal</a></p><blockquote><p>The only signal values guaranteed to be present in the os package on all systems are os.Interrupt (send the process an interrupt) and os.Kill (force the process to exit).
On Windows, sending os.Interrupt to a process with os.Process.Signal is not implemented;
it will return an error instead of sending a signal.</p></blockquote></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oss">oss</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aqua">aqua</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/what-i-did-2021-08"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">2021-08 やったこと</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/github-app-for-codebuild"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">AWS CodeBuild を実行する Github App を作る</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aqua-とは" class="table-of-contents__link toc-highlight">aqua とは</a></li><li><a href="#3-つの主なユースケース" class="table-of-contents__link toc-highlight">3 つの主なユースケース</a><ul><li><a href="#ユースケース1-cicd-で必要なツールの管理" class="table-of-contents__link toc-highlight">ユースケース1: CI/CD で必要なツールの管理</a></li><li><a href="#ユースケース2-ローカルでの開発に必要なプロジェクトリポジトリ固有のツールの管理" class="table-of-contents__link toc-highlight">ユースケース2: ローカルでの開発に必要なプロジェクト(リポジトリ)固有のツールの管理</a></li><li><a href="#ユースケース3-特定のプロジェクトリポジトリによらないツールの管理" class="table-of-contents__link toc-highlight">ユースケース3: 特定のプロジェクト(リポジトリ)によらないツールの管理</a></li></ul></li><li><a href="#akoi-との違い" class="table-of-contents__link toc-highlight">akoi との違い</a><ul><li><a href="#akoi-と比べた-aqua-の良い点" class="table-of-contents__link toc-highlight">akoi と比べた aqua の良い点</a></li></ul></li><li><a href="#便利な---only-link-option" class="table-of-contents__link toc-highlight">便利な <code>--only-link</code> option</a></li><li><a href="#コマンド実行時の自動インストール動的なバージョン切り替えの仕組み" class="table-of-contents__link toc-highlight">コマンド実行時の自動インストール、動的なバージョン切り替えの仕組み</a></li><li><a href="#aqua-proxy-とは" class="table-of-contents__link toc-highlight">aqua-proxy とは</a></li><li><a href="#プロセスツリーを確認してみる" class="table-of-contents__link toc-highlight">プロセスツリーを確認してみる</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2017 Shunsuke Suzuki. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.32bb3848.js"></script>
<script src="/assets/js/main.88921da3.js"></script>
</body>
</html>